<!DOCTYPE html>
<html lang="es" dir="ltr" prefix="content: http://purl.org/rss/1.0/modules/content/ dc: http://purl.org/dc/terms/ foaf: http://xmlns.com/foaf/0.1/ og: http://ogp.me/ns# rdfs: http://www.w3.org/2000/01/rdf-schema# sioc: http://rdfs.org/sioc/ns# sioct: http://rdfs.org/sioc/types# skos: http://www.w3.org/2004/02/skos/core# xsd: http://www.w3.org/2001/XMLSchema#">
<head>
  <link rel="profile" href="http://www.w3.org/1999/xhtml/vocab" />
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<link rel="shortcut icon" href="/sites/delphi.jmrds.com/themes/bootstrap/favicon.ico" type="image/vnd.microsoft.icon" />
<link rel="shortlink" href="/node/78" />
<link rel="canonical" href="/node/78" />
<meta name="Generator" content="Drupal 7 (http://drupal.org)" />
  <title>Leer los datos públicos del DNIe | La web de Seoane</title>
  <style>
@import url("/modules/system/system.base.css?");
</style>
<style>
@import url("/modules/field/theme/field.css?");
@import url("/modules/node/node.css?");
</style>
<style>
@import url("/sites/delphi.jmrds.com/modules/geshifilter/geshifilter.css?");
</style>
<link type="text/css" rel="stylesheet" href="/sites/delphi.jmrds.com/themes/bootstrap/bootstrap.css" media="all" />
<style>
@import url("/sites/delphi.jmrds.com/themes/bootstrap/css/3.3.5/overrides.min.css?");
</style>
  <!-- HTML5 element support for IE6-8 -->
  <!--[if lt IE 9]>
    <script src="https://cdn.jsdelivr.net/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
  <![endif]-->
  <script src="/sites/delphi.jmrds.com/modules/jquery_update/replace/jquery/1.10/jquery.min.js?v=1.10.2"></script>
<script src="/misc/jquery.once.js?v=1.2"></script>
<script src="/misc/drupal.js?"></script>
<script src="/sites/delphi.jmrds.com/themes/bootstrap/bootstrap.js"></script>
<script src="/sites/delphi.jmrds.com/files/languages/es_sB9mP1iixuFRbyZKZVySK7xrSW_2-LRj1vNEXyqwOu8.js?"></script>
<script>jQuery.extend(Drupal.settings, {"basePath":"\/","pathPrefix":"","ajaxPageState":{"theme":"bootstrap","theme_token":"H3aYG1zLk5eRxM3FuHVQ55WkoL0Buq5QLA9DlAwRjB4","js":{"sites\/delphi.jmrds.com\/themes\/bootstrap\/js\/bootstrap.js":1,"sites\/delphi.jmrds.com\/modules\/jquery_update\/replace\/jquery\/1.10\/jquery.min.js":1,"misc\/jquery.once.js":1,"misc\/drupal.js":1,"\/\/cdn.jsdelivr.net\/bootstrap\/3.3.5\/js\/bootstrap.js":1,"public:\/\/languages\/es_sB9mP1iixuFRbyZKZVySK7xrSW_2-LRj1vNEXyqwOu8.js":1},"css":{"modules\/system\/system.base.css":1,"modules\/field\/theme\/field.css":1,"modules\/node\/node.css":1,"sites\/delphi.jmrds.com\/modules\/geshifilter\/geshifilter.css":1,"\/\/cdn.jsdelivr.net\/bootstrap\/3.3.5\/css\/bootstrap.css":1,"sites\/delphi.jmrds.com\/themes\/bootstrap\/css\/3.3.5\/overrides.min.css":1}},"bootstrap":{"anchorsFix":"0","anchorsSmoothScrolling":"0","formHasError":1,"popoverEnabled":"1","popoverOptions":{"animation":1,"html":0,"placement":"right","selector":"","trigger":"click","triggerAutoclose":1,"title":"","content":"","delay":0,"container":"body"},"tooltipEnabled":"1","tooltipOptions":{"animation":1,"html":0,"placement":"auto left","selector":"","trigger":"hover focus","delay":0,"container":"body"}}});</script>
</head>
<body class="html not-front not-logged-in no-sidebars page-node page-node- page-node-78 node-type-article">
  <div id="skip-link">
    <a href="#main-content" class="element-invisible element-focusable">Pasar al contenido principal</a>
  </div>
    <header id="navbar" role="banner" class="navbar container navbar-default">
  <div class="container">
    <div class="navbar-header">
              <a class="logo navbar-btn pull-left" href="/" title="Inicio">
          <img src="/sites/delphi.jmrds.com/themes/bootstrap/logo.png" alt="Inicio" />
        </a>
      
              <a class="name navbar-brand" href="/" title="Inicio">La web de Seoane</a>
      
              <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#navbar-collapse">
          <span class="sr-only">Toggle navigation</span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
          </div>

          <div class="navbar-collapse collapse" id="navbar-collapse">
        <nav role="navigation">
                      <ul class="menu nav navbar-nav"><li class="first leaf"><a href="/" title="">Inicio</a></li>
<li class="last leaf"><a href="/node/26" title="">Contacto</a></li>
</ul>                                      </nav>
      </div>
      </div>
</header>

<div class="main-container container">

  <header role="banner" id="page-header">
    
      </header> <!-- /#page-header -->

  <div class="row">

    
    <section class="col-sm-12">
                  <a id="main-content"></a>
                    <h1 class="page-header">Leer los datos públicos del DNIe</h1>
                                                          <div class="region region-content">
    <section id="block-system-main" class="block block-system clearfix">

      
  <article id="node-78" class="node node-article node-promoted clearfix" about="/node/78" typeof="sioc:Item foaf:Document">
    <header>
            <span property="dc:title" content="Leer los datos públicos del DNIe" class="rdf-meta element-hidden"></span><span property="sioc:num_replies" content="6" datatype="xsd:integer" class="rdf-meta element-hidden"></span>        <span class="submitted">
            <span property="dc:date dc:created" content="2012-05-25T01:44:14+02:00" datatype="xsd:dateTime" rel="sioc:has_creator">Enviado por <span class="username" xml:lang="" about="/user/1" typeof="sioc:UserAccount" property="foaf:name" datatype="">admin</span> el Vie, 05/25/2012 - 01:44</span>    </span>
      </header>
    <div class="field field-name-body field-type-text-with-summary field-label-hidden"><div class="field-items"><div class="field-item even" property="content:encoded"><p>Me acabo de renovar el DNI (Documento Nacional de Identidad) y me lo dieron con su "chip" y su número PIN, así que aprovechando que tenia un lector de tarjetas guardado en un cajón desde hace mas de un año me propuse darle uso. Primero instale todo el software necesario para usarlo con el navegador, firmar documentos, etc ... pero pronto me aburrí, así que intente buscar la forma de acceder a los datos del DNIe desde Delphi (mi lenguaje de programación preferido). Pero no quería jugar con los "datos privados" contenidos en la tarjeta ya que para eso hace falta introducir el PIN y corría el riesgo, si me equivocaba al programar, de bloquear el DNIe y tener que ir a desbloquearlo a una comisaria de policía. Así que me limite a su "zona publica" donde, entre otras cosas, podemos encontrar el numero del documento, nuestro nombre y apellidos, la fecha de expedición, etc ...</p>
<!--break--><p> </p><center><img src="/sites/delphi.jmrds.com/imagenes/Stories/ejemplo_dni.jpg" /></center>
<p>El programa es sencillo, utiliza las funciones de la API de windows "Winscard" para acceder al lector y a la tarjeta, y así leer el contenido de los ficheros públicos.</p>
<p>Lo primero es encontrar el lector y comprobar que tiene un DNIe dentro:</p>
<div class="geshifilter">
<pre class="delphi geshifilter-delphi" style="font-family:monospace;"><span style="color: #000000; font-weight: bold;">var</span>
  hContext<span style="color: #000066;">:</span> SCARDCONTEXT<span style="color: #000066;">;</span>
  pmszReaders<span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">PAnsiChar</span><span style="color: #000066;">;</span>
  pReader<span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">PAnsiChar</span><span style="color: #000066;">;</span>
  cchReaders<span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">DWORD</span><span style="color: #000066;">;</span>
  lReturn<span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">Longint</span><span style="color: #000066;">;</span>
  Card<span style="color: #000066;">:</span> SCARDHANDLE<span style="color: #000066;">;</span>
  ActiveProtocol<span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">DWORD</span><span style="color: #000066;">;</span>
  Stream<span style="color: #000066;">:</span> TMemoryStream<span style="color: #000066;">;</span>
<span style="color: #000000; font-weight: bold;">begin</span>
  lReturn<span style="color: #000066;">:</span><span style="color: #000066;">=</span> SCardEstablishContext<span style="color: #000066;">(</span>SCARD_SCOPE_SYSTEM<span style="color: #000066;">,</span><span style="color: #000000; font-weight: bold;">nil</span><span style="color: #000066;">,</span><span style="color: #000000; font-weight: bold;">nil</span><span style="color: #000066;">,</span><span style="color: #000066;">@</span>hContext<span style="color: #000066;">)</span><span style="color: #000066;">;</span>
  <span style="color: #000000; font-weight: bold;">if</span> lReturn <span style="color: #000066;">=</span> SCARD_S_SUCCESS <span style="color: #000000; font-weight: bold;">then</span>
  <span style="color: #000000; font-weight: bold;">try</span>
    cchReaders<span style="color: #000066;">:</span><span style="color: #000066;">=</span> SCARD_AUTOALLOCATE<span style="color: #000066;">;</span>
    <span style="color: #808080; font-style: italic;">// Obtenemos una lista con todos los lectores</span>
    lReturn<span style="color: #000066;">:</span><span style="color: #000066;">=</span> SCardListReaders<span style="color: #000066;">(</span>hContext<span style="color: #000066;">,</span><span style="color: #000000; font-weight: bold;">nil</span><span style="color: #000066;">,</span><span style="color: #000066;">@</span>pmszReaders<span style="color: #000066;">,</span><span style="color: #000066;">@</span>cchReaders<span style="color: #000066;">)</span><span style="color: #000066;">;</span>
    <span style="color: #000000; font-weight: bold;">if</span> lReturn <span style="color: #000066;">=</span> SCARD_S_SUCCESS <span style="color: #000000; font-weight: bold;">then</span>
    <span style="color: #000000; font-weight: bold;">begin</span>
      pReader<span style="color: #000066;">:</span><span style="color: #000066;">=</span> pmszReaders<span style="color: #000066;">;</span>
      <span style="color: #808080; font-style: italic;">// Intentamos conectarnos a cada uno de los lectores de la lista</span>
      <span style="color: #000000; font-weight: bold;">while</span> <span style="color: #000066;">(</span>pReader<span style="color: #000066;">^</span> &lt;&gt; <span style="color: #ff0000;">#0</span><span style="color: #000066;">)</span> <span style="color: #000000; font-weight: bold;">do</span>
      <span style="color: #000000; font-weight: bold;">begin</span>
        lReturn<span style="color: #000066;">:</span><span style="color: #000066;">=</span> SCardConnect<span style="color: #000066;">(</span>hContext<span style="color: #000066;">,</span> pReader<span style="color: #000066;">,</span> SCARD_SHARE_SHARED<span style="color: #000066;">,</span>
          SCARD_PROTOCOL_T0<span style="color: #000066;">,</span> <span style="color: #000066;">@</span>Card<span style="color: #000066;">,</span> <span style="color: #000066;">@</span>ActiveProtocol<span style="color: #000066;">)</span><span style="color: #000066;">;</span>
        <span style="color: #000000; font-weight: bold;">if</span> lReturn <span style="color: #000066;">=</span> SCARD_S_SUCCESS <span style="color: #000000; font-weight: bold;">then</span>
        <span style="color: #000000; font-weight: bold;">begin</span>
          <span style="color: #808080; font-style: italic;">// Comprobamos si la tarjeta insertada es un DNIe</span>
          <span style="color: #000000; font-weight: bold;">if</span> isDNIe<span style="color: #000066;">(</span>Card<span style="color: #000066;">)</span> <span style="color: #000000; font-weight: bold;">then</span>
          <span style="color: #000000; font-weight: bold;">begin</span>
            <span style="color: #808080; font-style: italic;">// Si llegamos hasta aquí es que hemos encontrado el DNIe</span>
            <span style="color: #000066;">Writeln</span><span style="color: #000066;">(</span><span style="color: #ff0000;">'DNIe Encontrado'</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
            Writeln<span style="color: #000066;">;</span>            
            SCardDisconnect<span style="color: #000066;">(</span>Card<span style="color: #000066;">,</span>SCARD_RESET_CARD<span style="color: #000066;">)</span><span style="color: #000066;">;</span>
            break<span style="color: #000066;">;</span>
          <span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">;</span>
          SCardDisconnect<span style="color: #000066;">(</span>Card<span style="color: #000066;">,</span>SCARD_RESET_CARD<span style="color: #000066;">)</span><span style="color: #000066;">;</span>
        <span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">;</span>
        pReader<span style="color: #000066;">:</span><span style="color: #000066;">=</span> pReader <span style="color: #000066;">+</span> <span style="color: #000066;">StrLen</span><span style="color: #000066;">(</span>pReader<span style="color: #000066;">)</span> <span style="color: #000066;">+</span> <span style="color: #0000ff;">1</span><span style="color: #000066;">;</span>
      <span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">;</span>
      SCardFreeMemory<span style="color: #000066;">(</span>hContext<span style="color: #000066;">,</span>pmszReaders<span style="color: #000066;">)</span><span style="color: #000066;">;</span>
    <span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">;</span>
  <span style="color: #000000; font-weight: bold;">finally</span>
    SCardReleaseContext<span style="color: #000066;">(</span>hContext<span style="color: #000066;">)</span><span style="color: #000066;">;</span>
  <span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">;</span>
  <span style="color: #000066;">Writeln</span><span style="color: #000066;">(</span><span style="color: #ff0000;">'Adios!'</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
<span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">.</span></pre></div>
<p>La función que utilizamos para comprobar si es un DNIe es esta:</p>
<div class="geshifilter">
<pre class="delphi geshifilter-delphi" style="font-family:monospace;"><span style="color: #000000; font-weight: bold;">function</span> isDNIe<span style="color: #000066;">(</span>hCard<span style="color: #000066;">:</span> SCARDHANDLE<span style="color: #000066;">)</span><span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">Boolean</span><span style="color: #000066;">;</span>
<span style="color: #000000; font-weight: bold;">var</span>
  bAtr<span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">PByteArray</span><span style="color: #000066;">;</span>
  cbAtrLen<span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">DWORD</span><span style="color: #000066;">;</span>
  lReturn<span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">Longint</span><span style="color: #000066;">;</span>
<span style="color: #000000; font-weight: bold;">begin</span>
  bAtr<span style="color: #000066;">:</span><span style="color: #000066;">=</span> <span style="color: #000000; font-weight: bold;">nil</span><span style="color: #000066;">;</span>
  cbAtrLen<span style="color: #000066;">:</span><span style="color: #000066;">=</span> <span style="color: #0000ff;">0</span><span style="color: #000066;">;</span>
  lReturn<span style="color: #000066;">:</span><span style="color: #000066;">=</span> SCardStatus<span style="color: #000066;">(</span>hCard<span style="color: #000066;">,</span> <span style="color: #000000; font-weight: bold;">nil</span><span style="color: #000066;">,</span><span style="color: #000000; font-weight: bold;">nil</span><span style="color: #000066;">,</span><span style="color: #000000; font-weight: bold;">nil</span><span style="color: #000066;">,</span><span style="color: #000000; font-weight: bold;">nil</span><span style="color: #000066;">,</span>LPBYTE<span style="color: #000066;">(</span>bAtr<span style="color: #000066;">)</span><span style="color: #000066;">,</span><span style="color: #000066;">@</span>cbAtrLen<span style="color: #000066;">)</span><span style="color: #000066;">;</span>
  <span style="color: #000000; font-weight: bold;">if</span> <span style="color: #000066;">(</span>lReturn &lt;&gt; SCARD_S_SUCCESS<span style="color: #000066;">)</span> <span style="color: #000000; font-weight: bold;">or</span> <span style="color: #000066;">(</span>cbAtrLen&lt;&gt;<span style="color: #0000ff;">20</span><span style="color: #000066;">)</span> <span style="color: #000000; font-weight: bold;">then</span>
  <span style="color: #000000; font-weight: bold;">begin</span>
    Result<span style="color: #000066;">:</span><span style="color: #000066;">=</span> <span style="color: #000000; font-weight: bold;">FALSE</span><span style="color: #000066;">;</span>
    Exit<span style="color: #000066;">;</span>
  <span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">;</span>
  <span style="color: #000066;">GetMem</span><span style="color: #000066;">(</span>bAtr<span style="color: #000066;">,</span>cbAtrLen<span style="color: #000066;">)</span><span style="color: #000066;">;</span>
  <span style="color: #000000; font-weight: bold;">try</span>
    lReturn<span style="color: #000066;">:</span><span style="color: #000066;">=</span> SCardStatus<span style="color: #000066;">(</span>hCard<span style="color: #000066;">,</span> <span style="color: #000000; font-weight: bold;">nil</span><span style="color: #000066;">,</span><span style="color: #000000; font-weight: bold;">nil</span><span style="color: #000066;">,</span><span style="color: #000000; font-weight: bold;">nil</span><span style="color: #000066;">,</span><span style="color: #000000; font-weight: bold;">nil</span><span style="color: #000066;">,</span>LPBYTE<span style="color: #000066;">(</span>bAtr<span style="color: #000066;">)</span><span style="color: #000066;">,</span><span style="color: #000066;">@</span>cbAtrLen<span style="color: #000066;">)</span><span style="color: #000066;">;</span>
    <span style="color: #000000; font-weight: bold;">if</span> lReturn &lt;&gt; SCARD_S_SUCCESS <span style="color: #000000; font-weight: bold;">then</span>
    <span style="color: #000000; font-weight: bold;">begin</span>
      Result<span style="color: #000066;">:</span><span style="color: #000066;">=</span> <span style="color: #000000; font-weight: bold;">FALSE</span><span style="color: #000066;">;</span>
      Exit<span style="color: #000066;">;</span>
    <span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">;</span>
    Result<span style="color: #000066;">:</span><span style="color: #000066;">=</span>
      <span style="color: #000066;">(</span>bAtr<span style="color: #000066;">[</span>00<span style="color: #000066;">]</span><span style="color: #000066;">=</span><span style="color: #0000cc;">$3B</span><span style="color: #000066;">)</span> <span style="color: #000000; font-weight: bold;">and</span> <span style="color: #000066;">(</span>bAtr<span style="color: #000066;">[</span>01<span style="color: #000066;">]</span><span style="color: #000066;">=</span><span style="color: #0000cc;">$7F</span><span style="color: #000066;">)</span> <span style="color: #000000; font-weight: bold;">and</span> <span style="color: #000066;">(</span>bAtr<span style="color: #000066;">[</span>03<span style="color: #000066;">]</span><span style="color: #000066;">=</span><span style="color: #0000cc;">$00</span><span style="color: #000066;">)</span> <span style="color: #000000; font-weight: bold;">and</span> <span style="color: #000066;">(</span>bAtr<span style="color: #000066;">[</span>04<span style="color: #000066;">]</span><span style="color: #000066;">=</span><span style="color: #0000cc;">$00</span><span style="color: #000066;">)</span> <span style="color: #000000; font-weight: bold;">and</span>
      <span style="color: #000066;">(</span>bAtr<span style="color: #000066;">[</span>05<span style="color: #000066;">]</span><span style="color: #000066;">=</span><span style="color: #0000cc;">$00</span><span style="color: #000066;">)</span> <span style="color: #000000; font-weight: bold;">and</span> <span style="color: #000066;">(</span>bAtr<span style="color: #000066;">[</span>06<span style="color: #000066;">]</span><span style="color: #000066;">=</span><span style="color: #0000cc;">$6A</span><span style="color: #000066;">)</span> <span style="color: #000000; font-weight: bold;">and</span> <span style="color: #000066;">(</span>bAtr<span style="color: #000066;">[</span>07<span style="color: #000066;">]</span><span style="color: #000066;">=</span><span style="color: #0000cc;">$44</span><span style="color: #000066;">)</span> <span style="color: #000000; font-weight: bold;">and</span> <span style="color: #000066;">(</span>bAtr<span style="color: #000066;">[</span>08<span style="color: #000066;">]</span><span style="color: #000066;">=</span><span style="color: #0000cc;">$4E</span><span style="color: #000066;">)</span> <span style="color: #000000; font-weight: bold;">and</span>
      <span style="color: #000066;">(</span>bAtr<span style="color: #000066;">[</span>09<span style="color: #000066;">]</span><span style="color: #000066;">=</span><span style="color: #0000cc;">$49</span><span style="color: #000066;">)</span> <span style="color: #000000; font-weight: bold;">and</span> <span style="color: #000066;">(</span>bAtr<span style="color: #000066;">[</span><span style="color: #0000ff;">10</span><span style="color: #000066;">]</span><span style="color: #000066;">=</span><span style="color: #0000cc;">$65</span><span style="color: #000066;">)</span> <span style="color: #000000; font-weight: bold;">and</span> <span style="color: #000066;">(</span>bAtr<span style="color: #000066;">[</span><span style="color: #0000ff;">18</span><span style="color: #000066;">]</span><span style="color: #000066;">=</span><span style="color: #0000cc;">$90</span><span style="color: #000066;">)</span> <span style="color: #000000; font-weight: bold;">and</span> <span style="color: #000066;">(</span>bAtr<span style="color: #000066;">[</span><span style="color: #0000ff;">19</span><span style="color: #000066;">]</span><span style="color: #000066;">=</span><span style="color: #0000cc;">$00</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
  <span style="color: #000000; font-weight: bold;">finally</span>
    <span style="color: #000066;">FreeMem</span><span style="color: #000066;">(</span>bAtr<span style="color: #000066;">)</span><span style="color: #000066;">;</span>
  <span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">;</span>
<span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">;</span></pre></div>
<p>Comprueba la cadena ATR de la tarjeta con la que debe tener un DNIe: <a href="http://www.dnielectronico.es/PDFs/ATR1.pdf">http://www.dnielectronico.es/PDFs/ATR1.pdf</a></p>
<p>Una vez que estamos conectados a la tarjeta ya podemos leer sus ficheros, para eso utilizo estas dos funciones:</p>
<div class="geshifilter">
<pre class="delphi geshifilter-delphi" style="font-family:monospace;"><span style="color: #808080; font-style: italic;">// Envia un comando a la tarjeta (iso_7816-4v2_0.pdf)</span>
<span style="color: #000000; font-weight: bold;">function</span> SendCmd<span style="color: #000066;">(</span>Card<span style="color: #000066;">:</span> SCARDHANDLE<span style="color: #000066;">;</span> Cmd<span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">AnsiString</span><span style="color: #000066;">;</span> Buffer<span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">PByte</span><span style="color: #000066;">;</span> <span style="color: #000000; font-weight: bold;">var</span> l<span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">DWORD</span><span style="color: #000066;">)</span><span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">Boolean</span><span style="color: #000066;">;</span>
<span style="color: #000000; font-weight: bold;">begin</span>
  Result<span style="color: #000066;">:</span><span style="color: #000066;">=</span> <span style="color: #000000; font-weight: bold;">FALSE</span><span style="color: #000066;">;</span>
  <span style="color: #000000; font-weight: bold;">if</span> SCardTransmit<span style="color: #000066;">(</span>Card<span style="color: #000066;">,</span> <span style="color: #000066;">@</span>SCARD_PCI_T0<span style="color: #000066;">,</span><span style="color: #000066; font-weight: bold;">PAnsiChar</span><span style="color: #000066;">(</span>Cmd<span style="color: #000066;">)</span><span style="color: #000066;">,</span><span style="color: #000066;">Length</span><span style="color: #000066;">(</span>Cmd<span style="color: #000066;">)</span><span style="color: #000066;">,</span> <span style="color: #000000; font-weight: bold;">nil</span><span style="color: #000066;">,</span>
    LPBYTE<span style="color: #000066;">(</span>Buffer<span style="color: #000066;">)</span><span style="color: #000066;">,</span> <span style="color: #000066;">@</span>l<span style="color: #000066;">)</span> <span style="color: #000066;">=</span> SCARD_S_SUCCESS <span style="color: #000000; font-weight: bold;">then</span>
    <span style="color: #000000; font-weight: bold;">if</span> l &gt;<span style="color: #000066;">=</span> <span style="color: #0000ff;">2</span> <span style="color: #000000; font-weight: bold;">then</span>
      Result<span style="color: #000066;">:</span><span style="color: #000066;">=</span> <span style="color: #000066;">(</span><span style="color: #000066; font-weight: bold;">PByteArray</span><span style="color: #000066;">(</span>Buffer<span style="color: #000066;">)</span><span style="color: #000066;">[</span>l<span style="color: #000066;">-</span><span style="color: #0000ff;">2</span><span style="color: #000066;">]</span> <span style="color: #000066;">=</span> <span style="color: #0000cc;">$61</span><span style="color: #000066;">)</span> <span style="color: #000000; font-weight: bold;">or</span>
        <span style="color: #000066;">(</span><span style="color: #000066;">(</span><span style="color: #000066; font-weight: bold;">PByteArray</span><span style="color: #000066;">(</span>Buffer<span style="color: #000066;">)</span><span style="color: #000066;">[</span>l<span style="color: #000066;">-</span><span style="color: #0000ff;">2</span><span style="color: #000066;">]</span> <span style="color: #000066;">=</span> <span style="color: #0000cc;">$90</span><span style="color: #000066;">)</span> <span style="color: #000000; font-weight: bold;">and</span> <span style="color: #000066;">(</span><span style="color: #000066; font-weight: bold;">PByteArray</span><span style="color: #000066;">(</span>Buffer<span style="color: #000066;">)</span><span style="color: #000066;">[</span>l<span style="color: #000066;">-</span><span style="color: #0000ff;">1</span><span style="color: #000066;">]</span> <span style="color: #000066;">=</span> <span style="color: #0000cc;">$00</span><span style="color: #000066;">)</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
<span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">;</span>
 
<span style="color: #808080; font-style: italic;">// obtiene_CDF.pdf</span>
<span style="color: #000000; font-weight: bold;">function</span> SCardReadFile<span style="color: #000066;">(</span>Card<span style="color: #000066;">:</span> SCARDHANDLE<span style="color: #000066;">;</span> Path<span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">AnsiString</span><span style="color: #000066;">;</span> Stream<span style="color: #000066;">:</span> TStream<span style="color: #000066;">)</span><span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">Boolean</span><span style="color: #000066;">;</span>
<span style="color: #000000; font-weight: bold;">var</span>
  Buffer<span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">PByte</span><span style="color: #000066;">;</span>
  l<span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">DWORD</span><span style="color: #000066;">;</span>
  Offset<span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">Word</span><span style="color: #000066;">;</span>
  Size<span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">Word</span><span style="color: #000066;">;</span>
<span style="color: #000000; font-weight: bold;">begin</span>
  Result<span style="color: #000066;">:</span><span style="color: #000066;">=</span> <span style="color: #000000; font-weight: bold;">FALSE</span><span style="color: #000066;">;</span>
  <span style="color: #000000; font-weight: bold;">if</span> <span style="color: #000066;">Odd</span><span style="color: #000066;">(</span><span style="color: #000066;">Length</span><span style="color: #000066;">(</span>Path<span style="color: #000066;">)</span><span style="color: #000066;">)</span> <span style="color: #000000; font-weight: bold;">then</span>
    Exit<span style="color: #000066;">;</span>
  <span style="color: #000066;">GetMem</span><span style="color: #000066;">(</span>Buffer<span style="color: #000066;">,</span><span style="color: #0000ff;">258</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
  <span style="color: #000000; font-weight: bold;">try</span>
    l<span style="color: #000066;">:</span><span style="color: #000066;">=</span> <span style="color: #0000ff;">258</span><span style="color: #000066;">;</span>
    <span style="color: #808080; font-style: italic;">// SELECT directorio raiz</span>
    <span style="color: #000000; font-weight: bold;">if</span> <span style="color: #000000; font-weight: bold;">not</span> SendCmd<span style="color: #000066;">(</span>Card<span style="color: #000066;">,</span>
      <span style="color: #ff0000;">#$00</span><span style="color: #ff0000;">#$a4</span><span style="color: #ff0000;">#$04</span><span style="color: #ff0000;">#$00</span><span style="color: #ff0000;">#$0b</span><span style="color: #ff0000;">#$4D</span><span style="color: #ff0000;">#$61</span><span style="color: #ff0000;">#$73</span><span style="color: #ff0000;">#$74</span><span style="color: #ff0000;">#$65</span><span style="color: #ff0000;">#$72</span><span style="color: #ff0000;">#$2E</span><span style="color: #ff0000;">#$46</span><span style="color: #ff0000;">#$69</span><span style="color: #ff0000;">#$6C</span><span style="color: #ff0000;">#$65</span><span style="color: #000066;">,</span>
      Buffer<span style="color: #000066;">,</span> l<span style="color: #000066;">)</span> <span style="color: #000000; font-weight: bold;">then</span> Exit<span style="color: #000066;">;</span>
    <span style="color: #808080; font-style: italic;">// Seguimos la ruta del fichero</span>
    <span style="color: #000000; font-weight: bold;">while</span> <span style="color: #000066;">Length</span><span style="color: #000066;">(</span>Path<span style="color: #000066;">)</span> &gt; <span style="color: #0000ff;">0</span> <span style="color: #000000; font-weight: bold;">do</span>
    <span style="color: #000000; font-weight: bold;">begin</span>
      l<span style="color: #000066;">:</span><span style="color: #000066;">=</span> <span style="color: #0000ff;">258</span><span style="color: #000066;">;</span>
      <span style="color: #808080; font-style: italic;">// SELECT</span>
      <span style="color: #000000; font-weight: bold;">if</span> <span style="color: #000000; font-weight: bold;">not</span> SendCmd<span style="color: #000066;">(</span>Card<span style="color: #000066;">,</span><span style="color: #ff0000;">#$00</span><span style="color: #ff0000;">#$A4</span><span style="color: #ff0000;">#$00</span><span style="color: #ff0000;">#$00</span><span style="color: #ff0000;">#$02</span> <span style="color: #000066;">+</span> <span style="color: #000066;">Copy</span><span style="color: #000066;">(</span>Path<span style="color: #000066;">,</span><span style="color: #0000ff;">1</span><span style="color: #000066;">,</span><span style="color: #0000ff;">2</span><span style="color: #000066;">)</span><span style="color: #000066;">,</span>
        Buffer<span style="color: #000066;">,</span> l<span style="color: #000066;">)</span> <span style="color: #000000; font-weight: bold;">then</span> Exit<span style="color: #000066;">;</span>
      <span style="color: #000066;">delete</span><span style="color: #000066;">(</span>Path<span style="color: #000066;">,</span><span style="color: #0000ff;">1</span><span style="color: #000066;">,</span><span style="color: #0000ff;">2</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
    <span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">;</span>
    l<span style="color: #000066;">:</span><span style="color: #000066;">=</span> <span style="color: #0000ff;">258</span><span style="color: #000066;">;</span>
    <span style="color: #808080; font-style: italic;">// GET RESPONSE</span>
    <span style="color: #000000; font-weight: bold;">if</span> <span style="color: #000000; font-weight: bold;">not</span> SendCmd<span style="color: #000066;">(</span>Card<span style="color: #000066;">,</span><span style="color: #ff0000;">#$00</span><span style="color: #ff0000;">#$C0</span><span style="color: #ff0000;">#$00</span><span style="color: #ff0000;">#$00</span><span style="color: #ff0000;">#$0E</span><span style="color: #000066;">,</span>Buffer<span style="color: #000066;">,</span> l<span style="color: #000066;">)</span> <span style="color: #000000; font-weight: bold;">then</span>
      Exit<span style="color: #000066;">;</span>
    <span style="color: #000000; font-weight: bold;">if</span> <span style="color: #000066;">(</span>l &lt;&gt; <span style="color: #0000cc;">$10</span><span style="color: #000066;">)</span> <span style="color: #000000; font-weight: bold;">or</span> <span style="color: #000066;">(</span><span style="color: #000066; font-weight: bold;">PByteArray</span><span style="color: #000066;">(</span>buffer<span style="color: #000066;">)</span><span style="color: #000066;">[</span><span style="color: #0000ff;">0</span><span style="color: #000066;">]</span> &lt;&gt; <span style="color: #0000cc;">$6F</span><span style="color: #000066;">)</span> <span style="color: #000000; font-weight: bold;">then</span>
      Exit<span style="color: #000066;">;</span>
    <span style="color: #808080; font-style: italic;">// Obtenemos el tamaño</span>
    Size<span style="color: #000066;">:</span><span style="color: #000066;">=</span> <span style="color: #000066;">(</span><span style="color: #000066; font-weight: bold;">PByteArray</span><span style="color: #000066;">(</span>buffer<span style="color: #000066;">)</span><span style="color: #000066;">[</span><span style="color: #0000ff;">7</span><span style="color: #000066;">]</span> <span style="color: #000066;">*</span> <span style="color: #0000cc;">$100</span><span style="color: #000066;">)</span> <span style="color: #000066;">+</span> <span style="color: #000066; font-weight: bold;">PByteArray</span><span style="color: #000066;">(</span>buffer<span style="color: #000066;">)</span><span style="color: #000066;">[</span><span style="color: #0000ff;">8</span><span style="color: #000066;">]</span><span style="color: #000066;">;</span>
    Offset<span style="color: #000066;">:</span><span style="color: #000066;">=</span> <span style="color: #0000ff;">0</span><span style="color: #000066;">;</span>
    <span style="color: #000000; font-weight: bold;">while</span> Offset &lt; Size <span style="color: #000000; font-weight: bold;">do</span>
    <span style="color: #000000; font-weight: bold;">begin</span>
      l<span style="color: #000066;">:</span><span style="color: #000066;">=</span> <span style="color: #0000ff;">258</span><span style="color: #000066;">;</span>
      <span style="color: #808080; font-style: italic;">// Leemos el fichero en bloques de hasta 255 bytes</span>
      <span style="color: #000000; font-weight: bold;">if</span> <span style="color: #000000; font-weight: bold;">not</span> SendCmd<span style="color: #000066;">(</span>Card<span style="color: #000066;">,</span><span style="color: #ff0000;">#$00</span><span style="color: #ff0000;">#$B0</span> <span style="color: #000066;">+</span> <span style="color: #000066; font-weight: bold;">AnsiChar</span><span style="color: #000066;">(</span><span style="color: #000066;">Hi</span><span style="color: #000066;">(</span>Offset<span style="color: #000066;">)</span><span style="color: #000066;">)</span> <span style="color: #000066;">+</span> <span style="color: #000066; font-weight: bold;">AnsiChar</span><span style="color: #000066;">(</span><span style="color: #000066;">Lo</span><span style="color: #000066;">(</span>Offset<span style="color: #000066;">)</span><span style="color: #000066;">)</span>
        <span style="color: #000066;">+</span> <span style="color: #000066; font-weight: bold;">Char</span><span style="color: #000066;">(</span><span style="color: #000066;">Min</span><span style="color: #000066;">(</span>Size<span style="color: #000066;">-</span>Offset<span style="color: #000066;">,</span><span style="color: #0000cc;">$FF</span><span style="color: #000066;">)</span><span style="color: #000066;">)</span><span style="color: #000066;">,</span> Buffer<span style="color: #000066;">,</span> l<span style="color: #000066;">)</span> <span style="color: #000000; font-weight: bold;">then</span> Exit<span style="color: #000066;">;</span>
      <span style="color: #000000; font-weight: bold;">if</span> l &gt; <span style="color: #0000ff;">2</span> <span style="color: #000000; font-weight: bold;">then</span>
        Stream<span style="color: #000066;">.</span><span style="color: #000000; font-weight: bold;">Write</span><span style="color: #000066;">(</span>Buffer<span style="color: #000066;">^</span><span style="color: #000066;">,</span>l<span style="color: #000066;">-</span><span style="color: #0000ff;">2</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
      <span style="color: #000066;">inc</span><span style="color: #000066;">(</span>Offset<span style="color: #000066;">,</span><span style="color: #0000cc;">$FF</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
    <span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">;</span>
    Result<span style="color: #000066;">:</span><span style="color: #000066;">=</span> <span style="color: #000000; font-weight: bold;">TRUE</span><span style="color: #000066;">;</span>
  <span style="color: #000000; font-weight: bold;">finally</span>
    <span style="color: #000066;">FreeMem</span><span style="color: #000066;">(</span>Buffer<span style="color: #000066;">)</span><span style="color: #000066;">;</span>
  <span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">;</span>
<span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">;</span></pre></div>
<p>El parámetro "Path" es la ruta del fichero en hexadecimal a partir del directorio raíz. Por ejemplo la ruta del IDESP es "0006". Puedes encontrar mas rutas aquí:<br /><a href="http://opendnie.morfeo-project.org/wiki/index.php/Documentacion_DNIe_Estructura">http://opendnie.morfeo-project.org/wiki/index.php/Documentacion_DNIe_Est...</a></p>
<p>Algunas interesantes son:</p>
<div class="geshifilter">
<pre class="text geshifilter-text" style="font-family:monospace;">0006         IDESP
50156004  PKCS15-CDF</pre></div>
<p>El código fuente completo es este (es una aplicación de consola):</p>
<div class="geshifilter">
<pre class="delphi geshifilter-delphi" style="font-family:monospace;"><span style="color: #000000; font-weight: bold;">program</span> DNIeReader<span style="color: #000066;">;</span>
 
<span style="color: #008000; font-style: italic;">{$APPTYPE CONSOLE}</span>
 
<span style="color: #000000; font-weight: bold;">uses</span>
  Windows<span style="color: #000066;">,</span>
  SysUtils<span style="color: #000066;">,</span>
  Classes<span style="color: #000066;">,</span>
  WinSCard <span style="color: #000000; font-weight: bold;">in</span> <span style="color: #ff0000;">'WinSCard.pas'</span><span style="color: #000066;">;</span>
 
 
<span style="color: #000000; font-weight: bold;">function</span> <span style="color: #000066;">Min</span><span style="color: #000066;">(</span>i<span style="color: #000066;">,</span>j<span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">Integer</span><span style="color: #000066;">)</span><span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">Integer</span><span style="color: #000066;">;</span>
<span style="color: #000000; font-weight: bold;">begin</span>
  <span style="color: #000000; font-weight: bold;">if</span> i &lt; j <span style="color: #000000; font-weight: bold;">then</span>
    Result<span style="color: #000066;">:</span><span style="color: #000066;">=</span> i
  <span style="color: #000000; font-weight: bold;">else</span>
    Result<span style="color: #000066;">:</span><span style="color: #000066;">=</span> j<span style="color: #000066;">;</span>
<span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">;</span>
 
<span style="color: #808080; font-style: italic;">// Muestra el contenido del buffer en hexadecimal y como texto</span>
<span style="color: #000000; font-weight: bold;">procedure</span> WriteHex<span style="color: #000066;">(</span>Buffer<span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">PAnsiChar</span><span style="color: #000066;">;</span>  Count<span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">Integer</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
<span style="color: #000000; font-weight: bold;">var</span>
  i<span style="color: #000066;">,</span>j<span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">Integer</span><span style="color: #000066;">;</span>
<span style="color: #000000; font-weight: bold;">begin</span>
  j<span style="color: #000066;">:</span><span style="color: #000066;">=</span> <span style="color: #0000ff;">0</span><span style="color: #000066;">;</span>
  <span style="color: #000000; font-weight: bold;">while</span> Count &gt; <span style="color: #0000ff;">0</span> <span style="color: #000000; font-weight: bold;">do</span>
  <span style="color: #000000; font-weight: bold;">begin</span>
    <span style="color: #000000; font-weight: bold;">Write</span><span style="color: #000066;">(</span><span style="color: #000066;">IntToHex</span><span style="color: #000066;">(</span>j<span style="color: #000066;">,</span><span style="color: #0000ff;">8</span><span style="color: #000066;">)</span> <span style="color: #000066;">+</span> <span style="color: #ff0000;">':'</span> <span style="color: #000066;">+</span> <span style="color: #ff0000;">#32</span><span style="color: #ff0000;">#32</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
    <span style="color: #000000; font-weight: bold;">for</span> i<span style="color: #000066;">:</span><span style="color: #000066;">=</span> <span style="color: #0000ff;">0</span> <span style="color: #000000; font-weight: bold;">to</span> <span style="color: #000066;">Min</span><span style="color: #000066;">(</span>Count<span style="color: #000066;">,</span><span style="color: #0000ff;">8</span><span style="color: #000066;">)</span> <span style="color: #000066;">-</span> <span style="color: #0000ff;">1</span> <span style="color: #000000; font-weight: bold;">do</span>
      <span style="color: #000000; font-weight: bold;">Write</span><span style="color: #000066;">(</span><span style="color: #000066;">IntToHex</span><span style="color: #000066;">(</span><span style="color: #000066; font-weight: bold;">Byte</span><span style="color: #000066;">(</span>Buffer<span style="color: #000066;">[</span>i<span style="color: #000066;">]</span><span style="color: #000066;">)</span><span style="color: #000066;">,</span><span style="color: #0000ff;">2</span><span style="color: #000066;">)</span> <span style="color: #000066;">+</span> <span style="color: #ff0000;">#32</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
    <span style="color: #000000; font-weight: bold;">Write</span><span style="color: #000066;">(</span><span style="color: #ff0000;">#32</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
    <span style="color: #000000; font-weight: bold;">for</span> i<span style="color: #000066;">:</span><span style="color: #000066;">=</span> <span style="color: #0000ff;">8</span> <span style="color: #000000; font-weight: bold;">to</span> <span style="color: #000066;">Min</span><span style="color: #000066;">(</span>Count<span style="color: #000066;">,</span><span style="color: #0000ff;">16</span><span style="color: #000066;">)</span> <span style="color: #000066;">-</span> <span style="color: #0000ff;">1</span> <span style="color: #000000; font-weight: bold;">do</span>
      <span style="color: #000000; font-weight: bold;">Write</span><span style="color: #000066;">(</span><span style="color: #000066;">IntToHex</span><span style="color: #000066;">(</span><span style="color: #000066; font-weight: bold;">Byte</span><span style="color: #000066;">(</span>Buffer<span style="color: #000066;">[</span>i<span style="color: #000066;">]</span><span style="color: #000066;">)</span><span style="color: #000066;">,</span><span style="color: #0000ff;">2</span><span style="color: #000066;">)</span> <span style="color: #000066;">+</span> <span style="color: #ff0000;">#32</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
    <span style="color: #000000; font-weight: bold;">for</span> i<span style="color: #000066;">:</span><span style="color: #000066;">=</span> <span style="color: #000066;">Min</span><span style="color: #000066;">(</span>Count<span style="color: #000066;">,</span><span style="color: #0000ff;">16</span><span style="color: #000066;">)</span> <span style="color: #000000; font-weight: bold;">to</span> <span style="color: #0000ff;">15</span> <span style="color: #000000; font-weight: bold;">do</span>
      <span style="color: #000000; font-weight: bold;">Write</span><span style="color: #000066;">(</span><span style="color: #ff0000;">#32</span><span style="color: #ff0000;">#32</span><span style="color: #ff0000;">#32</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
    <span style="color: #000000; font-weight: bold;">Write</span><span style="color: #000066;">(</span><span style="color: #ff0000;">#32</span> <span style="color: #000066;">+</span> <span style="color: #ff0000;">'|'</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
    <span style="color: #000000; font-weight: bold;">for</span> i<span style="color: #000066;">:</span><span style="color: #000066;">=</span> <span style="color: #0000ff;">0</span> <span style="color: #000000; font-weight: bold;">to</span> <span style="color: #000066;">Min</span><span style="color: #000066;">(</span>Count<span style="color: #000066;">,</span><span style="color: #0000ff;">16</span><span style="color: #000066;">)</span> <span style="color: #000066;">-</span> <span style="color: #0000ff;">1</span> <span style="color: #000000; font-weight: bold;">do</span>
    <span style="color: #000000; font-weight: bold;">if</span> <span style="color: #000066; font-weight: bold;">Char</span><span style="color: #000066;">(</span>Buffer<span style="color: #000066;">[</span>i<span style="color: #000066;">]</span><span style="color: #000066;">)</span> <span style="color: #000000; font-weight: bold;">in</span> <span style="color: #000066;">[</span><span style="color: #ff0000;">'A'</span><span style="color: #000066;">..</span><span style="color: #ff0000;">'Z'</span><span style="color: #000066;">,</span><span style="color: #ff0000;">'a'</span><span style="color: #000066;">..</span><span style="color: #ff0000;">'z'</span><span style="color: #000066;">,</span><span style="color: #ff0000;">'0'</span><span style="color: #000066;">..</span><span style="color: #ff0000;">'9'</span><span style="color: #000066;">]</span> <span style="color: #000000; font-weight: bold;">then</span>
      <span style="color: #000000; font-weight: bold;">Write</span><span style="color: #000066;">(</span>Buffer<span style="color: #000066;">[</span>i<span style="color: #000066;">]</span><span style="color: #000066;">)</span>
    <span style="color: #000000; font-weight: bold;">else</span>
      <span style="color: #000000; font-weight: bold;">Write</span><span style="color: #000066;">(</span><span style="color: #ff0000;">'.'</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
    <span style="color: #000066;">Writeln</span><span style="color: #000066;">(</span><span style="color: #ff0000;">'|'</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
    <span style="color: #000066;">Dec</span><span style="color: #000066;">(</span>Count<span style="color: #000066;">,</span><span style="color: #0000ff;">16</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
    <span style="color: #000066;">inc</span><span style="color: #000066;">(</span>Buffer<span style="color: #000066;">,</span><span style="color: #0000ff;">16</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
    <span style="color: #000066;">inc</span><span style="color: #000066;">(</span>j<span style="color: #000066;">,</span><span style="color: #0000ff;">16</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
  <span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">;</span>
<span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">;</span>
 
<span style="color: #000000; font-weight: bold;">function</span> isDNIe<span style="color: #000066;">(</span>hCard<span style="color: #000066;">:</span> SCARDHANDLE<span style="color: #000066;">)</span><span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">Boolean</span><span style="color: #000066;">;</span>
<span style="color: #000000; font-weight: bold;">var</span>
  bAtr<span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">PByteArray</span><span style="color: #000066;">;</span>
  cbAtrLen<span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">DWORD</span><span style="color: #000066;">;</span>
  lReturn<span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">Longint</span><span style="color: #000066;">;</span>
<span style="color: #000000; font-weight: bold;">begin</span>
  bAtr<span style="color: #000066;">:</span><span style="color: #000066;">=</span> <span style="color: #000000; font-weight: bold;">nil</span><span style="color: #000066;">;</span>
  cbAtrLen<span style="color: #000066;">:</span><span style="color: #000066;">=</span> <span style="color: #0000ff;">0</span><span style="color: #000066;">;</span>
  lReturn<span style="color: #000066;">:</span><span style="color: #000066;">=</span> SCardStatus<span style="color: #000066;">(</span>hCard<span style="color: #000066;">,</span> <span style="color: #000000; font-weight: bold;">nil</span><span style="color: #000066;">,</span><span style="color: #000000; font-weight: bold;">nil</span><span style="color: #000066;">,</span><span style="color: #000000; font-weight: bold;">nil</span><span style="color: #000066;">,</span><span style="color: #000000; font-weight: bold;">nil</span><span style="color: #000066;">,</span>LPBYTE<span style="color: #000066;">(</span>bAtr<span style="color: #000066;">)</span><span style="color: #000066;">,</span><span style="color: #000066;">@</span>cbAtrLen<span style="color: #000066;">)</span><span style="color: #000066;">;</span>
  <span style="color: #808080; font-style: italic;">// ATR1.pdf</span>
  <span style="color: #000000; font-weight: bold;">if</span> <span style="color: #000066;">(</span>lReturn &lt;&gt; SCARD_S_SUCCESS<span style="color: #000066;">)</span> <span style="color: #000000; font-weight: bold;">or</span> <span style="color: #000066;">(</span>cbAtrLen&lt;&gt;<span style="color: #0000ff;">20</span><span style="color: #000066;">)</span> <span style="color: #000000; font-weight: bold;">then</span>
  <span style="color: #000000; font-weight: bold;">begin</span>
    Result<span style="color: #000066;">:</span><span style="color: #000066;">=</span> <span style="color: #000000; font-weight: bold;">FALSE</span><span style="color: #000066;">;</span>
    Exit<span style="color: #000066;">;</span>
  <span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">;</span>
  <span style="color: #000066;">GetMem</span><span style="color: #000066;">(</span>bAtr<span style="color: #000066;">,</span>cbAtrLen<span style="color: #000066;">)</span><span style="color: #000066;">;</span>
  <span style="color: #000000; font-weight: bold;">try</span>
    lReturn<span style="color: #000066;">:</span><span style="color: #000066;">=</span> SCardStatus<span style="color: #000066;">(</span>hCard<span style="color: #000066;">,</span> <span style="color: #000000; font-weight: bold;">nil</span><span style="color: #000066;">,</span><span style="color: #000000; font-weight: bold;">nil</span><span style="color: #000066;">,</span><span style="color: #000000; font-weight: bold;">nil</span><span style="color: #000066;">,</span><span style="color: #000000; font-weight: bold;">nil</span><span style="color: #000066;">,</span>LPBYTE<span style="color: #000066;">(</span>bAtr<span style="color: #000066;">)</span><span style="color: #000066;">,</span><span style="color: #000066;">@</span>cbAtrLen<span style="color: #000066;">)</span><span style="color: #000066;">;</span>
    <span style="color: #000000; font-weight: bold;">if</span> lReturn &lt;&gt; SCARD_S_SUCCESS <span style="color: #000000; font-weight: bold;">then</span>
    <span style="color: #000000; font-weight: bold;">begin</span>
      Result<span style="color: #000066;">:</span><span style="color: #000066;">=</span> <span style="color: #000000; font-weight: bold;">FALSE</span><span style="color: #000066;">;</span>
      Exit<span style="color: #000066;">;</span>
    <span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">;</span>
    <span style="color: #808080; font-style: italic;">// ATR1.pdf</span>
    Result<span style="color: #000066;">:</span><span style="color: #000066;">=</span>
      <span style="color: #000066;">(</span>bAtr<span style="color: #000066;">[</span>00<span style="color: #000066;">]</span><span style="color: #000066;">=</span><span style="color: #0000cc;">$3B</span><span style="color: #000066;">)</span> <span style="color: #000000; font-weight: bold;">and</span> <span style="color: #000066;">(</span>bAtr<span style="color: #000066;">[</span>01<span style="color: #000066;">]</span><span style="color: #000066;">=</span><span style="color: #0000cc;">$7F</span><span style="color: #000066;">)</span> <span style="color: #000000; font-weight: bold;">and</span> <span style="color: #000066;">(</span>bAtr<span style="color: #000066;">[</span>03<span style="color: #000066;">]</span><span style="color: #000066;">=</span><span style="color: #0000cc;">$00</span><span style="color: #000066;">)</span> <span style="color: #000000; font-weight: bold;">and</span> <span style="color: #000066;">(</span>bAtr<span style="color: #000066;">[</span>04<span style="color: #000066;">]</span><span style="color: #000066;">=</span><span style="color: #0000cc;">$00</span><span style="color: #000066;">)</span> <span style="color: #000000; font-weight: bold;">and</span>
      <span style="color: #000066;">(</span>bAtr<span style="color: #000066;">[</span>05<span style="color: #000066;">]</span><span style="color: #000066;">=</span><span style="color: #0000cc;">$00</span><span style="color: #000066;">)</span> <span style="color: #000000; font-weight: bold;">and</span> <span style="color: #000066;">(</span>bAtr<span style="color: #000066;">[</span>06<span style="color: #000066;">]</span><span style="color: #000066;">=</span><span style="color: #0000cc;">$6A</span><span style="color: #000066;">)</span> <span style="color: #000000; font-weight: bold;">and</span> <span style="color: #000066;">(</span>bAtr<span style="color: #000066;">[</span>07<span style="color: #000066;">]</span><span style="color: #000066;">=</span><span style="color: #0000cc;">$44</span><span style="color: #000066;">)</span> <span style="color: #000000; font-weight: bold;">and</span> <span style="color: #000066;">(</span>bAtr<span style="color: #000066;">[</span>08<span style="color: #000066;">]</span><span style="color: #000066;">=</span><span style="color: #0000cc;">$4E</span><span style="color: #000066;">)</span> <span style="color: #000000; font-weight: bold;">and</span>
      <span style="color: #000066;">(</span>bAtr<span style="color: #000066;">[</span>09<span style="color: #000066;">]</span><span style="color: #000066;">=</span><span style="color: #0000cc;">$49</span><span style="color: #000066;">)</span> <span style="color: #000000; font-weight: bold;">and</span> <span style="color: #000066;">(</span>bAtr<span style="color: #000066;">[</span><span style="color: #0000ff;">10</span><span style="color: #000066;">]</span><span style="color: #000066;">=</span><span style="color: #0000cc;">$65</span><span style="color: #000066;">)</span> <span style="color: #000000; font-weight: bold;">and</span> <span style="color: #000066;">(</span>bAtr<span style="color: #000066;">[</span><span style="color: #0000ff;">18</span><span style="color: #000066;">]</span><span style="color: #000066;">=</span><span style="color: #0000cc;">$90</span><span style="color: #000066;">)</span> <span style="color: #000000; font-weight: bold;">and</span> <span style="color: #000066;">(</span>bAtr<span style="color: #000066;">[</span><span style="color: #0000ff;">19</span><span style="color: #000066;">]</span><span style="color: #000066;">=</span><span style="color: #0000cc;">$00</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
  <span style="color: #000000; font-weight: bold;">finally</span>
    <span style="color: #000066;">FreeMem</span><span style="color: #000066;">(</span>bAtr<span style="color: #000066;">)</span><span style="color: #000066;">;</span>
  <span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">;</span>
<span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">;</span>
 
<span style="color: #808080; font-style: italic;">// Envia un comando a la tarjeta (iso_7816-4v2_0.pdf)</span>
<span style="color: #000000; font-weight: bold;">function</span> SendCmd<span style="color: #000066;">(</span>Card<span style="color: #000066;">:</span> SCARDHANDLE<span style="color: #000066;">;</span> Cmd<span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">AnsiString</span><span style="color: #000066;">;</span> Buffer<span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">PByte</span><span style="color: #000066;">;</span> <span style="color: #000000; font-weight: bold;">var</span> l<span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">DWORD</span><span style="color: #000066;">)</span><span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">Boolean</span><span style="color: #000066;">;</span>
<span style="color: #000000; font-weight: bold;">begin</span>
  Result<span style="color: #000066;">:</span><span style="color: #000066;">=</span> <span style="color: #000000; font-weight: bold;">FALSE</span><span style="color: #000066;">;</span>
  <span style="color: #000000; font-weight: bold;">if</span> SCardTransmit<span style="color: #000066;">(</span>Card<span style="color: #000066;">,</span> <span style="color: #000066;">@</span>SCARD_PCI_T0<span style="color: #000066;">,</span><span style="color: #000066; font-weight: bold;">PAnsiChar</span><span style="color: #000066;">(</span>Cmd<span style="color: #000066;">)</span><span style="color: #000066;">,</span><span style="color: #000066;">Length</span><span style="color: #000066;">(</span>Cmd<span style="color: #000066;">)</span><span style="color: #000066;">,</span> <span style="color: #000000; font-weight: bold;">nil</span><span style="color: #000066;">,</span>
    LPBYTE<span style="color: #000066;">(</span>Buffer<span style="color: #000066;">)</span><span style="color: #000066;">,</span> <span style="color: #000066;">@</span>l<span style="color: #000066;">)</span> <span style="color: #000066;">=</span> SCARD_S_SUCCESS <span style="color: #000000; font-weight: bold;">then</span>
    <span style="color: #000000; font-weight: bold;">if</span> l &gt;<span style="color: #000066;">=</span> <span style="color: #0000ff;">2</span> <span style="color: #000000; font-weight: bold;">then</span>
      Result<span style="color: #000066;">:</span><span style="color: #000066;">=</span> <span style="color: #000066;">(</span><span style="color: #000066; font-weight: bold;">PByteArray</span><span style="color: #000066;">(</span>Buffer<span style="color: #000066;">)</span><span style="color: #000066;">[</span>l<span style="color: #000066;">-</span><span style="color: #0000ff;">2</span><span style="color: #000066;">]</span> <span style="color: #000066;">=</span> <span style="color: #0000cc;">$61</span><span style="color: #000066;">)</span> <span style="color: #000000; font-weight: bold;">or</span>
        <span style="color: #000066;">(</span><span style="color: #000066;">(</span><span style="color: #000066; font-weight: bold;">PByteArray</span><span style="color: #000066;">(</span>Buffer<span style="color: #000066;">)</span><span style="color: #000066;">[</span>l<span style="color: #000066;">-</span><span style="color: #0000ff;">2</span><span style="color: #000066;">]</span> <span style="color: #000066;">=</span> <span style="color: #0000cc;">$90</span><span style="color: #000066;">)</span> <span style="color: #000000; font-weight: bold;">and</span> <span style="color: #000066;">(</span><span style="color: #000066; font-weight: bold;">PByteArray</span><span style="color: #000066;">(</span>Buffer<span style="color: #000066;">)</span><span style="color: #000066;">[</span>l<span style="color: #000066;">-</span><span style="color: #0000ff;">1</span><span style="color: #000066;">]</span> <span style="color: #000066;">=</span> <span style="color: #0000cc;">$00</span><span style="color: #000066;">)</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
<span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">;</span>
 
<span style="color: #808080; font-style: italic;">// obtiene_CDF.pdf</span>
<span style="color: #000000; font-weight: bold;">function</span> SCardReadFile<span style="color: #000066;">(</span>Card<span style="color: #000066;">:</span> SCARDHANDLE<span style="color: #000066;">;</span> Path<span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">AnsiString</span><span style="color: #000066;">;</span> Stream<span style="color: #000066;">:</span> TStream<span style="color: #000066;">)</span><span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">Boolean</span><span style="color: #000066;">;</span>
<span style="color: #000000; font-weight: bold;">var</span>
  Buffer<span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">PByte</span><span style="color: #000066;">;</span>
  l<span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">DWORD</span><span style="color: #000066;">;</span>
  Offset<span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">Word</span><span style="color: #000066;">;</span>
  Size<span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">Word</span><span style="color: #000066;">;</span>
<span style="color: #000000; font-weight: bold;">begin</span>
  Result<span style="color: #000066;">:</span><span style="color: #000066;">=</span> <span style="color: #000000; font-weight: bold;">FALSE</span><span style="color: #000066;">;</span>
  <span style="color: #000000; font-weight: bold;">if</span> <span style="color: #000066;">Odd</span><span style="color: #000066;">(</span><span style="color: #000066;">Length</span><span style="color: #000066;">(</span>Path<span style="color: #000066;">)</span><span style="color: #000066;">)</span> <span style="color: #000000; font-weight: bold;">then</span>
    Exit<span style="color: #000066;">;</span>
  <span style="color: #000066;">GetMem</span><span style="color: #000066;">(</span>Buffer<span style="color: #000066;">,</span><span style="color: #0000ff;">258</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
  <span style="color: #000000; font-weight: bold;">try</span>
    l<span style="color: #000066;">:</span><span style="color: #000066;">=</span> <span style="color: #0000ff;">258</span><span style="color: #000066;">;</span>
    <span style="color: #808080; font-style: italic;">// SELECT directorio raiz</span>
    <span style="color: #000000; font-weight: bold;">if</span> <span style="color: #000000; font-weight: bold;">not</span> SendCmd<span style="color: #000066;">(</span>Card<span style="color: #000066;">,</span>
      <span style="color: #ff0000;">#$00</span><span style="color: #ff0000;">#$a4</span><span style="color: #ff0000;">#$04</span><span style="color: #ff0000;">#$00</span><span style="color: #ff0000;">#$0b</span><span style="color: #ff0000;">#$4D</span><span style="color: #ff0000;">#$61</span><span style="color: #ff0000;">#$73</span><span style="color: #ff0000;">#$74</span><span style="color: #ff0000;">#$65</span><span style="color: #ff0000;">#$72</span><span style="color: #ff0000;">#$2E</span><span style="color: #ff0000;">#$46</span><span style="color: #ff0000;">#$69</span><span style="color: #ff0000;">#$6C</span><span style="color: #ff0000;">#$65</span><span style="color: #000066;">,</span>
      Buffer<span style="color: #000066;">,</span> l<span style="color: #000066;">)</span> <span style="color: #000000; font-weight: bold;">then</span> Exit<span style="color: #000066;">;</span>
    <span style="color: #808080; font-style: italic;">// Seguimos la ruta del fichero</span>
    <span style="color: #000000; font-weight: bold;">while</span> <span style="color: #000066;">Length</span><span style="color: #000066;">(</span>Path<span style="color: #000066;">)</span> &gt; <span style="color: #0000ff;">0</span> <span style="color: #000000; font-weight: bold;">do</span>
    <span style="color: #000000; font-weight: bold;">begin</span>
      l<span style="color: #000066;">:</span><span style="color: #000066;">=</span> <span style="color: #0000ff;">258</span><span style="color: #000066;">;</span>
      <span style="color: #808080; font-style: italic;">// SELECT</span>
      <span style="color: #000000; font-weight: bold;">if</span> <span style="color: #000000; font-weight: bold;">not</span> SendCmd<span style="color: #000066;">(</span>Card<span style="color: #000066;">,</span><span style="color: #ff0000;">#$00</span><span style="color: #ff0000;">#$A4</span><span style="color: #ff0000;">#$00</span><span style="color: #ff0000;">#$00</span><span style="color: #ff0000;">#$02</span> <span style="color: #000066;">+</span> <span style="color: #000066;">Copy</span><span style="color: #000066;">(</span>Path<span style="color: #000066;">,</span><span style="color: #0000ff;">1</span><span style="color: #000066;">,</span><span style="color: #0000ff;">2</span><span style="color: #000066;">)</span><span style="color: #000066;">,</span>
        Buffer<span style="color: #000066;">,</span> l<span style="color: #000066;">)</span> <span style="color: #000000; font-weight: bold;">then</span> Exit<span style="color: #000066;">;</span>
      <span style="color: #000066;">delete</span><span style="color: #000066;">(</span>Path<span style="color: #000066;">,</span><span style="color: #0000ff;">1</span><span style="color: #000066;">,</span><span style="color: #0000ff;">2</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
    <span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">;</span>
    l<span style="color: #000066;">:</span><span style="color: #000066;">=</span> <span style="color: #0000ff;">258</span><span style="color: #000066;">;</span>
    <span style="color: #808080; font-style: italic;">// GET RESPONSE</span>
    <span style="color: #000000; font-weight: bold;">if</span> <span style="color: #000000; font-weight: bold;">not</span> SendCmd<span style="color: #000066;">(</span>Card<span style="color: #000066;">,</span><span style="color: #ff0000;">#$00</span><span style="color: #ff0000;">#$C0</span><span style="color: #ff0000;">#$00</span><span style="color: #ff0000;">#$00</span><span style="color: #ff0000;">#$0E</span><span style="color: #000066;">,</span>Buffer<span style="color: #000066;">,</span> l<span style="color: #000066;">)</span> <span style="color: #000000; font-weight: bold;">then</span>
      Exit<span style="color: #000066;">;</span>
    <span style="color: #000000; font-weight: bold;">if</span> <span style="color: #000066;">(</span>l &lt;&gt; <span style="color: #0000cc;">$10</span><span style="color: #000066;">)</span> <span style="color: #000000; font-weight: bold;">or</span> <span style="color: #000066;">(</span><span style="color: #000066; font-weight: bold;">PByteArray</span><span style="color: #000066;">(</span>buffer<span style="color: #000066;">)</span><span style="color: #000066;">[</span><span style="color: #0000ff;">0</span><span style="color: #000066;">]</span> &lt;&gt; <span style="color: #0000cc;">$6F</span><span style="color: #000066;">)</span> <span style="color: #000000; font-weight: bold;">then</span>
      Exit<span style="color: #000066;">;</span>
    <span style="color: #808080; font-style: italic;">// Obtenemos el tamaño</span>
    Size<span style="color: #000066;">:</span><span style="color: #000066;">=</span> <span style="color: #000066;">(</span><span style="color: #000066; font-weight: bold;">PByteArray</span><span style="color: #000066;">(</span>buffer<span style="color: #000066;">)</span><span style="color: #000066;">[</span><span style="color: #0000ff;">7</span><span style="color: #000066;">]</span> <span style="color: #000066;">*</span> <span style="color: #0000cc;">$100</span><span style="color: #000066;">)</span> <span style="color: #000066;">+</span> <span style="color: #000066; font-weight: bold;">PByteArray</span><span style="color: #000066;">(</span>buffer<span style="color: #000066;">)</span><span style="color: #000066;">[</span><span style="color: #0000ff;">8</span><span style="color: #000066;">]</span><span style="color: #000066;">;</span>
    Offset<span style="color: #000066;">:</span><span style="color: #000066;">=</span> <span style="color: #0000ff;">0</span><span style="color: #000066;">;</span>
    <span style="color: #000000; font-weight: bold;">while</span> Offset &lt; Size <span style="color: #000000; font-weight: bold;">do</span>
    <span style="color: #000000; font-weight: bold;">begin</span>
      l<span style="color: #000066;">:</span><span style="color: #000066;">=</span> <span style="color: #0000ff;">258</span><span style="color: #000066;">;</span>
      <span style="color: #808080; font-style: italic;">// Leemos el fichero en bloques de hasta 255 bytes</span>
      <span style="color: #000000; font-weight: bold;">if</span> <span style="color: #000000; font-weight: bold;">not</span> SendCmd<span style="color: #000066;">(</span>Card<span style="color: #000066;">,</span><span style="color: #ff0000;">#$00</span><span style="color: #ff0000;">#$B0</span> <span style="color: #000066;">+</span> <span style="color: #000066; font-weight: bold;">AnsiChar</span><span style="color: #000066;">(</span><span style="color: #000066;">Hi</span><span style="color: #000066;">(</span>Offset<span style="color: #000066;">)</span><span style="color: #000066;">)</span> <span style="color: #000066;">+</span> <span style="color: #000066; font-weight: bold;">AnsiChar</span><span style="color: #000066;">(</span><span style="color: #000066;">Lo</span><span style="color: #000066;">(</span>Offset<span style="color: #000066;">)</span><span style="color: #000066;">)</span>
        <span style="color: #000066;">+</span> <span style="color: #000066; font-weight: bold;">Char</span><span style="color: #000066;">(</span><span style="color: #000066;">Min</span><span style="color: #000066;">(</span>Size<span style="color: #000066;">-</span>Offset<span style="color: #000066;">,</span><span style="color: #0000cc;">$FF</span><span style="color: #000066;">)</span><span style="color: #000066;">)</span><span style="color: #000066;">,</span> Buffer<span style="color: #000066;">,</span> l<span style="color: #000066;">)</span> <span style="color: #000000; font-weight: bold;">then</span> Exit<span style="color: #000066;">;</span>
      <span style="color: #000000; font-weight: bold;">if</span> l &gt; <span style="color: #0000ff;">2</span> <span style="color: #000000; font-weight: bold;">then</span>
        Stream<span style="color: #000066;">.</span><span style="color: #000000; font-weight: bold;">Write</span><span style="color: #000066;">(</span>Buffer<span style="color: #000066;">^</span><span style="color: #000066;">,</span>l<span style="color: #000066;">-</span><span style="color: #0000ff;">2</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
      <span style="color: #000066;">inc</span><span style="color: #000066;">(</span>Offset<span style="color: #000066;">,</span><span style="color: #0000cc;">$FF</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
    <span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">;</span>
    Result<span style="color: #000066;">:</span><span style="color: #000066;">=</span> <span style="color: #000000; font-weight: bold;">TRUE</span><span style="color: #000066;">;</span>
  <span style="color: #000000; font-weight: bold;">finally</span>
    <span style="color: #000066;">FreeMem</span><span style="color: #000066;">(</span>Buffer<span style="color: #000066;">)</span><span style="color: #000066;">;</span>
  <span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">;</span>
<span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">;</span>
 
<span style="color: #000000; font-weight: bold;">var</span>
  hContext<span style="color: #000066;">:</span> SCARDCONTEXT<span style="color: #000066;">;</span>
  pmszReaders<span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">PAnsiChar</span><span style="color: #000066;">;</span>
  pReader<span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">PAnsiChar</span><span style="color: #000066;">;</span>
  cchReaders<span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">DWORD</span><span style="color: #000066;">;</span>
  lReturn<span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">Longint</span><span style="color: #000066;">;</span>
  Card<span style="color: #000066;">:</span> SCARDHANDLE<span style="color: #000066;">;</span>
  ActiveProtocol<span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">DWORD</span><span style="color: #000066;">;</span>
  Stream<span style="color: #000066;">:</span> TMemoryStream<span style="color: #000066;">;</span>
<span style="color: #000000; font-weight: bold;">begin</span>
  lReturn<span style="color: #000066;">:</span><span style="color: #000066;">=</span> SCardEstablishContext<span style="color: #000066;">(</span>SCARD_SCOPE_SYSTEM<span style="color: #000066;">,</span><span style="color: #000000; font-weight: bold;">nil</span><span style="color: #000066;">,</span><span style="color: #000000; font-weight: bold;">nil</span><span style="color: #000066;">,</span><span style="color: #000066;">@</span>hContext<span style="color: #000066;">)</span><span style="color: #000066;">;</span>
  <span style="color: #000000; font-weight: bold;">if</span> lReturn <span style="color: #000066;">=</span> SCARD_S_SUCCESS <span style="color: #000000; font-weight: bold;">then</span>
  <span style="color: #000000; font-weight: bold;">try</span>
    cchReaders<span style="color: #000066;">:</span><span style="color: #000066;">=</span> SCARD_AUTOALLOCATE<span style="color: #000066;">;</span>
    <span style="color: #808080; font-style: italic;">// Obtenemos una lista con todos los lectores</span>
    lReturn<span style="color: #000066;">:</span><span style="color: #000066;">=</span> SCardListReaders<span style="color: #000066;">(</span>hContext<span style="color: #000066;">,</span><span style="color: #000000; font-weight: bold;">nil</span><span style="color: #000066;">,</span><span style="color: #000066;">@</span>pmszReaders<span style="color: #000066;">,</span><span style="color: #000066;">@</span>cchReaders<span style="color: #000066;">)</span><span style="color: #000066;">;</span>
    <span style="color: #000000; font-weight: bold;">if</span> lReturn <span style="color: #000066;">=</span> SCARD_S_SUCCESS <span style="color: #000000; font-weight: bold;">then</span>
    <span style="color: #000000; font-weight: bold;">begin</span>
      pReader<span style="color: #000066;">:</span><span style="color: #000066;">=</span> pmszReaders<span style="color: #000066;">;</span>
      <span style="color: #808080; font-style: italic;">// Intentamos conectarnos a cada uno de los lectores de la lista</span>
      <span style="color: #000000; font-weight: bold;">while</span> <span style="color: #000066;">(</span>pReader<span style="color: #000066;">^</span> &lt;&gt; <span style="color: #ff0000;">#0</span><span style="color: #000066;">)</span> <span style="color: #000000; font-weight: bold;">do</span>
      <span style="color: #000000; font-weight: bold;">begin</span>
        lReturn<span style="color: #000066;">:</span><span style="color: #000066;">=</span> SCardConnect<span style="color: #000066;">(</span>hContext<span style="color: #000066;">,</span> pReader<span style="color: #000066;">,</span> SCARD_SHARE_SHARED<span style="color: #000066;">,</span>
          SCARD_PROTOCOL_T0<span style="color: #000066;">,</span> <span style="color: #000066;">@</span>Card<span style="color: #000066;">,</span> <span style="color: #000066;">@</span>ActiveProtocol<span style="color: #000066;">)</span><span style="color: #000066;">;</span>
        <span style="color: #000000; font-weight: bold;">if</span> lReturn <span style="color: #000066;">=</span> SCARD_S_SUCCESS <span style="color: #000000; font-weight: bold;">then</span>
        <span style="color: #000000; font-weight: bold;">begin</span>
          <span style="color: #808080; font-style: italic;">// Comprobamos si la tarjeta insertada es un DNIe</span>
          <span style="color: #000000; font-weight: bold;">if</span> isDNIe<span style="color: #000066;">(</span>Card<span style="color: #000066;">)</span> <span style="color: #000000; font-weight: bold;">then</span>
          <span style="color: #000000; font-weight: bold;">begin</span>
            <span style="color: #000066;">Writeln</span><span style="color: #000066;">(</span><span style="color: #ff0000;">'DNIe Encontrado'</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
            Writeln<span style="color: #000066;">;</span>
            Stream<span style="color: #000066;">:</span><span style="color: #000066;">=</span> TMemoryStream<span style="color: #000066;">.</span><span style="color: #006600;">Create</span><span style="color: #000066;">;</span>
            <span style="color: #000000; font-weight: bold;">try</span>
              <span style="color: #808080; font-style: italic;">// Leemos el IDESP con la ruta 0006</span>
              <span style="color: #000000; font-weight: bold;">if</span> SCardReadFile<span style="color: #000066;">(</span>Card<span style="color: #000066;">,</span><span style="color: #ff0000;">#$00</span><span style="color: #ff0000;">#$06</span><span style="color: #000066;">,</span>Stream<span style="color: #000066;">)</span> <span style="color: #000000; font-weight: bold;">then</span>
              <span style="color: #000000; font-weight: bold;">begin</span>
                <span style="color: #000066;">Writeln</span><span style="color: #000066;">(</span><span style="color: #ff0000;">'IDESP (0006):'</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
                WriteHex<span style="color: #000066;">(</span>Stream<span style="color: #000066;">.</span><span style="color: #006600;">Memory</span><span style="color: #000066;">,</span>Stream<span style="color: #000066;">.</span><span style="color: #006600;">Size</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
                Writeln<span style="color: #000066;">;</span>
              <span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">;</span>
              Stream<span style="color: #000066;">.</span><span style="color: #006600;">Clear</span><span style="color: #000066;">;</span>
              <span style="color: #808080; font-style: italic;">// Leemos la version con la ruta 2F03</span>
              <span style="color: #000000; font-weight: bold;">if</span> SCardReadFile<span style="color: #000066;">(</span>Card<span style="color: #000066;">,</span><span style="color: #ff0000;">#$2F</span><span style="color: #ff0000;">#$03</span><span style="color: #000066;">,</span>Stream<span style="color: #000066;">)</span> <span style="color: #000000; font-weight: bold;">then</span>
              <span style="color: #000000; font-weight: bold;">begin</span>
                <span style="color: #000066;">Writeln</span><span style="color: #000066;">(</span><span style="color: #ff0000;">'Version (2F03):'</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
                WriteHex<span style="color: #000066;">(</span>Stream<span style="color: #000066;">.</span><span style="color: #006600;">Memory</span><span style="color: #000066;">,</span>Stream<span style="color: #000066;">.</span><span style="color: #006600;">Size</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
                Writeln<span style="color: #000066;">;</span>
              <span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">;</span>
              Stream<span style="color: #000066;">.</span><span style="color: #006600;">Clear</span><span style="color: #000066;">;</span>
              <span style="color: #808080; font-style: italic;">// Leemos el CDF con la ruta 50156004</span>
              <span style="color: #000000; font-weight: bold;">if</span> SCardReadFile<span style="color: #000066;">(</span>Card<span style="color: #000066;">,</span><span style="color: #ff0000;">#$50</span><span style="color: #ff0000;">#$15</span><span style="color: #ff0000;">#$60</span><span style="color: #ff0000;">#$04</span><span style="color: #000066;">,</span>Stream<span style="color: #000066;">)</span> <span style="color: #000000; font-weight: bold;">then</span>
              <span style="color: #000000; font-weight: bold;">begin</span>
                <span style="color: #000066;">Writeln</span><span style="color: #000066;">(</span><span style="color: #ff0000;">'CDF (50156004):'</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
                WriteHex<span style="color: #000066;">(</span>Stream<span style="color: #000066;">.</span><span style="color: #006600;">Memory</span><span style="color: #000066;">,</span>Stream<span style="color: #000066;">.</span><span style="color: #006600;">Size</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
                Writeln<span style="color: #000066;">;</span>
              <span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">;</span>
            <span style="color: #000000; font-weight: bold;">finally</span>
              Stream<span style="color: #000066;">.</span><span style="color: #006600;">Free</span><span style="color: #000066;">;</span>
            <span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">;</span>
            SCardDisconnect<span style="color: #000066;">(</span>Card<span style="color: #000066;">,</span>SCARD_RESET_CARD<span style="color: #000066;">)</span><span style="color: #000066;">;</span>
            break<span style="color: #000066;">;</span>
          <span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">;</span>
          SCardDisconnect<span style="color: #000066;">(</span>Card<span style="color: #000066;">,</span>SCARD_RESET_CARD<span style="color: #000066;">)</span><span style="color: #000066;">;</span>
        <span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">;</span>
        pReader<span style="color: #000066;">:</span><span style="color: #000066;">=</span> pReader <span style="color: #000066;">+</span> <span style="color: #000066;">StrLen</span><span style="color: #000066;">(</span>pReader<span style="color: #000066;">)</span> <span style="color: #000066;">+</span> <span style="color: #0000ff;">1</span><span style="color: #000066;">;</span>
      <span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">;</span>
      SCardFreeMemory<span style="color: #000066;">(</span>hContext<span style="color: #000066;">,</span>pmszReaders<span style="color: #000066;">)</span><span style="color: #000066;">;</span>
    <span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">;</span>
  <span style="color: #000000; font-weight: bold;">finally</span>
    SCardReleaseContext<span style="color: #000066;">(</span>hContext<span style="color: #000066;">)</span><span style="color: #000066;">;</span>
  <span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">;</span>
  <span style="color: #000066;">Writeln</span><span style="color: #000066;">(</span><span style="color: #ff0000;">'Adios!'</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
<span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">.</span></pre></div>
<p>La unit WinSCard.pas la cree para importar algunas funciones y constantes de la API</p>
<div class="geshifilter">
<pre class="delphi geshifilter-delphi" style="font-family:monospace;"><span style="color: #000000; font-weight: bold;">unit</span> WinSCard<span style="color: #000066;">;</span>
 
<span style="color: #000000; font-weight: bold;">interface</span>
 
<span style="color: #000000; font-weight: bold;">uses</span> Windows<span style="color: #000066;">,</span> Sysutils<span style="color: #000066;">;</span>
 
<span style="color: #000000; font-weight: bold;">type</span>
  SCARDHANDLE   <span style="color: #000066;">=</span> ULONG<span style="color: #000066;">;</span>
  PSCARDHANDLE  <span style="color: #000066;">=</span> <span style="color: #000066;">^</span>SCARDHANDLE<span style="color: #000066;">;</span>
  LPSCARDHANDLE <span style="color: #000066;">=</span> PSCARDHANDLE<span style="color: #000066;">;</span>
 
  SCARDCONTEXT   <span style="color: #000066;">=</span> ULONG<span style="color: #000066;">;</span>
  PSCARDCONTEXT  <span style="color: #000066;">=</span> <span style="color: #000066;">^</span>SCARDCONTEXT<span style="color: #000066;">;</span>
  LPSCARDCONTEXT <span style="color: #000066;">=</span> PSCARDCONTEXT<span style="color: #000066;">;</span>
 
  LPBYTE <span style="color: #000066;">=</span> <span style="color: #000066;">^</span>BYTE<span style="color: #000066;">;</span>
 
  SCARD_IO_REQUEST <span style="color: #000066;">=</span> <span style="color: #000000; font-weight: bold;">record</span>
    dwProtocol<span style="color: #000066;">:</span> ULONG<span style="color: #000066;">;</span>
    cbPciLength<span style="color: #000066;">:</span> ULONG<span style="color: #000066;">;</span>
  <span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">;</span>
  PSCARD_IO_REQUEST <span style="color: #000066;">=</span> <span style="color: #000066;">^</span>SCARD_IO_REQUEST<span style="color: #000066;">;</span>
  LPSCARD_IO_REQUEST <span style="color: #000066;">=</span> PSCARD_IO_REQUEST<span style="color: #000066;">;</span>
  LPCSCARD_IO_REQUEST <span style="color: #000066;">=</span> PSCARD_IO_REQUEST<span style="color: #000066;">;</span>
 
<span style="color: #000000; font-weight: bold;">const</span>
  WinSCard_dll <span style="color: #000066;">=</span> <span style="color: #ff0000;">'Winscard.dll'</span><span style="color: #000066;">;</span>
 
  MAX_ATR_SIZE <span style="color: #000066;">=</span> <span style="color: #0000ff;">3</span><span style="color: #000066;">;</span>
 
  SCARD_PROTOCOL_T0	<span style="color: #000066;">=</span> <span style="color: #0000cc;">$0001</span><span style="color: #000066;">;</span>
  SCARD_PROTOCOL_T1 <span style="color: #000066;">=</span> <span style="color: #0000cc;">$0002</span><span style="color: #000066;">;</span>
  SCARD_PROTOCOL_RAW <span style="color: #000066;">=</span> <span style="color: #0000cc;">$0004</span><span style="color: #000066;">;</span>
 
  SCARD_STATE_UNAWARE <span style="color: #000066;">=</span> <span style="color: #0000cc;">$0000</span><span style="color: #000066;">;</span>
  SCARD_STATE_IGNORE <span style="color: #000066;">=</span> <span style="color: #0000cc;">$0001</span><span style="color: #000066;">;</span>
  SCARD_STATE_CHANGED <span style="color: #000066;">=</span> <span style="color: #0000cc;">$0002</span><span style="color: #000066;">;</span>
  SCARD_STATE_UNKNOWN <span style="color: #000066;">=</span> <span style="color: #0000cc;">$0004</span><span style="color: #000066;">;</span>
  SCARD_STATE_UNAVAILABLE <span style="color: #000066;">=</span> <span style="color: #0000cc;">$0008</span><span style="color: #000066;">;</span>
  SCARD_STATE_EMPTY <span style="color: #000066;">=</span> <span style="color: #0000cc;">$0010</span><span style="color: #000066;">;</span>
  SCARD_STATE_PRESENT <span style="color: #000066;">=</span> <span style="color: #0000cc;">$0020</span><span style="color: #000066;">;</span>
  SCARD_STATE_EXCLUSIVE <span style="color: #000066;">=</span> <span style="color: #0000cc;">$0080</span><span style="color: #000066;">;</span>
  SCARD_STATE_INUSE <span style="color: #000066;">=</span> <span style="color: #0000cc;">$0100</span><span style="color: #000066;">;</span>
  SCARD_STATE_MUTE <span style="color: #000066;">=</span> <span style="color: #0000cc;">$0200</span><span style="color: #000066;">;</span>
  SCARD_STATE_UNPOWERED <span style="color: #000066;">=</span> <span style="color: #0000cc;">$0400</span><span style="color: #000066;">;</span>
 
 
  SCARD_SHARE_EXCLUSIVE <span style="color: #000066;">=</span> <span style="color: #0000cc;">$0001</span><span style="color: #000066;">;</span>
  SCARD_SHARE_SHARED <span style="color: #000066;">=</span> <span style="color: #0000cc;">$0002</span><span style="color: #000066;">;</span>
  SCARD_SHARE_DIRECT <span style="color: #000066;">=</span> <span style="color: #0000cc;">$0003</span><span style="color: #000066;">;</span>
 
  SCARD_LEAVE_CARD <span style="color: #000066;">=</span> <span style="color: #0000cc;">$0000</span><span style="color: #000066;">;</span>
  SCARD_RESET_CARD <span style="color: #000066;">=</span> <span style="color: #0000cc;">$0001</span><span style="color: #000066;">;</span>
  SCARD_UNPOWER_CARD <span style="color: #000066;">=</span> <span style="color: #0000cc;">$0002</span><span style="color: #000066;">;</span>
 
  SCARD_AUTOALLOCATE <span style="color: #000066;">=</span> <span style="color: #000066; font-weight: bold;">DWORD</span><span style="color: #000066;">(</span><span style="color: #000066;">-</span><span style="color: #0000ff;">1</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
 
  SCARD_SCOPE_USER <span style="color: #000066;">=</span> <span style="color: #0000ff;">0</span><span style="color: #000066;">;</span>
  SCARD_SCOPE_TERMINAL <span style="color: #000066;">=</span> <span style="color: #0000ff;">1</span><span style="color: #000066;">;</span>
  SCARD_SCOPE_SYSTEM <span style="color: #000066;">=</span> <span style="color: #0000ff;">2</span><span style="color: #000066;">;</span>
 
  SCARD_PCI_T0<span style="color: #000066;">:</span> SCARD_IO_REQUEST <span style="color: #000066;">=</span>
    <span style="color: #000066;">(</span>dwProtocol<span style="color: #000066;">:</span> SCARD_PROTOCOL_T0<span style="color: #000066;">;</span> cbPciLength<span style="color: #000066;">:</span> <span style="color: #000066;">SizeOf</span><span style="color: #000066;">(</span>SCARD_IO_REQUEST<span style="color: #000066;">)</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
  SCARD_PCI_T1<span style="color: #000066;">:</span> SCARD_IO_REQUEST <span style="color: #000066;">=</span>
    <span style="color: #000066;">(</span>dwProtocol<span style="color: #000066;">:</span> SCARD_PROTOCOL_T1<span style="color: #000066;">;</span> cbPciLength<span style="color: #000066;">:</span> <span style="color: #000066;">SizeOf</span><span style="color: #000066;">(</span>SCARD_IO_REQUEST<span style="color: #000066;">)</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
  SCARD_PCI_RAW<span style="color: #000066;">:</span> SCARD_IO_REQUEST <span style="color: #000066;">=</span>
    <span style="color: #000066;">(</span>dwProtocol<span style="color: #000066;">:</span> SCARD_PROTOCOL_RAW<span style="color: #000066;">;</span> cbPciLength<span style="color: #000066;">:</span> <span style="color: #000066;">SizeOf</span><span style="color: #000066;">(</span>SCARD_IO_REQUEST<span style="color: #000066;">)</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
 
  SCARD_S_SUCCESS	 <span style="color: #000066;">=</span> <span style="color: #0000cc;">$00000000</span><span style="color: #000066;">;</span>
  SCARD_E_CANCELLED <span style="color: #000066;">=</span> <span style="color: #0000cc;">$80100002</span><span style="color: #000066;">;</span>
  SCARD_E_INVALID_HANDLE <span style="color: #000066;">=</span> <span style="color: #0000cc;">$80100003</span><span style="color: #000066;">;</span>
  SCARD_E_INVALID_PARAMETER <span style="color: #000066;">=</span> <span style="color: #0000cc;">$80100004</span><span style="color: #000066;">;</span>
  SCARD_E_TIMEOUT	 <span style="color: #000066;">=</span> <span style="color: #0000cc;">$8010000A</span><span style="color: #000066;">;</span>
  SCARD_E_SHARING_VIOLATION	<span style="color: #000066;">=</span> <span style="color: #0000cc;">$8010000B</span><span style="color: #000066;">;</span>
  SCARD_E_NO_SMARTCARD <span style="color: #000066;">=</span> <span style="color: #0000cc;">$8010000C</span><span style="color: #000066;">;</span>
  SCARD_E_PROTO_MISMATCH <span style="color: #000066;">=</span> <span style="color: #0000cc;">$8010000F</span><span style="color: #000066;">;</span>
  SCARD_E_NOT_TRANSACTED <span style="color: #000066;">=</span> <span style="color: #0000cc;">$80100016</span><span style="color: #000066;">;</span>
  SCARD_E_READER_UNAVAILABLE <span style="color: #000066;">=</span> <span style="color: #0000cc;">$8010001</span><span style="color: #000066;">;</span>
  SCARD_E_NO_SERVICE <span style="color: #000066;">=</span> <span style="color: #0000cc;">$8010001D</span><span style="color: #000066;">;</span>
  SCARD_E_NO_READERS_AVAILABLE <span style="color: #000066;">=</span> <span style="color: #0000cc;">$8010002E</span><span style="color: #000066;">;</span>
  SCARD_W_UNRESPONSIVE_CARD <span style="color: #000066;">=</span> <span style="color: #0000cc;">$80100066</span><span style="color: #000066;">;</span>
  SCARD_W_UNPOWERED_CARD <span style="color: #000066;">=</span> <span style="color: #0000cc;">$80100067</span><span style="color: #000066;">;</span>
  SCARD_W_RESET_CARD <span style="color: #000066;">=</span> <span style="color: #0000cc;">$80100068</span><span style="color: #000066;">;</span>
  SCARD_W_REMOVED_CARD <span style="color: #000066;">=</span> <span style="color: #0000cc;">$80100069</span><span style="color: #000066;">;</span>
 
 
<span style="color: #000000; font-weight: bold;">function</span> SCardEstablishContext<span style="color: #000066;">(</span>dwScope<span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">DWORD</span><span style="color: #000066;">;</span> pvReserved1<span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">Pointer</span><span style="color: #000066;">;</span>
  pvReserved2<span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">Pointer</span><span style="color: #000066;">;</span> phContext<span style="color: #000066;">:</span> LPSCARDCONTEXT<span style="color: #000066;">)</span><span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">Longint</span><span style="color: #000066;">;</span> <span style="color: #000000; font-weight: bold;">stdcall</span><span style="color: #000066;">;</span>
  <span style="color: #000000; font-weight: bold;">external</span> WinSCard_dll<span style="color: #000066;">;</span>
 
<span style="color: #000000; font-weight: bold;">function</span> SCardReleaseContext<span style="color: #000066;">(</span>hContext<span style="color: #000066;">:</span> SCARDCONTEXT<span style="color: #000066;">)</span><span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">Longint</span><span style="color: #000066;">;</span> <span style="color: #000000; font-weight: bold;">stdcall</span><span style="color: #000066;">;</span>
  <span style="color: #000000; font-weight: bold;">external</span> WinSCard_dll<span style="color: #000066;">;</span>
 
<span style="color: #000000; font-weight: bold;">function</span> SCardListReaders<span style="color: #000066;">(</span>hContext<span style="color: #000066;">:</span> SCARDCONTEXT<span style="color: #000066;">;</span> mszGroups<span style="color: #000066;">:</span> LPCTSTR<span style="color: #000066;">;</span>
  mszReaders<span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">Pointer</span><span style="color: #000066;">;</span> pcchReaders<span style="color: #000066;">:</span> LPDWORD<span style="color: #000066;">)</span><span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">Longint</span><span style="color: #000066;">;</span> <span style="color: #000000; font-weight: bold;">stdcall</span><span style="color: #000066;">;</span>
  <span style="color: #000000; font-weight: bold;">external</span> WinSCard_dll name <span style="color: #ff0000;">'SCardListReadersA'</span><span style="color: #000066;">;</span>  <span style="color: #808080; font-style: italic;">// (ANSI)</span>
 
<span style="color: #000000; font-weight: bold;">function</span> SCardFreeMemory<span style="color: #000066;">(</span>hContext<span style="color: #000066;">:</span> SCARDCONTEXT<span style="color: #000066;">;</span> pvMem<span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">Pointer</span><span style="color: #000066;">)</span><span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">Longint</span><span style="color: #000066;">;</span>
  <span style="color: #000000; font-weight: bold;">stdcall</span><span style="color: #000066;">;</span> <span style="color: #000000; font-weight: bold;">external</span> WinSCard_dll<span style="color: #000066;">;</span>
 
<span style="color: #000000; font-weight: bold;">function</span> SCardConnect<span style="color: #000066;">(</span>hContext<span style="color: #000066;">:</span> SCARDCONTEXT<span style="color: #000066;">;</span> szReader<span style="color: #000066;">:</span> LPCTSTR<span style="color: #000066;">;</span>
  dwShareMode<span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">DWORD</span><span style="color: #000066;">;</span> dwPreferredProtocols<span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">DWORD</span><span style="color: #000066;">;</span> phCard<span style="color: #000066;">:</span> LPSCARDHANDLE<span style="color: #000066;">;</span>
  pdwActiveProtocol<span style="color: #000066;">:</span> LPDWORD<span style="color: #000066;">)</span><span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">Longint</span><span style="color: #000066;">;</span> <span style="color: #000000; font-weight: bold;">stdcall</span><span style="color: #000066;">;</span>
  <span style="color: #000000; font-weight: bold;">external</span> WinSCard_dll name <span style="color: #ff0000;">'SCardConnectA'</span><span style="color: #000066;">;</span>  <span style="color: #808080; font-style: italic;">// (ANSI)</span>
 
<span style="color: #000000; font-weight: bold;">function</span> SCardDisconnect<span style="color: #000066;">(</span>hCard<span style="color: #000066;">:</span> SCARDHANDLE<span style="color: #000066;">;</span> dwDisposition<span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">DWORD</span><span style="color: #000066;">)</span><span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">Longint</span><span style="color: #000066;">;</span>
  <span style="color: #000000; font-weight: bold;">stdcall</span><span style="color: #000066;">;</span> <span style="color: #000000; font-weight: bold;">external</span> WinSCard_dll<span style="color: #000066;">;</span>
 
<span style="color: #000000; font-weight: bold;">function</span> SCardStatus<span style="color: #000066;">(</span>hCard<span style="color: #000066;">:</span> SCARDHANDLE<span style="color: #000066;">;</span> szReaderName<span style="color: #000066;">:</span> LPTSTR<span style="color: #000066;">;</span>
  pcchReaderLen<span style="color: #000066;">:</span> LPDWORD<span style="color: #000066;">;</span> pdwState<span style="color: #000066;">:</span> LPDWORD<span style="color: #000066;">;</span> pdwProtocol<span style="color: #000066;">:</span> LPDWORD<span style="color: #000066;">;</span>
  pbAtr<span style="color: #000066;">:</span> LPBYTE<span style="color: #000066;">;</span> pcbAtrLen<span style="color: #000066;">:</span> LPDWORD<span style="color: #000066;">)</span><span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">Longint</span><span style="color: #000066;">;</span> <span style="color: #000000; font-weight: bold;">stdcall</span><span style="color: #000066;">;</span>
  <span style="color: #000000; font-weight: bold;">external</span> WinSCard_dll name <span style="color: #ff0000;">'SCardStatusA'</span><span style="color: #000066;">;</span>  <span style="color: #808080; font-style: italic;">// (ANSI)</span>
 
<span style="color: #000000; font-weight: bold;">function</span> SCardTransmit<span style="color: #000066;">(</span>hCard<span style="color: #000066;">:</span> SCARDHANDLE<span style="color: #000066;">;</span> pioSendPci<span style="color: #000066;">:</span> LPCSCARD_IO_REQUEST<span style="color: #000066;">;</span>
  pbSendBuffer<span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">Pointer</span><span style="color: #000066;">;</span> cbSendLength<span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">DWORD</span><span style="color: #000066;">;</span> pioRecvPci<span style="color: #000066;">:</span> LPSCARD_IO_REQUEST<span style="color: #000066;">;</span>
  pbRecvBuffer<span style="color: #000066;">:</span> LPBYTE<span style="color: #000066;">;</span> pcbRecvLength<span style="color: #000066;">:</span> LPDWORD<span style="color: #000066;">)</span><span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">Longint</span><span style="color: #000066;">;</span>
  <span style="color: #000000; font-weight: bold;">stdcall</span><span style="color: #000066;">;</span> <span style="color: #000000; font-weight: bold;">external</span> WinSCard_dll<span style="color: #000066;">;</span>
 
<span style="color: #000000; font-weight: bold;">implementation</span>
 
<span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">.</span></pre></div>
<p>El código fuente completo, la unit WinSCard y el programa ya compilado lo puedes bajar de  <a href="/sites/delphi.jmrds.com/adjuntos/DNIeReader.zip">aquí</a></p>
<p>Para saber más:<br /><a href="http://www.dnielectronico.es/PDFs/ATR1.pdf">http://www.dnielectronico.es/PDFs/ATR1.pdf</a><br /><a href="http://www.dnie.es/PDFs/obtiene_CDF.pdf">http://www.dnie.es/PDFs/obtiene_CDF.pdf</a><br /><a href="https://zonatic.usatudni.es/es/aprendizaje/aprende-sobre-el-dnie/58-desarrolla-con-el-dni-electronico/219-desarrollar-con-winscard.html">https://zonatic.usatudni.es/es/aprendizaje/aprende-sobre-el-dnie/58-desa...</a><br /><a href="http://blog.48bits.com/2010/03/16/analisis-de-la-estructura-interna-del-dni-e/">http://blog.48bits.com/2010/03/16/analisis-de-la-estructura-interna-del-...</a><br /><a href="http://opendnie.morfeo-project.org/wiki/index.php/Documentacion_DNIe_Estructura">http://opendnie.morfeo-project.org/wiki/index.php/Documentacion_DNIe_Est...</a><br /><a href="http://opendnie.cenatic.es/wiki/index.php/Documentacion_DNIe_Comandos">http://opendnie.cenatic.es/wiki/index.php/Documentacion_DNIe_Comandos</a></p>
</div></div></div>    <footer>
        <ul class="links list-inline"><li class="comment_forbidden first last"></li>
</ul>  </footer>
    <div id="comments" class="comment-wrapper">
          <h2 class="title">Comentarios</h2>
      
  <a id="comment-924"></a>
<div class="comment comment-by-anonymous clearfix" about="/comment/924#comment-924" typeof="sioc:Post sioct:Comment">
  
  
    <h3 property="dc:title" datatype=""><a style="display: none;" href="/comment/924#comment-924" class="permalink" rel="bookmark">Hola, estoy intentando</a></h3>
  
  <div class="submitted">
    <a style="display: none;" href="/comment/924#comment-924" class="permalink" rel="bookmark">Enlace permanente</a>    <span property="dc:date dc:created" content="2012-05-28T14:17:27+02:00" datatype="xsd:dateTime" rel="sioc:has_creator">Enviado por <span class="username" xml:lang="" typeof="sioc:UserAccount" property="foaf:name" datatype="">Antonio Garcia (no verificado)</span> el Lun, 05/28/2012 - 14:17</span>  </div>

  <div class="content">
    <span rel="sioc:reply_of" resource="/node/78" class="rdf-meta element-hidden"></span><div class="field field-name-comment-body field-type-text-long field-label-hidden"><div class="field-items"><div class="field-item even" property="content:encoded"><p>Hola, estoy intentando ejecutar tu programa en Delphi Xe2 pero no me va, en primer lugar me salen dos errores de compilacion en pmszReaders: PAnsiChar y pReader: PAnsiChar me dice E2010 Incompatible types - PwideChar and Pansichar, así que lo que he hecho es cambiar la deficnión de PAnsiChar por PWideChar y ya me ha compilado, no se si es una barbaridad....</p>
<p>y ahora al probar el programa, el lector me lo detecta, pero en la función SCardConnect me devuelve el valor 1117....</p>
<p>Alguna idea?</p>
<p>Gracias.</p>
</div></div></div>      </div>

  <ul class="links list-inline"><li class="comment_forbidden first last"></li>
</ul></div>

<div class="indented"><a id="comment-925"></a>
<div class="comment comment-by-node-author clearfix" about="/comment/925#comment-925" typeof="sioc:Post sioct:Comment">
  
  
    <h3 property="dc:title" datatype=""><a style="display: none;" href="/comment/925#comment-925" class="permalink" rel="bookmark">El error en que linea</a></h3>
  
  <div class="submitted">
    <a style="display: none;" href="/comment/925#comment-925" class="permalink" rel="bookmark">Enlace permanente</a>    <span property="dc:date dc:created" content="2012-05-28T18:27:00+02:00" datatype="xsd:dateTime" rel="sioc:has_creator">Enviado por <span class="username" xml:lang="" about="/user/1" typeof="sioc:UserAccount" property="foaf:name" datatype="">admin</span> el Lun, 05/28/2012 - 18:27</span>  </div>

  <div class="content">
    <span rel="sioc:reply_of" resource="/node/78" class="rdf-meta element-hidden"></span><span rel="sioc:reply_of" resource="/comment/924#comment-924" class="rdf-meta element-hidden"></span><div class="field field-name-comment-body field-type-text-long field-label-hidden"><div class="field-items"><div class="field-item even" property="content:encoded"><p>El error ¿en que linea exactamente te da? </p>
<p>Si es aqui:</p>
<div class="geshifilter">
<pre class="delphi geshifilter-delphi" style="font-family:monospace;">pReader<span style="color: #000066;">^</span> &lt;&gt; <span style="color: #ff0000;">#0</span></pre></div>
<p>prueba con esto:</p>
<div class="geshifilter">
<pre class="delphi geshifilter-delphi" style="font-family:monospace;">pReader<span style="color: #000066;">^</span> &lt;&gt; <span style="color: #000066; font-weight: bold;">AnsiChar</span><span style="color: #000066;">(</span><span style="color: #ff0000;">#0</span><span style="color: #000066;">)</span></pre></div>
<p>o con esto:</p>
<div class="geshifilter">
<pre class="delphi geshifilter-delphi" style="font-family:monospace;"><span style="color: #000066; font-weight: bold;">Byte</span><span style="color: #000066;">(</span>pReader<span style="color: #000066;">^</span><span style="color: #000066;">)</span> &lt;&gt; <span style="color: #0000ff;">0</span></pre></div>
<p>Lo de cambiar los tipos a PWideChar no va a funcionar porque las funciones de la API que uso son ANSI, puede que usando las mismas fuciones pero en su version unicode funcionase bien, pero seguramente habría que cambiar algunas cosas mas en el codigo.</p>
<p>Prueba con los cambios que te dije, y si no te va, dime exactamente en que linea te salta el error.</p>
<p>Saludos</p>
</div></div></div>      </div>

  <ul class="links list-inline"><li class="comment_forbidden first last"></li>
</ul></div>

<div class="indented"><a id="comment-926"></a>
<div class="comment comment-by-node-author clearfix" about="/comment/926#comment-926" typeof="sioc:Post sioct:Comment">
  
  
    <h3 property="dc:title" datatype=""><a style="display: none;" href="/comment/926#comment-926" class="permalink" rel="bookmark">Se me olvidaba, cambia</a></h3>
  
  <div class="submitted">
    <a style="display: none;" href="/comment/926#comment-926" class="permalink" rel="bookmark">Enlace permanente</a>    <span property="dc:date dc:created" content="2012-05-28T18:31:00+02:00" datatype="xsd:dateTime" rel="sioc:has_creator">Enviado por <span class="username" xml:lang="" about="/user/1" typeof="sioc:UserAccount" property="foaf:name" datatype="">admin</span> el Lun, 05/28/2012 - 18:31</span>  </div>

  <div class="content">
    <span rel="sioc:reply_of" resource="/node/78" class="rdf-meta element-hidden"></span><span rel="sioc:reply_of" resource="/comment/925#comment-925" class="rdf-meta element-hidden"></span><div class="field field-name-comment-body field-type-text-long field-label-hidden"><div class="field-items"><div class="field-item even" property="content:encoded"><p>Se me olvidaba, cambia tambien en la unidad WinSCard.pas "LPCTSTR" y "LPTSTR" por "PAnsiChar"</p>
</div></div></div>      </div>

  <ul class="links list-inline"><li class="comment_forbidden first last"></li>
</ul></div>
</div></div><a id="comment-939"></a>
<div class="comment comment-by-anonymous clearfix" about="/comment/939#comment-939" typeof="sioc:Post sioct:Comment">
  
  
    <h3 property="dc:title" datatype=""><a style="display: none;" href="/comment/939#comment-939" class="permalink" rel="bookmark">Gracias por tus artículos</a></h3>
  
  <div class="submitted">
    <a style="display: none;" href="/comment/939#comment-939" class="permalink" rel="bookmark">Enlace permanente</a>    <span property="dc:date dc:created" content="2012-06-21T00:00:38+02:00" datatype="xsd:dateTime" rel="sioc:has_creator">Enviado por <span class="username" xml:lang="" typeof="sioc:UserAccount" property="foaf:name" datatype="">dec (no verificado)</span> el Jue, 06/21/2012 - 00:00</span>  </div>

  <div class="content">
    <span rel="sioc:reply_of" resource="/node/78" class="rdf-meta element-hidden"></span><div class="field field-name-comment-body field-type-text-long field-label-hidden"><div class="field-items"><div class="field-item even" property="content:encoded"><p>Gracias por tus artículos Domingo: son todos excelentes, como no puede ser de otra forma viniendo de ti.</p>
</div></div></div>      </div>

  <ul class="links list-inline"><li class="comment_forbidden first last"></li>
</ul></div>
<a id="comment-945"></a>
<div class="comment comment-by-anonymous clearfix" about="/comment/945#comment-945" typeof="sioc:Post sioct:Comment">
  
  
    <h3 property="dc:title" datatype=""><a style="display: none;" href="/comment/945#comment-945" class="permalink" rel="bookmark">Gracias por el</a></h3>
  
  <div class="submitted">
    <a style="display: none;" href="/comment/945#comment-945" class="permalink" rel="bookmark">Enlace permanente</a>    <span property="dc:date dc:created" content="2012-06-25T17:01:00+02:00" datatype="xsd:dateTime" rel="sioc:has_creator">Enviado por <span class="username" xml:lang="" typeof="sioc:UserAccount" property="foaf:name" datatype="">(Verificado) o  (no verificado)</span> el Lun, 06/25/2012 - 17:01</span>  </div>

  <div class="content">
    <span rel="sioc:reply_of" resource="/node/78" class="rdf-meta element-hidden"></span><div class="field field-name-comment-body field-type-text-long field-label-hidden"><div class="field-items"><div class="field-item even" property="content:encoded"><p>Gracias por el interesantísimo artículo.<br />
Me gustaría informarme si existe alguna forma de acceder y descargar la fotografía del usuario, igualmente a como haces en este ejemplo, sin solicitar el pin al usuario.<br />
Sería una forma genial de actualizar la ficha del cliente en la aplicación que estoy desarrollando.<br />
¿Alguien ha conseguido o investigado esta posibilidad?<br />
Gracias a todos.</p>
</div></div></div>      </div>

  <ul class="links list-inline"><li class="comment_forbidden first last"></li>
</ul></div>

<div class="indented"><a id="comment-946"></a>
<div class="comment comment-by-node-author clearfix" about="/comment/946#comment-946" typeof="sioc:Post sioct:Comment">
  
  
    <h3 property="dc:title" datatype=""><a style="display: none;" href="/comment/946#comment-946" class="permalink" rel="bookmark">Pues CREO que ese tipo de</a></h3>
  
  <div class="submitted">
    <a style="display: none;" href="/comment/946#comment-946" class="permalink" rel="bookmark">Enlace permanente</a>    <span property="dc:date dc:created" content="2012-06-25T17:06:41+02:00" datatype="xsd:dateTime" rel="sioc:has_creator">Enviado por <span class="username" xml:lang="" about="/user/1" typeof="sioc:UserAccount" property="foaf:name" datatype="">admin</span> el Lun, 06/25/2012 - 17:06</span>  </div>

  <div class="content">
    <span rel="sioc:reply_of" resource="/node/78" class="rdf-meta element-hidden"></span><span rel="sioc:reply_of" resource="/comment/945#comment-945" class="rdf-meta element-hidden"></span><div class="field field-name-comment-body field-type-text-long field-label-hidden"><div class="field-items"><div class="field-item even" property="content:encoded"><p>Pues CREO que ese tipo de información no es accesible, ni incluso utilizando el PIN. </p>
<p>Tengo entendido que solo se puede acceder a estos datos desde los puestos que se encuentran en las comisarias de policía.</p>
</div></div></div>      </div>

  <ul class="links list-inline"><li class="comment_forbidden first last"></li>
</ul></div>
</div>
  </div>
</article>

</section>
  </div>
    </section>

    
  </div>
</div>

  <script src="/sites/delphi.jmrds.com/themes/bootstrap/js/bootstrap.js?"></script>
</body>
</html>
