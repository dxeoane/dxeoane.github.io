<!DOCTYPE html>
<html lang="es" dir="ltr" prefix="content: http://purl.org/rss/1.0/modules/content/ dc: http://purl.org/dc/terms/ foaf: http://xmlns.com/foaf/0.1/ og: http://ogp.me/ns# rdfs: http://www.w3.org/2000/01/rdf-schema# sioc: http://rdfs.org/sioc/ns# sioct: http://rdfs.org/sioc/types# skos: http://www.w3.org/2004/02/skos/core# xsd: http://www.w3.org/2001/XMLSchema#">
<head>
  <link rel="profile" href="http://www.w3.org/1999/xhtml/vocab" />
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<link rel="shortcut icon" href="/sites/delphi.jmrds.com/themes/bootstrap/favicon.ico" type="image/vnd.microsoft.icon" />
<link rel="shortlink" href="/node/30" />
<link rel="canonical" href="/node/30" />
<meta name="Generator" content="Drupal 7 (http://drupal.org)" />
  <title>Recuperar imagenes jpeg 2 | La web de Seoane</title>
  <style>
@import url("/modules/system/system.base.css?");
</style>
<style>
@import url("/modules/field/theme/field.css?");
@import url("/modules/node/node.css?");
</style>
<style>
@import url("/sites/delphi.jmrds.com/modules/geshifilter/geshifilter.css?");
</style>
<link type="text/css" rel="stylesheet" href="//cdn.jsdelivr.net/bootstrap/3.3.5/css/bootstrap.css" media="all" />
<style>
@import url("/sites/delphi.jmrds.com/themes/bootstrap/css/3.3.5/overrides.min.css?");
</style>
  <!-- HTML5 element support for IE6-8 -->
  <!--[if lt IE 9]>
    <script src="https://cdn.jsdelivr.net/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
  <![endif]-->
  <script src="/sites/delphi.jmrds.com/modules/jquery_update/replace/jquery/1.10/jquery.min.js?v=1.10.2"></script>
<script src="/misc/jquery.once.js?v=1.2"></script>
<script src="/misc/drupal.js?"></script>
<script src="//cdn.jsdelivr.net/bootstrap/3.3.5/js/bootstrap.js"></script>
<script src="/sites/delphi.jmrds.com/files/languages/es_sB9mP1iixuFRbyZKZVySK7xrSW_2-LRj1vNEXyqwOu8.js?"></script>
<script>jQuery.extend(Drupal.settings, {"basePath":"\/","pathPrefix":"","ajaxPageState":{"theme":"bootstrap","theme_token":"4lzd28HBC5T4wcOkIin_E8DGw_jFPZl6DOSbPAtTOF0","js":{"sites\/delphi.jmrds.com\/themes\/bootstrap\/js\/bootstrap.js":1,"sites\/delphi.jmrds.com\/modules\/jquery_update\/replace\/jquery\/1.10\/jquery.min.js":1,"misc\/jquery.once.js":1,"misc\/drupal.js":1,"\/\/cdn.jsdelivr.net\/bootstrap\/3.3.5\/js\/bootstrap.js":1,"public:\/\/languages\/es_sB9mP1iixuFRbyZKZVySK7xrSW_2-LRj1vNEXyqwOu8.js":1},"css":{"modules\/system\/system.base.css":1,"modules\/field\/theme\/field.css":1,"modules\/node\/node.css":1,"sites\/delphi.jmrds.com\/modules\/geshifilter\/geshifilter.css":1,"\/\/cdn.jsdelivr.net\/bootstrap\/3.3.5\/css\/bootstrap.css":1,"sites\/delphi.jmrds.com\/themes\/bootstrap\/css\/3.3.5\/overrides.min.css":1}},"bootstrap":{"anchorsFix":"0","anchorsSmoothScrolling":"0","formHasError":1,"popoverEnabled":"1","popoverOptions":{"animation":1,"html":0,"placement":"right","selector":"","trigger":"click","triggerAutoclose":1,"title":"","content":"","delay":0,"container":"body"},"tooltipEnabled":"1","tooltipOptions":{"animation":1,"html":0,"placement":"auto left","selector":"","trigger":"hover focus","delay":0,"container":"body"}}});</script>
</head>
<body class="html not-front not-logged-in no-sidebars page-node page-node- page-node-30 node-type-article">
  <div id="skip-link">
    <a href="#main-content" class="element-invisible element-focusable">Pasar al contenido principal</a>
  </div>
    <header id="navbar" role="banner" class="navbar container navbar-default">
  <div class="container">
    <div class="navbar-header">
              <a class="logo navbar-btn pull-left" href="/" title="Inicio">
          <img src="/sites/delphi.jmrds.com/themes/bootstrap/logo.png" alt="Inicio" />
        </a>
      
              <a class="name navbar-brand" href="/" title="Inicio">La web de Seoane</a>
      
              <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#navbar-collapse">
          <span class="sr-only">Toggle navigation</span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
          </div>

          <div class="navbar-collapse collapse" id="navbar-collapse">
        <nav role="navigation">
                      <ul class="menu nav navbar-nav"><li class="first leaf"><a href="/" title="">Inicio</a></li>
<li class="leaf"><a href="/search/node" title="">Buscar</a></li>
<li class="leaf"><a href="/rss.xml" title="">RSS</a></li>
<li class="leaf"><a href="/node/26" title="">Contacto</a></li>
<li class="last leaf"><a href="/user/login" title="">Login</a></li>
</ul>                                      </nav>
      </div>
      </div>
</header>

<div class="main-container container">

  <header role="banner" id="page-header">
    
      </header> <!-- /#page-header -->

  <div class="row">

    
    <section class="col-sm-12">
                  <a id="main-content"></a>
                    <h1 class="page-header">Recuperar imagenes jpeg 2</h1>
                                                          <div class="region region-content">
    <section id="block-system-main" class="block block-system clearfix">

      
  <article id="node-30" class="node node-article node-promoted clearfix" about="/node/30" typeof="sioc:Item foaf:Document">
    <header>
            <span property="dc:title" content="Recuperar imagenes jpeg 2" class="rdf-meta element-hidden"></span><span property="sioc:num_replies" content="0" datatype="xsd:integer" class="rdf-meta element-hidden"></span>        <span class="submitted">
            <span property="dc:date dc:created" content="2007-06-23T22:36:14+02:00" datatype="xsd:dateTime" rel="sioc:has_creator">Enviado por <span class="username" xml:lang="" about="/user/1" typeof="sioc:UserAccount" property="foaf:name" datatype="">admin</span> el Sáb, 06/23/2007 - 22:36</span>    </span>
      </header>
    <div class="field field-name-body field-type-text-with-summary field-label-hidden"><div class="field-items"><div class="field-item even" property="content:encoded"><p>En un <a href="/?q=node/27">artículo</a> anterior hablaba de como recuperar las imágenes borradas de un disco, o tarjeta de memoria, examinando cluster a cluster en busca de las imágenes. Ese programa estaba pensado para utilizarlo directamente sobre un disco o sobre la imagen de un disco, no sirve para examinar otro tipo de archivos, pero usando un sistema parecido podríamos extraer imágenes de cualquier archivo. La única diferencia es que en vez de ir buscando cluster a cluster, tendríamos que ir buscando byte a byte. Este proceso es mucho mas lento así que no es el mas adecuado para examinar discos enteros, sin embargo es perfecto para explorar archivo de un tamaño normal.</p>
<!--break--><p>El principio es el mismo de antes, buscamos la marca que indica el comienzo de un archivo jpeg, es decir, los bytes FFD8FF. Una vez encontrada, intentamos obtener, de los bytes que siguen a esos tres, una imagen jpeg, para luego continuar la búsqueda en el byte siguiente.</p>
<p>El programa necesita que se le pasen dos parámetros, el archivo de entrada y la plantilla que sirve para dar nombre a las imágenes recuperadas. La plantilla tiene que incluir "%d", esta variable sera sustituida por un valor que se va incrementando. Por ejemplo, si queremos guardar las imágenes en C:\Temp utilizaremos C:\Temp\%d.jpg</p>
<p>El código es el siguiente (es una aplicación de consola):</p>
<div class="geshifilter">
<pre class="delphi geshifilter-delphi" style="font-family:monospace;"><span style="color: #000000; font-weight: bold;">program</span> JpegRecover<span style="color: #000066;">;</span>
 
<span style="color: #008000; font-style: italic;">{$APPTYPE CONSOLE}</span>
 
<span style="color: #000000; font-weight: bold;">uses</span>
  SysUtils<span style="color: #000066;">,</span>
  Classes<span style="color: #000066;">;</span>
 
<span style="color: #000000; font-weight: bold;">procedure</span> Recover<span style="color: #000066;">(</span>Origen<span style="color: #000066;">:</span> TStream<span style="color: #000066;">;</span> FormatStr<span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">String</span><span style="color: #000066;">;</span> <span style="color: #000000; font-weight: bold;">var</span> Index<span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">Integer</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
<span style="color: #000000; font-weight: bold;">var</span>
  Destino<span style="color: #000066;">:</span> TMemoryStream<span style="color: #000066;">;</span>
  Buffer<span style="color: #000066;">:</span> <span style="color: #000000; font-weight: bold;">array</span><span style="color: #000066;">[</span><span style="color: #0000ff;">0</span><span style="color: #000066;">..</span><span style="color: #0000cc;">$FFFF</span><span style="color: #000066;">]</span> <span style="color: #000000; font-weight: bold;">of</span> <span style="color: #000066; font-weight: bold;">Byte</span><span style="color: #000066;">;</span>
  Header<span style="color: #000066;">:</span> <span style="color: #000000; font-weight: bold;">array</span><span style="color: #000066;">[</span><span style="color: #0000ff;">1</span><span style="color: #000066;">..</span><span style="color: #0000ff;">4</span><span style="color: #000066;">]</span> <span style="color: #000000; font-weight: bold;">of</span> <span style="color: #000066; font-weight: bold;">Byte</span><span style="color: #000066;">;</span>
  Size<span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">Integer</span><span style="color: #000066;">;</span>
<span style="color: #000000; font-weight: bold;">begin</span>
  Destino<span style="color: #000066;">:</span><span style="color: #000066;">=</span> TMemoryStream<span style="color: #000066;">.</span><span style="color: #006600;">Create</span><span style="color: #000066;">;</span>
  <span style="color: #000000; font-weight: bold;">try</span>
    <span style="color: #808080; font-style: italic;">// Escribimos los 2 primeros bytes del archivo</span>
    Header<span style="color: #000066;">[</span><span style="color: #0000ff;">1</span><span style="color: #000066;">]</span><span style="color: #000066;">:</span><span style="color: #000066;">=</span> <span style="color: #0000cc;">$FF</span><span style="color: #000066;">;</span>  Header<span style="color: #000066;">[</span><span style="color: #0000ff;">2</span><span style="color: #000066;">]</span><span style="color: #000066;">:</span><span style="color: #000066;">=</span> <span style="color: #0000cc;">$D8</span><span style="color: #000066;">;</span>
    Destino<span style="color: #000066;">.</span><span style="color: #006600;">WriteBuffer</span><span style="color: #000066;">(</span>Header<span style="color: #000066;">,</span><span style="color: #0000ff;">2</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
    Origen<span style="color: #000066;">.</span><span style="color: #000066;">Seek</span><span style="color: #000066;">(</span><span style="color: #000066;">-</span><span style="color: #0000ff;">1</span><span style="color: #000066;">,</span>soFromCurrent<span style="color: #000066;">)</span><span style="color: #000066;">;</span>
    <span style="color: #808080; font-style: italic;">// En este bucle vamos copiando segmento a segmento</span>
    <span style="color: #000000; font-weight: bold;">while</span> <span style="color: #000000; font-weight: bold;">TRUE</span> <span style="color: #000000; font-weight: bold;">do</span>
    <span style="color: #000000; font-weight: bold;">begin</span>
      <span style="color: #000066;">FillChar</span><span style="color: #000066;">(</span>Header<span style="color: #000066;">,</span><span style="color: #000066;">Sizeof</span><span style="color: #000066;">(</span>Header<span style="color: #000066;">)</span><span style="color: #000066;">,</span><span style="color: #ff0000;">#0</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
      Origen<span style="color: #000066;">.</span><span style="color: #000000; font-weight: bold;">Read</span><span style="color: #000066;">(</span>Header<span style="color: #000066;">,</span><span style="color: #0000ff;">4</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
      Size<span style="color: #000066;">:</span><span style="color: #000066;">=</span> <span style="color: #000066;">(</span><span style="color: #000066;">(</span>Header<span style="color: #000066;">[</span><span style="color: #0000ff;">3</span><span style="color: #000066;">]</span> <span style="color: #000000; font-weight: bold;">shl</span> <span style="color: #0000ff;">8</span><span style="color: #000066;">)</span> <span style="color: #000066;">+</span> Header<span style="color: #000066;">[</span><span style="color: #0000ff;">4</span><span style="color: #000066;">]</span><span style="color: #000066;">)</span> <span style="color: #000066;">-</span> <span style="color: #0000ff;">2</span><span style="color: #000066;">;</span>
      <span style="color: #000000; font-weight: bold;">case</span> Header<span style="color: #000066;">[</span><span style="color: #0000ff;">2</span><span style="color: #000066;">]</span> <span style="color: #000000; font-weight: bold;">of</span>
        <span style="color: #0000cc;">$01</span><span style="color: #000066;">,</span><span style="color: #0000cc;">$D0</span><span style="color: #000066;">..</span><span style="color: #0000cc;">$D8</span><span style="color: #000066;">:</span> <span style="color: #000000; font-weight: bold;">begin</span>
                        <span style="color: #808080; font-style: italic;">// Estos segmentos solo miden dos bytes,</span>
                        <span style="color: #808080; font-style: italic;">// asi que escribimos 2 bytes y</span>
                        Destino<span style="color: #000066;">.</span><span style="color: #006600;">WriteBuffer</span><span style="color: #000066;">(</span>Header<span style="color: #000066;">,</span><span style="color: #0000ff;">2</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
                        <span style="color: #808080; font-style: italic;">// retrocedemos otros dos hacia atras.</span>
                        Origen<span style="color: #000066;">.</span><span style="color: #000066;">Seek</span><span style="color: #000066;">(</span><span style="color: #000066;">-</span><span style="color: #0000ff;">2</span><span style="color: #000066;">,</span>soFromCurrent<span style="color: #000066;">)</span><span style="color: #000066;">;</span>
                      <span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">;</span>
        <span style="color: #0000cc;">$D9</span><span style="color: #000066;">:</span> <span style="color: #000000; font-weight: bold;">begin</span>
               <span style="color: #808080; font-style: italic;">// Este indica que llegamos al final del archivo jpeg</span>
               Destino<span style="color: #000066;">.</span><span style="color: #006600;">WriteBuffer</span><span style="color: #000066;">(</span>Header<span style="color: #000066;">,</span><span style="color: #0000ff;">2</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
               <span style="color: #808080; font-style: italic;">// Guardamos el archivo usando la plantilla</span>
               Destino<span style="color: #000066;">.</span><span style="color: #006600;">SaveToFile</span><span style="color: #000066;">(</span><span style="color: #000066;">Format</span><span style="color: #000066;">(</span>FormatStr<span style="color: #000066;">,</span><span style="color: #000066;">[</span>Index<span style="color: #000066;">]</span><span style="color: #000066;">)</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
               <span style="color: #000066;">Writeln</span><span style="color: #000066;">(</span><span style="color: #ff0000;">'Recuperada: '</span> <span style="color: #000066;">+</span> <span style="color: #000066;">Format</span><span style="color: #000066;">(</span>FormatStr<span style="color: #000066;">,</span><span style="color: #000066;">[</span>Index<span style="color: #000066;">]</span><span style="color: #000066;">)</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
               <span style="color: #808080; font-style: italic;">// Incrementamos el indice</span>
               <span style="color: #000066;">inc</span><span style="color: #000066;">(</span>Index<span style="color: #000066;">)</span><span style="color: #000066;">;</span>
               <span style="color: #808080; font-style: italic;">// Salimos del procedure</span>
               Exit<span style="color: #000066;">;</span>
             <span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">;</span>
        <span style="color: #0000cc;">$DA</span><span style="color: #000066;">:</span> <span style="color: #000000; font-weight: bold;">begin</span>
               <span style="color: #808080; font-style: italic;">// Este segmento no tiene tamaño</span>
               Destino<span style="color: #000066;">.</span><span style="color: #006600;">WriteBuffer</span><span style="color: #000066;">(</span>Header<span style="color: #000066;">,</span><span style="color: #0000ff;">2</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
               Origen<span style="color: #000066;">.</span><span style="color: #000066;">Seek</span><span style="color: #000066;">(</span><span style="color: #000066;">-</span><span style="color: #0000ff;">2</span><span style="color: #000066;">,</span>soFromCurrent<span style="color: #000066;">)</span><span style="color: #000066;">;</span>
               <span style="color: #808080; font-style: italic;">// Buscamos el final byte a byte</span>
               <span style="color: #000000; font-weight: bold;">while</span> <span style="color: #000000; font-weight: bold;">TRUE</span> <span style="color: #000000; font-weight: bold;">do</span>
               <span style="color: #000000; font-weight: bold;">begin</span>
                 Origen<span style="color: #000066;">.</span><span style="color: #006600;">ReadBuffer</span><span style="color: #000066;">(</span>Buffer<span style="color: #000066;">,</span><span style="color: #0000ff;">1</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
                 <span style="color: #808080; font-style: italic;">// Posible comienzo de otro segmento</span>
                 <span style="color: #000000; font-weight: bold;">if</span> Buffer<span style="color: #000066;">[</span><span style="color: #0000ff;">0</span><span style="color: #000066;">]</span> <span style="color: #000066;">=</span> <span style="color: #0000cc;">$FF</span> <span style="color: #000000; font-weight: bold;">then</span>
                 <span style="color: #000000; font-weight: bold;">begin</span>
                   Origen<span style="color: #000066;">.</span><span style="color: #006600;">ReadBuffer</span><span style="color: #000066;">(</span>Buffer<span style="color: #000066;">,</span><span style="color: #0000ff;">1</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
                   <span style="color: #808080; font-style: italic;">// $FF00 = Secuencia de escape</span>
                   <span style="color: #808080; font-style: italic;">// $FFD0 .. $FFD7 = Se deben de ignorar</span>
                   <span style="color: #000000; font-weight: bold;">if</span> <span style="color: #000066;">(</span>Buffer<span style="color: #000066;">[</span><span style="color: #0000ff;">0</span><span style="color: #000066;">]</span> &lt;&gt; <span style="color: #0000ff;">0</span><span style="color: #000066;">)</span> <span style="color: #000000; font-weight: bold;">and</span> <span style="color: #000000; font-weight: bold;">not</span> <span style="color: #000066;">(</span>Buffer<span style="color: #000066;">[</span><span style="color: #0000ff;">0</span><span style="color: #000066;">]</span> <span style="color: #000000; font-weight: bold;">in</span> <span style="color: #000066;">[</span><span style="color: #0000cc;">$D0</span><span style="color: #000066;">..</span><span style="color: #0000cc;">$D7</span><span style="color: #000066;">]</span><span style="color: #000066;">)</span> <span style="color: #000000; font-weight: bold;">then</span>
                   <span style="color: #000000; font-weight: bold;">begin</span>
                     <span style="color: #808080; font-style: italic;">// Si encontramos el comienzo de otro segmento,</span>
                     <span style="color: #808080; font-style: italic;">// retrocedemos dos bytes, y volvemos al bucle principal</span>
                     Origen<span style="color: #000066;">.</span><span style="color: #000066;">Seek</span><span style="color: #000066;">(</span><span style="color: #000066;">-</span><span style="color: #0000ff;">2</span><span style="color: #000066;">,</span>soFromCurrent<span style="color: #000066;">)</span><span style="color: #000066;">;</span>
                     break<span style="color: #000066;">;</span>
                   <span style="color: #000000; font-weight: bold;">end</span> <span style="color: #000000; font-weight: bold;">else</span>
                   <span style="color: #000000; font-weight: bold;">begin</span>
                     <span style="color: #808080; font-style: italic;">// Si no es el comienzo de otro segmento, escribimos</span>
                     <span style="color: #808080; font-style: italic;">// y continuamos</span>
                     Header<span style="color: #000066;">[</span><span style="color: #0000ff;">1</span><span style="color: #000066;">]</span><span style="color: #000066;">:</span><span style="color: #000066;">=</span> <span style="color: #0000cc;">$FF</span><span style="color: #000066;">;</span>
                     Header<span style="color: #000066;">[</span><span style="color: #0000ff;">2</span><span style="color: #000066;">]</span><span style="color: #000066;">:</span><span style="color: #000066;">=</span> Buffer<span style="color: #000066;">[</span><span style="color: #0000ff;">0</span><span style="color: #000066;">]</span><span style="color: #000066;">;</span>
                     Destino<span style="color: #000066;">.</span><span style="color: #006600;">WriteBuffer</span><span style="color: #000066;">(</span>Header<span style="color: #000066;">,</span><span style="color: #0000ff;">2</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
                   <span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">;</span>
                 <span style="color: #000000; font-weight: bold;">end</span> <span style="color: #000000; font-weight: bold;">else</span>
                   Destino<span style="color: #000066;">.</span><span style="color: #006600;">WriteBuffer</span><span style="color: #000066;">(</span>Buffer<span style="color: #000066;">,</span><span style="color: #0000ff;">1</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
               <span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">;</span>
             <span style="color: #000000; font-weight: bold;">end</span>
        <span style="color: #000000; font-weight: bold;">else</span>
        <span style="color: #000000; font-weight: bold;">begin</span>
          <span style="color: #808080; font-style: italic;">// Cualquier otro segmento lo copiamos directamente</span>
          Origen<span style="color: #000066;">.</span><span style="color: #006600;">ReadBuffer</span><span style="color: #000066;">(</span>Buffer<span style="color: #000066;">,</span>Size<span style="color: #000066;">)</span><span style="color: #000066;">;</span>
          Destino<span style="color: #000066;">.</span><span style="color: #006600;">WriteBuffer</span><span style="color: #000066;">(</span>Header<span style="color: #000066;">,</span><span style="color: #0000ff;">4</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
          Destino<span style="color: #000066;">.</span><span style="color: #006600;">WriteBuffer</span><span style="color: #000066;">(</span>Buffer<span style="color: #000066;">,</span>Size<span style="color: #000066;">)</span><span style="color: #000066;">;</span>
        <span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">;</span>
      <span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">;</span>
    <span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">;</span>
  <span style="color: #000000; font-weight: bold;">finally</span>
    Destino<span style="color: #000066;">.</span><span style="color: #006600;">Free</span><span style="color: #000066;">;</span>
  <span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">;</span>
<span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">;</span>
 
<span style="color: #000000; font-weight: bold;">procedure</span> Scanfile<span style="color: #000066;">(</span>Stream<span style="color: #000066;">:</span> TStream<span style="color: #000066;">;</span> FormatStr<span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">String</span><span style="color: #000066;">;</span> <span style="color: #000000; font-weight: bold;">var</span> Index<span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">Integer</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
<span style="color: #000000; font-weight: bold;">var</span>
  B<span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">Byte</span><span style="color: #000066;">;</span>
  Leidos<span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">Integer</span><span style="color: #000066;">;</span>
  Posicion<span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">int64</span><span style="color: #000066;">;</span>
<span style="color: #000000; font-weight: bold;">begin</span>
  <span style="color: #808080; font-style: italic;">// Vamos leyendo byte a byte el archivo</span>
  Leidos<span style="color: #000066;">:</span><span style="color: #000066;">=</span> Stream<span style="color: #000066;">.</span><span style="color: #000000; font-weight: bold;">Read</span><span style="color: #000066;">(</span>B<span style="color: #000066;">,</span><span style="color: #0000ff;">1</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
  <span style="color: #000000; font-weight: bold;">while</span> Leidos <span style="color: #000066;">=</span> <span style="color: #0000ff;">1</span> <span style="color: #000000; font-weight: bold;">do</span>
    <span style="color: #000000; font-weight: bold;">if</span> B <span style="color: #000066;">=</span> <span style="color: #0000cc;">$FF</span> <span style="color: #000000; font-weight: bold;">then</span>
    <span style="color: #000000; font-weight: bold;">begin</span>
      Leidos<span style="color: #000066;">:</span><span style="color: #000066;">=</span> Stream<span style="color: #000066;">.</span><span style="color: #000000; font-weight: bold;">Read</span><span style="color: #000066;">(</span>B<span style="color: #000066;">,</span><span style="color: #0000ff;">1</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
      <span style="color: #000000; font-weight: bold;">if</span> Leidos <span style="color: #000066;">=</span> <span style="color: #0000ff;">1</span> <span style="color: #000000; font-weight: bold;">then</span>
        <span style="color: #000000; font-weight: bold;">if</span> B <span style="color: #000066;">=</span> <span style="color: #0000cc;">$D8</span> <span style="color: #000000; font-weight: bold;">then</span>
        <span style="color: #000000; font-weight: bold;">begin</span>
          Leidos<span style="color: #000066;">:</span><span style="color: #000066;">=</span> Stream<span style="color: #000066;">.</span><span style="color: #000000; font-weight: bold;">Read</span><span style="color: #000066;">(</span>B<span style="color: #000066;">,</span><span style="color: #0000ff;">1</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
          <span style="color: #000000; font-weight: bold;">if</span> Leidos <span style="color: #000066;">=</span> <span style="color: #0000ff;">1</span> <span style="color: #000000; font-weight: bold;">then</span>
            <span style="color: #000000; font-weight: bold;">if</span> B <span style="color: #000066;">=</span> <span style="color: #0000cc;">$FF</span> <span style="color: #000000; font-weight: bold;">then</span>
            <span style="color: #000000; font-weight: bold;">begin</span>
              <span style="color: #808080; font-style: italic;">// Hasta encontrar la combinacion $FFD8FF</span>
              <span style="color: #000066;">Writeln</span><span style="color: #000066;">(</span><span style="color: #ff0000;">'Encontrada una posible imagen.'</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
              <span style="color: #808080; font-style: italic;">// Guardamos la posicion</span>
              Posicion<span style="color: #000066;">:</span><span style="color: #000066;">=</span> Stream<span style="color: #000066;">.</span><span style="color: #006600;">Position</span><span style="color: #000066;">;</span>
              <span style="color: #000000; font-weight: bold;">try</span>
                <span style="color: #808080; font-style: italic;">// Intentamos recuperar la imagen</span>
                Recover<span style="color: #000066;">(</span>Stream<span style="color: #000066;">,</span>FormatStr<span style="color: #000066;">,</span>Index<span style="color: #000066;">)</span><span style="color: #000066;">;</span>
              <span style="color: #000000; font-weight: bold;">except</span>
                <span style="color: #808080; font-style: italic;">// Si se produce un error lo mostramos, pero no salimos del bucle</span>
                <span style="color: #000000; font-weight: bold;">On</span> E<span style="color: #000066;">:</span> Exception <span style="color: #000000; font-weight: bold;">do</span>
                   <span style="color: #000066;">Writeln</span><span style="color: #000066;">(</span><span style="color: #ff0000;">'Error: '</span> <span style="color: #000066;">+</span> E<span style="color: #000066;">.</span><span style="color: #000000; font-weight: bold;">Message</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
              <span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">;</span>
              <span style="color: #808080; font-style: italic;">// Volvemos a la posicion en la que estabamos</span>
              Stream<span style="color: #000066;">.</span><span style="color: #006600;">Position</span><span style="color: #000066;">:</span><span style="color: #000066;">=</span> Posicion<span style="color: #000066;">;</span>
            <span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">;</span>
        <span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">;</span>
    <span style="color: #000000; font-weight: bold;">end</span> <span style="color: #000000; font-weight: bold;">else</span>
      Leidos<span style="color: #000066;">:</span><span style="color: #000066;">=</span> Stream<span style="color: #000066;">.</span><span style="color: #000000; font-weight: bold;">Read</span><span style="color: #000066;">(</span>B<span style="color: #000066;">,</span><span style="color: #0000ff;">1</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
<span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">;</span>
 
<span style="color: #000000; font-weight: bold;">var</span>
  i<span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">Integer</span><span style="color: #000066;">;</span>
  Stream<span style="color: #000066;">:</span> TFileStream<span style="color: #000066;">;</span>
<span style="color: #000000; font-weight: bold;">begin</span>
  <span style="color: #000066;">Writeln</span><span style="color: #000066;">(</span><span style="color: #ff0000;">'JpegRecover 0.1 - Copyright (c) 2007 Domingo Seoane'</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
  <span style="color: #000066;">Writeln</span><span style="color: #000066;">(</span><span style="color: #ff0000;">'&lt;a href="http://delphi.jmrds.com'</span>"&gt;http<span style="color: #000066;">:</span><span style="color: #808080; font-style: italic;">//delphi.jmrds.com'&lt;/a&gt;);</span>
  Writeln<span style="color: #000066;">;</span>
  <span style="color: #000000; font-weight: bold;">if</span> ParamCount <span style="color: #000066;">=</span> <span style="color: #0000ff;">2</span> <span style="color: #000000; font-weight: bold;">then</span>
  <span style="color: #000000; font-weight: bold;">try</span>
    <span style="color: #808080; font-style: italic;">// Comprobamos que se pueden crear archivos en la ruta indicada</span>
    TFileStream<span style="color: #000066;">.</span><span style="color: #006600;">Create</span><span style="color: #000066;">(</span><span style="color: #000066;">Format</span><span style="color: #000066;">(</span><span style="color: #000066;">ParamStr</span><span style="color: #000066;">(</span><span style="color: #0000ff;">2</span><span style="color: #000066;">)</span><span style="color: #000066;">,</span><span style="color: #000066;">[</span><span style="color: #0000ff;">0</span><span style="color: #000066;">]</span><span style="color: #000066;">)</span><span style="color: #000066;">,</span>fmCreate<span style="color: #000066;">)</span><span style="color: #000066;">.</span><span style="color: #006600;">Free</span><span style="color: #000066;">;</span>
    <span style="color: #808080; font-style: italic;">// Borramos el archivo de prueba</span>
    <span style="color: #000066;">DeleteFile</span><span style="color: #000066;">(</span><span style="color: #000066;">Format</span><span style="color: #000066;">(</span><span style="color: #000066;">ParamStr</span><span style="color: #000066;">(</span><span style="color: #0000ff;">2</span><span style="color: #000066;">)</span><span style="color: #000066;">,</span><span style="color: #000066;">[</span><span style="color: #0000ff;">0</span><span style="color: #000066;">]</span><span style="color: #000066;">)</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
    i<span style="color: #000066;">:</span><span style="color: #000066;">=</span> <span style="color: #0000ff;">0</span><span style="color: #000066;">;</span>
    <span style="color: #808080; font-style: italic;">// Creamos el Stream del archivo</span>
    Stream<span style="color: #000066;">:</span><span style="color: #000066;">=</span> TFileStream<span style="color: #000066;">.</span><span style="color: #006600;">Create</span><span style="color: #000066;">(</span><span style="color: #000066;">Paramstr</span><span style="color: #000066;">(</span><span style="color: #0000ff;">1</span><span style="color: #000066;">)</span><span style="color: #000066;">,</span>fmOpenRead<span style="color: #000066;">)</span><span style="color: #000066;">;</span>
    <span style="color: #000000; font-weight: bold;">try</span>
      <span style="color: #000066;">Writeln</span><span style="color: #000066;">(</span><span style="color: #ff0000;">'Explorando el archivo: '</span> <span style="color: #000066;">+</span> <span style="color: #000066;">ParamStr</span><span style="color: #000066;">(</span><span style="color: #0000ff;">1</span><span style="color: #000066;">)</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
      Scanfile<span style="color: #000066;">(</span>Stream<span style="color: #000066;">,</span><span style="color: #000066;">ParamStr</span><span style="color: #000066;">(</span><span style="color: #0000ff;">2</span><span style="color: #000066;">)</span><span style="color: #000066;">,</span>i<span style="color: #000066;">)</span><span style="color: #000066;">;</span>
    <span style="color: #000000; font-weight: bold;">finally</span>
      Stream<span style="color: #000066;">.</span><span style="color: #006600;">Free</span><span style="color: #000066;">;</span>
    <span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">;</span>
  <span style="color: #000000; font-weight: bold;">except</span>
    <span style="color: #808080; font-style: italic;">// Si se produce un error, lo mostramos</span>
    <span style="color: #000000; font-weight: bold;">On</span> E<span style="color: #000066;">:</span> Exception <span style="color: #000000; font-weight: bold;">do</span>
      <span style="color: #000066;">Writeln</span><span style="color: #000066;">(</span><span style="color: #ff0000;">'Error: '</span> <span style="color: #000066;">+</span> E<span style="color: #000066;">.</span><span style="color: #000000; font-weight: bold;">Message</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
  <span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">;</span>
<span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">.</span></pre></div>
<p>Por ejemplo, para buscar imágenes en el archivo "ejemplo.dat" y guardarlas en C:\Temp, usaríamos el siguiente comando:</p>
<p>JpegRecover ejemplo.dat C:\Temp\%d.jpg</p>
<p>El código completo y programa, los puedes bajar de <a href="/sites/delphi.jmrds.com/adjuntos/recover2_delphi.zip">aquí</a></p>
<p>Ahora le podemos buscar un uso mas "ludico" a este codigo, y por ejemplo fisgar un poco en los archivos "thumb.db". Estos archivos "thumb.db" (al parecer en Vista se llaman thumbcache_xxxx.db) son creados por el explorer cuando vemos una carpeta con imágenes utilizando las "Vistas en miniatura". Lo "divertido" es que tiene el mal habito de no borrar las miniaturas almacenadas en la cache cuando se borra la imagen original, así que podemos encontrarnos con alguna sorpresa. </p>
<p>Es una aplicación de consola:</p>
<div class="geshifilter">
<pre class="delphi geshifilter-delphi" style="font-family:monospace;"><span style="color: #000000; font-weight: bold;">program</span> Fisgon<span style="color: #000066;">;</span>
 
<span style="color: #008000; font-style: italic;">{$APPTYPE CONSOLE}</span>
 
<span style="color: #000000; font-weight: bold;">uses</span>
  SysUtils<span style="color: #000066;">,</span>
  Classes<span style="color: #000066;">;</span>
 
<span style="color: #000000; font-weight: bold;">procedure</span> Recover<span style="color: #000066;">(</span>Origen<span style="color: #000066;">:</span> TStream<span style="color: #000066;">;</span> FormatStr<span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">String</span><span style="color: #000066;">;</span> <span style="color: #000000; font-weight: bold;">var</span> Index<span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">Integer</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
<span style="color: #000000; font-weight: bold;">var</span>
  Destino<span style="color: #000066;">:</span> TMemoryStream<span style="color: #000066;">;</span>
  Buffer<span style="color: #000066;">:</span> <span style="color: #000000; font-weight: bold;">array</span><span style="color: #000066;">[</span><span style="color: #0000ff;">0</span><span style="color: #000066;">..</span><span style="color: #0000cc;">$FFFF</span><span style="color: #000066;">]</span> <span style="color: #000000; font-weight: bold;">of</span> <span style="color: #000066; font-weight: bold;">Byte</span><span style="color: #000066;">;</span>
  Header<span style="color: #000066;">:</span> <span style="color: #000000; font-weight: bold;">array</span><span style="color: #000066;">[</span><span style="color: #0000ff;">1</span><span style="color: #000066;">..</span><span style="color: #0000ff;">4</span><span style="color: #000066;">]</span> <span style="color: #000000; font-weight: bold;">of</span> <span style="color: #000066; font-weight: bold;">Byte</span><span style="color: #000066;">;</span>
  Size<span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">Integer</span><span style="color: #000066;">;</span>
<span style="color: #000000; font-weight: bold;">begin</span>
  Destino<span style="color: #000066;">:</span><span style="color: #000066;">=</span> TMemoryStream<span style="color: #000066;">.</span><span style="color: #006600;">Create</span><span style="color: #000066;">;</span>
  <span style="color: #000000; font-weight: bold;">try</span>
    <span style="color: #808080; font-style: italic;">// Escribimos los 2 primeros bytes del archivo</span>
    Header<span style="color: #000066;">[</span><span style="color: #0000ff;">1</span><span style="color: #000066;">]</span><span style="color: #000066;">:</span><span style="color: #000066;">=</span> <span style="color: #0000cc;">$FF</span><span style="color: #000066;">;</span>  Header<span style="color: #000066;">[</span><span style="color: #0000ff;">2</span><span style="color: #000066;">]</span><span style="color: #000066;">:</span><span style="color: #000066;">=</span> <span style="color: #0000cc;">$D8</span><span style="color: #000066;">;</span>
    Destino<span style="color: #000066;">.</span><span style="color: #006600;">WriteBuffer</span><span style="color: #000066;">(</span>Header<span style="color: #000066;">,</span><span style="color: #0000ff;">2</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
    Origen<span style="color: #000066;">.</span><span style="color: #000066;">Seek</span><span style="color: #000066;">(</span><span style="color: #000066;">-</span><span style="color: #0000ff;">1</span><span style="color: #000066;">,</span>soFromCurrent<span style="color: #000066;">)</span><span style="color: #000066;">;</span>
    <span style="color: #808080; font-style: italic;">// En este bucle vamos copiando segmento a segmento</span>
    <span style="color: #000000; font-weight: bold;">while</span> <span style="color: #000000; font-weight: bold;">TRUE</span> <span style="color: #000000; font-weight: bold;">do</span>
    <span style="color: #000000; font-weight: bold;">begin</span>
      <span style="color: #000066;">FillChar</span><span style="color: #000066;">(</span>Header<span style="color: #000066;">,</span><span style="color: #000066;">Sizeof</span><span style="color: #000066;">(</span>Header<span style="color: #000066;">)</span><span style="color: #000066;">,</span><span style="color: #ff0000;">#0</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
      Origen<span style="color: #000066;">.</span><span style="color: #000000; font-weight: bold;">Read</span><span style="color: #000066;">(</span>Header<span style="color: #000066;">,</span><span style="color: #0000ff;">4</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
      Size<span style="color: #000066;">:</span><span style="color: #000066;">=</span> <span style="color: #000066;">(</span><span style="color: #000066;">(</span>Header<span style="color: #000066;">[</span><span style="color: #0000ff;">3</span><span style="color: #000066;">]</span> <span style="color: #000000; font-weight: bold;">shl</span> <span style="color: #0000ff;">8</span><span style="color: #000066;">)</span> <span style="color: #000066;">+</span> Header<span style="color: #000066;">[</span><span style="color: #0000ff;">4</span><span style="color: #000066;">]</span><span style="color: #000066;">)</span> <span style="color: #000066;">-</span> <span style="color: #0000ff;">2</span><span style="color: #000066;">;</span>
      <span style="color: #000000; font-weight: bold;">case</span> Header<span style="color: #000066;">[</span><span style="color: #0000ff;">2</span><span style="color: #000066;">]</span> <span style="color: #000000; font-weight: bold;">of</span>
        <span style="color: #0000cc;">$01</span><span style="color: #000066;">,</span><span style="color: #0000cc;">$D0</span><span style="color: #000066;">..</span><span style="color: #0000cc;">$D8</span><span style="color: #000066;">:</span> <span style="color: #000000; font-weight: bold;">begin</span>
                        <span style="color: #808080; font-style: italic;">// Estos segmentos solo miden dos bytes,</span>
                        <span style="color: #808080; font-style: italic;">// asi que escribimos 2 bytes y</span>
                        Destino<span style="color: #000066;">.</span><span style="color: #006600;">WriteBuffer</span><span style="color: #000066;">(</span>Header<span style="color: #000066;">,</span><span style="color: #0000ff;">2</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
                        <span style="color: #808080; font-style: italic;">// retrocedemos otros dos hacia atras.</span>
                        Origen<span style="color: #000066;">.</span><span style="color: #000066;">Seek</span><span style="color: #000066;">(</span><span style="color: #000066;">-</span><span style="color: #0000ff;">2</span><span style="color: #000066;">,</span>soFromCurrent<span style="color: #000066;">)</span><span style="color: #000066;">;</span>
                      <span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">;</span>
        <span style="color: #0000cc;">$D9</span><span style="color: #000066;">:</span> <span style="color: #000000; font-weight: bold;">begin</span>
               <span style="color: #808080; font-style: italic;">// Este indica que llegamos al final del archivo jpeg</span>
               Destino<span style="color: #000066;">.</span><span style="color: #006600;">WriteBuffer</span><span style="color: #000066;">(</span>Header<span style="color: #000066;">,</span><span style="color: #0000ff;">2</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
               <span style="color: #808080; font-style: italic;">// Guardamos el archivo usando la plantilla</span>
               Destino<span style="color: #000066;">.</span><span style="color: #006600;">SaveToFile</span><span style="color: #000066;">(</span><span style="color: #000066;">Format</span><span style="color: #000066;">(</span>FormatStr<span style="color: #000066;">,</span><span style="color: #000066;">[</span>Index<span style="color: #000066;">]</span><span style="color: #000066;">)</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
               <span style="color: #000066;">Writeln</span><span style="color: #000066;">(</span><span style="color: #ff0000;">'Recuperada: '</span> <span style="color: #000066;">+</span> <span style="color: #000066;">Format</span><span style="color: #000066;">(</span>FormatStr<span style="color: #000066;">,</span><span style="color: #000066;">[</span>Index<span style="color: #000066;">]</span><span style="color: #000066;">)</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
               <span style="color: #808080; font-style: italic;">// Incrementamos el indice</span>
               <span style="color: #000066;">inc</span><span style="color: #000066;">(</span>Index<span style="color: #000066;">)</span><span style="color: #000066;">;</span>
               <span style="color: #808080; font-style: italic;">// Salimos del procedure</span>
               Exit<span style="color: #000066;">;</span>
             <span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">;</span>
        <span style="color: #0000cc;">$DA</span><span style="color: #000066;">:</span> <span style="color: #000000; font-weight: bold;">begin</span>
               <span style="color: #808080; font-style: italic;">// Este segmento no tiene tamaño</span>
               Destino<span style="color: #000066;">.</span><span style="color: #006600;">WriteBuffer</span><span style="color: #000066;">(</span>Header<span style="color: #000066;">,</span><span style="color: #0000ff;">2</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
               Origen<span style="color: #000066;">.</span><span style="color: #000066;">Seek</span><span style="color: #000066;">(</span><span style="color: #000066;">-</span><span style="color: #0000ff;">2</span><span style="color: #000066;">,</span>soFromCurrent<span style="color: #000066;">)</span><span style="color: #000066;">;</span>
               <span style="color: #808080; font-style: italic;">// Buscamos el final byte a byte</span>
               <span style="color: #000000; font-weight: bold;">while</span> <span style="color: #000000; font-weight: bold;">TRUE</span> <span style="color: #000000; font-weight: bold;">do</span>
               <span style="color: #000000; font-weight: bold;">begin</span>
                 Origen<span style="color: #000066;">.</span><span style="color: #006600;">ReadBuffer</span><span style="color: #000066;">(</span>Buffer<span style="color: #000066;">,</span><span style="color: #0000ff;">1</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
                 <span style="color: #808080; font-style: italic;">// Posible comienzo de otro segmento</span>
                 <span style="color: #000000; font-weight: bold;">if</span> Buffer<span style="color: #000066;">[</span><span style="color: #0000ff;">0</span><span style="color: #000066;">]</span> <span style="color: #000066;">=</span> <span style="color: #0000cc;">$FF</span> <span style="color: #000000; font-weight: bold;">then</span>
                 <span style="color: #000000; font-weight: bold;">begin</span>
                   Origen<span style="color: #000066;">.</span><span style="color: #006600;">ReadBuffer</span><span style="color: #000066;">(</span>Buffer<span style="color: #000066;">,</span><span style="color: #0000ff;">1</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
                   <span style="color: #808080; font-style: italic;">// $FF00 = Secuencia de escape</span>
                   <span style="color: #808080; font-style: italic;">// $FFD0 .. $FFD7 = Se deben de ignorar</span>
                   <span style="color: #000000; font-weight: bold;">if</span> <span style="color: #000066;">(</span>Buffer<span style="color: #000066;">[</span><span style="color: #0000ff;">0</span><span style="color: #000066;">]</span> &lt;&gt; <span style="color: #0000ff;">0</span><span style="color: #000066;">)</span> <span style="color: #000000; font-weight: bold;">and</span> <span style="color: #000000; font-weight: bold;">not</span> <span style="color: #000066;">(</span>Buffer<span style="color: #000066;">[</span><span style="color: #0000ff;">0</span><span style="color: #000066;">]</span> <span style="color: #000000; font-weight: bold;">in</span> <span style="color: #000066;">[</span><span style="color: #0000cc;">$D0</span><span style="color: #000066;">..</span><span style="color: #0000cc;">$D7</span><span style="color: #000066;">]</span><span style="color: #000066;">)</span> <span style="color: #000000; font-weight: bold;">then</span>
                   <span style="color: #000000; font-weight: bold;">begin</span>
                     <span style="color: #808080; font-style: italic;">// Si encontramos el comienzo de otro segmento,</span>
                     <span style="color: #808080; font-style: italic;">// retrocedemos dos bytes, y volvemos al bucle principal</span>
                     Origen<span style="color: #000066;">.</span><span style="color: #000066;">Seek</span><span style="color: #000066;">(</span><span style="color: #000066;">-</span><span style="color: #0000ff;">2</span><span style="color: #000066;">,</span>soFromCurrent<span style="color: #000066;">)</span><span style="color: #000066;">;</span>
                     break<span style="color: #000066;">;</span>
                   <span style="color: #000000; font-weight: bold;">end</span> <span style="color: #000000; font-weight: bold;">else</span>
                   <span style="color: #000000; font-weight: bold;">begin</span>
                     <span style="color: #808080; font-style: italic;">// Si no es el comienzo de otro segmento, escribimos</span>
                     <span style="color: #808080; font-style: italic;">// y continuamos</span>
                     Header<span style="color: #000066;">[</span><span style="color: #0000ff;">1</span><span style="color: #000066;">]</span><span style="color: #000066;">:</span><span style="color: #000066;">=</span> <span style="color: #0000cc;">$FF</span><span style="color: #000066;">;</span>
                     Header<span style="color: #000066;">[</span><span style="color: #0000ff;">2</span><span style="color: #000066;">]</span><span style="color: #000066;">:</span><span style="color: #000066;">=</span> Buffer<span style="color: #000066;">[</span><span style="color: #0000ff;">0</span><span style="color: #000066;">]</span><span style="color: #000066;">;</span>
                     Destino<span style="color: #000066;">.</span><span style="color: #006600;">WriteBuffer</span><span style="color: #000066;">(</span>Header<span style="color: #000066;">,</span><span style="color: #0000ff;">2</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
                   <span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">;</span>  
                 <span style="color: #000000; font-weight: bold;">end</span> <span style="color: #000000; font-weight: bold;">else</span>
                   Destino<span style="color: #000066;">.</span><span style="color: #006600;">WriteBuffer</span><span style="color: #000066;">(</span>Buffer<span style="color: #000066;">,</span><span style="color: #0000ff;">1</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
               <span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">;</span>
             <span style="color: #000000; font-weight: bold;">end</span>
        <span style="color: #000000; font-weight: bold;">else</span>
        <span style="color: #000000; font-weight: bold;">begin</span>
          <span style="color: #808080; font-style: italic;">// Cualquier otro segmento lo copiamos directamente</span>
          Origen<span style="color: #000066;">.</span><span style="color: #006600;">ReadBuffer</span><span style="color: #000066;">(</span>Buffer<span style="color: #000066;">,</span>Size<span style="color: #000066;">)</span><span style="color: #000066;">;</span>
          Destino<span style="color: #000066;">.</span><span style="color: #006600;">WriteBuffer</span><span style="color: #000066;">(</span>Header<span style="color: #000066;">,</span><span style="color: #0000ff;">4</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
          Destino<span style="color: #000066;">.</span><span style="color: #006600;">WriteBuffer</span><span style="color: #000066;">(</span>Buffer<span style="color: #000066;">,</span>Size<span style="color: #000066;">)</span><span style="color: #000066;">;</span>
        <span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">;</span>
      <span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">;</span>
    <span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">;</span>
  <span style="color: #000000; font-weight: bold;">finally</span>
    Destino<span style="color: #000066;">.</span><span style="color: #006600;">Free</span><span style="color: #000066;">;</span>
  <span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">;</span>
<span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">;</span>
 
<span style="color: #000000; font-weight: bold;">procedure</span> Scanfile<span style="color: #000066;">(</span>Stream<span style="color: #000066;">:</span> TStream<span style="color: #000066;">;</span> FormatStr<span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">String</span><span style="color: #000066;">;</span> <span style="color: #000000; font-weight: bold;">var</span> Index<span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">Integer</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
<span style="color: #000000; font-weight: bold;">var</span>
  B<span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">Byte</span><span style="color: #000066;">;</span>
  Leidos<span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">Integer</span><span style="color: #000066;">;</span>
  Posicion<span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">int64</span><span style="color: #000066;">;</span>
<span style="color: #000000; font-weight: bold;">begin</span>
  <span style="color: #808080; font-style: italic;">// Vamos leyendo byte a byte el archivo</span>
  Leidos<span style="color: #000066;">:</span><span style="color: #000066;">=</span> Stream<span style="color: #000066;">.</span><span style="color: #000000; font-weight: bold;">Read</span><span style="color: #000066;">(</span>B<span style="color: #000066;">,</span><span style="color: #0000ff;">1</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
  <span style="color: #000000; font-weight: bold;">while</span> Leidos <span style="color: #000066;">=</span> <span style="color: #0000ff;">1</span> <span style="color: #000000; font-weight: bold;">do</span>
    <span style="color: #000000; font-weight: bold;">if</span> B <span style="color: #000066;">=</span> <span style="color: #0000cc;">$FF</span> <span style="color: #000000; font-weight: bold;">then</span>
    <span style="color: #000000; font-weight: bold;">begin</span>
      Leidos<span style="color: #000066;">:</span><span style="color: #000066;">=</span> Stream<span style="color: #000066;">.</span><span style="color: #000000; font-weight: bold;">Read</span><span style="color: #000066;">(</span>B<span style="color: #000066;">,</span><span style="color: #0000ff;">1</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
      <span style="color: #000000; font-weight: bold;">if</span> Leidos <span style="color: #000066;">=</span> <span style="color: #0000ff;">1</span> <span style="color: #000000; font-weight: bold;">then</span>
        <span style="color: #000000; font-weight: bold;">if</span> B <span style="color: #000066;">=</span> <span style="color: #0000cc;">$D8</span> <span style="color: #000000; font-weight: bold;">then</span>
        <span style="color: #000000; font-weight: bold;">begin</span>
          Leidos<span style="color: #000066;">:</span><span style="color: #000066;">=</span> Stream<span style="color: #000066;">.</span><span style="color: #000000; font-weight: bold;">Read</span><span style="color: #000066;">(</span>B<span style="color: #000066;">,</span><span style="color: #0000ff;">1</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
          <span style="color: #000000; font-weight: bold;">if</span> Leidos <span style="color: #000066;">=</span> <span style="color: #0000ff;">1</span> <span style="color: #000000; font-weight: bold;">then</span>
            <span style="color: #000000; font-weight: bold;">if</span> B <span style="color: #000066;">=</span> <span style="color: #0000cc;">$FF</span> <span style="color: #000000; font-weight: bold;">then</span>
            <span style="color: #000000; font-weight: bold;">begin</span>
              <span style="color: #808080; font-style: italic;">// Hasta encontrar la combinacion $FFD8FF</span>
              <span style="color: #000066;">Writeln</span><span style="color: #000066;">(</span><span style="color: #ff0000;">'Encontrada una posible imagen.'</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
              <span style="color: #808080; font-style: italic;">// Guardamos la posicion</span>
              Posicion<span style="color: #000066;">:</span><span style="color: #000066;">=</span> Stream<span style="color: #000066;">.</span><span style="color: #006600;">Position</span><span style="color: #000066;">;</span>
              <span style="color: #000000; font-weight: bold;">try</span>
                <span style="color: #808080; font-style: italic;">// Intentamos recuperar la imagen</span>
                Recover<span style="color: #000066;">(</span>Stream<span style="color: #000066;">,</span>FormatStr<span style="color: #000066;">,</span>Index<span style="color: #000066;">)</span><span style="color: #000066;">;</span>
              <span style="color: #000000; font-weight: bold;">except</span>
                <span style="color: #808080; font-style: italic;">// Si se produce un error lo mostramos, pero no salimos del bucle</span>
                <span style="color: #000000; font-weight: bold;">On</span> E<span style="color: #000066;">:</span> Exception <span style="color: #000000; font-weight: bold;">do</span>
                   <span style="color: #000066;">Writeln</span><span style="color: #000066;">(</span><span style="color: #ff0000;">'Error: '</span> <span style="color: #000066;">+</span> E<span style="color: #000066;">.</span><span style="color: #000000; font-weight: bold;">Message</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
              <span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">;</span>
              <span style="color: #808080; font-style: italic;">// Volvemos a la posicion en la que estabamos</span>
              Stream<span style="color: #000066;">.</span><span style="color: #006600;">Position</span><span style="color: #000066;">:</span><span style="color: #000066;">=</span> Posicion<span style="color: #000066;">;</span>
            <span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">;</span>
        <span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">;</span>
    <span style="color: #000000; font-weight: bold;">end</span> <span style="color: #000000; font-weight: bold;">else</span>
      Leidos<span style="color: #000066;">:</span><span style="color: #000066;">=</span> Stream<span style="color: #000066;">.</span><span style="color: #000000; font-weight: bold;">Read</span><span style="color: #000066;">(</span>B<span style="color: #000066;">,</span><span style="color: #0000ff;">1</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
<span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">;</span>
 
<span style="color: #000000; font-weight: bold;">procedure</span> Buscar<span style="color: #000066;">(</span>Path<span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">string</span><span style="color: #000066;">;</span> <span style="color: #000000; font-weight: bold;">var</span> Index<span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">Integer</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
<span style="color: #000000; font-weight: bold;">var</span>
  SR<span style="color: #000066;">:</span> TSearchRec<span style="color: #000066;">;</span>
  Stream<span style="color: #000066;">:</span> TFileStream<span style="color: #000066;">;</span>
<span style="color: #000000; font-weight: bold;">begin</span>
  <span style="color: #000000; font-weight: bold;">if</span> Path <span style="color: #000066;">=</span> <span style="color: #ff0000;">''</span> <span style="color: #000000; font-weight: bold;">then</span> exit<span style="color: #000066;">;</span>
  <span style="color: #000000; font-weight: bold;">if</span> <span style="color: #000066;">copy</span><span style="color: #000066;">(</span>Path<span style="color: #000066;">,</span> <span style="color: #000066;">Length</span><span style="color: #000066;">(</span>Path<span style="color: #000066;">)</span><span style="color: #000066;">,</span> <span style="color: #0000ff;">1</span><span style="color: #000066;">)</span> &lt;&gt; <span style="color: #ff0000;">'\'</span> <span style="color: #000000; font-weight: bold;">then</span> Path <span style="color: #000066;">:</span><span style="color: #000066;">=</span> Path <span style="color: #000066;">+</span> <span style="color: #ff0000;">'\'</span><span style="color: #000066;">;</span>
  <span style="color: #000000; font-weight: bold;">if</span> <span style="color: #000066;">FindFirst</span><span style="color: #000066;">(</span>Path <span style="color: #000066;">+</span> <span style="color: #ff0000;">'*'</span><span style="color: #000066;">,</span> faDirectory<span style="color: #000066;">,</span> SR<span style="color: #000066;">)</span> <span style="color: #000066;">=</span> <span style="color: #0000ff;">0</span> <span style="color: #000000; font-weight: bold;">then</span>
  <span style="color: #000000; font-weight: bold;">repeat</span>
    <span style="color: #000000; font-weight: bold;">if</span> <span style="color: #000066;">(</span>SR<span style="color: #000066;">.</span><span style="color: #006600;">Name</span> &lt;&gt; <span style="color: #ff0000;">'.'</span><span style="color: #000066;">)</span> <span style="color: #000000; font-weight: bold;">and</span> <span style="color: #000066;">(</span>SR<span style="color: #000066;">.</span><span style="color: #006600;">Name</span> &lt;&gt; <span style="color: #ff0000;">'..'</span><span style="color: #000066;">)</span> <span style="color: #000000; font-weight: bold;">then</span>
      Buscar<span style="color: #000066;">(</span>Path <span style="color: #000066;">+</span> SR<span style="color: #000066;">.</span><span style="color: #006600;">Name</span><span style="color: #000066;">,</span> Index<span style="color: #000066;">)</span><span style="color: #000066;">;</span>
  <span style="color: #000000; font-weight: bold;">until</span> <span style="color: #000066;">FindNext</span><span style="color: #000066;">(</span>SR<span style="color: #000066;">)</span> &lt;&gt; <span style="color: #0000ff;">0</span><span style="color: #000066;">;</span>
  <span style="color: #000066;">FindClose</span><span style="color: #000066;">(</span>SR<span style="color: #000066;">)</span><span style="color: #000066;">;</span>
  <span style="color: #000000; font-weight: bold;">if</span> <span style="color: #000066;">FindFirst</span><span style="color: #000066;">(</span>Path <span style="color: #000066;">+</span> <span style="color: #ff0000;">'thumb*.db'</span><span style="color: #000066;">,</span>faAnyfile<span style="color: #000066;">,</span> SR<span style="color: #000066;">)</span> <span style="color: #000066;">=</span> <span style="color: #0000ff;">0</span> <span style="color: #000000; font-weight: bold;">then</span>
  <span style="color: #000000; font-weight: bold;">repeat</span>
    Stream<span style="color: #000066;">:</span><span style="color: #000066;">=</span> TFileStream<span style="color: #000066;">.</span><span style="color: #006600;">Create</span><span style="color: #000066;">(</span>Path <span style="color: #000066;">+</span> SR<span style="color: #000066;">.</span><span style="color: #006600;">Name</span><span style="color: #000066;">,</span>fmOpenRead<span style="color: #000066;">)</span><span style="color: #000066;">;</span>
    <span style="color: #000000; font-weight: bold;">try</span>
      <span style="color: #000066;">Writeln</span><span style="color: #000066;">(</span><span style="color: #ff0000;">'Explorando el archivo: '</span> <span style="color: #000066;">+</span> Path <span style="color: #000066;">+</span> SR<span style="color: #000066;">.</span><span style="color: #006600;">Name</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
      Scanfile<span style="color: #000066;">(</span>Stream<span style="color: #000066;">,</span><span style="color: #000066;">ParamStr</span><span style="color: #000066;">(</span><span style="color: #0000ff;">2</span><span style="color: #000066;">)</span><span style="color: #000066;">,</span>Index<span style="color: #000066;">)</span><span style="color: #000066;">;</span>
    <span style="color: #000000; font-weight: bold;">finally</span>
      Stream<span style="color: #000066;">.</span><span style="color: #006600;">Free</span><span style="color: #000066;">;</span>
    <span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">;</span>
  <span style="color: #000000; font-weight: bold;">until</span> <span style="color: #000066;">FindNext</span><span style="color: #000066;">(</span>SR<span style="color: #000066;">)</span> &lt;&gt; <span style="color: #0000ff;">0</span><span style="color: #000066;">;</span>
  <span style="color: #000066;">FindClose</span><span style="color: #000066;">(</span>SR<span style="color: #000066;">)</span><span style="color: #000066;">;</span>
<span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">;</span>
 
<span style="color: #000000; font-weight: bold;">var</span>
  i<span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">Integer</span><span style="color: #000066;">;</span>
<span style="color: #000000; font-weight: bold;">begin</span>
  <span style="color: #000000; font-weight: bold;">if</span> ParamCount <span style="color: #000066;">=</span> <span style="color: #0000ff;">2</span> <span style="color: #000000; font-weight: bold;">then</span>
  <span style="color: #000000; font-weight: bold;">try</span>
    <span style="color: #808080; font-style: italic;">// Comprobamos que se pueden crear archivos en la ruta indicada</span>
    TFileStream<span style="color: #000066;">.</span><span style="color: #006600;">Create</span><span style="color: #000066;">(</span><span style="color: #000066;">Format</span><span style="color: #000066;">(</span><span style="color: #000066;">ParamStr</span><span style="color: #000066;">(</span><span style="color: #0000ff;">2</span><span style="color: #000066;">)</span><span style="color: #000066;">,</span><span style="color: #000066;">[</span><span style="color: #0000ff;">0</span><span style="color: #000066;">]</span><span style="color: #000066;">)</span><span style="color: #000066;">,</span>fmCreate<span style="color: #000066;">)</span><span style="color: #000066;">.</span><span style="color: #006600;">Free</span><span style="color: #000066;">;</span>
    <span style="color: #808080; font-style: italic;">// Borramos el archivo de prueba</span>
    <span style="color: #000066;">DeleteFile</span><span style="color: #000066;">(</span><span style="color: #000066;">Format</span><span style="color: #000066;">(</span><span style="color: #000066;">ParamStr</span><span style="color: #000066;">(</span><span style="color: #0000ff;">2</span><span style="color: #000066;">)</span><span style="color: #000066;">,</span><span style="color: #000066;">[</span><span style="color: #0000ff;">0</span><span style="color: #000066;">]</span><span style="color: #000066;">)</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
    <span style="color: #808080; font-style: italic;">// Buscamos en la ruta indicada</span>
    i<span style="color: #000066;">:</span><span style="color: #000066;">=</span> <span style="color: #0000ff;">0</span><span style="color: #000066;">;</span>
    Buscar<span style="color: #000066;">(</span><span style="color: #000066;">ParamStr</span><span style="color: #000066;">(</span><span style="color: #0000ff;">1</span><span style="color: #000066;">)</span><span style="color: #000066;">,</span>i<span style="color: #000066;">)</span><span style="color: #000066;">;</span>
  <span style="color: #000000; font-weight: bold;">except</span>
    <span style="color: #808080; font-style: italic;">// Si se produce un error, lo mostramos</span>
    <span style="color: #000000; font-weight: bold;">On</span> E<span style="color: #000066;">:</span> Exception <span style="color: #000000; font-weight: bold;">do</span>
      <span style="color: #000066;">Writeln</span><span style="color: #000066;">(</span><span style="color: #ff0000;">'Error: '</span> <span style="color: #000066;">+</span> E<span style="color: #000066;">.</span><span style="color: #000000; font-weight: bold;">Message</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
  <span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">;</span>
<span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">.</span></pre></div>
<p>Por ejemplo:</p>
<p>Fisgon C:\ %d.jpg</p>
<p>Bueno, creo que con esto ya hay bastante para entretenerse durante un tiempo. Pero si con esto no es suficiente, también puedes usar este mismo código para mirar dentro de los propios archivos jpeg. Alguno de ellos además de la imagen que muestran, incluyen una miniatura que se utiliza a modo de "vista previa". Y lo curioso en este caso, es que algunos programas al modificar la imagen no cambian la miniatura. Así nos podemos encontrar con fotos recortadas o con partes borradas, y sin embargo una miniatura de la imagen sin manipular.</p>
</div></div></div>    <footer>
        <ul class="links list-inline"><li class="comment_forbidden first last"></li>
</ul>  </footer>
    </article>

</section>
  </div>
    </section>

    
  </div>
</div>

  <footer class="footer container">
      <div class="region region-footer">
    <section id="block-menu-menu-enlaces" class="block block-menu clearfix">

        <h2 class="block-title">Enlaces interesantes</h2>
    
  <ul class="menu nav"><li class="first leaf"><a href="http://www.cadetill.com" title="">Cadetill</a></li>
<li class="leaf"><a href="http://www.delphiaccess.com/forum" title="">DelphiAccess</a></li>
<li class="leaf"><a href="http://www.delphispano.com/" title="">Delphispano</a></li>
<li class="leaf"><a href="http://egostar.delphiaccess.com/" title="">Egostar</a></li>
<li class="leaf"><a href="http://jachguate.wordpress.com/" title="">Jachguate</a></li>
<li class="leaf"><a href="http://neftali.clubdelphi.com/" title="">Neftali</a></li>
<li class="leaf"><a href="http://elpoli.delphiaccess.com/" title="">Poliburro</a></li>
<li class="leaf"><a href="http://theroadtodelphi.wordpress.com/" title="">Rodrigo Ruz</a></li>
<li class="last leaf"><a href="http://salvador.oversistemas.com/" title="">Salvador Gomez</a></li>
</ul>
</section>
<section id="block-block-1" class="block block-block clearfix">

      
  <p>copyright (c) 2007 - 2016 Domingo Seoane</p>

</section>
  </div>
  </footer>
  <script src="/sites/delphi.jmrds.com/themes/bootstrap/js/bootstrap.js?"></script>
</body>
</html>
