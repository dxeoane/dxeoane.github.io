<!DOCTYPE html>
<html lang="es" dir="ltr" prefix="content: http://purl.org/rss/1.0/modules/content/ dc: http://purl.org/dc/terms/ foaf: http://xmlns.com/foaf/0.1/ og: http://ogp.me/ns# rdfs: http://www.w3.org/2000/01/rdf-schema# sioc: http://rdfs.org/sioc/ns# sioct: http://rdfs.org/sioc/types# skos: http://www.w3.org/2004/02/skos/core# xsd: http://www.w3.org/2001/XMLSchema#">
<head>
  <link rel="profile" href="http://www.w3.org/1999/xhtml/vocab" />
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<link rel="shortcut icon" href="/sites/delphi.jmrds.com/themes/bootstrap/favicon.ico" type="image/vnd.microsoft.icon" />
<link rel="shortlink" href="/node/35" />
<link rel="canonical" href="/node/35" />
<meta name="Generator" content="Drupal 7 (http://drupal.org)" />
  <title>Compartir objetos del kernel entre procesos (SECURITY_DESCRIPTOR) | La web de Seoane</title>
  <style>
@import url("/modules/system/system.base.css?");
</style>
<style>
@import url("/modules/field/theme/field.css?");
@import url("/modules/node/node.css?");
</style>
<style>
@import url("/sites/delphi.jmrds.com/modules/geshifilter/geshifilter.css?");
</style>
<link type="text/css" rel="stylesheet" href="//cdn.jsdelivr.net/bootstrap/3.3.5/css/bootstrap.css" media="all" />
<style>
@import url("/sites/delphi.jmrds.com/themes/bootstrap/css/3.3.5/overrides.min.css?");
</style>
  <!-- HTML5 element support for IE6-8 -->
  <!--[if lt IE 9]>
    <script src="https://cdn.jsdelivr.net/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
  <![endif]-->
  <script src="/sites/delphi.jmrds.com/modules/jquery_update/replace/jquery/1.10/jquery.min.js?v=1.10.2"></script>
<script src="/misc/jquery.once.js?v=1.2"></script>
<script src="/misc/drupal.js?"></script>
<script src="//cdn.jsdelivr.net/bootstrap/3.3.5/js/bootstrap.js"></script>
<script src="/sites/delphi.jmrds.com/files/languages/es_sB9mP1iixuFRbyZKZVySK7xrSW_2-LRj1vNEXyqwOu8.js?"></script>
<script>jQuery.extend(Drupal.settings, {"basePath":"\/","pathPrefix":"","ajaxPageState":{"theme":"bootstrap","theme_token":"ESUZFZbVmP0dNNu-Gx16CTX-EK4bQR8JnNGb9-R26zw","js":{"sites\/delphi.jmrds.com\/themes\/bootstrap\/js\/bootstrap.js":1,"sites\/delphi.jmrds.com\/modules\/jquery_update\/replace\/jquery\/1.10\/jquery.min.js":1,"misc\/jquery.once.js":1,"misc\/drupal.js":1,"\/\/cdn.jsdelivr.net\/bootstrap\/3.3.5\/js\/bootstrap.js":1,"public:\/\/languages\/es_sB9mP1iixuFRbyZKZVySK7xrSW_2-LRj1vNEXyqwOu8.js":1},"css":{"modules\/system\/system.base.css":1,"modules\/field\/theme\/field.css":1,"modules\/node\/node.css":1,"sites\/delphi.jmrds.com\/modules\/geshifilter\/geshifilter.css":1,"\/\/cdn.jsdelivr.net\/bootstrap\/3.3.5\/css\/bootstrap.css":1,"sites\/delphi.jmrds.com\/themes\/bootstrap\/css\/3.3.5\/overrides.min.css":1}},"bootstrap":{"anchorsFix":"0","anchorsSmoothScrolling":"0","formHasError":1,"popoverEnabled":"1","popoverOptions":{"animation":1,"html":0,"placement":"right","selector":"","trigger":"click","triggerAutoclose":1,"title":"","content":"","delay":0,"container":"body"},"tooltipEnabled":"1","tooltipOptions":{"animation":1,"html":0,"placement":"auto left","selector":"","trigger":"hover focus","delay":0,"container":"body"}}});</script>
</head>
<body class="html not-front not-logged-in no-sidebars page-node page-node- page-node-35 node-type-article">
  <div id="skip-link">
    <a href="#main-content" class="element-invisible element-focusable">Pasar al contenido principal</a>
  </div>
    <header id="navbar" role="banner" class="navbar container navbar-default">
  <div class="container">
    <div class="navbar-header">
              <a class="logo navbar-btn pull-left" href="/" title="Inicio">
          <img src="/sites/delphi.jmrds.com/themes/bootstrap/logo.png" alt="Inicio" />
        </a>
      
              <a class="name navbar-brand" href="/" title="Inicio">La web de Seoane</a>
      
              <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#navbar-collapse">
          <span class="sr-only">Toggle navigation</span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
          </div>

          <div class="navbar-collapse collapse" id="navbar-collapse">
        <nav role="navigation">
                      <ul class="menu nav navbar-nav"><li class="first leaf"><a href="/" title="">Inicio</a></li>
<li class="last leaf"><a href="/node/26" title="">Contacto</a></li>
</ul>                                      </nav>
      </div>
      </div>
</header>

<div class="main-container container">

  <header role="banner" id="page-header">
    
      </header> <!-- /#page-header -->

  <div class="row">

    
    <section class="col-sm-12">
                  <a id="main-content"></a>
                    <h1 class="page-header">Compartir objetos del kernel entre procesos (SECURITY_DESCRIPTOR)</h1>
                                                          <div class="region region-content">
    <section id="block-system-main" class="block block-system clearfix">

      
  <article id="node-35" class="node node-article node-promoted clearfix" about="/node/35" typeof="sioc:Item foaf:Document">
    <header>
            <span property="dc:title" content="Compartir objetos del kernel entre procesos (SECURITY_DESCRIPTOR)" class="rdf-meta element-hidden"></span><span property="sioc:num_replies" content="1" datatype="xsd:integer" class="rdf-meta element-hidden"></span>        <span class="submitted">
            <span property="dc:date dc:created" content="2007-08-17T12:08:43+02:00" datatype="xsd:dateTime" rel="sioc:has_creator">Enviado por <span class="username" xml:lang="" about="/user/1" typeof="sioc:UserAccount" property="foaf:name" datatype="">admin</span> el Vie, 08/17/2007 - 12:08</span>    </span>
      </header>
    <div class="field field-name-body field-type-text-with-summary field-label-hidden"><div class="field-items"><div class="field-item even" property="content:encoded"><p>En el siguiente ejemplo demuestro como crear un descriptor de seguridad (security descriptor) para permitir el acceso a un objeto del kernel a todos los usuarios, de esta manera puede ser compartido por procesos pertenecientes a diferentes cuentas de usuario. Esto puede resultar útil, por ejemplo, cuando un servicio tiene que compartir un objeto con una aplicación que se esta ejecutando bajo una cuenta de usuario diferente.</p>
<!--break--><p>La siguiente función inicializa la variable del tipo SECURITY_DESCRIPTOR, que se le pasa como parámetro, con una DACL que permite a todos los usuarios identificados los accesos GERERIC_READ, GENERIC_WRITE y GENERIC_EXECUTE. La función devuelve <b>nil</b> si falla o un puntero si termina con éxito. Este puntero debe ser liberado, una vez lo hemos utilizado para crear el nuevo objeto, llamando a la función FreeRestridtedSD.</p>
<div class="geshifilter">
<pre class="delphi geshifilter-delphi" style="font-family:monospace;"><span style="color: #000000; font-weight: bold;">const</span>
  SECURITY_NT_AUTHORITY<span style="color: #000066;">:</span> TSIDIdentifierAuthority <span style="color: #000066;">=</span> <span style="color: #000066;">(</span>Value<span style="color: #000066;">:</span> <span style="color: #000066;">(</span><span style="color: #0000ff;">0</span><span style="color: #000066;">,</span> <span style="color: #0000ff;">0</span><span style="color: #000066;">,</span> <span style="color: #0000ff;">0</span><span style="color: #000066;">,</span> <span style="color: #0000ff;">0</span><span style="color: #000066;">,</span> <span style="color: #0000ff;">0</span><span style="color: #000066;">,</span> <span style="color: #0000ff;">5</span><span style="color: #000066;">)</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
  SECURITY_AUTHENTICATED_USER_RID <span style="color: #000066;">=</span> <span style="color: #0000ff;">11</span><span style="color: #000066;">;</span>
  ACL_REVISION  <span style="color: #000066;">=</span> <span style="color: #0000ff;">2</span><span style="color: #000066;">;</span>
 
<span style="color: #000000; font-weight: bold;">type</span>
  ACE_HEADER <span style="color: #000066;">=</span> <span style="color: #000000; font-weight: bold;">record</span>
    AceType<span style="color: #000066;">,</span>
    AceFlags<span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">BYTE</span><span style="color: #000066;">;</span>
    AceSize<span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">WORD</span><span style="color: #000066;">;</span>
  <span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">;</span>
 
  PACE_HEADER <span style="color: #000066;">=</span> <span style="color: #000066;">^</span>ACE_HEADER<span style="color: #000066;">;</span>
 
  ACCESS_ALLOWED_ACE <span style="color: #000066;">=</span> <span style="color: #000000; font-weight: bold;">record</span>
    Header<span style="color: #000066;">:</span> ACE_HEADER<span style="color: #000066;">;</span>
    Mask<span style="color: #000066;">:</span> ACCESS_MASK<span style="color: #000066;">;</span>
    SidStart<span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">DWORD</span><span style="color: #000066;">;</span>
  <span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">;</span>
 
<span style="color: #000000; font-weight: bold;">function</span> BuildRestrictedSD<span style="color: #000066;">(</span>pSD<span style="color: #000066;">:</span> PSECURITY_DESCRIPTOR<span style="color: #000066;">)</span><span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">Pointer</span><span style="color: #000066;">;</span>
<span style="color: #000000; font-weight: bold;">var</span>
  dwAclLength<span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">DWORD</span><span style="color: #000066;">;</span>
  pAuthenticatedUsersSID<span style="color: #000066;">:</span> PSID<span style="color: #000066;">;</span>
  pDACL<span style="color: #000066;">:</span> PACL<span style="color: #000066;">;</span>
  bResult<span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">BOOL</span><span style="color: #000066;">;</span>
  siaNT<span style="color: #000066;">:</span> SID_IDENTIFIER_AUTHORITY<span style="color: #000066;">;</span>
<span style="color: #000000; font-weight: bold;">begin</span>
  pAuthenticatedUsersSID<span style="color: #000066;">:</span><span style="color: #000066;">=</span> <span style="color: #000000; font-weight: bold;">nil</span><span style="color: #000066;">;</span>
  pDACL<span style="color: #000066;">:</span><span style="color: #000066;">=</span> <span style="color: #000000; font-weight: bold;">nil</span><span style="color: #000066;">;</span>
  bResult<span style="color: #000066;">:</span><span style="color: #000066;">=</span> <span style="color: #000000; font-weight: bold;">FALSE</span><span style="color: #000066;">;</span>
  siaNT<span style="color: #000066;">:</span><span style="color: #000066;">=</span> SECURITY_NT_AUTHORITY<span style="color: #000066;">;</span>
  <span style="color: #000000; font-weight: bold;">if</span> InitializeSecurityDescriptor<span style="color: #000066;">(</span>pSD<span style="color: #000066;">,</span>SECURITY_DESCRIPTOR_REVISION<span style="color: #000066;">)</span> <span style="color: #000000; font-weight: bold;">then</span>
    <span style="color: #000000; font-weight: bold;">if</span> AllocateAndInitializeSid<span style="color: #000066;">(</span>siaNT<span style="color: #000066;">,</span> <span style="color: #0000ff;">1</span><span style="color: #000066;">,</span> SECURITY_AUTHENTICATED_USER_RID<span style="color: #000066;">,</span>
      <span style="color: #0000ff;">0</span><span style="color: #000066;">,</span> <span style="color: #0000ff;">0</span><span style="color: #000066;">,</span> <span style="color: #0000ff;">0</span><span style="color: #000066;">,</span> <span style="color: #0000ff;">0</span><span style="color: #000066;">,</span> <span style="color: #0000ff;">0</span><span style="color: #000066;">,</span> <span style="color: #0000ff;">0</span><span style="color: #000066;">,</span> <span style="color: #0000ff;">0</span><span style="color: #000066;">,</span>pAuthenticatedUsersSID<span style="color: #000066;">)</span> <span style="color: #000000; font-weight: bold;">then</span>
    <span style="color: #000000; font-weight: bold;">begin</span>
      dwAclLength<span style="color: #000066;">:</span><span style="color: #000066;">=</span> <span style="color: #000066;">Sizeof</span><span style="color: #000066;">(</span>ACL<span style="color: #000066;">)</span>
            <span style="color: #000066;">+</span> <span style="color: #000066;">Sizeof</span><span style="color: #000066;">(</span>ACCESS_ALLOWED_ACE<span style="color: #000066;">)</span> <span style="color: #000066;">-</span> <span style="color: #000066;">Sizeof</span><span style="color: #000066;">(</span><span style="color: #000066; font-weight: bold;">DWORD</span><span style="color: #000066;">)</span>
            <span style="color: #000066;">+</span> GetLengthSid<span style="color: #000066;">(</span>pAuthenticatedUsersSID<span style="color: #000066;">)</span><span style="color: #000066;">;</span>
      <span style="color: #000066;">GetMem</span><span style="color: #000066;">(</span>pDACL<span style="color: #000066;">,</span>dwAclLength<span style="color: #000066;">)</span><span style="color: #000066;">;</span>
      <span style="color: #000000; font-weight: bold;">if</span> InitializeAcl<span style="color: #000066;">(</span>pDACL<span style="color: #000066;">^</span><span style="color: #000066;">,</span> dwAclLength<span style="color: #000066;">,</span> ACL_REVISION<span style="color: #000066;">)</span> <span style="color: #000000; font-weight: bold;">then</span>
        <span style="color: #000000; font-weight: bold;">if</span> AddAccessAllowedAce<span style="color: #000066;">(</span>pDACL<span style="color: #000066;">^</span><span style="color: #000066;">,</span> ACL_REVISION<span style="color: #000066;">,</span>
          GENERIC_READ <span style="color: #000000; font-weight: bold;">or</span> GENERIC_WRITE <span style="color: #000000; font-weight: bold;">or</span> GENERIC_EXECUTE<span style="color: #000066;">,</span>
          pAuthenticatedUsersSID<span style="color: #000066;">)</span> <span style="color: #000000; font-weight: bold;">then</span>
          <span style="color: #000000; font-weight: bold;">if</span> SetSecurityDescriptorDacl<span style="color: #000066;">(</span>pSD<span style="color: #000066;">,</span> <span style="color: #000000; font-weight: bold;">TRUE</span><span style="color: #000066;">,</span> pDACL<span style="color: #000066;">,</span> <span style="color: #000000; font-weight: bold;">FALSE</span><span style="color: #000066;">)</span> <span style="color: #000000; font-weight: bold;">then</span>
            bResult<span style="color: #000066;">:</span><span style="color: #000066;">=</span> <span style="color: #000000; font-weight: bold;">TRUE</span><span style="color: #000066;">;</span>
      <span style="color: #000000; font-weight: bold;">if</span> pAuthenticatedUsersSID &lt;&gt; <span style="color: #000000; font-weight: bold;">nil</span> <span style="color: #000000; font-weight: bold;">then</span>
        FreeSid<span style="color: #000066;">(</span>pAuthenticatedUsersSID<span style="color: #000066;">)</span><span style="color: #000066;">;</span>
      <span style="color: #000000; font-weight: bold;">if</span> <span style="color: #000000; font-weight: bold;">not</span> bResult <span style="color: #000000; font-weight: bold;">then</span>
        <span style="color: #000000; font-weight: bold;">if</span> pDACL &lt;&gt; <span style="color: #000000; font-weight: bold;">nil</span> <span style="color: #000000; font-weight: bold;">then</span>
        <span style="color: #000000; font-weight: bold;">begin</span>
          <span style="color: #000066;">FreeMem</span><span style="color: #000066;">(</span>pDACL<span style="color: #000066;">)</span><span style="color: #000066;">;</span>
          pDACL<span style="color: #000066;">:</span><span style="color: #000066;">=</span> <span style="color: #000000; font-weight: bold;">nil</span><span style="color: #000066;">;</span>
        <span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">;</span>
    <span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">;</span>
  Result<span style="color: #000066;">:</span><span style="color: #000066;">=</span> pDACL<span style="color: #000066;">;</span>
<span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">;</span></pre></div>
<p>Ahora vamos a demostrar como, utilizando la función anterior, podemos crear un mutex que puede ser compartido entre distintos usuarios:</p>
<div class="geshifilter">
<pre class="delphi geshifilter-delphi" style="font-family:monospace;"><span style="color: #000000; font-weight: bold;">function</span> CrearMutex<span style="color: #000066;">(</span>Nombre<span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">String</span><span style="color: #000066;">)</span><span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">THandle</span><span style="color: #000066;">;</span>
<span style="color: #000000; font-weight: bold;">var</span>
  sa<span style="color: #000066;">:</span> SECURITY_ATTRIBUTES<span style="color: #000066;">;</span>
  sd<span style="color: #000066;">:</span> SECURITY_DESCRIPTOR<span style="color: #000066;">;</span>
  ptr<span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">Pointer</span><span style="color: #000066;">;</span>
<span style="color: #000000; font-weight: bold;">begin</span>
  Result<span style="color: #000066;">:</span><span style="color: #000066;">=</span> <span style="color: #0000ff;">0</span><span style="color: #000066;">;</span>
  ptr<span style="color: #000066;">:</span><span style="color: #000066;">=</span> BuildRestrictedSD<span style="color: #000066;">(</span><span style="color: #000066;">@</span>sd<span style="color: #000066;">)</span><span style="color: #000066;">;</span>
  <span style="color: #000000; font-weight: bold;">if</span> ptr &lt;&gt; <span style="color: #000000; font-weight: bold;">nil</span> <span style="color: #000000; font-weight: bold;">then</span>
  <span style="color: #000000; font-weight: bold;">try</span>
    sa<span style="color: #000066;">.</span><span style="color: #006600;">nLength</span><span style="color: #000066;">:</span><span style="color: #000066;">=</span> <span style="color: #000066;">Sizeof</span><span style="color: #000066;">(</span>sa<span style="color: #000066;">)</span><span style="color: #000066;">;</span>
    sa<span style="color: #000066;">.</span><span style="color: #006600;">lpSecurityDescriptor</span><span style="color: #000066;">:</span><span style="color: #000066;">=</span> <span style="color: #000066;">@</span>sd<span style="color: #000066;">;</span>
    sa<span style="color: #000066;">.</span><span style="color: #006600;">bInheritHandle</span><span style="color: #000066;">:</span><span style="color: #000066;">=</span> <span style="color: #000000; font-weight: bold;">FALSE</span><span style="color: #000066;">;</span>
    Result<span style="color: #000066;">:</span><span style="color: #000066;">=</span> CreateMutex<span style="color: #000066;">(</span><span style="color: #000066;">@</span>sa<span style="color: #000066;">,</span> <span style="color: #000000; font-weight: bold;">TRUE</span><span style="color: #000066;">,</span> <span style="color: #000066; font-weight: bold;">PChar</span><span style="color: #000066;">(</span>Nombre<span style="color: #000066;">)</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
    <span style="color: #000000; font-weight: bold;">if</span> Result &lt;&gt; <span style="color: #0000ff;">0</span> <span style="color: #000000; font-weight: bold;">then</span>
      ReleaseMutex<span style="color: #000066;">(</span>Result<span style="color: #000066;">)</span><span style="color: #000066;">;</span>
  <span style="color: #000000; font-weight: bold;">finally</span>
    <span style="color: #000066;">FreeMem</span><span style="color: #000066;">(</span>ptr<span style="color: #000066;">)</span><span style="color: #000066;">;</span>
  <span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">;</span>
<span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">;</span></pre></div>
</div></div></div>    <footer>
        <ul class="links list-inline"><li class="comment_forbidden first last"></li>
</ul>  </footer>
    <div id="comments" class="comment-wrapper">
          <h2 class="title">Comentarios</h2>
      
  <a id="comment-19"></a>
<div class="comment comment-by-anonymous clearfix" about="/comment/19#comment-19" typeof="sioc:Post sioct:Comment">
  
  
    <h3 property="dc:title" datatype=""><a href="/comment/19#comment-19" class="permalink" rel="bookmark">Muy interesante este</a></h3>
  
  <div class="submitted">
    <a href="/comment/19#comment-19" class="permalink" rel="bookmark">Enlace permanente</a>    <span property="dc:date dc:created" content="2007-09-19T20:37:41+02:00" datatype="xsd:dateTime" rel="sioc:has_creator">Enviado por <span class="username" xml:lang="" typeof="sioc:UserAccount" property="foaf:name" datatype="">fer21unmsm (no verificado)</span> el Mié, 09/19/2007 - 20:37</span>  </div>

  <div class="content">
    <span rel="sioc:reply_of" resource="/node/35" class="rdf-meta element-hidden"></span><div class="field field-name-comment-body field-type-text-long field-label-hidden"><div class="field-items"><div class="field-item even" property="content:encoded"><p>Muy interesante este código!!!, lo probaré.</p>
<p>saludos seoane</p>
</div></div></div>      </div>

  <ul class="links list-inline"><li class="comment_forbidden first last"></li>
</ul></div>

  </div>
</article>

</section>
  </div>
    </section>

    
  </div>
</div>

  <script src="/sites/delphi.jmrds.com/themes/bootstrap/js/bootstrap.js?"></script>
</body>
</html>
