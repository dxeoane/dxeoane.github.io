<!DOCTYPE html>
<html lang="es" dir="ltr" prefix="content: http://purl.org/rss/1.0/modules/content/ dc: http://purl.org/dc/terms/ foaf: http://xmlns.com/foaf/0.1/ og: http://ogp.me/ns# rdfs: http://www.w3.org/2000/01/rdf-schema# sioc: http://rdfs.org/sioc/ns# sioct: http://rdfs.org/sioc/types# skos: http://www.w3.org/2004/02/skos/core# xsd: http://www.w3.org/2001/XMLSchema#">
<head>
  <link rel="profile" href="http://www.w3.org/1999/xhtml/vocab" />
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<link rel="shortcut icon" href="/sites/delphi.jmrds.com/themes/bootstrap/favicon.ico" type="image/vnd.microsoft.icon" />
<link rel="shortlink" href="/node/27" />
<link rel="canonical" href="/node/27" />
<meta name="Generator" content="Drupal 7 (http://drupal.org)" />
  <title>Recuperar imagenes jpeg | La web de Seoane</title>
  <style>
@import url("/modules/system/system.base.css?");
</style>
<style>
@import url("/modules/field/theme/field.css?");
@import url("/modules/node/node.css?");
</style>
<style>
@import url("/sites/delphi.jmrds.com/modules/geshifilter/geshifilter.css?");
</style>
<link type="text/css" rel="stylesheet" href="//cdn.jsdelivr.net/bootstrap/3.3.5/css/bootstrap.css" media="all" />
<style>
@import url("/sites/delphi.jmrds.com/themes/bootstrap/css/3.3.5/overrides.min.css?");
</style>
  <!-- HTML5 element support for IE6-8 -->
  <!--[if lt IE 9]>
    <script src="https://cdn.jsdelivr.net/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
  <![endif]-->
  <script src="/sites/delphi.jmrds.com/modules/jquery_update/replace/jquery/1.10/jquery.min.js?v=1.10.2"></script>
<script src="/misc/jquery.once.js?v=1.2"></script>
<script src="/misc/drupal.js?"></script>
<script src="//cdn.jsdelivr.net/bootstrap/3.3.5/js/bootstrap.js"></script>
<script src="/sites/delphi.jmrds.com/files/languages/es_sB9mP1iixuFRbyZKZVySK7xrSW_2-LRj1vNEXyqwOu8.js?"></script>
<script>jQuery.extend(Drupal.settings, {"basePath":"\/","pathPrefix":"","ajaxPageState":{"theme":"bootstrap","theme_token":"3zlVbyvNrl-MBVy2nzXGpcDBct_mtJl1BS31asL-J1c","js":{"sites\/delphi.jmrds.com\/themes\/bootstrap\/js\/bootstrap.js":1,"sites\/delphi.jmrds.com\/modules\/jquery_update\/replace\/jquery\/1.10\/jquery.min.js":1,"misc\/jquery.once.js":1,"misc\/drupal.js":1,"\/\/cdn.jsdelivr.net\/bootstrap\/3.3.5\/js\/bootstrap.js":1,"public:\/\/languages\/es_sB9mP1iixuFRbyZKZVySK7xrSW_2-LRj1vNEXyqwOu8.js":1},"css":{"modules\/system\/system.base.css":1,"modules\/field\/theme\/field.css":1,"modules\/node\/node.css":1,"sites\/delphi.jmrds.com\/modules\/geshifilter\/geshifilter.css":1,"\/\/cdn.jsdelivr.net\/bootstrap\/3.3.5\/css\/bootstrap.css":1,"sites\/delphi.jmrds.com\/themes\/bootstrap\/css\/3.3.5\/overrides.min.css":1}},"bootstrap":{"anchorsFix":"0","anchorsSmoothScrolling":"0","formHasError":1,"popoverEnabled":"1","popoverOptions":{"animation":1,"html":0,"placement":"right","selector":"","trigger":"click","triggerAutoclose":1,"title":"","content":"","delay":0,"container":"body"},"tooltipEnabled":"1","tooltipOptions":{"animation":1,"html":0,"placement":"auto left","selector":"","trigger":"hover focus","delay":0,"container":"body"}}});</script>
</head>
<body class="html not-front not-logged-in no-sidebars page-node page-node- page-node-27 node-type-article">
  <div id="skip-link">
    <a href="#main-content" class="element-invisible element-focusable">Pasar al contenido principal</a>
  </div>
    <header id="navbar" role="banner" class="navbar container navbar-default">
  <div class="container">
    <div class="navbar-header">
              <a class="logo navbar-btn pull-left" href="/" title="Inicio">
          <img src="/sites/delphi.jmrds.com/themes/bootstrap/logo.png" alt="Inicio" />
        </a>
      
              <a class="name navbar-brand" href="/" title="Inicio">La web de Seoane</a>
      
              <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#navbar-collapse">
          <span class="sr-only">Toggle navigation</span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
          </div>

          <div class="navbar-collapse collapse" id="navbar-collapse">
        <nav role="navigation">
                      <ul class="menu nav navbar-nav"><li class="first leaf"><a href="/" title="">Inicio</a></li>
<li class="leaf"><a href="/search/node" title="">Buscar</a></li>
<li class="leaf"><a href="/rss.xml" title="">RSS</a></li>
<li class="leaf"><a href="/node/26" title="">Contacto</a></li>
<li class="last leaf"><a href="/user/login" title="">Login</a></li>
</ul>                                      </nav>
      </div>
      </div>
</header>

<div class="main-container container">

  <header role="banner" id="page-header">
    
      </header> <!-- /#page-header -->

  <div class="row">

    
    <section class="col-sm-12">
                  <a id="main-content"></a>
                    <h1 class="page-header">Recuperar imagenes jpeg</h1>
                                                          <div class="region region-content">
    <section id="block-system-main" class="block block-system clearfix">

      
  <article id="node-27" class="node node-article node-promoted clearfix" about="/node/27" typeof="sioc:Item foaf:Document">
    <header>
            <span property="dc:title" content="Recuperar imagenes jpeg" class="rdf-meta element-hidden"></span><span property="sioc:num_replies" content="2" datatype="xsd:integer" class="rdf-meta element-hidden"></span>        <span class="submitted">
            <span property="dc:date dc:created" content="2007-05-18T16:07:42+02:00" datatype="xsd:dateTime" rel="sioc:has_creator">Enviado por <span class="username" xml:lang="" about="/user/1" typeof="sioc:UserAccount" property="foaf:name" datatype="">admin</span> el Vie, 05/18/2007 - 16:07</span>    </span>
      </header>
    <div class="field field-name-body field-type-text-with-summary field-label-hidden"><div class="field-items"><div class="field-item even" property="content:encoded"><p>El siguiente programa sirve para recuperar imágenes jpeg borradas. Se basa en la suposición de que la imagen que se quiere recuperar esta guardada en clusteres consecutivos dentro del disco duro. Esta suposición no siempre tiene que ser cierta, pero si lo es en la mayoría de los casos. Así que si hay suerte, podremos recuperar la imagen.</p>
<!--break--><p>El proceso es sencillo, examinamos cluster a cluster, buscando uno cuyos tres primeros bytes coincidan con los tres primeros bytes de un archivo jpeg. Estos bytes, para cualquier archivo jpeg, son FFD8FF. Una vez que encontramos esa coincidencia intentamos reconstruir la imagen a partir de ese cluster y los siguientes. Una vez finalizada la reconstrucción, tanto si tuvo éxito como si no, regresamos hasta el cluster siguiente y continuamos la búsqueda.</p>
<p>El programa necesita que se le pasen al menos dos parámetros, el archivo de entrada y la plantilla que sirve para dar nombre a las imágenes recuperadas. También se puede incluir un tercer parámetro que indica el tamaño del cluster a utilizar.</p>
<p>El archivo de entrada puede ser la imagen de un disco (una imagen .iso, o una imagen de un disco duro), o puede ser directamente el propio disco. Para este ultimo caso utilizaremos el siguiente parámetro \\.\F: donde F es la letra que identifica el disco.</p>
<p>La plantilla tiene que incluir "%d", esta variable sera sustituida por un valor que se va incrementando. Por ejemplo, si queremos guardar las imágenes en C:\Temp utilizaremos C:\Temp\%d.jpg</p>
<p>El ultimo parámetro sirve para determinar el tamaño del cluster. El tamaño que se utilizara es igual al valor del parámetro multiplicado por 512. El valor mínimo es 1, en algunas memorias usb deberías de usar 2, en los discos duros un valor de 8 podría ser el adecuado. Cuanto mayor es el tamaño mas rápida es la búsqueda, pero si indicamos un tamaño demasiado grande el programa no funciona. Así que lo mejor es averiguar el tamaño del cluster del disco duro a examinar, o utilizar 1 que siempre funciona. Si no se usa este parámetro el valor por defecto es 1.</p>
<p>El código es el siguiente (es una aplicación de consola):</p>
<div class="geshifilter">
<pre class="delphi geshifilter-delphi" style="font-family:monospace;"><span style="color: #000000; font-weight: bold;">program</span> recover<span style="color: #000066;">;</span>
 
<span style="color: #008000; font-style: italic;">{$APPTYPE CONSOLE}</span>
 
<span style="color: #000000; font-weight: bold;">uses</span> Windows<span style="color: #000066;">,</span> SysUtils<span style="color: #000066;">,</span> Classes<span style="color: #000066;">;</span>
 
<span style="color: #000000; font-weight: bold;">procedure</span> RecuperarJpeg<span style="color: #000066;">(</span>Origen<span style="color: #000066;">:</span> TStream<span style="color: #000066;">;</span> FormatStr<span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">String</span><span style="color: #000066;">;</span> <span style="color: #000000; font-weight: bold;">var</span> Index<span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">Integer</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
<span style="color: #000000; font-weight: bold;">var</span>
  Destino<span style="color: #000066;">:</span> TMemoryStream<span style="color: #000066;">;</span>
  Buffer<span style="color: #000066;">:</span> <span style="color: #000000; font-weight: bold;">array</span><span style="color: #000066;">[</span><span style="color: #0000ff;">0</span><span style="color: #000066;">..</span><span style="color: #0000cc;">$FFFF</span><span style="color: #000066;">]</span> <span style="color: #000000; font-weight: bold;">of</span> <span style="color: #000066; font-weight: bold;">Byte</span><span style="color: #000066;">;</span>
  Header<span style="color: #000066;">:</span> <span style="color: #000000; font-weight: bold;">array</span><span style="color: #000066;">[</span><span style="color: #0000ff;">1</span><span style="color: #000066;">..</span><span style="color: #0000ff;">4</span><span style="color: #000066;">]</span> <span style="color: #000000; font-weight: bold;">of</span> <span style="color: #000066; font-weight: bold;">Byte</span><span style="color: #000066;">;</span>
  Size<span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">Integer</span><span style="color: #000066;">;</span>
<span style="color: #000000; font-weight: bold;">begin</span>
  Destino<span style="color: #000066;">:</span><span style="color: #000066;">=</span> TMemoryStream<span style="color: #000066;">.</span><span style="color: #006600;">Create</span><span style="color: #000066;">;</span>
  <span style="color: #000000; font-weight: bold;">try</span>
    <span style="color: #808080; font-style: italic;">// En este bucle vamos copiando segmento a segmento</span>
    <span style="color: #000000; font-weight: bold;">while</span> <span style="color: #000000; font-weight: bold;">TRUE</span> <span style="color: #000000; font-weight: bold;">do</span>
    <span style="color: #000000; font-weight: bold;">begin</span>
      Origen<span style="color: #000066;">.</span><span style="color: #006600;">ReadBuffer</span><span style="color: #000066;">(</span>Header<span style="color: #000066;">,</span><span style="color: #0000ff;">4</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
      Size<span style="color: #000066;">:</span><span style="color: #000066;">=</span> <span style="color: #000066;">(</span><span style="color: #000066;">(</span>Header<span style="color: #000066;">[</span><span style="color: #0000ff;">3</span><span style="color: #000066;">]</span> <span style="color: #000000; font-weight: bold;">shl</span> <span style="color: #0000ff;">8</span><span style="color: #000066;">)</span> <span style="color: #000066;">+</span> Header<span style="color: #000066;">[</span><span style="color: #0000ff;">4</span><span style="color: #000066;">]</span><span style="color: #000066;">)</span> <span style="color: #000066;">-</span> <span style="color: #0000ff;">2</span><span style="color: #000066;">;</span>
      <span style="color: #000000; font-weight: bold;">case</span> Header<span style="color: #000066;">[</span><span style="color: #0000ff;">2</span><span style="color: #000066;">]</span> <span style="color: #000000; font-weight: bold;">of</span>
        <span style="color: #0000cc;">$01</span><span style="color: #000066;">,</span><span style="color: #0000cc;">$D0</span><span style="color: #000066;">..</span><span style="color: #0000cc;">$D8</span><span style="color: #000066;">:</span> <span style="color: #000000; font-weight: bold;">begin</span>
                        <span style="color: #808080; font-style: italic;">// Estos segmentos solo miden dos bytes,</span>
                        <span style="color: #808080; font-style: italic;">// asi que escribimos 2 bytes y</span>
                        Destino<span style="color: #000066;">.</span><span style="color: #006600;">WriteBuffer</span><span style="color: #000066;">(</span>Header<span style="color: #000066;">,</span><span style="color: #0000ff;">2</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
                        <span style="color: #808080; font-style: italic;">// retrocedemos otros dos hacia atras.</span>
                        Origen<span style="color: #000066;">.</span><span style="color: #000066;">Seek</span><span style="color: #000066;">(</span><span style="color: #000066;">-</span><span style="color: #0000ff;">2</span><span style="color: #000066;">,</span>soFromCurrent<span style="color: #000066;">)</span><span style="color: #000066;">;</span>
                      <span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">;</span>
        <span style="color: #0000cc;">$D9</span><span style="color: #000066;">:</span> <span style="color: #000000; font-weight: bold;">begin</span>
               <span style="color: #808080; font-style: italic;">// Este indica que llegamos al final del archivo jpeg</span>
               Destino<span style="color: #000066;">.</span><span style="color: #006600;">WriteBuffer</span><span style="color: #000066;">(</span>Header<span style="color: #000066;">,</span><span style="color: #0000ff;">2</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
               <span style="color: #808080; font-style: italic;">// Guardamos el archivo usando la plantilla</span>
               Destino<span style="color: #000066;">.</span><span style="color: #006600;">SaveToFile</span><span style="color: #000066;">(</span><span style="color: #000066;">Format</span><span style="color: #000066;">(</span>FormatStr<span style="color: #000066;">,</span><span style="color: #000066;">[</span>Index<span style="color: #000066;">]</span><span style="color: #000066;">)</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
               <span style="color: #000066;">Writeln</span><span style="color: #000066;">(</span><span style="color: #ff0000;">'Recuperada: '</span> <span style="color: #000066;">+</span> <span style="color: #000066;">Format</span><span style="color: #000066;">(</span>FormatStr<span style="color: #000066;">,</span><span style="color: #000066;">[</span>Index<span style="color: #000066;">]</span><span style="color: #000066;">)</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
               <span style="color: #808080; font-style: italic;">// Incrementamos el indice</span>
               <span style="color: #000066;">inc</span><span style="color: #000066;">(</span>Index<span style="color: #000066;">)</span><span style="color: #000066;">;</span>
               <span style="color: #808080; font-style: italic;">// Salimos del procedure</span>
               Exit<span style="color: #000066;">;</span>
             <span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">;</span>
        <span style="color: #0000cc;">$DA</span><span style="color: #000066;">:</span> <span style="color: #000000; font-weight: bold;">begin</span>
               <span style="color: #808080; font-style: italic;">// Este segmento no tiene tamaño</span>
               Destino<span style="color: #000066;">.</span><span style="color: #006600;">WriteBuffer</span><span style="color: #000066;">(</span>Header<span style="color: #000066;">,</span><span style="color: #0000ff;">2</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
               Origen<span style="color: #000066;">.</span><span style="color: #000066;">Seek</span><span style="color: #000066;">(</span><span style="color: #000066;">-</span><span style="color: #0000ff;">2</span><span style="color: #000066;">,</span>soFromCurrent<span style="color: #000066;">)</span><span style="color: #000066;">;</span>
               <span style="color: #808080; font-style: italic;">// Buscamos el final byte a byte</span>
               <span style="color: #000000; font-weight: bold;">while</span> <span style="color: #000000; font-weight: bold;">TRUE</span> <span style="color: #000000; font-weight: bold;">do</span>
               <span style="color: #000000; font-weight: bold;">begin</span>
                 Origen<span style="color: #000066;">.</span><span style="color: #006600;">ReadBuffer</span><span style="color: #000066;">(</span>Buffer<span style="color: #000066;">,</span><span style="color: #0000ff;">1</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
                 <span style="color: #808080; font-style: italic;">// Posible comienzo de otro segmento</span>
                 <span style="color: #000000; font-weight: bold;">if</span> Buffer<span style="color: #000066;">[</span><span style="color: #0000ff;">0</span><span style="color: #000066;">]</span> <span style="color: #000066;">=</span> <span style="color: #0000cc;">$FF</span> <span style="color: #000000; font-weight: bold;">then</span>
                 <span style="color: #000000; font-weight: bold;">begin</span>
                   Origen<span style="color: #000066;">.</span><span style="color: #006600;">ReadBuffer</span><span style="color: #000066;">(</span>Buffer<span style="color: #000066;">,</span><span style="color: #0000ff;">1</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
                   <span style="color: #808080; font-style: italic;">// $FF00 = Secuencia de escape</span>
                   <span style="color: #808080; font-style: italic;">// $FFD0 .. $FFD7 = Se deben de ignorar</span>
                   <span style="color: #000000; font-weight: bold;">if</span> <span style="color: #000066;">(</span>Buffer<span style="color: #000066;">[</span><span style="color: #0000ff;">0</span><span style="color: #000066;">]</span> &lt;&gt; <span style="color: #0000ff;">0</span><span style="color: #000066;">)</span> <span style="color: #000000; font-weight: bold;">and</span> <span style="color: #000000; font-weight: bold;">not</span> <span style="color: #000066;">(</span>Buffer<span style="color: #000066;">[</span><span style="color: #0000ff;">0</span><span style="color: #000066;">]</span> <span style="color: #000000; font-weight: bold;">in</span> <span style="color: #000066;">[</span><span style="color: #0000cc;">$D0</span><span style="color: #000066;">..</span><span style="color: #0000cc;">$D7</span><span style="color: #000066;">]</span><span style="color: #000066;">)</span> <span style="color: #000000; font-weight: bold;">then</span>
                   <span style="color: #000000; font-weight: bold;">begin</span>
                     <span style="color: #808080; font-style: italic;">// Si encontramos el comienzo de otro segmento,</span>
                     <span style="color: #808080; font-style: italic;">// retrocedemos dos bytes, y volvemos al bucle principal</span>
                     Origen<span style="color: #000066;">.</span><span style="color: #000066;">Seek</span><span style="color: #000066;">(</span><span style="color: #000066;">-</span><span style="color: #0000ff;">2</span><span style="color: #000066;">,</span>soFromCurrent<span style="color: #000066;">)</span><span style="color: #000066;">;</span>
                     break<span style="color: #000066;">;</span>
                   <span style="color: #000000; font-weight: bold;">end</span> <span style="color: #000000; font-weight: bold;">else</span>
                   <span style="color: #000000; font-weight: bold;">begin</span>
                     <span style="color: #808080; font-style: italic;">// Si no es el comienzo de otro segmento, escribimos</span>
                     <span style="color: #808080; font-style: italic;">// y continuamos</span>
                     Header<span style="color: #000066;">[</span><span style="color: #0000ff;">1</span><span style="color: #000066;">]</span><span style="color: #000066;">:</span><span style="color: #000066;">=</span> <span style="color: #0000cc;">$FF</span><span style="color: #000066;">;</span>
                     Header<span style="color: #000066;">[</span><span style="color: #0000ff;">2</span><span style="color: #000066;">]</span><span style="color: #000066;">:</span><span style="color: #000066;">=</span> Buffer<span style="color: #000066;">[</span><span style="color: #0000ff;">0</span><span style="color: #000066;">]</span><span style="color: #000066;">;</span>
                     Destino<span style="color: #000066;">.</span><span style="color: #006600;">WriteBuffer</span><span style="color: #000066;">(</span>Header<span style="color: #000066;">,</span><span style="color: #0000ff;">2</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
                   <span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">;</span>  
                 <span style="color: #000000; font-weight: bold;">end</span> <span style="color: #000000; font-weight: bold;">else</span>
                   Destino<span style="color: #000066;">.</span><span style="color: #006600;">WriteBuffer</span><span style="color: #000066;">(</span>Buffer<span style="color: #000066;">,</span><span style="color: #0000ff;">1</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
               <span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">;</span>
             <span style="color: #000000; font-weight: bold;">end</span>
        <span style="color: #000000; font-weight: bold;">else</span>
        <span style="color: #000000; font-weight: bold;">begin</span>
          <span style="color: #808080; font-style: italic;">// Cualquier otro segmento lo copiamos directamente</span>
          Origen<span style="color: #000066;">.</span><span style="color: #006600;">ReadBuffer</span><span style="color: #000066;">(</span>Buffer<span style="color: #000066;">,</span>Size<span style="color: #000066;">)</span><span style="color: #000066;">;</span>
          Destino<span style="color: #000066;">.</span><span style="color: #006600;">WriteBuffer</span><span style="color: #000066;">(</span>Header<span style="color: #000066;">,</span><span style="color: #0000ff;">4</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
          Destino<span style="color: #000066;">.</span><span style="color: #006600;">WriteBuffer</span><span style="color: #000066;">(</span>Buffer<span style="color: #000066;">,</span>Size<span style="color: #000066;">)</span><span style="color: #000066;">;</span>
        <span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">;</span>
      <span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">;</span>
    <span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">;</span>
  <span style="color: #000000; font-weight: bold;">finally</span>
    Destino<span style="color: #000066;">.</span><span style="color: #006600;">Free</span><span style="color: #000066;">;</span>
  <span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">;</span>
<span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">;</span>
 
<span style="color: #000000; font-weight: bold;">procedure</span> Scan<span style="color: #000066;">(</span>Stream<span style="color: #000066;">:</span> TStream<span style="color: #000066;">;</span> ClusterSize<span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">Integer</span><span style="color: #000066;">;</span> FormatStr<span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">String</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
<span style="color: #000000; font-weight: bold;">var</span>
  Buffer<span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">PChar</span><span style="color: #000066;">;</span>
  Indice<span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">Integer</span><span style="color: #000066;">;</span>
  Leidos<span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">Integer</span><span style="color: #000066;">;</span>
  MemStream<span style="color: #000066;">:</span> TMemoryStream<span style="color: #000066;">;</span>
  Posicion<span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">int64</span><span style="color: #000066;">;</span>
<span style="color: #000000; font-weight: bold;">begin</span>
  Indice<span style="color: #000066;">:</span><span style="color: #000066;">=</span> <span style="color: #0000ff;">0</span><span style="color: #000066;">;</span>
  <span style="color: #808080; font-style: italic;">// Reservamos memoria</span>
  <span style="color: #000066;">GetMem</span><span style="color: #000066;">(</span>Buffer<span style="color: #000066;">,</span>ClusterSize<span style="color: #000066;">)</span><span style="color: #000066;">;</span>
  <span style="color: #000000; font-weight: bold;">try</span>
    <span style="color: #808080; font-style: italic;">// Leemos un cluster completo</span>
    Leidos<span style="color: #000066;">:</span><span style="color: #000066;">=</span> Stream<span style="color: #000066;">.</span><span style="color: #000000; font-weight: bold;">Read</span><span style="color: #000066;">(</span>Buffer<span style="color: #000066;">^</span><span style="color: #000066;">,</span>ClusterSize<span style="color: #000066;">)</span><span style="color: #000066;">;</span>
    <span style="color: #000000; font-weight: bold;">while</span> Leidos &gt; <span style="color: #0000ff;">0</span> <span style="color: #000000; font-weight: bold;">do</span>
    <span style="color: #000000; font-weight: bold;">begin</span>
      <span style="color: #808080; font-style: italic;">// Comprobamos si los primeros bytes del cluter coinciden con</span>
      <span style="color: #808080; font-style: italic;">// el inicio de un archivo jpeg.</span>
      <span style="color: #000000; font-weight: bold;">if</span> <span style="color: #000066;">CompareMem</span><span style="color: #000066;">(</span>Buffer<span style="color: #000066;">,</span><span style="color: #000066; font-weight: bold;">PChar</span><span style="color: #000066;">(</span><span style="color: #ff0000;">#$FF</span><span style="color: #ff0000;">#$D8</span><span style="color: #ff0000;">#$FF</span><span style="color: #000066;">)</span><span style="color: #000066;">,</span><span style="color: #0000ff;">3</span><span style="color: #000066;">)</span> <span style="color: #000000; font-weight: bold;">then</span>
      <span style="color: #000000; font-weight: bold;">begin</span>
        <span style="color: #808080; font-style: italic;">// Guardamos la posicion</span>
        Posicion<span style="color: #000066;">:</span><span style="color: #000066;">=</span> Stream<span style="color: #000066;">.</span><span style="color: #006600;">Position</span><span style="color: #000066;">;</span>
        <span style="color: #000000; font-weight: bold;">try</span>
          <span style="color: #808080; font-style: italic;">// Cargamos en un stream este cluster y los siguientes 8 Megas</span>
          MemStream<span style="color: #000066;">:</span><span style="color: #000066;">=</span> TMemoryStream<span style="color: #000066;">.</span><span style="color: #006600;">Create</span><span style="color: #000066;">;</span>
          <span style="color: #000000; font-weight: bold;">try</span>
            MemStream<span style="color: #000066;">.</span><span style="color: #000000; font-weight: bold;">Write</span><span style="color: #000066;">(</span>Buffer<span style="color: #000066;">^</span><span style="color: #000066;">,</span>Leidos<span style="color: #000066;">)</span><span style="color: #000066;">;</span>
            MemStream<span style="color: #000066;">.</span><span style="color: #006600;">CopyFrom</span><span style="color: #000066;">(</span>Stream<span style="color: #000066;">,</span><span style="color: #0000ff;">8</span><span style="color: #000066;">*</span><span style="color: #0000ff;">1024</span><span style="color: #000066;">*</span><span style="color: #0000ff;">1024</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
            MemStream<span style="color: #000066;">.</span><span style="color: #006600;">Position</span><span style="color: #000066;">:</span><span style="color: #000066;">=</span> <span style="color: #0000ff;">0</span><span style="color: #000066;">;</span>
            <span style="color: #000066;">Writeln</span><span style="color: #000066;">(</span><span style="color: #ff0000;">'Encontrada una posible imagen.'</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
            <span style="color: #808080; font-style: italic;">// Intentamos recuperar la imagen</span>
            RecuperarJpeg<span style="color: #000066;">(</span>MemStream<span style="color: #000066;">,</span>FormatStr<span style="color: #000066;">,</span>Indice<span style="color: #000066;">)</span><span style="color: #000066;">;</span>
          <span style="color: #000000; font-weight: bold;">finally</span>
            MemStream<span style="color: #000066;">.</span><span style="color: #006600;">Free</span><span style="color: #000066;">;</span>
          <span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">;</span>
        <span style="color: #000000; font-weight: bold;">except</span>
          <span style="color: #808080; font-style: italic;">// Si se produce un error lo mostramos, pero no salimos del bucle</span>
          <span style="color: #000000; font-weight: bold;">On</span> E<span style="color: #000066;">:</span> Exception <span style="color: #000000; font-weight: bold;">do</span>
             <span style="color: #000066;">Writeln</span><span style="color: #000066;">(</span><span style="color: #ff0000;">'Error: '</span> <span style="color: #000066;">+</span> E<span style="color: #000066;">.</span><span style="color: #000000; font-weight: bold;">Message</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
        <span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">;</span>
        <span style="color: #808080; font-style: italic;">// Nos movemos hasta el siguiente cluster</span>
        Stream<span style="color: #000066;">.</span><span style="color: #006600;">Position</span><span style="color: #000066;">:</span><span style="color: #000066;">=</span> Posicion <span style="color: #000066;">+</span> ClusterSize<span style="color: #000066;">;</span>
      <span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">;</span>
      Leidos<span style="color: #000066;">:</span><span style="color: #000066;">=</span> Stream<span style="color: #000066;">.</span><span style="color: #000000; font-weight: bold;">Read</span><span style="color: #000066;">(</span>Buffer<span style="color: #000066;">^</span><span style="color: #000066;">,</span>ClusterSize<span style="color: #000066;">)</span><span style="color: #000066;">;</span>
    <span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">;</span>
  <span style="color: #000000; font-weight: bold;">finally</span>
    <span style="color: #000066;">FreeMem</span><span style="color: #000066;">(</span>Buffer<span style="color: #000066;">)</span><span style="color: #000066;">;</span>
  <span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">;</span>
<span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">;</span>
 
<span style="color: #000000; font-weight: bold;">var</span>
  TickCount<span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">Cardinal</span><span style="color: #000066;">;</span>
  Stream<span style="color: #000066;">:</span> TFileStream<span style="color: #000066;">;</span>
<span style="color: #000000; font-weight: bold;">begin</span>
  <span style="color: #000000; font-weight: bold;">try</span>
    <span style="color: #808080; font-style: italic;">// Necesitamos al menos 2 parametros</span>
    <span style="color: #000000; font-weight: bold;">if</span> ParamCount &gt; <span style="color: #0000ff;">1</span> <span style="color: #000000; font-weight: bold;">then</span>
    <span style="color: #000000; font-weight: bold;">begin</span>
      <span style="color: #808080; font-style: italic;">// Comprobamos que se pueden crear archivos en la ruta indicada</span>
      TFileStream<span style="color: #000066;">.</span><span style="color: #006600;">Create</span><span style="color: #000066;">(</span><span style="color: #000066;">Format</span><span style="color: #000066;">(</span><span style="color: #000066;">ParamStr</span><span style="color: #000066;">(</span><span style="color: #0000ff;">2</span><span style="color: #000066;">)</span><span style="color: #000066;">,</span><span style="color: #000066;">[</span><span style="color: #0000ff;">0</span><span style="color: #000066;">]</span><span style="color: #000066;">)</span><span style="color: #000066;">,</span>fmCreate<span style="color: #000066;">)</span><span style="color: #000066;">.</span><span style="color: #006600;">Free</span><span style="color: #000066;">;</span>
      <span style="color: #808080; font-style: italic;">// Borramos el archivo de prueba</span>
      <span style="color: #000066;">DeleteFile</span><span style="color: #000066;">(</span><span style="color: #000066;">Format</span><span style="color: #000066;">(</span><span style="color: #000066;">ParamStr</span><span style="color: #000066;">(</span><span style="color: #0000ff;">2</span><span style="color: #000066;">)</span><span style="color: #000066;">,</span><span style="color: #000066;">[</span><span style="color: #0000ff;">0</span><span style="color: #000066;">]</span><span style="color: #000066;">)</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
      <span style="color: #808080; font-style: italic;">// Abrimos el archivo de origen</span>
      Stream<span style="color: #000066;">:</span><span style="color: #000066;">=</span> TFileStream<span style="color: #000066;">.</span><span style="color: #006600;">Create</span><span style="color: #000066;">(</span><span style="color: #000066;">ParamStr</span><span style="color: #000066;">(</span><span style="color: #0000ff;">1</span><span style="color: #000066;">)</span><span style="color: #000066;">,</span>fmOpenRead <span style="color: #000000; font-weight: bold;">or</span> fmShareDenyNone<span style="color: #000066;">)</span><span style="color: #000066;">;</span>
      <span style="color: #000000; font-weight: bold;">try</span>
        <span style="color: #808080; font-style: italic;">// Si llegamos hasta aqui podemos leer y escribir</span>
        TickCount<span style="color: #000066;">:</span><span style="color: #000066;">=</span> GetTickCount<span style="color: #000066;">;</span>
        <span style="color: #808080; font-style: italic;">// Iniciamos la busqueda</span>
        <span style="color: #000066;">Writeln</span><span style="color: #000066;">(</span><span style="color: #ff0000;">'Comenzando la busqueda ...'</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
        Scan<span style="color: #000066;">(</span>Stream<span style="color: #000066;">,</span><span style="color: #000066;">StrToIntDef</span><span style="color: #000066;">(</span><span style="color: #000066;">ParamStr</span><span style="color: #000066;">(</span><span style="color: #0000ff;">3</span><span style="color: #000066;">)</span><span style="color: #000066;">,</span><span style="color: #0000ff;">1</span><span style="color: #000066;">)</span> <span style="color: #000066;">*</span> <span style="color: #0000ff;">512</span><span style="color: #000066;">,</span><span style="color: #000066;">ParamStr</span><span style="color: #000066;">(</span><span style="color: #0000ff;">2</span><span style="color: #000066;">)</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
        <span style="color: #808080; font-style: italic;">// Mostramos el tiempo que hemos tardado</span>
        <span style="color: #000066;">Writeln</span><span style="color: #000066;">(</span><span style="color: #000066;">Format</span><span style="color: #000066;">(</span><span style="color: #ff0000;">'Tiempo transcurrido: %d ms'</span><span style="color: #000066;">,</span><span style="color: #000066;">[</span>GetTickCount <span style="color: #000066;">-</span> TickCount<span style="color: #000066;">]</span><span style="color: #000066;">)</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
      <span style="color: #000000; font-weight: bold;">finally</span>
        Stream<span style="color: #000066;">.</span><span style="color: #006600;">Free</span><span style="color: #000066;">;</span>
      <span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">;</span>
    <span style="color: #000000; font-weight: bold;">end</span> <span style="color: #000000; font-weight: bold;">else</span>
      <span style="color: #808080; font-style: italic;">// Si no nos pasan dos parametros, imprimimos una pequeña ayuda</span>
      <span style="color: #000066;">Writeln</span><span style="color: #000066;">(</span><span style="color: #ff0000;">'Help: '</span> <span style="color: #000066;">+</span> <span style="color: #000066;">ExtractFilename</span><span style="color: #000066;">(</span><span style="color: #000066;">ParamStr</span><span style="color: #000066;">(</span><span style="color: #0000ff;">0</span><span style="color: #000066;">)</span><span style="color: #000066;">)</span> <span style="color: #000066;">+</span> <span style="color: #ff0000;">' &lt;File&gt; &lt;Format&gt; [ClusterSize]'</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
  <span style="color: #000000; font-weight: bold;">except</span>
    <span style="color: #000000; font-weight: bold;">On</span> E<span style="color: #000066;">:</span> Exception <span style="color: #000000; font-weight: bold;">do</span>
      <span style="color: #808080; font-style: italic;">// Si algo sale mal, escribimos la descripcion del error</span>
      <span style="color: #000066;">Writeln</span><span style="color: #000066;">(</span><span style="color: #ff0000;">'Error: '</span> <span style="color: #000066;">+</span> E<span style="color: #000066;">.</span><span style="color: #000000; font-weight: bold;">Message</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
  <span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">;</span>
<span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">.</span></pre></div>
<p>Por ejemplo, para buscar imágenes en el disco F, guardarlas en C:\Temp y usar un tamaño de cluster de 1024 bytes, usaríamos el siguiente comando:</p>
<p><b>recover \\.\F: C:\Temp\%d.jpg 2</b></p>
<p>El código completo y programa, los puedes bajar de <a href="/sites/delphi.jmrds.com/adjuntos/recover_delphi.zip">aquí</a></p>
</div></div></div>    <footer>
        <ul class="links list-inline"><li class="comment_forbidden first last"></li>
</ul>  </footer>
    <div id="comments" class="comment-wrapper">
          <h2 class="title">Comentarios</h2>
      
  <a id="comment-131"></a>
<div class="comment comment-by-anonymous clearfix" about="/comment/131#comment-131" typeof="sioc:Post sioct:Comment">
  
  
    <h3 property="dc:title" datatype=""><a href="/comment/131#comment-131" class="permalink" rel="bookmark">Gracias por este estupendo</a></h3>
  
  <div class="submitted">
    <a href="/comment/131#comment-131" class="permalink" rel="bookmark">Enlace permanente</a>    <span property="dc:date dc:created" content="2009-06-30T09:51:00+02:00" datatype="xsd:dateTime" rel="sioc:has_creator">Enviado por <a href="http://www.pecero.com" rel="nofollow foaf:page" class="username" xml:lang="" typeof="sioc:UserAccount" property="foaf:name" datatype="">Luis (no verificado)</a> el Mar, 06/30/2009 - 09:51</span>  </div>

  <div class="content">
    <span rel="sioc:reply_of" resource="/node/27" class="rdf-meta element-hidden"></span><div class="field field-name-comment-body field-type-text-long field-label-hidden"><div class="field-items"><div class="field-item even" property="content:encoded"><p>Gracias por este estupendo programa, me ha servido y mucho....</p>
<p>Saludos</p>
</div></div></div>      </div>

  <ul class="links list-inline"><li class="comment_forbidden first last"></li>
</ul></div>
<a id="comment-836"></a>
<div class="comment comment-by-anonymous clearfix" about="/comment/836#comment-836" typeof="sioc:Post sioct:Comment">
  
  
    <h3 property="dc:title" datatype=""><a href="/comment/836#comment-836" class="permalink" rel="bookmark">Muy bueno !!!</a></h3>
  
  <div class="submitted">
    <a href="/comment/836#comment-836" class="permalink" rel="bookmark">Enlace permanente</a>    <span property="dc:date dc:created" content="2012-01-04T18:30:28+01:00" datatype="xsd:dateTime" rel="sioc:has_creator">Enviado por <span class="username" xml:lang="" typeof="sioc:UserAccount" property="foaf:name" datatype="">Alejandro (no verificado)</span> el Mié, 01/04/2012 - 18:30</span>  </div>

  <div class="content">
    <span rel="sioc:reply_of" resource="/node/27" class="rdf-meta element-hidden"></span><div class="field field-name-comment-body field-type-text-long field-label-hidden"><div class="field-items"><div class="field-item even" property="content:encoded"><p>Muy bueno !!!</p>
</div></div></div>      </div>

  <ul class="links list-inline"><li class="comment_forbidden first last"></li>
</ul></div>

  </div>
</article>

</section>
  </div>
    </section>

    
  </div>
</div>

  <footer class="footer container">
      <div class="region region-footer">
    <section id="block-menu-menu-enlaces" class="block block-menu clearfix">

        <h2 class="block-title">Enlaces interesantes</h2>
    
  <ul class="menu nav"><li class="first leaf"><a href="http://www.cadetill.com" title="">Cadetill</a></li>
<li class="leaf"><a href="http://www.delphiaccess.com/forum" title="">DelphiAccess</a></li>
<li class="leaf"><a href="http://www.delphispano.com/" title="">Delphispano</a></li>
<li class="leaf"><a href="http://egostar.delphiaccess.com/" title="">Egostar</a></li>
<li class="leaf"><a href="http://jachguate.wordpress.com/" title="">Jachguate</a></li>
<li class="leaf"><a href="http://neftali.clubdelphi.com/" title="">Neftali</a></li>
<li class="leaf"><a href="http://elpoli.delphiaccess.com/" title="">Poliburro</a></li>
<li class="leaf"><a href="http://theroadtodelphi.wordpress.com/" title="">Rodrigo Ruz</a></li>
<li class="last leaf"><a href="http://salvador.oversistemas.com/" title="">Salvador Gomez</a></li>
</ul>
</section>
<section id="block-block-1" class="block block-block clearfix">

      
  <p>copyright (c) 2007 - 2016 Domingo Seoane</p>

</section>
  </div>
  </footer>
  <script src="/sites/delphi.jmrds.com/themes/bootstrap/js/bootstrap.js?"></script>
</body>
</html>
