<!DOCTYPE html>
<html lang="es" dir="ltr" prefix="content: http://purl.org/rss/1.0/modules/content/ dc: http://purl.org/dc/terms/ foaf: http://xmlns.com/foaf/0.1/ og: http://ogp.me/ns# rdfs: http://www.w3.org/2000/01/rdf-schema# sioc: http://rdfs.org/sioc/ns# sioct: http://rdfs.org/sioc/types# skos: http://www.w3.org/2004/02/skos/core# xsd: http://www.w3.org/2001/XMLSchema#">
<head>
  <link rel="profile" href="http://www.w3.org/1999/xhtml/vocab" />
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<link rel="shortcut icon" href="/sites/delphi.jmrds.com/themes/bootstrap/favicon.ico" type="image/vnd.microsoft.icon" />
<link rel="shortlink" href="/node/48" />
<link rel="canonical" href="/node/48" />
<meta name="Generator" content="Drupal 7 (http://drupal.org)" />
  <title>Espiar las comunicaciones de otros procesos | La web de Seoane</title>
  <style>
@import url("/modules/system/system.base.css?");
</style>
<style>
@import url("/modules/field/theme/field.css?");
@import url("/modules/node/node.css?");
</style>
<style>
@import url("/sites/delphi.jmrds.com/modules/geshifilter/geshifilter.css?");
</style>
<link type="text/css" rel="stylesheet" href="//cdn.jsdelivr.net/bootstrap/3.3.5/css/bootstrap.css" media="all" />
<style>
@import url("/sites/delphi.jmrds.com/themes/bootstrap/css/3.3.5/overrides.min.css?");
</style>
  <!-- HTML5 element support for IE6-8 -->
  <!--[if lt IE 9]>
    <script src="https://cdn.jsdelivr.net/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
  <![endif]-->
  <script src="/sites/delphi.jmrds.com/modules/jquery_update/replace/jquery/1.10/jquery.min.js?v=1.10.2"></script>
<script src="/misc/jquery.once.js?v=1.2"></script>
<script src="/misc/drupal.js?"></script>
<script src="//cdn.jsdelivr.net/bootstrap/3.3.5/js/bootstrap.js"></script>
<script src="/sites/delphi.jmrds.com/files/languages/es_sB9mP1iixuFRbyZKZVySK7xrSW_2-LRj1vNEXyqwOu8.js?"></script>
<script>jQuery.extend(Drupal.settings, {"basePath":"\/","pathPrefix":"","ajaxPageState":{"theme":"bootstrap","theme_token":"bjuWWas21why6JFAKrI3oGrtwKTNCZfUqB7qwEqUkcQ","js":{"sites\/delphi.jmrds.com\/themes\/bootstrap\/js\/bootstrap.js":1,"sites\/delphi.jmrds.com\/modules\/jquery_update\/replace\/jquery\/1.10\/jquery.min.js":1,"misc\/jquery.once.js":1,"misc\/drupal.js":1,"\/\/cdn.jsdelivr.net\/bootstrap\/3.3.5\/js\/bootstrap.js":1,"public:\/\/languages\/es_sB9mP1iixuFRbyZKZVySK7xrSW_2-LRj1vNEXyqwOu8.js":1},"css":{"modules\/system\/system.base.css":1,"modules\/field\/theme\/field.css":1,"modules\/node\/node.css":1,"sites\/delphi.jmrds.com\/modules\/geshifilter\/geshifilter.css":1,"\/\/cdn.jsdelivr.net\/bootstrap\/3.3.5\/css\/bootstrap.css":1,"sites\/delphi.jmrds.com\/themes\/bootstrap\/css\/3.3.5\/overrides.min.css":1}},"bootstrap":{"anchorsFix":"0","anchorsSmoothScrolling":"0","formHasError":1,"popoverEnabled":"1","popoverOptions":{"animation":1,"html":0,"placement":"right","selector":"","trigger":"click","triggerAutoclose":1,"title":"","content":"","delay":0,"container":"body"},"tooltipEnabled":"1","tooltipOptions":{"animation":1,"html":0,"placement":"auto left","selector":"","trigger":"hover focus","delay":0,"container":"body"}}});</script>
</head>
<body class="html not-front not-logged-in no-sidebars page-node page-node- page-node-48 node-type-article">
  <div id="skip-link">
    <a href="#main-content" class="element-invisible element-focusable">Pasar al contenido principal</a>
  </div>
    <header id="navbar" role="banner" class="navbar container navbar-default">
  <div class="container">
    <div class="navbar-header">
              <a class="logo navbar-btn pull-left" href="/" title="Inicio">
          <img src="/sites/delphi.jmrds.com/themes/bootstrap/logo.png" alt="Inicio" />
        </a>
      
              <a class="name navbar-brand" href="/" title="Inicio">La web de Seoane</a>
      
              <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#navbar-collapse">
          <span class="sr-only">Toggle navigation</span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
          </div>

          <div class="navbar-collapse collapse" id="navbar-collapse">
        <nav role="navigation">
                      <ul class="menu nav navbar-nav"><li class="first leaf"><a href="/" title="">Inicio</a></li>
<li class="leaf"><a href="/search/node" title="">Buscar</a></li>
<li class="leaf"><a href="/rss.xml" title="">RSS</a></li>
<li class="leaf"><a href="/node/26" title="">Contacto</a></li>
<li class="last leaf"><a href="/user/login" title="">Login</a></li>
</ul>                                      </nav>
      </div>
      </div>
</header>

<div class="main-container container">

  <header role="banner" id="page-header">
    
      </header> <!-- /#page-header -->

  <div class="row">

    
    <section class="col-sm-12">
                  <a id="main-content"></a>
                    <h1 class="page-header">Espiar las comunicaciones de otros procesos</h1>
                                                          <div class="region region-content">
    <section id="block-system-main" class="block block-system clearfix">

      
  <article id="node-48" class="node node-article node-promoted clearfix" about="/node/48" typeof="sioc:Item foaf:Document">
    <header>
            <span property="dc:title" content="Espiar las comunicaciones de otros procesos" class="rdf-meta element-hidden"></span><span property="sioc:num_replies" content="2" datatype="xsd:integer" class="rdf-meta element-hidden"></span>        <span class="submitted">
            <span property="dc:date dc:created" content="2008-10-26T21:16:51+01:00" datatype="xsd:dateTime" rel="sioc:has_creator">Enviado por <span class="username" xml:lang="" about="/user/1" typeof="sioc:UserAccount" property="foaf:name" datatype="">admin</span> el Dom, 10/26/2008 - 21:16</span>    </span>
      </header>
    <div class="field field-name-body field-type-text-with-summary field-label-hidden"><div class="field-items"><div class="field-item even" property="content:encoded"><p>Seguro que alguna vez has tenido curiosidad por saber como funciona otro proceso, que envía y que recibe a través de internet, para esta tarea ya existen programas muy buenos, por ejemplo <a href="http://www.wireshark.org/">wireshark</a>, pero lo que aquí propongo es hacerlo nosotros mismos desde un programa en delphi. Puede que el resultado no sea muy profesional, pero sirve perfectamente como ejemplo de como inyectar código en otro proceso e interceptar las llamadas que hace este a funciones de la API de windows. Solo es una "prueba de concepto", un pequeño juguete, para usarlo de una forma un poco más seria habría que limar un poco el código, pero ese no es ahora mismo mi objetivo.</p>
<!--break--><p>El proyecto se divide en dos partes, una dll que se va a cargar en el proceso a espiar y un ejecutable que se va a encargar de inyectar a la dll dentro del otro proceso. Una vez inyectada la dll en el proceso que queremos espiar, busca la zona de memoria donde se guardan las direcciones de las funciones a interceptar, guarda ese valor, y lo reemplaza con la dirección de sus propias funciones. De esta manera cuando el programa intente ejecutar la función, lo que hará realmente es ejecutar la nueva función.</p>
<p>El código del programa y la dll (<a href="/sites/delphi.jmrds.com/adjuntos/sockspy.zip">sockspy.zip</a>):</p>
<p>El código de la dll:</p>
<div class="geshifilter">
<pre class="delphi geshifilter-delphi" style="font-family:monospace;"><span style="color: #000000; font-weight: bold;">library</span> Hook<span style="color: #000066;">;</span>
 
<span style="color: #000000; font-weight: bold;">uses</span>
  Windows<span style="color: #000066;">,</span>
  Sysutils<span style="color: #000066;">,</span>
  Messages<span style="color: #000066;">,</span>
  Psapi<span style="color: #000066;">,</span>
  ImageHlp<span style="color: #000066;">,</span>
  Winsock<span style="color: #000066;">;</span>
 
<span style="color: #000000; font-weight: bold;">type</span>
  IMAGE_IMPORT_DESCRIPTOR <span style="color: #000066;">=</span> <span style="color: #000000; font-weight: bold;">record</span>
    Characteristics<span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">DWORD</span><span style="color: #000066;">;</span>
    TimeDateStamp<span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">DWORD</span><span style="color: #000066;">;</span>
    ForwarderChain<span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">DWORD</span><span style="color: #000066;">;</span>
    Name<span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">DWORD</span><span style="color: #000066;">;</span>
    FirstThunk<span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">DWORD</span><span style="color: #000066;">;</span>
  <span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">;</span>
  PIMAGE_IMPORT_DESCRIPTOR <span style="color: #000066;">=</span> <span style="color: #000066;">^</span>IMAGE_IMPORT_DESCRIPTOR<span style="color: #000066;">;</span>
 
  TWSABUF <span style="color: #000066;">=</span> <span style="color: #000000; font-weight: bold;">record</span>
    len<span style="color: #000066;">:</span> u_long<span style="color: #000066;">;</span>
    buf<span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">PChar</span><span style="color: #000066;">;</span>
  <span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">;</span>
  PWSABUF <span style="color: #000066;">=</span> <span style="color: #000066;">^</span>TWSABUF<span style="color: #000066;">;</span>
 
  TSendFunc <span style="color: #000066;">=</span> <span style="color: #000000; font-weight: bold;">function</span> <span style="color: #000066;">(</span>s<span style="color: #000066;">:</span> TSocket<span style="color: #000066;">;</span> Buf<span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">Pchar</span><span style="color: #000066;">;</span> len<span style="color: #000066;">,</span> flags<span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">Integer</span><span style="color: #000066;">)</span><span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">Integer</span><span style="color: #000066;">;</span> <span style="color: #000000; font-weight: bold;">stdcall</span><span style="color: #000066;">;</span>
  TRecvFunc <span style="color: #000066;">=</span> <span style="color: #000000; font-weight: bold;">function</span> <span style="color: #000066;">(</span>s<span style="color: #000066;">:</span> TSocket<span style="color: #000066;">;</span> Buf<span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">Pchar</span><span style="color: #000066;">;</span> len<span style="color: #000066;">,</span> flags<span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">Integer</span><span style="color: #000066;">)</span><span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">Integer</span><span style="color: #000066;">;</span> <span style="color: #000000; font-weight: bold;">stdcall</span><span style="color: #000066;">;</span>
  TWSASendFunc <span style="color: #000066;">=</span> <span style="color: #000000; font-weight: bold;">function</span><span style="color: #000066;">(</span>s<span style="color: #000066;">:</span> TSocket<span style="color: #000066;">;</span> lpBuffers<span style="color: #000066;">:</span> PWSABUF<span style="color: #000066;">;</span> dwBufferCount<span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">DWORD</span><span style="color: #000066;">;</span>
    lpNumberOfBytesSent<span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">Pointer</span><span style="color: #000066;">;</span> dwFlags<span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">DWORD</span><span style="color: #000066;">;</span> lpOverlapped<span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">Pointer</span><span style="color: #000066;">;</span>
    lpCompletionRoutine<span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">Pointer</span><span style="color: #000066;">)</span><span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">Integer</span><span style="color: #000066;">;</span> <span style="color: #000000; font-weight: bold;">stdcall</span><span style="color: #000066;">;</span>
  TWSARecvFunc <span style="color: #000066;">=</span> <span style="color: #000000; font-weight: bold;">function</span><span style="color: #000066;">(</span>s<span style="color: #000066;">:</span> TSocket<span style="color: #000066;">;</span> lpBuffers<span style="color: #000066;">:</span> PWSABUF<span style="color: #000066;">;</span> dwBufferCount<span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">DWORD</span><span style="color: #000066;">;</span>
    lpNumberOfBytesSent<span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">Pointer</span><span style="color: #000066;">;</span> dwFlags<span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">DWORD</span><span style="color: #000066;">;</span> lpOverlapped<span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">Pointer</span><span style="color: #000066;">;</span>
    lpCompletionRoutine<span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">Pointer</span><span style="color: #000066;">)</span><span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">Integer</span><span style="color: #000066;">;</span> <span style="color: #000000; font-weight: bold;">stdcall</span><span style="color: #000066;">;</span>
 
  TBufType <span style="color: #000066;">=</span> <span style="color: #000066;">(</span>btSend<span style="color: #000066;">,</span> btRecv<span style="color: #000066;">)</span><span style="color: #000066;">;</span>
 
<span style="color: #000000; font-weight: bold;">var</span>
  OldSend<span style="color: #000066;">:</span> TSendFunc<span style="color: #000066;">;</span>
  OldRecv<span style="color: #000066;">:</span> TRecvFunc<span style="color: #000066;">;</span>
  OldWSASend<span style="color: #000066;">:</span> TWSASendFunc<span style="color: #000066;">;</span>
  OldWSARecv<span style="color: #000066;">:</span> TWSARecvFunc<span style="color: #000066;">;</span>
 
<span style="color: #808080; font-style: italic;">// Esta funcion convierte los datos a texto, convirtiendo los caracteres no imprimibles</span>
<span style="color: #808080; font-style: italic;">// a su representacion hexadecimal</span>
<span style="color: #000000; font-weight: bold;">function</span> BufToString<span style="color: #000066;">(</span>Buf<span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">PChar</span><span style="color: #000066;">;</span> Len<span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">Integer</span><span style="color: #000066;">)</span><span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">String</span><span style="color: #000066;">;</span>
<span style="color: #000000; font-weight: bold;">var</span>
  i<span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">Integer</span><span style="color: #000066;">;</span>
<span style="color: #000000; font-weight: bold;">begin</span>
  Result<span style="color: #000066;">:</span><span style="color: #000066;">=</span> EmptyStr<span style="color: #000066;">;</span>
  <span style="color: #000000; font-weight: bold;">for</span> i<span style="color: #000066;">:</span><span style="color: #000066;">=</span> <span style="color: #0000ff;">1</span> <span style="color: #000000; font-weight: bold;">to</span> Len <span style="color: #000000; font-weight: bold;">do</span>
  <span style="color: #000000; font-weight: bold;">begin</span>
    <span style="color: #000000; font-weight: bold;">if</span> <span style="color: #000066;">(</span>Buf<span style="color: #000066;">^</span> <span style="color: #000000; font-weight: bold;">in</span> <span style="color: #000066;">[</span><span style="color: #ff0000;">#32</span><span style="color: #000066;">..</span><span style="color: #ff0000;">#126</span><span style="color: #000066;">]</span><span style="color: #000066;">)</span> <span style="color: #000000; font-weight: bold;">then</span>
      Result<span style="color: #000066;">:</span><span style="color: #000066;">=</span> Result <span style="color: #000066;">+</span> Buf<span style="color: #000066;">^</span>
    <span style="color: #000000; font-weight: bold;">else</span>
      Result<span style="color: #000066;">:</span><span style="color: #000066;">=</span> Result <span style="color: #000066;">+</span> <span style="color: #ff0000;">'['</span> <span style="color: #000066;">+</span> <span style="color: #000066;">IntToHex</span><span style="color: #000066;">(</span><span style="color: #000066; font-weight: bold;">Byte</span><span style="color: #000066;">(</span>Buf<span style="color: #000066;">^</span><span style="color: #000066;">)</span><span style="color: #000066;">,</span><span style="color: #0000ff;">2</span><span style="color: #000066;">)</span> <span style="color: #000066;">+</span> <span style="color: #ff0000;">']'</span><span style="color: #000066;">;</span>
    <span style="color: #000066;">inc</span><span style="color: #000066;">(</span>Buf<span style="color: #000066;">)</span><span style="color: #000066;">;</span>
  <span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">;</span>
<span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">;</span>
 
<span style="color: #808080; font-style: italic;">// Todos los hooks apuntan hacia aqui</span>
<span style="color: #000000; font-weight: bold;">procedure</span> SaveBuf<span style="color: #000066;">(</span>S<span style="color: #000066;">:</span> TSocket<span style="color: #000066;">;</span> Buf<span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">PChar</span><span style="color: #000066;">;</span> Len<span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">Integer</span><span style="color: #000066;">;</span> Tipo<span style="color: #000066;">:</span> TBufType<span style="color: #000066;">)</span><span style="color: #000066;">;</span>
<span style="color: #000000; font-weight: bold;">var</span>
  Str<span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">String</span><span style="color: #000066;">;</span>
<span style="color: #000000; font-weight: bold;">begin</span> 
  Str<span style="color: #000066;">:</span><span style="color: #000066;">=</span> BufToString<span style="color: #000066;">(</span>Buf<span style="color: #000066;">,</span>len<span style="color: #000066;">)</span><span style="color: #000066;">;</span>
  <span style="color: #000000; font-weight: bold;">if</span> Tipo <span style="color: #000066;">=</span> btSend <span style="color: #000000; font-weight: bold;">then</span>
    Str<span style="color: #000066;">:</span><span style="color: #000066;">=</span> <span style="color: #000066;">Format</span><span style="color: #000066;">(</span><span style="color: #ff0000;">'Send(%d): %s'</span><span style="color: #000066;">,</span><span style="color: #000066;">[</span>S<span style="color: #000066;">,</span>Str<span style="color: #000066;">]</span><span style="color: #000066;">)</span>
  <span style="color: #000000; font-weight: bold;">else</span> <span style="color: #000000; font-weight: bold;">if</span> Tipo <span style="color: #000066;">=</span> btRecv <span style="color: #000000; font-weight: bold;">then</span>
    Str<span style="color: #000066;">:</span><span style="color: #000066;">=</span> <span style="color: #000066;">Format</span><span style="color: #000066;">(</span><span style="color: #ff0000;">'Recv(%d): %s'</span><span style="color: #000066;">,</span><span style="color: #000066;">[</span>S<span style="color: #000066;">,</span>Str<span style="color: #000066;">]</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
  OutputDebugString<span style="color: #000066;">(</span><span style="color: #000066; font-weight: bold;">PChar</span><span style="color: #000066;">(</span>Str<span style="color: #000066;">)</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
<span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">;</span>
 
<span style="color: #000000; font-weight: bold;">function</span> NewSend<span style="color: #000066;">(</span>s<span style="color: #000066;">:</span> TSocket<span style="color: #000066;">;</span> Buf<span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">PChar</span><span style="color: #000066;">;</span> len<span style="color: #000066;">,</span> flags<span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">Integer</span><span style="color: #000066;">)</span><span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">Integer</span><span style="color: #000066;">;</span> <span style="color: #000000; font-weight: bold;">stdcall</span><span style="color: #000066;">;</span>
<span style="color: #000000; font-weight: bold;">begin</span>
  SaveBuf<span style="color: #000066;">(</span>s<span style="color: #000066;">,</span>Buf<span style="color: #000066;">,</span>len<span style="color: #000066;">,</span>btSend<span style="color: #000066;">)</span><span style="color: #000066;">;</span>
  <span style="color: #000000; font-weight: bold;">if</span> <span style="color: #000066;">@</span>OldSend &lt;&gt; <span style="color: #000000; font-weight: bold;">nil</span> <span style="color: #000000; font-weight: bold;">then</span>
    Result<span style="color: #000066;">:</span><span style="color: #000066;">=</span> OldSend<span style="color: #000066;">(</span>s<span style="color: #000066;">,</span>Buf<span style="color: #000066;">,</span>len<span style="color: #000066;">,</span>flags<span style="color: #000066;">)</span>
  <span style="color: #000000; font-weight: bold;">else</span>
    Result<span style="color: #000066;">:</span><span style="color: #000066;">=</span> SOCKET_ERROR<span style="color: #000066;">;</span>
<span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">;</span>
 
<span style="color: #000000; font-weight: bold;">function</span> NewRecv<span style="color: #000066;">(</span>s<span style="color: #000066;">:</span> TSocket<span style="color: #000066;">;</span> Buf<span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">PChar</span><span style="color: #000066;">;</span> len<span style="color: #000066;">,</span> flags<span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">Integer</span><span style="color: #000066;">)</span><span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">Integer</span><span style="color: #000066;">;</span> <span style="color: #000000; font-weight: bold;">stdcall</span><span style="color: #000066;">;</span>
<span style="color: #000000; font-weight: bold;">begin</span>
  <span style="color: #000000; font-weight: bold;">if</span> <span style="color: #000066;">@</span>OldRecv &lt;&gt; <span style="color: #000000; font-weight: bold;">nil</span> <span style="color: #000000; font-weight: bold;">then</span>
    Result<span style="color: #000066;">:</span><span style="color: #000066;">=</span> OldRecv<span style="color: #000066;">(</span>s<span style="color: #000066;">,</span>Buf<span style="color: #000066;">,</span>len<span style="color: #000066;">,</span>flags<span style="color: #000066;">)</span>
  <span style="color: #000000; font-weight: bold;">else</span>
    Result<span style="color: #000066;">:</span><span style="color: #000066;">=</span> SOCKET_ERROR<span style="color: #000066;">;</span>
  <span style="color: #000000; font-weight: bold;">if</span> Result &gt; <span style="color: #0000ff;">0</span> <span style="color: #000000; font-weight: bold;">then</span>
    SaveBuf<span style="color: #000066;">(</span>s<span style="color: #000066;">,</span>Buf<span style="color: #000066;">,</span>Result<span style="color: #000066;">,</span>btRecv<span style="color: #000066;">)</span><span style="color: #000066;">;</span>
<span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">;</span>
 
<span style="color: #000000; font-weight: bold;">function</span> NewWSASend<span style="color: #000066;">(</span>s<span style="color: #000066;">:</span> TSocket<span style="color: #000066;">;</span> lpBuffers<span style="color: #000066;">:</span> PWSABUF<span style="color: #000066;">;</span> dwBufferCount<span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">DWORD</span><span style="color: #000066;">;</span>
  lpNumberOfBytesSent<span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">Pointer</span><span style="color: #000066;">;</span> dwFlags<span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">DWORD</span><span style="color: #000066;">;</span> lpOverlapped<span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">Pointer</span><span style="color: #000066;">;</span>
  lpCompletionRoutine<span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">Pointer</span><span style="color: #000066;">)</span><span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">Integer</span><span style="color: #000066;">;</span> <span style="color: #000000; font-weight: bold;">stdcall</span><span style="color: #000066;">;</span>
<span style="color: #000000; font-weight: bold;">var</span>
  i<span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">DWORD</span><span style="color: #000066;">;</span>
  P<span style="color: #000066;">:</span> PWSABUF<span style="color: #000066;">;</span>
<span style="color: #000000; font-weight: bold;">begin</span>
  i<span style="color: #000066;">:</span><span style="color: #000066;">=</span> dwBufferCount<span style="color: #000066;">;</span>
  P<span style="color: #000066;">:</span><span style="color: #000066;">=</span> lpBuffers<span style="color: #000066;">;</span>
  <span style="color: #000000; font-weight: bold;">while</span> i &gt; <span style="color: #0000ff;">0</span> <span style="color: #000000; font-weight: bold;">do</span>
  <span style="color: #000000; font-weight: bold;">begin</span>
    SaveBuf<span style="color: #000066;">(</span>s<span style="color: #000066;">,</span>P<span style="color: #000066;">.</span><span style="color: #006600;">Buf</span><span style="color: #000066;">,</span>P<span style="color: #000066;">.</span><span style="color: #006600;">len</span><span style="color: #000066;">,</span>btSend<span style="color: #000066;">)</span><span style="color: #000066;">;</span>
    <span style="color: #000066;">dec</span><span style="color: #000066;">(</span>i<span style="color: #000066;">)</span><span style="color: #000066;">;</span>
    <span style="color: #000066;">inc</span><span style="color: #000066;">(</span>P<span style="color: #000066;">)</span><span style="color: #000066;">;</span>
  <span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">;</span>
  <span style="color: #000000; font-weight: bold;">if</span> <span style="color: #000066;">@</span>OldWSASend &lt;&gt; <span style="color: #000000; font-weight: bold;">nil</span> <span style="color: #000000; font-weight: bold;">then</span>
    Result<span style="color: #000066;">:</span><span style="color: #000066;">=</span> OldWSASend<span style="color: #000066;">(</span>s<span style="color: #000066;">,</span>lpBuffers<span style="color: #000066;">,</span>dwBufferCount<span style="color: #000066;">,</span>lpNumberOfBytesSent<span style="color: #000066;">,</span>dwFlags<span style="color: #000066;">,</span>
      lpOverlapped<span style="color: #000066;">,</span>lpCompletionRoutine<span style="color: #000066;">)</span>
  <span style="color: #000000; font-weight: bold;">else</span>
    Result<span style="color: #000066;">:</span><span style="color: #000066;">=</span> SOCKET_ERROR<span style="color: #000066;">;</span>
<span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">;</span>
 
<span style="color: #000000; font-weight: bold;">function</span> newWSARecv<span style="color: #000066;">(</span>s<span style="color: #000066;">:</span> TSocket<span style="color: #000066;">;</span> lpBuffers<span style="color: #000066;">:</span> PWSABUF<span style="color: #000066;">;</span> dwBufferCount<span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">DWORD</span><span style="color: #000066;">;</span>
  lpNumberOfBytesSent<span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">Pointer</span><span style="color: #000066;">;</span> dwFlags<span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">DWORD</span><span style="color: #000066;">;</span> lpOverlapped<span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">Pointer</span><span style="color: #000066;">;</span>
  lpCompletionRoutine<span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">Pointer</span><span style="color: #000066;">)</span><span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">Integer</span><span style="color: #000066;">;</span> <span style="color: #000000; font-weight: bold;">stdcall</span><span style="color: #000066;">;</span>
<span style="color: #000000; font-weight: bold;">var</span>
  i<span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">DWORD</span><span style="color: #000066;">;</span>
  P<span style="color: #000066;">:</span> PWSABUF<span style="color: #000066;">;</span>
<span style="color: #000000; font-weight: bold;">begin</span>
  <span style="color: #000000; font-weight: bold;">if</span> <span style="color: #000066;">@</span>OldWSARecv &lt;&gt; <span style="color: #000000; font-weight: bold;">nil</span> <span style="color: #000000; font-weight: bold;">then</span>
    Result<span style="color: #000066;">:</span><span style="color: #000066;">=</span> OldWSARecv<span style="color: #000066;">(</span>s<span style="color: #000066;">,</span>lpBuffers<span style="color: #000066;">,</span>dwBufferCount<span style="color: #000066;">,</span>lpNumberOfBytesSent<span style="color: #000066;">,</span>dwFlags<span style="color: #000066;">,</span>
      lpOverlapped<span style="color: #000066;">,</span>lpCompletionRoutine<span style="color: #000066;">)</span>
  <span style="color: #000000; font-weight: bold;">else</span>
    Result<span style="color: #000066;">:</span><span style="color: #000066;">=</span> SOCKET_ERROR<span style="color: #000066;">;</span>
  <span style="color: #000000; font-weight: bold;">if</span> Result &lt;&gt; SOCKET_ERROR <span style="color: #000000; font-weight: bold;">then</span>
  <span style="color: #000000; font-weight: bold;">begin</span>
    i<span style="color: #000066;">:</span><span style="color: #000066;">=</span> dwBufferCount<span style="color: #000066;">;</span>
    P<span style="color: #000066;">:</span><span style="color: #000066;">=</span> lpBuffers<span style="color: #000066;">;</span>
    <span style="color: #000000; font-weight: bold;">while</span> i &gt; <span style="color: #0000ff;">0</span> <span style="color: #000000; font-weight: bold;">do</span>
    <span style="color: #000000; font-weight: bold;">begin</span>
      SaveBuf<span style="color: #000066;">(</span>s<span style="color: #000066;">,</span>P<span style="color: #000066;">.</span><span style="color: #006600;">Buf</span><span style="color: #000066;">,</span>P<span style="color: #000066;">.</span><span style="color: #006600;">len</span><span style="color: #000066;">,</span>btRecv<span style="color: #000066;">)</span><span style="color: #000066;">;</span>
      <span style="color: #000066;">dec</span><span style="color: #000066;">(</span>i<span style="color: #000066;">)</span><span style="color: #000066;">;</span>
      <span style="color: #000066;">inc</span><span style="color: #000066;">(</span>P<span style="color: #000066;">)</span><span style="color: #000066;">;</span>
    <span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">;</span>
  <span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">;</span>
<span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">;</span>
 
<span style="color: #000000; font-weight: bold;">function</span> HookFunction<span style="color: #000066;">(</span>ModName<span style="color: #000066;">,</span> ProcName<span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">PChar</span><span style="color: #000066;">;</span> Nuevo<span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">Pointer</span><span style="color: #000066;">)</span><span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">Pointer</span><span style="color: #000066;">;</span>
<span style="color: #000000; font-weight: bold;">var</span>
  i<span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">Integer</span><span style="color: #000066;">;</span>
  hProcess<span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">THandle</span><span style="color: #000066;">;</span>
  hModules<span style="color: #000066;">:</span> <span style="color: #000000; font-weight: bold;">array</span><span style="color: #000066;">[</span><span style="color: #0000ff;">0</span><span style="color: #000066;">..</span><span style="color: #0000ff;">1024</span><span style="color: #000066;">]</span> <span style="color: #000000; font-weight: bold;">of</span> HMODULE<span style="color: #000066;">;</span>
  cbNeeded<span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">DWORD</span><span style="color: #000066;">;</span>
  hMod<span style="color: #000066;">:</span> HMODULE<span style="color: #000066;">;</span>
  ImportDesc<span style="color: #000066;">:</span> PIMAGE_IMPORT_DESCRIPTOR<span style="color: #000066;">;</span>
  Size<span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">Cardinal</span><span style="color: #000066;">;</span>
  szModName<span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">PChar</span><span style="color: #000066;">;</span>
  Thunk<span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">PPointer</span><span style="color: #000066;">;</span>
  MBI<span style="color: #000066;">:</span> MEMORY_BASIC_INFORMATION<span style="color: #000066;">;</span>
<span style="color: #000000; font-weight: bold;">begin</span>
  Result<span style="color: #000066;">:</span><span style="color: #000066;">=</span> <span style="color: #000000; font-weight: bold;">nil</span><span style="color: #000066;">;</span>
  hMod<span style="color: #000066;">:</span><span style="color: #000066;">=</span> GetModuleHandle<span style="color: #000066;">(</span>ModName<span style="color: #000066;">)</span><span style="color: #000066;">;</span>
  <span style="color: #000000; font-weight: bold;">if</span> hMod &lt;&gt; <span style="color: #0000ff;">0</span> <span style="color: #000000; font-weight: bold;">then</span>
  <span style="color: #000000; font-weight: bold;">begin</span>
    Result<span style="color: #000066;">:</span><span style="color: #000066;">=</span> GetProcAddress<span style="color: #000066;">(</span>hMod<span style="color: #000066;">,</span> ProcName<span style="color: #000066;">)</span><span style="color: #000066;">;</span>
    <span style="color: #000000; font-weight: bold;">if</span> Result &lt;&gt; <span style="color: #000000; font-weight: bold;">nil</span> <span style="color: #000000; font-weight: bold;">then</span>
    <span style="color: #000000; font-weight: bold;">begin</span>
      hProcess<span style="color: #000066;">:</span><span style="color: #000066;">=</span> OpenProcess<span style="color: #000066;">(</span>PROCESS_QUERY_INFORMATION  <span style="color: #000000; font-weight: bold;">or</span> PROCESS_VM_READ<span style="color: #000066;">,</span>
        <span style="color: #000000; font-weight: bold;">FALSE</span><span style="color: #000066;">,</span> GetCurrentProcessId<span style="color: #000066;">)</span><span style="color: #000066;">;</span>
      <span style="color: #000000; font-weight: bold;">if</span> hProcess &lt;&gt; <span style="color: #0000ff;">0</span> <span style="color: #000000; font-weight: bold;">then</span>
      <span style="color: #000000; font-weight: bold;">begin</span>
        <span style="color: #000000; font-weight: bold;">if</span> EnumProcessModules<span style="color: #000066;">(</span>hProcess<span style="color: #000066;">,</span> <span style="color: #000066;">@</span>hModules<span style="color: #000066;">,</span> <span style="color: #000066;">Sizeof</span><span style="color: #000066;">(</span>hModules<span style="color: #000066;">)</span><span style="color: #000066;">,</span> cbNeeded<span style="color: #000066;">)</span> <span style="color: #000000; font-weight: bold;">then</span>
          <span style="color: #000000; font-weight: bold;">for</span> i<span style="color: #000066;">:</span><span style="color: #000066;">=</span> <span style="color: #0000ff;">0</span> <span style="color: #000000; font-weight: bold;">to</span> <span style="color: #000066;">(</span>cbNeeded <span style="color: #000000; font-weight: bold;">div</span> <span style="color: #000066;">Sizeof</span><span style="color: #000066;">(</span>HMODULE<span style="color: #000066;">)</span><span style="color: #000066;">)</span> <span style="color: #000066;">-</span> <span style="color: #0000ff;">1</span> <span style="color: #000000; font-weight: bold;">do</span>
          <span style="color: #000000; font-weight: bold;">begin</span>
            ImportDesc<span style="color: #000066;">:</span><span style="color: #000066;">=</span> ImageDirectoryEntryToData<span style="color: #000066;">(</span><span style="color: #000066; font-weight: bold;">Pointer</span><span style="color: #000066;">(</span>hModules<span style="color: #000066;">[</span>i<span style="color: #000066;">]</span><span style="color: #000066;">)</span><span style="color: #000066;">,</span>
              <span style="color: #000000; font-weight: bold;">TRUE</span><span style="color: #000066;">,</span> IMAGE_DIRECTORY_ENTRY_IMPORT<span style="color: #000066;">,</span> Size<span style="color: #000066;">)</span><span style="color: #000066;">;</span>
            <span style="color: #000000; font-weight: bold;">if</span> ImportDesc &lt;&gt; <span style="color: #000000; font-weight: bold;">nil</span> <span style="color: #000000; font-weight: bold;">then</span>
            <span style="color: #000000; font-weight: bold;">begin</span>
              <span style="color: #000000; font-weight: bold;">while</span> ImportDesc<span style="color: #000066;">.</span><span style="color: #006600;">Name</span> &gt; <span style="color: #0000ff;">0</span> <span style="color: #000000; font-weight: bold;">do</span>
              <span style="color: #000000; font-weight: bold;">begin</span>
                szModName<span style="color: #000066;">:</span><span style="color: #000066;">=</span> <span style="color: #000066; font-weight: bold;">PChar</span><span style="color: #000066;">(</span>hModules<span style="color: #000066;">[</span>i<span style="color: #000066;">]</span> <span style="color: #000066;">+</span> ImportDesc<span style="color: #000066;">.</span><span style="color: #006600;">Name</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
                <span style="color: #000000; font-weight: bold;">if</span> <span style="color: #000066;">StrIComp</span><span style="color: #000066;">(</span>szModName<span style="color: #000066;">,</span>ModName<span style="color: #000066;">)</span> <span style="color: #000066;">=</span> <span style="color: #0000ff;">0</span>  <span style="color: #000000; font-weight: bold;">then</span>
                <span style="color: #000000; font-weight: bold;">begin</span>
                  Thunk<span style="color: #000066;">:</span><span style="color: #000066;">=</span> <span style="color: #000066; font-weight: bold;">Pointer</span><span style="color: #000066;">(</span>hModules<span style="color: #000066;">[</span>i<span style="color: #000066;">]</span> <span style="color: #000066;">+</span> ImportDesc<span style="color: #000066;">.</span><span style="color: #006600;">FirstThunk</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
                  <span style="color: #000000; font-weight: bold;">while</span> Thunk<span style="color: #000066;">^</span> &lt;&gt; <span style="color: #000000; font-weight: bold;">nil</span> <span style="color: #000000; font-weight: bold;">do</span>
                  <span style="color: #000000; font-weight: bold;">begin</span>
                    <span style="color: #000000; font-weight: bold;">if</span> Thunk<span style="color: #000066;">^</span> <span style="color: #000066;">=</span> Result <span style="color: #000000; font-weight: bold;">then</span>
                    <span style="color: #000000; font-weight: bold;">begin</span>
                      OutputDebugString<span style="color: #000066;">(</span><span style="color: #000066; font-weight: bold;">PChar</span><span style="color: #000066;">(</span><span style="color: #000066; font-weight: bold;">String</span><span style="color: #000066;">(</span>ProcName<span style="color: #000066;">)</span> <span style="color: #000066;">+</span> <span style="color: #ff0000;">': '</span> <span style="color: #000066;">+</span> <span style="color: #ff0000;">'Hookeado'</span><span style="color: #000066;">)</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
                      VirtualQuery<span style="color: #000066;">(</span>Thunk<span style="color: #000066;">,</span>MBI<span style="color: #000066;">,</span><span style="color: #000066;">Sizeof</span><span style="color: #000066;">(</span>MEMORY_BASIC_INFORMATION<span style="color: #000066;">)</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
                      VirtualProtect<span style="color: #000066;">(</span>MBI<span style="color: #000066;">.</span><span style="color: #006600;">BaseAddress</span><span style="color: #000066;">,</span>MBI<span style="color: #000066;">.</span><span style="color: #006600;">RegionSize</span><span style="color: #000066;">,</span>PAGE_READWRITE<span style="color: #000066;">,</span>
                        MBI<span style="color: #000066;">.</span><span style="color: #006600;">Protect</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
                      Thunk<span style="color: #000066;">^</span><span style="color: #000066;">:</span><span style="color: #000066;">=</span>  Nuevo<span style="color: #000066;">;</span>
                      VirtualProtect<span style="color: #000066;">(</span>mbi<span style="color: #000066;">.</span><span style="color: #006600;">BaseAddress</span><span style="color: #000066;">,</span>mbi<span style="color: #000066;">.</span><span style="color: #006600;">RegionSize</span><span style="color: #000066;">,</span>mbi<span style="color: #000066;">.</span><span style="color: #006600;">Protect</span><span style="color: #000066;">,</span>
                        MBI<span style="color: #000066;">.</span><span style="color: #006600;">Protect</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
                    <span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">;</span>
                    <span style="color: #000066;">inc</span><span style="color: #000066;">(</span>Thunk<span style="color: #000066;">)</span><span style="color: #000066;">;</span>
                  <span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">;</span>
                <span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">;</span>
                <span style="color: #000066;">inc</span><span style="color: #000066;">(</span>ImportDesc<span style="color: #000066;">)</span><span style="color: #000066;">;</span>
              <span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">;</span>
            <span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">;</span>
          <span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">;</span>
      <span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">;</span>
    <span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">;</span>
  <span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">;</span>
<span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">;</span>
 
<span style="color: #000000; font-weight: bold;">procedure</span> ProcessAttach<span style="color: #000066;">;</span> <span style="color: #000000; font-weight: bold;">stdcall</span><span style="color: #000066;">;</span>
<span style="color: #000000; font-weight: bold;">begin</span>
  OldSend<span style="color: #000066;">:</span><span style="color: #000066;">=</span> HookFunction<span style="color: #000066;">(</span><span style="color: #ff0000;">'wsock32.dll'</span><span style="color: #000066;">,</span><span style="color: #ff0000;">'send'</span><span style="color: #000066;">,</span><span style="color: #000066;">@</span>NewSend<span style="color: #000066;">)</span><span style="color: #000066;">;</span>
  OldRecv<span style="color: #000066;">:</span><span style="color: #000066;">=</span> HookFunction<span style="color: #000066;">(</span><span style="color: #ff0000;">'wsock32.dll'</span><span style="color: #000066;">,</span><span style="color: #ff0000;">'recv'</span><span style="color: #000066;">,</span><span style="color: #000066;">@</span>newRecv<span style="color: #000066;">)</span><span style="color: #000066;">;</span>
  OldWSASend<span style="color: #000066;">:</span><span style="color: #000066;">=</span> HookFunction<span style="color: #000066;">(</span><span style="color: #ff0000;">'Ws2_32.dll'</span><span style="color: #000066;">,</span><span style="color: #ff0000;">'WSASend'</span><span style="color: #000066;">,</span><span style="color: #000066;">@</span>NewWSASend<span style="color: #000066;">)</span><span style="color: #000066;">;</span>
  OldWSARecv<span style="color: #000066;">:</span><span style="color: #000066;">=</span> HookFunction<span style="color: #000066;">(</span><span style="color: #ff0000;">'Ws2_32.dll'</span><span style="color: #000066;">,</span><span style="color: #ff0000;">'WSARecv'</span><span style="color: #000066;">,</span><span style="color: #000066;">@</span>NewWSARecv<span style="color: #000066;">)</span><span style="color: #000066;">;</span>
<span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">;</span>
 
<span style="color: #000000; font-weight: bold;">procedure</span> ProcessDetach<span style="color: #000066;">;</span> <span style="color: #000000; font-weight: bold;">stdcall</span><span style="color: #000066;">;</span>
<span style="color: #000000; font-weight: bold;">begin</span>
<span style="color: #808080; font-style: italic;">//</span>
<span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">;</span>
 
<span style="color: #000000; font-weight: bold;">procedure</span> DLLEntryPoint<span style="color: #000066;">(</span>Reason<span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">integer</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
<span style="color: #000000; font-weight: bold;">begin</span>
  <span style="color: #000000; font-weight: bold;">case</span> Reason <span style="color: #000000; font-weight: bold;">of</span>
    Dll_Process_Detach<span style="color: #000066;">:</span> ProcessDetach<span style="color: #000066;">;</span>
    Dll_Process_Attach<span style="color: #000066;">:</span> ProcessAttach<span style="color: #000066;">;</span>
  <span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">;</span>
<span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">;</span>
 
<span style="color: #000000; font-weight: bold;">begin</span>
  ProcessAttach<span style="color: #000066;">;</span>
  DLLProc<span style="color: #000066;">:</span><span style="color: #000066;">=</span> <span style="color: #000066;">@</span>DLLEntryPoint<span style="color: #000066;">;</span>
<span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">.</span></pre></div>
<p>Por otro lado el programa es muy sencillo, solamente lista los procesos y permite cargar la dll anterior en cualquiera de ellos.  </p>
<p>Las dos funciones principales son las siguientes:</p>
<div class="geshifilter">
<pre class="delphi geshifilter-delphi" style="font-family:monospace;"><span style="color: #000000; font-weight: bold;">procedure</span> TfrmMain<span style="color: #000066;">.</span><span style="color: #006600;">btnInyectarClick</span><span style="color: #000066;">(</span>Sender<span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">TObject</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
<span style="color: #000000; font-weight: bold;">var</span>
  Procesos<span style="color: #000066;">:</span> <span style="color: #000000; font-weight: bold;">array</span><span style="color: #000066;">[</span><span style="color: #0000ff;">1</span><span style="color: #000066;">..</span><span style="color: #0000ff;">1024</span><span style="color: #000066;">]</span> <span style="color: #000000; font-weight: bold;">of</span> <span style="color: #000066; font-weight: bold;">DWORD</span><span style="color: #000066;">;</span>
  Needed<span style="color: #000066;">,</span> i<span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">DWORD</span><span style="color: #000066;">;</span>
  Process<span style="color: #000066;">,</span> Thread<span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">THandle</span><span style="color: #000066;">;</span>
  ModName<span style="color: #000066;">:</span> <span style="color: #000000; font-weight: bold;">array</span><span style="color: #000066;">[</span><span style="color: #0000ff;">0</span><span style="color: #000066;">..</span><span style="color: #006600;">MAX_PATH</span><span style="color: #000066;">]</span> <span style="color: #000000; font-weight: bold;">of</span> <span style="color: #000066; font-weight: bold;">Char</span><span style="color: #000066;">;</span>
  RemLibPath<span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">PChar</span><span style="color: #000066;">;</span>
  ExitCode<span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">Cardinal</span><span style="color: #000066;">;</span>
  LibPath<span style="color: #000066;">,</span> Target<span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">String</span><span style="color: #000066;">;</span>
<span style="color: #000000; font-weight: bold;">begin</span>
  <span style="color: #000000; font-weight: bold;">if</span> lsbMain<span style="color: #000066;">.</span><span style="color: #006600;">ItemIndex</span> &gt;<span style="color: #000066;">=</span> <span style="color: #0000ff;">0</span> <span style="color: #000000; font-weight: bold;">then</span>
  <span style="color: #000000; font-weight: bold;">begin</span>
    Target<span style="color: #000066;">:</span><span style="color: #000066;">=</span> lsbMain<span style="color: #000066;">.</span><span style="color: #006600;">Items</span><span style="color: #000066;">[</span>lsbMain<span style="color: #000066;">.</span><span style="color: #006600;">ItemIndex</span><span style="color: #000066;">]</span><span style="color: #000066;">;</span>
    LibPath<span style="color: #000066;">:</span><span style="color: #000066;">=</span> <span style="color: #000066;">IncludeTrailingPathDelimiter</span><span style="color: #000066;">(</span><span style="color: #000066;">ExtractFilePath</span><span style="color: #000066;">(</span><span style="color: #000066;">ParamStr</span><span style="color: #000066;">(</span><span style="color: #0000ff;">0</span><span style="color: #000066;">)</span><span style="color: #000066;">)</span><span style="color: #000066;">)</span> <span style="color: #000066;">+</span>
      <span style="color: #ff0000;">'Hook.dll'</span><span style="color: #000066;">;</span>
    <span style="color: #000000; font-weight: bold;">if</span> EnumProcesses<span style="color: #000066;">(</span><span style="color: #000066;">@</span>Procesos<span style="color: #000066;">,</span> <span style="color: #000066;">SizeOf</span><span style="color: #000066;">(</span>Procesos<span style="color: #000066;">)</span><span style="color: #000066;">,</span> Needed <span style="color: #000066;">)</span> <span style="color: #000000; font-weight: bold;">then</span>
    <span style="color: #000000; font-weight: bold;">begin</span>
      <span style="color: #000000; font-weight: bold;">for</span> i<span style="color: #000066;">:</span><span style="color: #000066;">=</span> <span style="color: #0000ff;">1</span> <span style="color: #000000; font-weight: bold;">to</span> <span style="color: #000066;">(</span>Needed <span style="color: #000000; font-weight: bold;">div</span> <span style="color: #000066;">Sizeof</span><span style="color: #000066;">(</span><span style="color: #000066; font-weight: bold;">DWORD</span><span style="color: #000066;">)</span><span style="color: #000066;">)</span> <span style="color: #000000; font-weight: bold;">do</span>
      <span style="color: #000000; font-weight: bold;">begin</span>
        Process <span style="color: #000066;">:</span><span style="color: #000066;">=</span> OpenProcess<span style="color: #000066;">(</span>PROCESS_ALL_ACCESS<span style="color: #000066;">,</span> <span style="color: #000000; font-weight: bold;">FALSE</span><span style="color: #000066;">,</span>Procesos<span style="color: #000066;">[</span>i<span style="color: #000066;">]</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
        <span style="color: #000000; font-weight: bold;">if</span> Process &lt;&gt; <span style="color: #0000ff;">0</span> <span style="color: #000000; font-weight: bold;">then</span>
        <span style="color: #000000; font-weight: bold;">begin</span>
          <span style="color: #000000; font-weight: bold;">if</span> GetModuleFileNameEx<span style="color: #000066;">(</span>Process<span style="color: #000066;">,</span><span style="color: #0000ff;">0</span><span style="color: #000066;">,</span>ModName<span style="color: #000066;">,</span><span style="color: #000066;">SizeOf</span><span style="color: #000066;">(</span>ModName<span style="color: #000066;">)</span><span style="color: #000066;">-</span><span style="color: #0000ff;">1</span><span style="color: #000066;">)</span> &gt; <span style="color: #0000ff;">0</span>  <span style="color: #000000; font-weight: bold;">then</span>
          <span style="color: #000000; font-weight: bold;">begin</span>
            <span style="color: #000000; font-weight: bold;">if</span> <span style="color: #000066;">AnsiStrPos</span><span style="color: #000066;">(</span>ModName<span style="color: #000066;">,</span><span style="color: #000066; font-weight: bold;">PChar</span><span style="color: #000066;">(</span>Target<span style="color: #000066;">)</span><span style="color: #000066;">)</span> &lt;&gt; <span style="color: #000000; font-weight: bold;">nil</span> <span style="color: #000000; font-weight: bold;">then</span>
            <span style="color: #000000; font-weight: bold;">begin</span>
              RemLibPath<span style="color: #000066;">:</span><span style="color: #000066;">=</span> VirtualAllocEx<span style="color: #000066;">(</span>Process<span style="color: #000066;">,</span> <span style="color: #000000; font-weight: bold;">nil</span><span style="color: #000066;">,</span><span style="color: #000066;">Length</span><span style="color: #000066;">(</span>LibPath<span style="color: #000066;">)</span><span style="color: #000066;">+</span><span style="color: #0000ff;">1</span><span style="color: #000066;">,</span>
                MEM_COMMIT<span style="color: #000066;">,</span> PAGE_READWRITE<span style="color: #000066;">)</span><span style="color: #000066;">;</span>
              <span style="color: #000000; font-weight: bold;">if</span> RemLibPath &lt;&gt; <span style="color: #000000; font-weight: bold;">nil</span> <span style="color: #000000; font-weight: bold;">then</span>
              <span style="color: #000000; font-weight: bold;">begin</span>
                <span style="color: #000000; font-weight: bold;">if</span> WriteProcessMemory<span style="color: #000066;">(</span>Process<span style="color: #000066;">,</span> RemLibPath<span style="color: #000066;">,</span> <span style="color: #000066; font-weight: bold;">PChar</span><span style="color: #000066;">(</span>LibPath<span style="color: #000066;">)</span><span style="color: #000066;">,</span>
                  <span style="color: #000066;">Length</span><span style="color: #000066;">(</span>LibPath<span style="color: #000066;">)</span><span style="color: #000066;">,</span><span style="color: #000066; font-weight: bold;">PDWORD</span><span style="color: #000066;">(</span><span style="color: #000000; font-weight: bold;">nil</span><span style="color: #000066;">)</span><span style="color: #000066;">^</span><span style="color: #000066;">)</span> <span style="color: #000000; font-weight: bold;">then</span>
                <span style="color: #000000; font-weight: bold;">begin</span>
                  Thread<span style="color: #000066;">:</span><span style="color: #000066;">=</span> CreateRemoteThread<span style="color: #000066;">(</span>Process<span style="color: #000066;">,</span> <span style="color: #000000; font-weight: bold;">nil</span><span style="color: #000066;">,</span> <span style="color: #0000ff;">0</span><span style="color: #000066;">,</span>
                    GetProcAddress<span style="color: #000066;">(</span>GetModuleHandle<span style="color: #000066;">(</span><span style="color: #ff0000;">'Kernel32'</span><span style="color: #000066;">)</span><span style="color: #000066;">,</span><span style="color: #ff0000;">'LoadLibraryA'</span><span style="color: #000066;">)</span><span style="color: #000066;">,</span>
                    RemLibPath<span style="color: #000066;">,</span> <span style="color: #0000ff;">0</span><span style="color: #000066;">,</span> <span style="color: #000066; font-weight: bold;">PDWORD</span><span style="color: #000066;">(</span><span style="color: #000000; font-weight: bold;">nil</span><span style="color: #000066;">)</span><span style="color: #000066;">^</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
                  <span style="color: #000000; font-weight: bold;">if</span> Thread &lt;&gt; <span style="color: #0000ff;">0</span> <span style="color: #000000; font-weight: bold;">then</span>
                  <span style="color: #000000; font-weight: bold;">begin</span>
                    WaitForSingleObject<span style="color: #000066;">(</span>Thread<span style="color: #000066;">,</span>INFINITE <span style="color: #000066;">)</span><span style="color: #000066;">;</span>
                    GetExitCodeThread<span style="color: #000066;">(</span>Thread<span style="color: #000066;">,</span>ExitCode<span style="color: #000066;">)</span><span style="color: #000066;">;</span>
                    CloseHandle<span style="color: #000066;">(</span>Thread<span style="color: #000066;">)</span><span style="color: #000066;">;</span>
                  <span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">;</span>
                <span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">;</span>
                VirtualFreeEx<span style="color: #000066;">(</span>Process<span style="color: #000066;">,</span>RemLibPath<span style="color: #000066;">,</span><span style="color: #000066;">Length</span><span style="color: #000066;">(</span>LibPath<span style="color: #000066;">)</span><span style="color: #000066;">+</span><span style="color: #0000ff;">1</span><span style="color: #000066;">,</span>MEM_RELEASE<span style="color: #000066;">)</span><span style="color: #000066;">;</span>
              <span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">;</span>
            <span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">;</span>
          <span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">;</span>
          CloseHandle<span style="color: #000066;">(</span>Process<span style="color: #000066;">)</span><span style="color: #000066;">;</span>
        <span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">;</span>
      <span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">;</span>
    <span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">;</span>
  <span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">;</span>
<span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">;</span>
 
<span style="color: #000000; font-weight: bold;">procedure</span> TfrmMain<span style="color: #000066;">.</span><span style="color: #006600;">btnRefrescarClick</span><span style="color: #000066;">(</span>Sender<span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">TObject</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
<span style="color: #000000; font-weight: bold;">var</span>
  Procesos<span style="color: #000066;">:</span> <span style="color: #000000; font-weight: bold;">array</span><span style="color: #000066;">[</span><span style="color: #0000ff;">1</span><span style="color: #000066;">..</span><span style="color: #0000ff;">1024</span><span style="color: #000066;">]</span> <span style="color: #000000; font-weight: bold;">of</span> <span style="color: #000066; font-weight: bold;">DWORD</span><span style="color: #000066;">;</span>
  Needed<span style="color: #000066;">,</span> i<span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">DWORD</span><span style="color: #000066;">;</span>
  Process<span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">THandle</span><span style="color: #000066;">;</span>
  ModName<span style="color: #000066;">:</span> <span style="color: #000000; font-weight: bold;">array</span><span style="color: #000066;">[</span><span style="color: #0000ff;">0</span><span style="color: #000066;">..</span><span style="color: #006600;">MAX_PATH</span><span style="color: #000066;">]</span> <span style="color: #000000; font-weight: bold;">of</span> <span style="color: #000066; font-weight: bold;">Char</span><span style="color: #000066;">;</span>
<span style="color: #000000; font-weight: bold;">begin</span>
  lsbMain<span style="color: #000066;">.</span><span style="color: #006600;">Clear</span><span style="color: #000066;">;</span>
  <span style="color: #000000; font-weight: bold;">if</span> EnumProcesses<span style="color: #000066;">(</span><span style="color: #000066;">@</span>Procesos<span style="color: #000066;">,</span><span style="color: #000066;">SizeOf</span><span style="color: #000066;">(</span>Procesos<span style="color: #000066;">)</span><span style="color: #000066;">,</span>Needed<span style="color: #000066;">)</span> <span style="color: #000000; font-weight: bold;">then</span>
  <span style="color: #000000; font-weight: bold;">begin</span>
    <span style="color: #000000; font-weight: bold;">for</span> i<span style="color: #000066;">:</span><span style="color: #000066;">=</span> <span style="color: #0000ff;">1</span> <span style="color: #000000; font-weight: bold;">to</span> <span style="color: #000066;">(</span>Needed <span style="color: #000000; font-weight: bold;">div</span> <span style="color: #000066;">Sizeof</span><span style="color: #000066;">(</span><span style="color: #000066; font-weight: bold;">DWORD</span><span style="color: #000066;">)</span><span style="color: #000066;">)</span> <span style="color: #000000; font-weight: bold;">do</span>
    <span style="color: #000000; font-weight: bold;">begin</span>
      Process <span style="color: #000066;">:</span><span style="color: #000066;">=</span> OpenProcess<span style="color: #000066;">(</span>PROCESS_QUERY_INFORMATION <span style="color: #000000; font-weight: bold;">or</span> PROCESS_VM_READ<span style="color: #000066;">,</span>
        <span style="color: #000000; font-weight: bold;">FALSE</span><span style="color: #000066;">,</span>Procesos<span style="color: #000066;">[</span>i<span style="color: #000066;">]</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
      <span style="color: #000000; font-weight: bold;">if</span> Process &lt;&gt; <span style="color: #0000ff;">0</span> <span style="color: #000000; font-weight: bold;">then</span>
      <span style="color: #000000; font-weight: bold;">begin</span>
        <span style="color: #000000; font-weight: bold;">if</span> GetModuleFileNameEx<span style="color: #000066;">(</span>Process<span style="color: #000066;">,</span><span style="color: #0000ff;">0</span><span style="color: #000066;">,</span>ModName<span style="color: #000066;">,</span><span style="color: #000066;">SizeOf</span><span style="color: #000066;">(</span>ModName<span style="color: #000066;">)</span><span style="color: #000066;">-</span><span style="color: #0000ff;">1</span><span style="color: #000066;">)</span>&gt;<span style="color: #0000ff;">0</span>  <span style="color: #000000; font-weight: bold;">then</span>
        <span style="color: #000000; font-weight: bold;">begin</span>
          lsbMain<span style="color: #000066;">.</span><span style="color: #006600;">Items</span><span style="color: #000066;">.</span><span style="color: #006600;">Add</span><span style="color: #000066;">(</span>ModName<span style="color: #000066;">)</span><span style="color: #000066;">;</span>
        <span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">;</span>
        CloseHandle<span style="color: #000066;">(</span>Process<span style="color: #000066;">)</span><span style="color: #000066;">;</span>
      <span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">;</span>
    <span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">;</span>
  <span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">;</span>
<span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">;</span></pre></div>
<p>Para usar el programa solo hay que ejecutar el programa, buscar el proceso que queremos espiar y pulsar el botón inyectar. A partir de ese momento cuando el programa llame a las APIS send, recv, WSASend, WSARecv el contenido sera volcado a la "salida de debug". Para poder verlo necesitaremos de un programa como <a href="http://technet.microsoft.com/en-us/sysinternals/bb896647.aspx">DebugView</a> de Sysinternals.</p>
<p>Un ejemplo de la información que puedes obtener usando este programa:</p>
<p>Servidor ftp normal</p>
<div class="geshifilter">
<pre class="text geshifilter-text" style="font-family:monospace;">Recv(472): 220---------- Welcome to Pure-FTPd [TLS] ----------	
Send(472): USER usuario..	
Recv(472): 331 User usuario OK. Password required..	
Send(472): PASS password..	
Recv(472): 230-User usuario has group access to:  usuario   ..230 OK. Current restricted directory is /..	
Send(472): SYST..	
Recv(472): 215 UNIX Type: L8..	
 Send(472): FEAT..	
Recv(472): 211-Extensions supported:.. EPRT.. IDLE.. MDTM.. SIZE.. REST STREAM.. MLST type*;size*;sizd*;modify*;UNIX.mode*;UNIX.uid*;UNIX.gid*;unique*;.. MLSD.. ESTP.. PASV.. EPSV.. SPSV.. ESTA.. AUTH TLS.. PBSZ.. PROT..211 End...	
Send(472): PWD..	
Recv(472): 257 "/" is your current location..	
Send(472): TYPE A..	
Recv(472): 200 TYPE is now ASCII..	
Send(472): PASV..	
Recv(472): 227 Entering Passive Mode (86,109,99,252,148,1)..	
Send(472): LIST..</pre></div>
<p>Servidor ftps (SSL Explicit)</p>
<div class="geshifilter">
<pre class="text geshifilter-text" style="font-family:monospace;">Recv(472): 220 Indy FTP Server ready...	
Send(472): AUTH SSL..	
Recv(472): 234 AUTH Command OK. Initializing SSL..	
Send(472): .j....Q......9..8..5..............3..2../.............................@.....................&gt;^...z....T..).Q	
Recv(472): ._....../....0..+0...............j...0...*.H........0E1.0...U....AU1.0...U... (Continua)
Send(472): .R.......@...&lt;.#$./d.!..Ji....C......+{}$....`..~.M.....\(.."...u%J..L...(Continua)
Recv(472): .(..R.....B..h+.Cx..(..../....S..V..z#......(.t....l.,....)P.....c.Ky$K.....5.Z.T..K8.</pre></div>
</div></div></div>    <footer>
        <ul class="links list-inline"><li class="comment_forbidden first last"></li>
</ul>  </footer>
    <div id="comments" class="comment-wrapper">
          <h2 class="title">Comentarios</h2>
      
  <a id="comment-74"></a>
<div class="comment comment-by-anonymous clearfix" about="/comment/74#comment-74" typeof="sioc:Post sioct:Comment">
  
  
    <h3 property="dc:title" datatype=""><a href="/comment/74#comment-74" class="permalink" rel="bookmark">Fenomenal código. Muchas</a></h3>
  
  <div class="submitted">
    <a href="/comment/74#comment-74" class="permalink" rel="bookmark">Enlace permanente</a>    <span property="dc:date dc:created" content="2008-10-31T19:21:00+01:00" datatype="xsd:dateTime" rel="sioc:has_creator">Enviado por <span class="username" xml:lang="" typeof="sioc:UserAccount" property="foaf:name" datatype="">Anonimo (no verificado)</span> el Vie, 10/31/2008 - 19:21</span>  </div>

  <div class="content">
    <span rel="sioc:reply_of" resource="/node/48" class="rdf-meta element-hidden"></span><div class="field field-name-comment-body field-type-text-long field-label-hidden"><div class="field-items"><div class="field-item even" property="content:encoded"><p>Fenomenal código. Muchas gracias</p>
</div></div></div>      </div>

  <ul class="links list-inline"><li class="comment_forbidden first last"></li>
</ul></div>
<a id="comment-194"></a>
<div class="comment comment-by-anonymous clearfix" about="/comment/194#comment-194" typeof="sioc:Post sioct:Comment">
  
  
    <h3 property="dc:title" datatype=""><a href="/comment/194#comment-194" class="permalink" rel="bookmark">Excelente, bastante</a></h3>
  
  <div class="submitted">
    <a href="/comment/194#comment-194" class="permalink" rel="bookmark">Enlace permanente</a>    <span property="dc:date dc:created" content="2009-11-10T23:00:00+01:00" datatype="xsd:dateTime" rel="sioc:has_creator">Enviado por <span class="username" xml:lang="" typeof="sioc:UserAccount" property="foaf:name" datatype="">Guidus (no verificado)</span> el Mar, 11/10/2009 - 23:00</span>  </div>

  <div class="content">
    <span rel="sioc:reply_of" resource="/node/48" class="rdf-meta element-hidden"></span><div class="field field-name-comment-body field-type-text-long field-label-hidden"><div class="field-items"><div class="field-item even" property="content:encoded"><p>Excelente, bastante entendible para nosotros los que empezamos aprendiendo.</p>
<p>Gracias Domingo.</p>
</div></div></div>      </div>

  <ul class="links list-inline"><li class="comment_forbidden first last"></li>
</ul></div>

  </div>
</article>

</section>
  </div>
    </section>

    
  </div>
</div>

  <footer class="footer container">
      <div class="region region-footer">
    <section id="block-menu-menu-enlaces" class="block block-menu clearfix">

        <h2 class="block-title">Enlaces interesantes</h2>
    
  <ul class="menu nav"><li class="first leaf"><a href="http://www.cadetill.com" title="">Cadetill</a></li>
<li class="leaf"><a href="http://www.delphiaccess.com/forum" title="">DelphiAccess</a></li>
<li class="leaf"><a href="http://www.delphispano.com/" title="">Delphispano</a></li>
<li class="leaf"><a href="http://egostar.delphiaccess.com/" title="">Egostar</a></li>
<li class="leaf"><a href="http://jachguate.wordpress.com/" title="">Jachguate</a></li>
<li class="leaf"><a href="http://neftali.clubdelphi.com/" title="">Neftali</a></li>
<li class="leaf"><a href="http://elpoli.delphiaccess.com/" title="">Poliburro</a></li>
<li class="leaf"><a href="http://theroadtodelphi.wordpress.com/" title="">Rodrigo Ruz</a></li>
<li class="last leaf"><a href="http://salvador.oversistemas.com/" title="">Salvador Gomez</a></li>
</ul>
</section>
<section id="block-block-1" class="block block-block clearfix">

      
  <p>copyright (c) 2007 - 2016 Domingo Seoane</p>

</section>
  </div>
  </footer>
  <script src="/sites/delphi.jmrds.com/themes/bootstrap/js/bootstrap.js?"></script>
</body>
</html>
