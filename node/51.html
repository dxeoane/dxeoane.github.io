<!DOCTYPE html>
<html lang="es" dir="ltr" prefix="content: http://purl.org/rss/1.0/modules/content/ dc: http://purl.org/dc/terms/ foaf: http://xmlns.com/foaf/0.1/ og: http://ogp.me/ns# rdfs: http://www.w3.org/2000/01/rdf-schema# sioc: http://rdfs.org/sioc/ns# sioct: http://rdfs.org/sioc/types# skos: http://www.w3.org/2004/02/skos/core# xsd: http://www.w3.org/2001/XMLSchema#">
<head>
  <link rel="profile" href="http://www.w3.org/1999/xhtml/vocab" />
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<link rel="shortcut icon" href="/sites/delphi.jmrds.com/themes/bootstrap/favicon.ico" type="image/vnd.microsoft.icon" />
<link rel="shortlink" href="/node/51" />
<link rel="canonical" href="/node/51" />
<meta name="Generator" content="Drupal 7 (http://drupal.org)" />
  <title>Comprimir un archivo con RtlCompressBuffer | La web de Seoane</title>
  <style>
@import url("/modules/system/system.base.css?");
</style>
<style>
@import url("/modules/field/theme/field.css?");
@import url("/modules/node/node.css?");
</style>
<style>
@import url("/sites/delphi.jmrds.com/modules/geshifilter/geshifilter.css?");
</style>
<link type="text/css" rel="stylesheet" href="//cdn.jsdelivr.net/bootstrap/3.3.5/css/bootstrap.css" media="all" />
<style>
@import url("/sites/delphi.jmrds.com/themes/bootstrap/css/3.3.5/overrides.min.css?");
</style>
  <!-- HTML5 element support for IE6-8 -->
  <!--[if lt IE 9]>
    <script src="https://cdn.jsdelivr.net/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
  <![endif]-->
  <script src="/sites/delphi.jmrds.com/modules/jquery_update/replace/jquery/1.10/jquery.min.js?v=1.10.2"></script>
<script src="/misc/jquery.once.js?v=1.2"></script>
<script src="/misc/drupal.js?"></script>
<script src="//cdn.jsdelivr.net/bootstrap/3.3.5/js/bootstrap.js"></script>
<script src="/sites/delphi.jmrds.com/files/languages/es_sB9mP1iixuFRbyZKZVySK7xrSW_2-LRj1vNEXyqwOu8.js?"></script>
<script>jQuery.extend(Drupal.settings, {"basePath":"\/","pathPrefix":"","ajaxPageState":{"theme":"bootstrap","theme_token":"yFYMoDww9F5UzPeQOPSNyqfjTm1PMbAOFgt9V1Wxnsw","js":{"sites\/delphi.jmrds.com\/themes\/bootstrap\/js\/bootstrap.js":1,"sites\/delphi.jmrds.com\/modules\/jquery_update\/replace\/jquery\/1.10\/jquery.min.js":1,"misc\/jquery.once.js":1,"misc\/drupal.js":1,"\/\/cdn.jsdelivr.net\/bootstrap\/3.3.5\/js\/bootstrap.js":1,"public:\/\/languages\/es_sB9mP1iixuFRbyZKZVySK7xrSW_2-LRj1vNEXyqwOu8.js":1},"css":{"modules\/system\/system.base.css":1,"modules\/field\/theme\/field.css":1,"modules\/node\/node.css":1,"sites\/delphi.jmrds.com\/modules\/geshifilter\/geshifilter.css":1,"\/\/cdn.jsdelivr.net\/bootstrap\/3.3.5\/css\/bootstrap.css":1,"sites\/delphi.jmrds.com\/themes\/bootstrap\/css\/3.3.5\/overrides.min.css":1}},"bootstrap":{"anchorsFix":"0","anchorsSmoothScrolling":"0","formHasError":1,"popoverEnabled":"1","popoverOptions":{"animation":1,"html":0,"placement":"right","selector":"","trigger":"click","triggerAutoclose":1,"title":"","content":"","delay":0,"container":"body"},"tooltipEnabled":"1","tooltipOptions":{"animation":1,"html":0,"placement":"auto left","selector":"","trigger":"hover focus","delay":0,"container":"body"}}});</script>
</head>
<body class="html not-front not-logged-in no-sidebars page-node page-node- page-node-51 node-type-article">
  <div id="skip-link">
    <a href="#main-content" class="element-invisible element-focusable">Pasar al contenido principal</a>
  </div>
    <header id="navbar" role="banner" class="navbar container navbar-default">
  <div class="container">
    <div class="navbar-header">
              <a class="logo navbar-btn pull-left" href="/" title="Inicio">
          <img src="/sites/delphi.jmrds.com/themes/bootstrap/logo.png" alt="Inicio" />
        </a>
      
              <a class="name navbar-brand" href="/" title="Inicio">La web de Seoane</a>
      
              <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#navbar-collapse">
          <span class="sr-only">Toggle navigation</span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
          </div>

          <div class="navbar-collapse collapse" id="navbar-collapse">
        <nav role="navigation">
                      <ul class="menu nav navbar-nav"><li class="first leaf"><a href="/" title="">Inicio</a></li>
<li class="last leaf"><a href="/node/26" title="">Contacto</a></li>
</ul>                                      </nav>
      </div>
      </div>
</header>

<div class="main-container container">

  <header role="banner" id="page-header">
    
      </header> <!-- /#page-header -->

  <div class="row">

    
    <section class="col-sm-12">
                  <a id="main-content"></a>
                    <h1 class="page-header">Comprimir un archivo con RtlCompressBuffer</h1>
                                                          <div class="region region-content">
    <section id="block-system-main" class="block block-system clearfix">

      
  <article id="node-51" class="node node-article node-promoted clearfix" about="/node/51" typeof="sioc:Item foaf:Document">
    <header>
            <span property="dc:title" content="Comprimir un archivo con RtlCompressBuffer" class="rdf-meta element-hidden"></span><span property="sioc:num_replies" content="2" datatype="xsd:integer" class="rdf-meta element-hidden"></span>        <span class="submitted">
            <span property="dc:date dc:created" content="2009-04-26T22:53:14+02:00" datatype="xsd:dateTime" rel="sioc:has_creator">Enviado por <span class="username" xml:lang="" about="/user/1" typeof="sioc:UserAccount" property="foaf:name" datatype="">admin</span> el Dom, 04/26/2009 - 22:53</span>    </span>
      </header>
    <div class="field field-name-body field-type-text-with-summary field-label-hidden"><div class="field-items"><div class="field-item even" property="content:encoded"><p>El siguiente código es un ejemplo, sencillo, de como comprimir y descomprimir un archivo usando la función RtlCompressBuffer.</p>
<!--break--><p>Esta unit contiene las funciones para comprimir/descomprimir un archivo o un stream:</p>
<div class="geshifilter">
<pre class="delphi geshifilter-delphi" style="font-family:monospace;"><span style="color: #000000; font-weight: bold;">unit</span> Compressor<span style="color: #000066;">;</span>
 
<span style="color: #000000; font-weight: bold;">interface</span>
 
<span style="color: #000000; font-weight: bold;">uses</span> Windows<span style="color: #000066;">,</span> Sysutils<span style="color: #000066;">,</span> Classes<span style="color: #000066;">;</span>
 
<span style="color: #000000; font-weight: bold;">function</span> CompressStream<span style="color: #000066;">(</span>InStream<span style="color: #000066;">,</span> OutStream<span style="color: #000066;">:</span> TStream<span style="color: #000066;">)</span><span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">Boolean</span><span style="color: #000066;">;</span>
<span style="color: #000000; font-weight: bold;">function</span> CompressFile<span style="color: #000066;">(</span>Src<span style="color: #000066;">,</span> Dst<span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">String</span><span style="color: #000066;">)</span><span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">Boolean</span><span style="color: #000066;">;</span>
<span style="color: #000000; font-weight: bold;">function</span> DecompressStream<span style="color: #000066;">(</span>InStream<span style="color: #000066;">,</span> OutStream<span style="color: #000066;">:</span> TStream<span style="color: #000066;">)</span><span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">Boolean</span><span style="color: #000066;">;</span>
<span style="color: #000000; font-weight: bold;">function</span> DecompressFile<span style="color: #000066;">(</span>Src<span style="color: #000066;">,</span> Dst<span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">String</span><span style="color: #000066;">)</span><span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">Boolean</span><span style="color: #000066;">;</span>
 
<span style="color: #000000; font-weight: bold;">implementation</span>
 
<span style="color: #000000; font-weight: bold;">type</span>
  NTSTATUS <span style="color: #000066;">=</span> ULONG<span style="color: #000066;">;</span>
  USHORT <span style="color: #000066;">=</span> <span style="color: #000066; font-weight: bold;">Word</span><span style="color: #000066;">;</span>
 
  TBufferHeader <span style="color: #000066;">=</span> <span style="color: #000000; font-weight: bold;">record</span>
    CompressedBufferSize<span style="color: #000066;">:</span> ULONG<span style="color: #000066;">;</span>
  <span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">;</span>
 
<span style="color: #000000; font-weight: bold;">const</span>
  ntdll <span style="color: #000066;">=</span> <span style="color: #ff0000;">'ntdll.dll'</span><span style="color: #000066;">;</span>
 
  COMPRESSION_FORMAT_LZNT1    <span style="color: #000066;">=</span> <span style="color: #0000cc;">$0002</span><span style="color: #000066;">;</span>
  COMPRESSION_ENGINE_STANDARD <span style="color: #000066;">=</span> <span style="color: #0000cc;">$0000</span><span style="color: #000066;">;</span>
  COMPRESSION_ENGINE_MAXIMUM  <span style="color: #000066;">=</span> <span style="color: #0000cc;">$0100</span><span style="color: #000066;">;</span>
 
  STATUS_SUCCESS          <span style="color: #000066;">=</span> <span style="color: #0000cc;">$00000000</span><span style="color: #000066;">;</span>
  STATUS_BUFFER_ALL_ZEROS <span style="color: #000066;">=</span> <span style="color: #0000cc;">$00000117</span><span style="color: #000066;">;</span>
  STATUS_BUFFER_TOO_SMALL <span style="color: #000066;">=</span> <span style="color: #0000cc;">$C0000023</span><span style="color: #000066;">;</span>
 
 
  BUFFER_SIZE <span style="color: #000066;">=</span> <span style="color: #0000ff;">32</span><span style="color: #000066;">*</span><span style="color: #0000ff;">1024</span><span style="color: #000066;">;</span>
  MAX_BUFFER_SIZE <span style="color: #000066;">=</span> <span style="color: #0000ff;">8</span><span style="color: #000066;">*</span>BUFFER_SIZE<span style="color: #000066;">;</span>
 
<span style="color: #000000; font-weight: bold;">function</span> RtlCompressBuffer<span style="color: #000066;">(</span>CompressionFormatAndEngine<span style="color: #000066;">:</span> USHORT<span style="color: #000066;">;</span> UncompressedBuffer<span style="color: #000066;">:</span> PUCHAR<span style="color: #000066;">;</span>
  UncompressedBufferSize<span style="color: #000066;">:</span> ULONG<span style="color: #000066;">;</span> CompressedBuffer<span style="color: #000066;">:</span> PUCHAR<span style="color: #000066;">;</span> CompressedBufferSize<span style="color: #000066;">:</span> ULONG<span style="color: #000066;">;</span>
  UncompressedChunkSize<span style="color: #000066;">:</span> ULONG<span style="color: #000066;">;</span> FinalCompressedSize<span style="color: #000066;">:</span> PULONG<span style="color: #000066;">;</span> WorkSpace<span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">Pointer</span>
  <span style="color: #000066;">)</span><span style="color: #000066;">:</span> NTSTATUS<span style="color: #000066;">;</span> <span style="color: #000000; font-weight: bold;">stdcall</span><span style="color: #000066;">;</span> <span style="color: #000000; font-weight: bold;">external</span> ntdll<span style="color: #000066;">;</span>
 
<span style="color: #000000; font-weight: bold;">function</span> RtlDecompressBuffer<span style="color: #000066;">(</span>CompressionFormat<span style="color: #000066;">:</span> USHORT<span style="color: #000066;">;</span> UncompressedBuffer<span style="color: #000066;">:</span> PUCHAR<span style="color: #000066;">;</span>
  UncompressedBufferSize<span style="color: #000066;">:</span> ULONG<span style="color: #000066;">;</span> CompressedBuffer<span style="color: #000066;">:</span> PUCHAR<span style="color: #000066;">;</span> CompressedBufferSize<span style="color: #000066;">:</span> ULONG<span style="color: #000066;">;</span>
  FinalUncompressedSize<span style="color: #000066;">:</span> PULONG<span style="color: #000066;">)</span><span style="color: #000066;">:</span> NTSTATUS<span style="color: #000066;">;</span> <span style="color: #000000; font-weight: bold;">stdcall</span><span style="color: #000066;">;</span> <span style="color: #000000; font-weight: bold;">external</span> ntdll<span style="color: #000066;">;</span>
 
<span style="color: #000000; font-weight: bold;">function</span> RtlGetCompressionWorkSpaceSize<span style="color: #000066;">(</span>CompressionFormatAndEngine<span style="color: #000066;">:</span> USHORT<span style="color: #000066;">;</span>
  CompressBufferWorkSpaceSize<span style="color: #000066;">:</span> PULONG<span style="color: #000066;">;</span> CompressFragmentWorkSpaceSize<span style="color: #000066;">:</span> PULONG
<span style="color: #000066;">)</span><span style="color: #000066;">:</span> NTSTATUS<span style="color: #000066;">;</span> <span style="color: #000000; font-weight: bold;">stdcall</span><span style="color: #000066;">;</span> <span style="color: #000000; font-weight: bold;">external</span> ntdll<span style="color: #000066;">;</span>
 
<span style="color: #000000; font-weight: bold;">function</span> CompressStream<span style="color: #000066;">(</span>InStream<span style="color: #000066;">,</span> OutStream<span style="color: #000066;">:</span> TStream<span style="color: #000066;">)</span><span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">Boolean</span><span style="color: #000066;">;</span>
<span style="color: #000000; font-weight: bold;">var</span>
  i<span style="color: #000066;">:</span> ULONG<span style="color: #000066;">;</span>
  Status<span style="color: #000066;">:</span> NTSTATUS<span style="color: #000066;">;</span>
  FormatAndEngine<span style="color: #000066;">:</span> USHORT<span style="color: #000066;">;</span>
  UnCompressedBuffer<span style="color: #000066;">:</span> PUCHAR<span style="color: #000066;">;</span>
  CompressedBuffer<span style="color: #000066;">:</span> PUCHAR<span style="color: #000066;">;</span>
  CompressedBufferSize<span style="color: #000066;">:</span> ULONG<span style="color: #000066;">;</span>
  WorkSpace<span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">Pointer</span><span style="color: #000066;">;</span>
  WorkSpaceSize<span style="color: #000066;">,</span>FragmentWorkSpaceSize<span style="color: #000066;">:</span> ULONG<span style="color: #000066;">;</span>
  BufferHeader<span style="color: #000066;">:</span> TBufferHeader<span style="color: #000066;">;</span>
<span style="color: #000000; font-weight: bold;">begin</span>
  Result<span style="color: #000066;">:</span><span style="color: #000066;">=</span> <span style="color: #000000; font-weight: bold;">FALSE</span><span style="color: #000066;">;</span>
  FormatAndEngine<span style="color: #000066;">:</span><span style="color: #000066;">=</span> COMPRESSION_FORMAT_LZNT1 <span style="color: #000000; font-weight: bold;">or</span> COMPRESSION_ENGINE_STANDARD<span style="color: #000066;">;</span>
  <span style="color: #000000; font-weight: bold;">try</span>
    <span style="color: #000066;">GetMem</span><span style="color: #000066;">(</span>UnCompressedBuffer<span style="color: #000066;">,</span>BUFFER_SIZE<span style="color: #000066;">)</span><span style="color: #000066;">;</span>
    <span style="color: #000000; font-weight: bold;">try</span>
      CompressedBufferSize<span style="color: #000066;">:</span><span style="color: #000066;">=</span> BUFFER_SIZE<span style="color: #000066;">;</span>
      <span style="color: #000066;">GetMem</span><span style="color: #000066;">(</span>CompressedBuffer<span style="color: #000066;">,</span>CompressedBufferSize<span style="color: #000066;">)</span><span style="color: #000066;">;</span>
      <span style="color: #000000; font-weight: bold;">try</span>
        RtlGetCompressionWorkSpaceSize<span style="color: #000066;">(</span>FormatAndEngine<span style="color: #000066;">,</span><span style="color: #000066;">@</span>WorkSpaceSize<span style="color: #000066;">,</span>
          <span style="color: #000066;">@</span>FragmentWorkSpaceSize<span style="color: #000066;">)</span><span style="color: #000066;">;</span>
        <span style="color: #000066;">GetMem</span><span style="color: #000066;">(</span>WorkSpace<span style="color: #000066;">,</span>WorkSpaceSize<span style="color: #000066;">)</span><span style="color: #000066;">;</span>
        <span style="color: #000000; font-weight: bold;">try</span>
          <span style="color: #000000; font-weight: bold;">repeat</span>
            i<span style="color: #000066;">:</span><span style="color: #000066;">=</span> InStream<span style="color: #000066;">.</span><span style="color: #000000; font-weight: bold;">Read</span><span style="color: #000066;">(</span>UnCompressedBuffer<span style="color: #000066;">^</span><span style="color: #000066;">,</span>BUFFER_SIZE<span style="color: #000066;">)</span><span style="color: #000066;">;</span>
            <span style="color: #000000; font-weight: bold;">repeat</span>
              <span style="color: #000066;">FillChar</span><span style="color: #000066;">(</span>BufferHeader<span style="color: #000066;">,</span><span style="color: #000066;">Sizeof</span><span style="color: #000066;">(</span>TBufferHeader<span style="color: #000066;">)</span><span style="color: #000066;">,</span><span style="color: #ff0000;">#0</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
              Status<span style="color: #000066;">:</span><span style="color: #000066;">=</span> RtlCompressBuffer<span style="color: #000066;">(</span>FormatAndEngine<span style="color: #000066;">,</span>UnCompressedBuffer<span style="color: #000066;">,</span>i<span style="color: #000066;">,</span>
                CompressedBuffer<span style="color: #000066;">,</span>CompressedBufferSize<span style="color: #000066;">,</span><span style="color: #0000ff;">4096</span><span style="color: #000066;">,</span><span style="color: #000066;">@</span>BufferHeader<span style="color: #000066;">.</span><span style="color: #006600;">CompressedBufferSize</span><span style="color: #000066;">,</span>
                WorkSpace<span style="color: #000066;">)</span><span style="color: #000066;">;</span>
              <span style="color: #000000; font-weight: bold;">if</span> Status <span style="color: #000066;">=</span> STATUS_BUFFER_TOO_SMALL <span style="color: #000000; font-weight: bold;">then</span>
              <span style="color: #000000; font-weight: bold;">begin</span>
                CompressedBufferSize<span style="color: #000066;">:</span><span style="color: #000066;">=</span> CompressedBufferSize <span style="color: #000066;">+</span> BUFFER_SIZE<span style="color: #000066;">;</span>
                <span style="color: #000066;">ReallocMem</span><span style="color: #000066;">(</span>CompressedBuffer<span style="color: #000066;">,</span>CompressedBufferSize<span style="color: #000066;">)</span><span style="color: #000066;">;</span>
              <span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">;</span>
            <span style="color: #000000; font-weight: bold;">until</span> <span style="color: #000066;">(</span>Status &lt;&gt; STATUS_BUFFER_TOO_SMALL<span style="color: #000066;">)</span> <span style="color: #000000; font-weight: bold;">or</span> <span style="color: #000066;">(</span>CompressedBufferSize &gt; MAX_BUFFER_SIZE<span style="color: #000066;">)</span><span style="color: #000066;">;</span>
            <span style="color: #000000; font-weight: bold;">if</span> <span style="color: #000066;">(</span>Status &lt;&gt; STATUS_SUCCESS<span style="color: #000066;">)</span> <span style="color: #000000; font-weight: bold;">and</span> <span style="color: #000066;">(</span>Status &lt;&gt; STATUS_BUFFER_ALL_ZEROS<span style="color: #000066;">)</span> <span style="color: #000000; font-weight: bold;">then</span>
              Exit<span style="color: #000066;">;</span>
            OutStream<span style="color: #000066;">.</span><span style="color: #006600;">WriteBuffer</span><span style="color: #000066;">(</span>BufferHeader<span style="color: #000066;">,</span><span style="color: #000066;">Sizeof</span><span style="color: #000066;">(</span>TBufferHeader<span style="color: #000066;">)</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
            OutStream<span style="color: #000066;">.</span><span style="color: #006600;">WriteBuffer</span><span style="color: #000066;">(</span>CompressedBuffer<span style="color: #000066;">^</span><span style="color: #000066;">,</span>BufferHeader<span style="color: #000066;">.</span><span style="color: #006600;">CompressedBufferSize</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
          <span style="color: #000000; font-weight: bold;">until</span> i &lt; BUFFER_SIZE<span style="color: #000066;">;</span>
          Result<span style="color: #000066;">:</span><span style="color: #000066;">=</span> <span style="color: #000000; font-weight: bold;">TRUE</span><span style="color: #000066;">;</span>
        <span style="color: #000000; font-weight: bold;">finally</span>
          <span style="color: #000066;">FreeMem</span><span style="color: #000066;">(</span>WorkSpace<span style="color: #000066;">)</span><span style="color: #000066;">;</span>
        <span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">;</span>
      <span style="color: #000000; font-weight: bold;">finally</span>
        <span style="color: #000066;">FreeMem</span><span style="color: #000066;">(</span>CompressedBuffer<span style="color: #000066;">)</span><span style="color: #000066;">;</span>
      <span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">;</span>
    <span style="color: #000000; font-weight: bold;">finally</span>
      <span style="color: #000066;">FreeMem</span><span style="color: #000066;">(</span>UnCompressedBuffer<span style="color: #000066;">)</span><span style="color: #000066;">;</span>
    <span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">;</span>
  <span style="color: #000000; font-weight: bold;">except</span>  <span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">;</span>
<span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">;</span>
 
<span style="color: #000000; font-weight: bold;">function</span> CompressFile<span style="color: #000066;">(</span>Src<span style="color: #000066;">,</span> Dst<span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">String</span><span style="color: #000066;">)</span><span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">Boolean</span><span style="color: #000066;">;</span>
<span style="color: #000000; font-weight: bold;">var</span>
  InStream<span style="color: #000066;">,</span> OutStream<span style="color: #000066;">:</span> TFileStream<span style="color: #000066;">;</span>
<span style="color: #000000; font-weight: bold;">begin</span>
  Result<span style="color: #000066;">:</span><span style="color: #000066;">=</span> <span style="color: #000000; font-weight: bold;">FALSE</span><span style="color: #000066;">;</span>
  <span style="color: #000000; font-weight: bold;">try</span>
    InStream<span style="color: #000066;">:</span><span style="color: #000066;">=</span> TFileStream<span style="color: #000066;">.</span><span style="color: #006600;">Create</span><span style="color: #000066;">(</span>Src<span style="color: #000066;">,</span>fmOpenRead <span style="color: #000000; font-weight: bold;">or</span> fmShareDenyWrite<span style="color: #000066;">)</span><span style="color: #000066;">;</span>
    <span style="color: #000000; font-weight: bold;">try</span>
      OutStream<span style="color: #000066;">:</span><span style="color: #000066;">=</span> TFileStream<span style="color: #000066;">.</span><span style="color: #006600;">Create</span><span style="color: #000066;">(</span>Dst<span style="color: #000066;">,</span>fmCreate <span style="color: #000000; font-weight: bold;">or</span> fmShareDenyWrite<span style="color: #000066;">)</span><span style="color: #000066;">;</span>
      <span style="color: #000000; font-weight: bold;">try</span>
        Result<span style="color: #000066;">:</span><span style="color: #000066;">=</span> CompressStream<span style="color: #000066;">(</span>Instream<span style="color: #000066;">,</span>OutStream<span style="color: #000066;">)</span><span style="color: #000066;">;</span>
      <span style="color: #000000; font-weight: bold;">finally</span>
        OutStream<span style="color: #000066;">.</span><span style="color: #006600;">Free</span><span style="color: #000066;">;</span>
      <span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">;</span>
    <span style="color: #000000; font-weight: bold;">finally</span>
      InStream<span style="color: #000066;">.</span><span style="color: #006600;">Free</span><span style="color: #000066;">;</span>
    <span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">;</span>
  <span style="color: #000000; font-weight: bold;">except</span> <span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">;</span>
<span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">;</span>
 
<span style="color: #000000; font-weight: bold;">function</span> DecompressStream<span style="color: #000066;">(</span>InStream<span style="color: #000066;">,</span> OutStream<span style="color: #000066;">:</span> TStream<span style="color: #000066;">)</span><span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">Boolean</span><span style="color: #000066;">;</span>
<span style="color: #000000; font-weight: bold;">var</span>
  i<span style="color: #000066;">:</span> ULONG<span style="color: #000066;">;</span>
  Status<span style="color: #000066;">:</span> NTSTATUS<span style="color: #000066;">;</span>
  FormatAndEngine<span style="color: #000066;">:</span> USHORT<span style="color: #000066;">;</span>
  UnCompressedBuffer<span style="color: #000066;">:</span> PUCHAR<span style="color: #000066;">;</span>
  UnCompressedBufferSize<span style="color: #000066;">:</span> ULONG<span style="color: #000066;">;</span>
  CompressedBuffer<span style="color: #000066;">:</span> PUCHAR<span style="color: #000066;">;</span>
  WorkSpace<span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">Pointer</span><span style="color: #000066;">;</span>
  WorkSpaceSize<span style="color: #000066;">,</span>FragmentWorkSpaceSize<span style="color: #000066;">:</span> ULONG<span style="color: #000066;">;</span>
  BufferHeader<span style="color: #000066;">:</span> TBufferHeader<span style="color: #000066;">;</span>
<span style="color: #000000; font-weight: bold;">begin</span>
  Result<span style="color: #000066;">:</span><span style="color: #000066;">=</span> <span style="color: #000000; font-weight: bold;">FALSE</span><span style="color: #000066;">;</span>
  FormatAndEngine<span style="color: #000066;">:</span><span style="color: #000066;">=</span> COMPRESSION_FORMAT_LZNT1 <span style="color: #000000; font-weight: bold;">or</span> COMPRESSION_ENGINE_STANDARD<span style="color: #000066;">;</span>
  <span style="color: #000000; font-weight: bold;">try</span>
    UnCompressedBufferSize<span style="color: #000066;">:</span><span style="color: #000066;">=</span> BUFFER_SIZE<span style="color: #000066;">;</span>
    <span style="color: #000066;">GetMem</span><span style="color: #000066;">(</span>UnCompressedBuffer<span style="color: #000066;">,</span>UnCompressedBufferSize<span style="color: #000066;">)</span><span style="color: #000066;">;</span>
    <span style="color: #000000; font-weight: bold;">try</span>
      <span style="color: #000066;">GetMem</span><span style="color: #000066;">(</span>CompressedBuffer<span style="color: #000066;">,</span>BUFFER_SIZE<span style="color: #000066;">)</span><span style="color: #000066;">;</span>
      <span style="color: #000000; font-weight: bold;">try</span>
        RtlGetCompressionWorkSpaceSize<span style="color: #000066;">(</span>FormatAndEngine<span style="color: #000066;">,</span><span style="color: #000066;">@</span>WorkSpaceSize<span style="color: #000066;">,</span>
          <span style="color: #000066;">@</span>FragmentWorkSpaceSize<span style="color: #000066;">)</span><span style="color: #000066;">;</span>
        <span style="color: #000066;">GetMem</span><span style="color: #000066;">(</span>WorkSpace<span style="color: #000066;">,</span>WorkSpaceSize<span style="color: #000066;">)</span><span style="color: #000066;">;</span>
        <span style="color: #000000; font-weight: bold;">try</span>
          <span style="color: #000000; font-weight: bold;">while</span> <span style="color: #000000; font-weight: bold;">TRUE</span> <span style="color: #000000; font-weight: bold;">do</span>
          <span style="color: #000000; font-weight: bold;">begin</span>
            i<span style="color: #000066;">:</span><span style="color: #000066;">=</span> InStream<span style="color: #000066;">.</span><span style="color: #000000; font-weight: bold;">Read</span><span style="color: #000066;">(</span>BufferHeader<span style="color: #000066;">,</span><span style="color: #000066;">SizeOf</span><span style="color: #000066;">(</span>TBufferHeader<span style="color: #000066;">)</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
            <span style="color: #000000; font-weight: bold;">if</span> i <span style="color: #000066;">=</span> <span style="color: #000066;">SizeOf</span><span style="color: #000066;">(</span>TBufferHeader<span style="color: #000066;">)</span> <span style="color: #000000; font-weight: bold;">then</span>
            <span style="color: #000000; font-weight: bold;">begin</span>
              <span style="color: #000000; font-weight: bold;">if</span> BufferHeader<span style="color: #000066;">.</span><span style="color: #006600;">CompressedBufferSize</span> &lt;<span style="color: #000066;">=</span> MAX_BUFFER_SIZE <span style="color: #000000; font-weight: bold;">then</span>
              <span style="color: #000000; font-weight: bold;">begin</span>
                Instream<span style="color: #000066;">.</span><span style="color: #006600;">ReadBuffer</span><span style="color: #000066;">(</span>CompressedBuffer<span style="color: #000066;">^</span><span style="color: #000066;">,</span>BufferHeader<span style="color: #000066;">.</span><span style="color: #006600;">CompressedBufferSize</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
                <span style="color: #000000; font-weight: bold;">repeat</span>
                  Status<span style="color: #000066;">:</span><span style="color: #000066;">=</span> RtlDecompressBuffer<span style="color: #000066;">(</span>FormatAndEngine<span style="color: #000066;">,</span>UnCompressedBuffer<span style="color: #000066;">,</span>UnCompressedBufferSize<span style="color: #000066;">,</span>
                    CompressedBuffer<span style="color: #000066;">,</span>BufferHeader<span style="color: #000066;">.</span><span style="color: #006600;">CompressedBufferSize</span><span style="color: #000066;">,</span><span style="color: #000066;">@</span>i<span style="color: #000066;">)</span><span style="color: #000066;">;</span>
                  <span style="color: #000000; font-weight: bold;">if</span> Status <span style="color: #000066;">=</span> STATUS_BUFFER_TOO_SMALL <span style="color: #000000; font-weight: bold;">then</span>
                  <span style="color: #000000; font-weight: bold;">begin</span>
                    UnCompressedBufferSize<span style="color: #000066;">:</span><span style="color: #000066;">=</span> UnCompressedBufferSize <span style="color: #000066;">+</span> BUFFER_SIZE<span style="color: #000066;">;</span>
                    <span style="color: #000066;">ReallocMem</span><span style="color: #000066;">(</span>UnCompressedBuffer<span style="color: #000066;">,</span>UnCompressedBufferSize<span style="color: #000066;">)</span><span style="color: #000066;">;</span>
                  <span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">;</span>
                <span style="color: #000000; font-weight: bold;">until</span> <span style="color: #000066;">(</span>Status &lt;&gt; STATUS_BUFFER_TOO_SMALL<span style="color: #000066;">)</span> <span style="color: #000000; font-weight: bold;">or</span> <span style="color: #000066;">(</span>UnCompressedBufferSize &gt; MAX_BUFFER_SIZE<span style="color: #000066;">)</span><span style="color: #000066;">;</span>
                <span style="color: #000000; font-weight: bold;">if</span> <span style="color: #000066;">(</span>Status &lt;&gt; STATUS_SUCCESS<span style="color: #000066;">)</span> <span style="color: #000000; font-weight: bold;">and</span> <span style="color: #000066;">(</span>Status &lt;&gt; STATUS_BUFFER_ALL_ZEROS<span style="color: #000066;">)</span> <span style="color: #000000; font-weight: bold;">then</span>
                  Exit<span style="color: #000066;">;</span>
                OutStream<span style="color: #000066;">.</span><span style="color: #006600;">WriteBuffer</span><span style="color: #000066;">(</span>UnCompressedBuffer<span style="color: #000066;">^</span><span style="color: #000066;">,</span>i<span style="color: #000066;">)</span><span style="color: #000066;">;</span>
              <span style="color: #000000; font-weight: bold;">end</span> <span style="color: #000000; font-weight: bold;">else</span>
                Exit<span style="color: #000066;">;</span>
            <span style="color: #000000; font-weight: bold;">end</span> <span style="color: #000000; font-weight: bold;">else</span>
            <span style="color: #000000; font-weight: bold;">begin</span>
              <span style="color: #000000; font-weight: bold;">if</span> i <span style="color: #000066;">=</span> <span style="color: #0000ff;">0</span> <span style="color: #000000; font-weight: bold;">then</span>
                Result<span style="color: #000066;">:</span><span style="color: #000066;">=</span> <span style="color: #000000; font-weight: bold;">TRUE</span><span style="color: #000066;">;</span>
              Exit<span style="color: #000066;">;</span>
            <span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">;</span>
          <span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">;</span>
        <span style="color: #000000; font-weight: bold;">finally</span>
          <span style="color: #000066;">FreeMem</span><span style="color: #000066;">(</span>WorkSpace<span style="color: #000066;">)</span><span style="color: #000066;">;</span>
        <span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">;</span>
      <span style="color: #000000; font-weight: bold;">finally</span>
        <span style="color: #000066;">FreeMem</span><span style="color: #000066;">(</span>CompressedBuffer<span style="color: #000066;">)</span><span style="color: #000066;">;</span>
      <span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">;</span>
    <span style="color: #000000; font-weight: bold;">finally</span>
      <span style="color: #000066;">FreeMem</span><span style="color: #000066;">(</span>UnCompressedBuffer<span style="color: #000066;">)</span><span style="color: #000066;">;</span>
    <span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">;</span>
  <span style="color: #000000; font-weight: bold;">except</span>  <span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">;</span>
<span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">;</span>
 
<span style="color: #000000; font-weight: bold;">function</span> DecompressFile<span style="color: #000066;">(</span>Src<span style="color: #000066;">,</span> Dst<span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">String</span><span style="color: #000066;">)</span><span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">Boolean</span><span style="color: #000066;">;</span>
<span style="color: #000000; font-weight: bold;">var</span>
  InStream<span style="color: #000066;">,</span> OutStream<span style="color: #000066;">:</span> TFileStream<span style="color: #000066;">;</span>
<span style="color: #000000; font-weight: bold;">begin</span>
  Result<span style="color: #000066;">:</span><span style="color: #000066;">=</span> <span style="color: #000000; font-weight: bold;">FALSE</span><span style="color: #000066;">;</span>
  <span style="color: #000000; font-weight: bold;">try</span>
    InStream<span style="color: #000066;">:</span><span style="color: #000066;">=</span> TFileStream<span style="color: #000066;">.</span><span style="color: #006600;">Create</span><span style="color: #000066;">(</span>Src<span style="color: #000066;">,</span>fmOpenRead <span style="color: #000000; font-weight: bold;">or</span> fmShareDenyWrite<span style="color: #000066;">)</span><span style="color: #000066;">;</span>
    <span style="color: #000000; font-weight: bold;">try</span>
      OutStream<span style="color: #000066;">:</span><span style="color: #000066;">=</span> TFileStream<span style="color: #000066;">.</span><span style="color: #006600;">Create</span><span style="color: #000066;">(</span>Dst<span style="color: #000066;">,</span>fmCreate <span style="color: #000000; font-weight: bold;">or</span> fmShareDenyWrite<span style="color: #000066;">)</span><span style="color: #000066;">;</span>
      <span style="color: #000000; font-weight: bold;">try</span>
        Result<span style="color: #000066;">:</span><span style="color: #000066;">=</span> DecompressStream<span style="color: #000066;">(</span>Instream<span style="color: #000066;">,</span>OutStream<span style="color: #000066;">)</span><span style="color: #000066;">;</span>
      <span style="color: #000000; font-weight: bold;">finally</span>
        OutStream<span style="color: #000066;">.</span><span style="color: #006600;">Free</span><span style="color: #000066;">;</span>
      <span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">;</span>
    <span style="color: #000000; font-weight: bold;">finally</span>
      InStream<span style="color: #000066;">.</span><span style="color: #006600;">Free</span><span style="color: #000066;">;</span>
    <span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">;</span>
  <span style="color: #000000; font-weight: bold;">except</span> <span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">;</span>
<span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">;</span>
 
<span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">.</span></pre></div>
<p>Un ejemplo de como usar las funciones anteriores:</p>
<div class="geshifilter">
<pre class="delphi geshifilter-delphi" style="font-family:monospace;">  <span style="color: #000000; font-weight: bold;">if</span> CompressFile<span style="color: #000066;">(</span><span style="color: #ff0000;">'C:\1.txt'</span><span style="color: #000066;">,</span><span style="color: #ff0000;">'C:\1.bin'</span><span style="color: #000066;">)</span> <span style="color: #000000; font-weight: bold;">then</span>
    DecompressFile<span style="color: #000066;">(</span><span style="color: #ff0000;">'c:\1.bin'</span><span style="color: #000066;">,</span><span style="color: #ff0000;">'C:\1.txt'</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span></pre></div>
<p>Los ratios de compresión no son una maravilla, dependiendo del archivo podremos tener archivos comprimidos hasta un 30% mas grandes que los obtenidos con compresores comerciales como Winzip o Winrar, pero lo que perdemos en ratios de compresión lo ganamos en sencillez. En resumen, se trata de una alternativa más, que se puede mejorar de muchas manera pero que puede ser útil en algunos casos puntuales.</p>
<p>Para saber más:<br /><a href="http://msdn.microsoft.com/en-us/library/bb981783.aspx">http://msdn.microsoft.com/en-us/library/bb981783.aspx</a></p>
</div></div></div>    <footer>
        <ul class="links list-inline"><li class="comment_forbidden first last"></li>
</ul>  </footer>
    <div id="comments" class="comment-wrapper">
          <h2 class="title">Comentarios</h2>
      
  <a id="comment-112"></a>
<div class="comment comment-by-anonymous clearfix" about="/comment/112#comment-112" typeof="sioc:Post sioct:Comment">
  
  
    <h3 property="dc:title" datatype=""><a href="/comment/112#comment-112" class="permalink" rel="bookmark">Muy bueno, amigo, voy a hacer</a></h3>
  
  <div class="submitted">
    <a href="/comment/112#comment-112" class="permalink" rel="bookmark">Enlace permanente</a>    <span property="dc:date dc:created" content="2009-05-02T14:11:00+02:00" datatype="xsd:dateTime" rel="sioc:has_creator">Enviado por <span class="username" xml:lang="" typeof="sioc:UserAccount" property="foaf:name" datatype="">ctrl.attack (no verificado)</span> el Sáb, 05/02/2009 - 14:11</span>  </div>

  <div class="content">
    <span rel="sioc:reply_of" resource="/node/51" class="rdf-meta element-hidden"></span><div class="field field-name-comment-body field-type-text-long field-label-hidden"><div class="field-items"><div class="field-item even" property="content:encoded"><p>Muy bueno, amigo, voy a hacer unas pruebas para ver como trabaja, gracias..</p>
<p>¿Tiene algun statusbar para indicar el estado de compresion del archivo?</p>
</div></div></div>      </div>

  <ul class="links list-inline"><li class="comment_forbidden first last"></li>
</ul></div>

<div class="indented"><a id="comment-113"></a>
<div class="comment comment-by-node-author clearfix" about="/comment/113#comment-113" typeof="sioc:Post sioct:Comment">
  
  
    <h3 property="dc:title" datatype=""><a href="/comment/113#comment-113" class="permalink" rel="bookmark">No, no tiene ningún</a></h3>
  
  <div class="submitted">
    <a href="/comment/113#comment-113" class="permalink" rel="bookmark">Enlace permanente</a>    <span property="dc:date dc:created" content="2009-05-03T04:13:00+02:00" datatype="xsd:dateTime" rel="sioc:has_creator">Enviado por <span class="username" xml:lang="" about="/user/1" typeof="sioc:UserAccount" property="foaf:name" datatype="">admin</span> el Dom, 05/03/2009 - 04:13</span>  </div>

  <div class="content">
    <span rel="sioc:reply_of" resource="/node/51" class="rdf-meta element-hidden"></span><span rel="sioc:reply_of" resource="/comment/112#comment-112" class="rdf-meta element-hidden"></span><div class="field field-name-comment-body field-type-text-long field-label-hidden"><div class="field-items"><div class="field-item even" property="content:encoded"><p>No, no tiene ningún statusbar. El ejemplo es intencionadamente sencillo, pero puedes añadirle un statusbar muy fácilmente, solo tienes que obtener el tamaño del archivo al comenzar y dentro del bucle "repeat ... until" ir modificando la posición del statusbar cada vez que comprimas o descomprimas un bloque.</p>
</div></div></div>      </div>

  <ul class="links list-inline"><li class="comment_forbidden first last"></li>
</ul></div>
</div>
  </div>
</article>

</section>
  </div>
    </section>

    
  </div>
</div>

  <script src="/sites/delphi.jmrds.com/themes/bootstrap/js/bootstrap.js?"></script>
</body>
</html>
