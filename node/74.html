<!DOCTYPE html>
<html lang="es" dir="ltr" prefix="content: http://purl.org/rss/1.0/modules/content/ dc: http://purl.org/dc/terms/ foaf: http://xmlns.com/foaf/0.1/ og: http://ogp.me/ns# rdfs: http://www.w3.org/2000/01/rdf-schema# sioc: http://rdfs.org/sioc/ns# sioct: http://rdfs.org/sioc/types# skos: http://www.w3.org/2004/02/skos/core# xsd: http://www.w3.org/2001/XMLSchema#">
<head>
  <link rel="profile" href="http://www.w3.org/1999/xhtml/vocab" />
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<link rel="shortcut icon" href="/sites/delphi.jmrds.com/themes/bootstrap/favicon.ico" type="image/vnd.microsoft.icon" />
<link rel="shortlink" href="/node/74" />
<link rel="canonical" href="/node/74" />
<meta name="Generator" content="Drupal 7 (http://drupal.org)" />
  <title>Leer contenido de la FAT | La web de Seoane</title>
  <style>
@import url("/modules/system/system.base.css?");
</style>
<style>
@import url("/modules/field/theme/field.css?");
@import url("/modules/node/node.css?");
</style>
<style>
@import url("/sites/delphi.jmrds.com/modules/geshifilter/geshifilter.css?");
</style>
<link type="text/css" rel="stylesheet" href="//cdn.jsdelivr.net/bootstrap/3.3.5/css/bootstrap.css" media="all" />
<style>
@import url("/sites/delphi.jmrds.com/themes/bootstrap/css/3.3.5/overrides.min.css?");
</style>
  <!-- HTML5 element support for IE6-8 -->
  <!--[if lt IE 9]>
    <script src="https://cdn.jsdelivr.net/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
  <![endif]-->
  <script src="/sites/delphi.jmrds.com/modules/jquery_update/replace/jquery/1.10/jquery.min.js?v=1.10.2"></script>
<script src="/misc/jquery.once.js?v=1.2"></script>
<script src="/misc/drupal.js?"></script>
<script src="//cdn.jsdelivr.net/bootstrap/3.3.5/js/bootstrap.js"></script>
<script src="/sites/delphi.jmrds.com/files/languages/es_sB9mP1iixuFRbyZKZVySK7xrSW_2-LRj1vNEXyqwOu8.js?"></script>
<script>jQuery.extend(Drupal.settings, {"basePath":"\/","pathPrefix":"","ajaxPageState":{"theme":"bootstrap","theme_token":"ectagFAJ4kf2d1pVfIpOYec2Jv2t5He6ePW304vqwf0","js":{"sites\/delphi.jmrds.com\/themes\/bootstrap\/js\/bootstrap.js":1,"sites\/delphi.jmrds.com\/modules\/jquery_update\/replace\/jquery\/1.10\/jquery.min.js":1,"misc\/jquery.once.js":1,"misc\/drupal.js":1,"\/\/cdn.jsdelivr.net\/bootstrap\/3.3.5\/js\/bootstrap.js":1,"public:\/\/languages\/es_sB9mP1iixuFRbyZKZVySK7xrSW_2-LRj1vNEXyqwOu8.js":1},"css":{"modules\/system\/system.base.css":1,"modules\/field\/theme\/field.css":1,"modules\/node\/node.css":1,"sites\/delphi.jmrds.com\/modules\/geshifilter\/geshifilter.css":1,"\/\/cdn.jsdelivr.net\/bootstrap\/3.3.5\/css\/bootstrap.css":1,"sites\/delphi.jmrds.com\/themes\/bootstrap\/css\/3.3.5\/overrides.min.css":1}},"bootstrap":{"anchorsFix":"0","anchorsSmoothScrolling":"0","formHasError":1,"popoverEnabled":"1","popoverOptions":{"animation":1,"html":0,"placement":"right","selector":"","trigger":"click","triggerAutoclose":1,"title":"","content":"","delay":0,"container":"body"},"tooltipEnabled":"1","tooltipOptions":{"animation":1,"html":0,"placement":"auto left","selector":"","trigger":"hover focus","delay":0,"container":"body"}}});</script>
</head>
<body class="html not-front not-logged-in no-sidebars page-node page-node- page-node-74 node-type-article">
  <div id="skip-link">
    <a href="#main-content" class="element-invisible element-focusable">Pasar al contenido principal</a>
  </div>
    <header id="navbar" role="banner" class="navbar container navbar-default">
  <div class="container">
    <div class="navbar-header">
              <a class="logo navbar-btn pull-left" href="/" title="Inicio">
          <img src="/sites/delphi.jmrds.com/themes/bootstrap/logo.png" alt="Inicio" />
        </a>
      
              <a class="name navbar-brand" href="/" title="Inicio">La web de Seoane</a>
      
              <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#navbar-collapse">
          <span class="sr-only">Toggle navigation</span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
          </div>

          <div class="navbar-collapse collapse" id="navbar-collapse">
        <nav role="navigation">
                      <ul class="menu nav navbar-nav"><li class="first leaf"><a href="/" title="">Inicio</a></li>
<li class="last leaf"><a href="/node/26" title="">Contacto</a></li>
</ul>                                      </nav>
      </div>
      </div>
</header>

<div class="main-container container">

  <header role="banner" id="page-header">
    
      </header> <!-- /#page-header -->

  <div class="row">

    
    <section class="col-sm-12">
                  <a id="main-content"></a>
                    <h1 class="page-header">Leer contenido de la FAT</h1>
                                                          <div class="region region-content">
    <section id="block-system-main" class="block block-system clearfix">

      
  <article id="node-74" class="node node-article node-promoted clearfix" about="/node/74" typeof="sioc:Item foaf:Document">
    <header>
            <span property="dc:title" content="Leer contenido de la FAT" class="rdf-meta element-hidden"></span><span property="sioc:num_replies" content="0" datatype="xsd:integer" class="rdf-meta element-hidden"></span>        <span class="submitted">
            <span property="dc:date dc:created" content="2012-04-27T22:52:10+02:00" datatype="xsd:dateTime" rel="sioc:has_creator">Enviado por <span class="username" xml:lang="" about="/user/1" typeof="sioc:UserAccount" property="foaf:name" datatype="">admin</span> el Vie, 04/27/2012 - 22:52</span>    </span>
      </header>
    <div class="field field-name-body field-type-text-with-summary field-label-hidden"><div class="field-items"><div class="field-item even" property="content:encoded"><p>El siguiente programa permite leer el sector de arranque de una partición del tipo FAT32, el mismo tipo de partición que usan la mayoría de las memorias USB y tarjetas de memoria, y volcar la información que contiene, así como extraer la estructura de directorios directamente de la FAT. La lectura se puede hacer directamente sobre un disco, o sobre un fichero de imagen creado con alguna herramienta como <a href="http://delphi.jmrds.com/node/45">Dump</a>. En futuras versiones tengo intención de poder extraer el contenido de los ficheros, aunque por ahora solo podemos ver su nombre.</p>
<!--break--><p>El código es el siguiente (es una aplicación de consola):</p>
<div class="geshifilter">
<pre class="delphi geshifilter-delphi" style="font-family:monospace;"><span style="color: #000000; font-weight: bold;">unit</span> umain<span style="color: #000066;">;</span>
 
<span style="color: #000000; font-weight: bold;">interface</span>
 
<span style="color: #000000; font-weight: bold;">uses</span> Windows<span style="color: #000066;">,</span> Sysutils<span style="color: #000066;">,</span> Classes<span style="color: #000066;">;</span>
 
<span style="color: #000000; font-weight: bold;">procedure</span> main<span style="color: #000066;">;</span>
 
<span style="color: #000000; font-weight: bold;">implementation</span>
 
<span style="color: #000000; font-weight: bold;">type</span>
  PDWordArray <span style="color: #000066;">=</span> <span style="color: #000066;">^</span>TDWordArray<span style="color: #000066;">;</span>
  TDWordArray <span style="color: #000066;">=</span> <span style="color: #000000; font-weight: bold;">array</span><span style="color: #000066;">[</span><span style="color: #0000ff;">0</span><span style="color: #000066;">..</span><span style="color: #0000cc;">$0FFFFFFF</span><span style="color: #000066;">]</span> <span style="color: #000000; font-weight: bold;">of</span> <span style="color: #000066; font-weight: bold;">DWord</span><span style="color: #000066;">;</span>
 
  TPartition <span style="color: #000066;">=</span> <span style="color: #000000; font-weight: bold;">record</span>
    Stream<span style="color: #000066;">:</span> TFileStream<span style="color: #000066;">;</span>
    PartType<span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">Byte</span><span style="color: #000066;">;</span>
    PartBegin<span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">DWord</span><span style="color: #000066;">;</span>
    BytsPerSec<span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">Word</span><span style="color: #000066;">;</span>
    SecPerClus<span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">Byte</span><span style="color: #000066;">;</span>
    BytsPerClus<span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">Word</span><span style="color: #000066;">;</span>
    RsvdSecCnt<span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">Word</span><span style="color: #000066;">;</span>
    NumFATs<span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">Byte</span><span style="color: #000066;">;</span>
    FATSz32<span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">Word</span><span style="color: #000066;">;</span>
    ClusCount<span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">DWord</span><span style="color: #000066;">;</span>
    ClusBegin<span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">DWord</span><span style="color: #000066;">;</span>
    RootClus<span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">DWord</span><span style="color: #000066;">;</span>
    FAT<span style="color: #000066;">:</span> PDWordArray<span style="color: #000066;">;</span>
  <span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">;</span> 
 
<span style="color: #000000; font-weight: bold;">function</span> <span style="color: #000066;">Min</span><span style="color: #000066;">(</span>i<span style="color: #000066;">,</span>j<span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">Integer</span><span style="color: #000066;">)</span><span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">Integer</span><span style="color: #000066;">;</span>
<span style="color: #000000; font-weight: bold;">begin</span>
  <span style="color: #000000; font-weight: bold;">if</span> i &lt; j <span style="color: #000000; font-weight: bold;">then</span>
    Result<span style="color: #000066;">:</span><span style="color: #000066;">=</span> i
  <span style="color: #000000; font-weight: bold;">else</span>
    Result<span style="color: #000066;">:</span><span style="color: #000066;">=</span> j<span style="color: #000066;">;</span>
<span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">;</span>
 
<span style="color: #808080; font-style: italic;">// Muestra el contenido del buffer en hexadecimal y como texto</span>
<span style="color: #000000; font-weight: bold;">procedure</span> WriteHex<span style="color: #000066;">(</span>Buffer<span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">PAnsiChar</span><span style="color: #000066;">;</span>  Count<span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">Integer</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
<span style="color: #000000; font-weight: bold;">var</span>
  i<span style="color: #000066;">,</span>j<span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">Integer</span><span style="color: #000066;">;</span>
<span style="color: #000000; font-weight: bold;">begin</span>
  j<span style="color: #000066;">:</span><span style="color: #000066;">=</span> <span style="color: #0000ff;">0</span><span style="color: #000066;">;</span>
  <span style="color: #000000; font-weight: bold;">while</span> Count &gt; <span style="color: #0000ff;">0</span> <span style="color: #000000; font-weight: bold;">do</span>
  <span style="color: #000000; font-weight: bold;">begin</span>
    <span style="color: #000000; font-weight: bold;">Write</span><span style="color: #000066;">(</span><span style="color: #000066;">IntToHex</span><span style="color: #000066;">(</span>j<span style="color: #000066;">,</span><span style="color: #0000ff;">8</span><span style="color: #000066;">)</span> <span style="color: #000066;">+</span> <span style="color: #ff0000;">':'</span> <span style="color: #000066;">+</span> <span style="color: #ff0000;">#32</span><span style="color: #ff0000;">#32</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
    <span style="color: #000000; font-weight: bold;">for</span> i<span style="color: #000066;">:</span><span style="color: #000066;">=</span> <span style="color: #0000ff;">0</span> <span style="color: #000000; font-weight: bold;">to</span> <span style="color: #000066;">Min</span><span style="color: #000066;">(</span>Count<span style="color: #000066;">,</span><span style="color: #0000ff;">8</span><span style="color: #000066;">)</span> <span style="color: #000066;">-</span> <span style="color: #0000ff;">1</span> <span style="color: #000000; font-weight: bold;">do</span>
      <span style="color: #000000; font-weight: bold;">Write</span><span style="color: #000066;">(</span><span style="color: #000066;">IntToHex</span><span style="color: #000066;">(</span><span style="color: #000066; font-weight: bold;">Byte</span><span style="color: #000066;">(</span>Buffer<span style="color: #000066;">[</span>i<span style="color: #000066;">]</span><span style="color: #000066;">)</span><span style="color: #000066;">,</span><span style="color: #0000ff;">2</span><span style="color: #000066;">)</span> <span style="color: #000066;">+</span> <span style="color: #ff0000;">#32</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
    <span style="color: #000000; font-weight: bold;">Write</span><span style="color: #000066;">(</span><span style="color: #ff0000;">#32</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
    <span style="color: #000000; font-weight: bold;">for</span> i<span style="color: #000066;">:</span><span style="color: #000066;">=</span> <span style="color: #0000ff;">8</span> <span style="color: #000000; font-weight: bold;">to</span> <span style="color: #000066;">Min</span><span style="color: #000066;">(</span>Count<span style="color: #000066;">,</span><span style="color: #0000ff;">16</span><span style="color: #000066;">)</span> <span style="color: #000066;">-</span> <span style="color: #0000ff;">1</span> <span style="color: #000000; font-weight: bold;">do</span>
      <span style="color: #000000; font-weight: bold;">Write</span><span style="color: #000066;">(</span><span style="color: #000066;">IntToHex</span><span style="color: #000066;">(</span><span style="color: #000066; font-weight: bold;">Byte</span><span style="color: #000066;">(</span>Buffer<span style="color: #000066;">[</span>i<span style="color: #000066;">]</span><span style="color: #000066;">)</span><span style="color: #000066;">,</span><span style="color: #0000ff;">2</span><span style="color: #000066;">)</span> <span style="color: #000066;">+</span> <span style="color: #ff0000;">#32</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
    <span style="color: #000000; font-weight: bold;">for</span> i<span style="color: #000066;">:</span><span style="color: #000066;">=</span> <span style="color: #000066;">Min</span><span style="color: #000066;">(</span>Count<span style="color: #000066;">,</span><span style="color: #0000ff;">16</span><span style="color: #000066;">)</span> <span style="color: #000000; font-weight: bold;">to</span> <span style="color: #0000ff;">15</span> <span style="color: #000000; font-weight: bold;">do</span>
      <span style="color: #000000; font-weight: bold;">Write</span><span style="color: #000066;">(</span><span style="color: #ff0000;">#32</span><span style="color: #ff0000;">#32</span><span style="color: #ff0000;">#32</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
    <span style="color: #000000; font-weight: bold;">Write</span><span style="color: #000066;">(</span><span style="color: #ff0000;">#32</span> <span style="color: #000066;">+</span> <span style="color: #ff0000;">'|'</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
    <span style="color: #000000; font-weight: bold;">for</span> i<span style="color: #000066;">:</span><span style="color: #000066;">=</span> <span style="color: #0000ff;">0</span> <span style="color: #000000; font-weight: bold;">to</span> <span style="color: #000066;">Min</span><span style="color: #000066;">(</span>Count<span style="color: #000066;">,</span><span style="color: #0000ff;">16</span><span style="color: #000066;">)</span> <span style="color: #000066;">-</span> <span style="color: #0000ff;">1</span> <span style="color: #000000; font-weight: bold;">do</span>
    <span style="color: #000000; font-weight: bold;">if</span> <span style="color: #000066; font-weight: bold;">Char</span><span style="color: #000066;">(</span>Buffer<span style="color: #000066;">[</span>i<span style="color: #000066;">]</span><span style="color: #000066;">)</span> <span style="color: #000000; font-weight: bold;">in</span> <span style="color: #000066;">[</span><span style="color: #ff0000;">'A'</span><span style="color: #000066;">..</span><span style="color: #ff0000;">'Z'</span><span style="color: #000066;">,</span><span style="color: #ff0000;">'a'</span><span style="color: #000066;">..</span><span style="color: #ff0000;">'z'</span><span style="color: #000066;">,</span><span style="color: #ff0000;">'0'</span><span style="color: #000066;">..</span><span style="color: #ff0000;">'9'</span><span style="color: #000066;">]</span> <span style="color: #000000; font-weight: bold;">then</span>
      <span style="color: #000000; font-weight: bold;">Write</span><span style="color: #000066;">(</span>Buffer<span style="color: #000066;">[</span>i<span style="color: #000066;">]</span><span style="color: #000066;">)</span>
    <span style="color: #000000; font-weight: bold;">else</span>
      <span style="color: #000000; font-weight: bold;">Write</span><span style="color: #000066;">(</span><span style="color: #ff0000;">'.'</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
    <span style="color: #000066;">Writeln</span><span style="color: #000066;">(</span><span style="color: #ff0000;">'|'</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
    <span style="color: #000066;">Dec</span><span style="color: #000066;">(</span>Count<span style="color: #000066;">,</span><span style="color: #0000ff;">16</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
    <span style="color: #000066;">inc</span><span style="color: #000066;">(</span>Buffer<span style="color: #000066;">,</span><span style="color: #0000ff;">16</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
    <span style="color: #000066;">inc</span><span style="color: #000066;">(</span>j<span style="color: #000066;">,</span><span style="color: #0000ff;">16</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
  <span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">;</span>
<span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">;</span>
 
<span style="color: #000000; font-weight: bold;">function</span> FormatFileSize<span style="color: #000066;">(</span><span style="color: #000000; font-weight: bold;">const</span> Bytes<span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">int64</span><span style="color: #000066;">)</span><span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">String</span><span style="color: #000066;">;</span>
<span style="color: #000000; font-weight: bold;">const</span>
  B <span style="color: #000066;">=</span> <span style="color: #0000ff;">1</span><span style="color: #000066;">;</span>          <span style="color: #808080; font-style: italic;">// Byte</span>
  KB <span style="color: #000066;">=</span> <span style="color: #0000ff;">1024</span> <span style="color: #000066;">*</span> B<span style="color: #000066;">;</span>  <span style="color: #808080; font-style: italic;">// Kilobyte</span>
  MB <span style="color: #000066;">=</span> <span style="color: #0000ff;">1024</span> <span style="color: #000066;">*</span> KB<span style="color: #000066;">;</span> <span style="color: #808080; font-style: italic;">// Megabyte</span>
  GB <span style="color: #000066;">=</span> <span style="color: #0000ff;">1024</span> <span style="color: #000066;">*</span> MB<span style="color: #000066;">;</span> <span style="color: #808080; font-style: italic;">// Gigabyte</span>
<span style="color: #000000; font-weight: bold;">begin</span>
  <span style="color: #000000; font-weight: bold;">if</span> Bytes &gt; GB <span style="color: #000000; font-weight: bold;">then</span>
    Result <span style="color: #000066;">:</span><span style="color: #000066;">=</span> <span style="color: #000066;">FormatFloat</span><span style="color: #000066;">(</span><span style="color: #ff0000;">'0.00 GB'</span><span style="color: #000066;">,</span> Bytes <span style="color: #000066;">/</span> GB<span style="color: #000066;">)</span>
  <span style="color: #000000; font-weight: bold;">else</span> <span style="color: #000000; font-weight: bold;">if</span> Bytes &gt; MB <span style="color: #000000; font-weight: bold;">then</span>
    Result <span style="color: #000066;">:</span><span style="color: #000066;">=</span> <span style="color: #000066;">FormatFloat</span><span style="color: #000066;">(</span><span style="color: #ff0000;">'0.00 MB'</span><span style="color: #000066;">,</span> Bytes <span style="color: #000066;">/</span> MB<span style="color: #000066;">)</span>
  <span style="color: #000000; font-weight: bold;">else</span> <span style="color: #000000; font-weight: bold;">if</span> Bytes &gt; KB <span style="color: #000000; font-weight: bold;">then</span>
    Result <span style="color: #000066;">:</span><span style="color: #000066;">=</span> <span style="color: #000066;">FormatFloat</span><span style="color: #000066;">(</span><span style="color: #ff0000;">'0.00 KB'</span><span style="color: #000066;">,</span> Bytes <span style="color: #000066;">/</span> KB<span style="color: #000066;">)</span>
  <span style="color: #000000; font-weight: bold;">else</span>
    Result <span style="color: #000066;">:</span><span style="color: #000066;">=</span> <span style="color: #000066;">FormatFloat</span><span style="color: #000066;">(</span>   <span style="color: #ff0000;">'0   '</span><span style="color: #000066;">,</span> Bytes<span style="color: #000066;">)</span><span style="color: #000066;">;</span>
<span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">;</span>
 
<span style="color: #808080; font-style: italic;">// Lee el MasterBootRecord</span>
<span style="color: #000000; font-weight: bold;">procedure</span> ReadMasterBootRecord<span style="color: #000066;">(</span><span style="color: #000000; font-weight: bold;">var</span> Partition<span style="color: #000066;">:</span> TPartition<span style="color: #000066;">)</span><span style="color: #000066;">;</span>
<span style="color: #000000; font-weight: bold;">var</span>
  i<span style="color: #000066;">,</span>j<span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">Integer</span><span style="color: #000066;">;</span>
  Buffer<span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">PByteArray</span><span style="color: #000066;">;</span>
<span style="color: #000000; font-weight: bold;">begin</span>
  <span style="color: #808080; font-style: italic;">// Reservamos memoria para guardar el MBR</span>
  <span style="color: #000066;">GetMem</span><span style="color: #000066;">(</span>Buffer<span style="color: #000066;">,</span><span style="color: #0000cc;">$0200</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
  <span style="color: #000000; font-weight: bold;">try</span>
    <span style="color: #000000; font-weight: bold;">with</span> Partition <span style="color: #000000; font-weight: bold;">do</span>
    <span style="color: #000000; font-weight: bold;">begin</span>
      <span style="color: #808080; font-style: italic;">// Leemos el MBR</span>
      Stream<span style="color: #000066;">.</span><span style="color: #006600;">ReadBuffer</span><span style="color: #000066;">(</span>Buffer<span style="color: #000066;">^</span><span style="color: #000066;">,</span><span style="color: #0000cc;">$0200</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
      <span style="color: #808080; font-style: italic;">// Volcamos en pantalla el contenido del MBR</span>
      <span style="color: #000066;">Writeln</span><span style="color: #000066;">(</span><span style="color: #ff0000;">'=== Master Boot Record ==='</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
      WriteHex<span style="color: #000066;">(</span><span style="color: #000066; font-weight: bold;">PAnsiChar</span><span style="color: #000066;">(</span>Buffer<span style="color: #000066;">)</span><span style="color: #000066;">,</span> <span style="color: #0000cc;">$0200</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
      Writeln<span style="color: #000066;">;</span>
      <span style="color: #808080; font-style: italic;">// Comprobamos la firma del MBR</span>
      <span style="color: #000000; font-weight: bold;">if</span> <span style="color: #000066; font-weight: bold;">PWORD</span><span style="color: #000066;">(</span><span style="color: #000066;">@</span>Buffer<span style="color: #000066;">[</span><span style="color: #0000cc;">$01FE</span><span style="color: #000066;">]</span><span style="color: #000066;">)</span><span style="color: #000066;">^</span> &lt;&gt; <span style="color: #0000cc;">$AA55</span> <span style="color: #000000; font-weight: bold;">then</span>
        <span style="color: #000000; font-weight: bold;">raise</span> Exception<span style="color: #000066;">.</span><span style="color: #006600;">Create</span><span style="color: #000066;">(</span><span style="color: #ff0000;">'Invalid MBR signature = '</span>
          <span style="color: #000066;">+</span> <span style="color: #000066;">IntToHex</span><span style="color: #000066;">(</span><span style="color: #000066;">Swap</span><span style="color: #000066;">(</span><span style="color: #000066; font-weight: bold;">PWORD</span><span style="color: #000066;">(</span><span style="color: #000066;">@</span>Buffer<span style="color: #000066;">[</span><span style="color: #0000cc;">$01FE</span><span style="color: #000066;">]</span><span style="color: #000066;">)</span><span style="color: #000066;">^</span><span style="color: #000066;">)</span><span style="color: #000066;">,</span><span style="color: #0000ff;">2</span><span style="color: #000066;">)</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
      <span style="color: #808080; font-style: italic;">// Volcamos la tabla de particiones</span>
      <span style="color: #000066;">Writeln</span><span style="color: #000066;">(</span><span style="color: #ff0000;">'=== Table ==='</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
      WriteHex<span style="color: #000066;">(</span><span style="color: #000066; font-weight: bold;">PAnsiChar</span><span style="color: #000066;">(</span><span style="color: #000066;">@</span>Buffer<span style="color: #000066;">[</span><span style="color: #0000cc;">$01BE</span><span style="color: #000066;">]</span><span style="color: #000066;">)</span><span style="color: #000066;">,</span> <span style="color: #0000cc;">$0040</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
      Writeln<span style="color: #000066;">;</span>
      <span style="color: #808080; font-style: italic;">// Volcamos cada entrada de la tabla de particiones</span>
      <span style="color: #000066;">Writeln</span><span style="color: #000066;">(</span><span style="color: #ff0000;">'=== Partitions ==='</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
      <span style="color: #000000; font-weight: bold;">for</span> i<span style="color: #000066;">:</span><span style="color: #000066;">=</span> <span style="color: #0000ff;">0</span> <span style="color: #000000; font-weight: bold;">to</span> <span style="color: #0000ff;">3</span> <span style="color: #000000; font-weight: bold;">do</span>
      <span style="color: #000000; font-weight: bold;">begin</span>
        j<span style="color: #000066;">:</span><span style="color: #000066;">=</span> <span style="color: #0000cc;">$01BE</span> <span style="color: #000066;">+</span> <span style="color: #000066;">(</span><span style="color: #0000ff;">16</span> <span style="color: #000066;">*</span> i<span style="color: #000066;">)</span><span style="color: #000066;">;</span>
        <span style="color: #000000; font-weight: bold;">if</span> Buffer<span style="color: #000066;">[</span>j<span style="color: #000066;">]</span> <span style="color: #000066;">=</span> <span style="color: #0000cc;">$80</span> <span style="color: #000000; font-weight: bold;">then</span>
          <span style="color: #000066;">Writeln</span><span style="color: #000066;">(</span><span style="color: #000066;">Format</span><span style="color: #000066;">(</span><span style="color: #ff0000;">'[%d] %8.8x/%8.8x A'</span><span style="color: #000066;">,</span><span style="color: #000066;">[</span>i<span style="color: #000066;">,</span>
            <span style="color: #000066; font-weight: bold;">PDWORD</span><span style="color: #000066;">(</span><span style="color: #000066;">@</span>Buffer<span style="color: #000066;">[</span>j <span style="color: #000066;">+</span> <span style="color: #0000cc;">$08</span><span style="color: #000066;">]</span><span style="color: #000066;">)</span><span style="color: #000066;">^</span><span style="color: #000066;">,</span><span style="color: #000066; font-weight: bold;">PDWORD</span><span style="color: #000066;">(</span><span style="color: #000066;">@</span>Buffer<span style="color: #000066;">[</span>j <span style="color: #000066;">+</span> <span style="color: #0000cc;">$0C</span><span style="color: #000066;">]</span><span style="color: #000066;">)</span><span style="color: #000066;">^</span><span style="color: #000066;">]</span><span style="color: #000066;">)</span><span style="color: #000066;">)</span>
        <span style="color: #000000; font-weight: bold;">else</span>
          <span style="color: #000066;">Writeln</span><span style="color: #000066;">(</span><span style="color: #000066;">Format</span><span style="color: #000066;">(</span><span style="color: #ff0000;">'[%d] %8.8x/%8.8x'</span><span style="color: #000066;">,</span><span style="color: #000066;">[</span>i<span style="color: #000066;">,</span>
            <span style="color: #000066; font-weight: bold;">PDWORD</span><span style="color: #000066;">(</span><span style="color: #000066;">@</span>Buffer<span style="color: #000066;">[</span>j <span style="color: #000066;">+</span> <span style="color: #0000cc;">$08</span><span style="color: #000066;">]</span><span style="color: #000066;">)</span><span style="color: #000066;">^</span><span style="color: #000066;">,</span><span style="color: #000066; font-weight: bold;">PDWORD</span><span style="color: #000066;">(</span><span style="color: #000066;">@</span>Buffer<span style="color: #000066;">[</span>j <span style="color: #000066;">+</span> <span style="color: #0000cc;">$0C</span><span style="color: #000066;">]</span><span style="color: #000066;">)</span><span style="color: #000066;">^</span><span style="color: #000066;">]</span><span style="color: #000066;">)</span><span style="color: #000066;">)</span>
      <span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">;</span>
      Writeln<span style="color: #000066;">;</span>
      <span style="color: #808080; font-style: italic;">// Usamos siempre la primera particion</span>
      <span style="color: #000066;">Writeln</span><span style="color: #000066;">(</span><span style="color: #ff0000;">'Go to partition 0 ...'</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
      Writeln<span style="color: #000066;">;</span>
      PartType<span style="color: #000066;">:</span><span style="color: #000066;">=</span> Buffer<span style="color: #000066;">[</span><span style="color: #0000cc;">$01BE</span> <span style="color: #000066;">+</span> <span style="color: #0000cc;">$04</span><span style="color: #000066;">]</span><span style="color: #000066;">;</span>
      PartBegin<span style="color: #000066;">:</span><span style="color: #000066;">=</span> <span style="color: #000066; font-weight: bold;">PDWORD</span><span style="color: #000066;">(</span><span style="color: #000066;">@</span>Buffer<span style="color: #000066;">[</span><span style="color: #0000cc;">$01BE</span> <span style="color: #000066;">+</span> <span style="color: #0000cc;">$08</span><span style="color: #000066;">]</span><span style="color: #000066;">)</span><span style="color: #000066;">^</span><span style="color: #000066;">;</span>
    <span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">;</span>
  <span style="color: #000000; font-weight: bold;">finally</span>
    <span style="color: #000066;">FreeMem</span><span style="color: #000066;">(</span>Buffer<span style="color: #000066;">)</span><span style="color: #000066;">;</span>
  <span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">;</span>
<span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">;</span>
 
<span style="color: #808080; font-style: italic;">// Lee el primer sector de la particion</span>
<span style="color: #000000; font-weight: bold;">procedure</span> ReadBootSector<span style="color: #000066;">(</span><span style="color: #000000; font-weight: bold;">var</span> Partition<span style="color: #000066;">:</span> TPartition<span style="color: #000066;">)</span><span style="color: #000066;">;</span>
<span style="color: #000000; font-weight: bold;">var</span>
  Buffer<span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">PByteArray</span><span style="color: #000066;">;</span>
<span style="color: #000000; font-weight: bold;">begin</span>
  <span style="color: #808080; font-style: italic;">// Reservamos memoria para guardar el sector de arranque</span>
  <span style="color: #000066;">GetMem</span><span style="color: #000066;">(</span>Buffer<span style="color: #000066;">,</span><span style="color: #0000cc;">$0200</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
  <span style="color: #000000; font-weight: bold;">try</span>
    <span style="color: #000000; font-weight: bold;">with</span> Partition <span style="color: #000000; font-weight: bold;">do</span>
    <span style="color: #000000; font-weight: bold;">begin</span>
      <span style="color: #808080; font-style: italic;">// Leemos el sector de arranque</span>
      Stream<span style="color: #000066;">.</span><span style="color: #006600;">ReadBuffer</span><span style="color: #000066;">(</span>Buffer<span style="color: #000066;">^</span><span style="color: #000066;">,</span><span style="color: #0000cc;">$0200</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
      <span style="color: #808080; font-style: italic;">// Volcamos en pantalla el contenido del sector de arranque</span>
      <span style="color: #000066;">Writeln</span><span style="color: #000066;">(</span><span style="color: #ff0000;">'=== Boot Sector ==='</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
      WriteHex<span style="color: #000066;">(</span><span style="color: #000066; font-weight: bold;">PAnsiChar</span><span style="color: #000066;">(</span>Buffer<span style="color: #000066;">)</span><span style="color: #000066;">,</span> <span style="color: #0000cc;">$0200</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
      Writeln<span style="color: #000066;">;</span>
      <span style="color: #808080; font-style: italic;">// Comprobamos la firma del sector de arranque</span>
      <span style="color: #000000; font-weight: bold;">if</span> <span style="color: #000066; font-weight: bold;">PWORD</span><span style="color: #000066;">(</span><span style="color: #000066;">@</span>Buffer<span style="color: #000066;">[</span><span style="color: #0000cc;">$01FE</span><span style="color: #000066;">]</span><span style="color: #000066;">)</span><span style="color: #000066;">^</span> &lt;&gt; <span style="color: #0000cc;">$AA55</span> <span style="color: #000000; font-weight: bold;">then</span>
        <span style="color: #000000; font-weight: bold;">raise</span> Exception<span style="color: #000066;">.</span><span style="color: #006600;">Create</span><span style="color: #000066;">(</span><span style="color: #ff0000;">'Invalid Boot Sector signature = '</span>
          <span style="color: #000066;">+</span> <span style="color: #000066;">IntToHex</span><span style="color: #000066;">(</span><span style="color: #000066;">Swap</span><span style="color: #000066;">(</span><span style="color: #000066; font-weight: bold;">PWORD</span><span style="color: #000066;">(</span><span style="color: #000066;">@</span>Buffer<span style="color: #000066;">[</span><span style="color: #0000cc;">$01FE</span><span style="color: #000066;">]</span><span style="color: #000066;">)</span><span style="color: #000066;">^</span><span style="color: #000066;">)</span><span style="color: #000066;">,</span><span style="color: #0000ff;">2</span><span style="color: #000066;">)</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
      <span style="color: #808080; font-style: italic;">// Comprobamos que es FAT32</span>
      <span style="color: #000000; font-weight: bold;">if</span> PartType &lt;&gt; <span style="color: #0000ff;">0</span> <span style="color: #000000; font-weight: bold;">then</span>
      <span style="color: #000000; font-weight: bold;">begin</span>
        <span style="color: #808080; font-style: italic;">// si no lo es mostramos el error</span>
        <span style="color: #000000; font-weight: bold;">if</span> <span style="color: #000000; font-weight: bold;">not</span> <span style="color: #000066;">(</span>PartType <span style="color: #000000; font-weight: bold;">in</span> <span style="color: #000066;">[</span><span style="color: #0000cc;">$0B</span><span style="color: #000066;">,</span><span style="color: #0000cc;">$0C</span><span style="color: #000066;">]</span><span style="color: #000066;">)</span> <span style="color: #000000; font-weight: bold;">then</span>
          <span style="color: #000000; font-weight: bold;">raise</span> Exception<span style="color: #000066;">.</span><span style="color: #006600;">Create</span><span style="color: #000066;">(</span><span style="color: #ff0000;">'Invalid Partition Type = 0x'</span>
            <span style="color: #000066;">+</span> <span style="color: #000066;">IntToHex</span><span style="color: #000066;">(</span>PartType<span style="color: #000066;">,</span><span style="color: #0000ff;">2</span><span style="color: #000066;">)</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
        <span style="color: #000066;">Writeln</span><span style="color: #000066;">(</span><span style="color: #ff0000;">'Partiton type:       0x'</span> <span style="color: #000066;">+</span> <span style="color: #000066;">IntToHex</span><span style="color: #000066;">(</span>PartType<span style="color: #000066;">,</span><span style="color: #0000ff;">2</span><span style="color: #000066;">)</span> <span style="color: #000066;">+</span> <span style="color: #ff0000;">' (FAT32)'</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
      <span style="color: #000000; font-weight: bold;">end</span> <span style="color: #000000; font-weight: bold;">else</span>
      <span style="color: #000000; font-weight: bold;">begin</span>
        <span style="color: #808080; font-style: italic;">// Si no queda mas remedio usamos el "System ID"</span>
        <span style="color: #000000; font-weight: bold;">if</span> <span style="color: #000066;">Trim</span><span style="color: #000066;">(</span><span style="color: #000066;">Copy</span><span style="color: #000066;">(</span><span style="color: #000066; font-weight: bold;">PAnsiChar</span><span style="color: #000066;">(</span><span style="color: #000066;">@</span>Buffer<span style="color: #000066;">[</span><span style="color: #0000cc;">$0052</span><span style="color: #000066;">]</span><span style="color: #000066;">)</span><span style="color: #000066;">,</span><span style="color: #0000ff;">1</span><span style="color: #000066;">,</span><span style="color: #0000ff;">8</span><span style="color: #000066;">)</span><span style="color: #000066;">)</span> &lt;&gt; <span style="color: #ff0000;">'FAT32'</span> <span style="color: #000000; font-weight: bold;">then</span>
          <span style="color: #000000; font-weight: bold;">raise</span> Exception<span style="color: #000066;">.</span><span style="color: #006600;">Create</span><span style="color: #000066;">(</span><span style="color: #ff0000;">'Invalid System ID = '</span>
            <span style="color: #000066;">+</span> <span style="color: #000066;">Trim</span><span style="color: #000066;">(</span><span style="color: #000066;">Copy</span><span style="color: #000066;">(</span><span style="color: #000066; font-weight: bold;">AnsiString</span><span style="color: #000066;">(</span><span style="color: #000066; font-weight: bold;">PAnsiChar</span><span style="color: #000066;">(</span><span style="color: #000066;">@</span>Buffer<span style="color: #000066;">[</span><span style="color: #0000cc;">$0052</span><span style="color: #000066;">]</span><span style="color: #000066;">)</span><span style="color: #000066;">)</span><span style="color: #000066;">,</span><span style="color: #0000ff;">1</span><span style="color: #000066;">,</span><span style="color: #0000ff;">8</span><span style="color: #000066;">)</span><span style="color: #000066;">)</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
      <span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">;</span>
      <span style="color: #808080; font-style: italic;">// Mostramos la informacion de la particion por pantalla</span>
      <span style="color: #000066;">Writeln</span><span style="color: #000066;">(</span><span style="color: #ff0000;">'Signature:           '</span> <span style="color: #000066;">+</span> <span style="color: #000066;">IntToHex</span><span style="color: #000066;">(</span><span style="color: #000066;">Swap</span><span style="color: #000066;">(</span><span style="color: #000066; font-weight: bold;">PWORD</span><span style="color: #000066;">(</span><span style="color: #000066;">@</span>Buffer<span style="color: #000066;">[</span><span style="color: #0000cc;">$01FE</span><span style="color: #000066;">]</span><span style="color: #000066;">)</span><span style="color: #000066;">^</span><span style="color: #000066;">)</span><span style="color: #000066;">,</span><span style="color: #0000ff;">2</span><span style="color: #000066;">)</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
      <span style="color: #000066;">Writeln</span><span style="color: #000066;">(</span><span style="color: #ff0000;">'System ID:           '</span> <span style="color: #000066;">+</span> <span style="color: #000066;">Trim</span><span style="color: #000066;">(</span><span style="color: #000066;">Copy</span><span style="color: #000066;">(</span><span style="color: #000066; font-weight: bold;">PAnsiChar</span><span style="color: #000066;">(</span><span style="color: #000066;">@</span>Buffer<span style="color: #000066;">[</span><span style="color: #0000cc;">$0052</span><span style="color: #000066;">]</span><span style="color: #000066;">)</span><span style="color: #000066;">,</span><span style="color: #0000ff;">1</span><span style="color: #000066;">,</span><span style="color: #0000ff;">8</span><span style="color: #000066;">)</span><span style="color: #000066;">)</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
      <span style="color: #000066;">Writeln</span><span style="color: #000066;">(</span><span style="color: #ff0000;">'OEM ID:              '</span> <span style="color: #000066;">+</span> <span style="color: #000066;">Trim</span><span style="color: #000066;">(</span><span style="color: #000066;">Copy</span><span style="color: #000066;">(</span><span style="color: #000066; font-weight: bold;">PAnsiChar</span><span style="color: #000066;">(</span><span style="color: #000066;">@</span>Buffer<span style="color: #000066;">[</span><span style="color: #0000cc;">$0003</span><span style="color: #000066;">]</span><span style="color: #000066;">)</span><span style="color: #000066;">,</span><span style="color: #0000ff;">1</span><span style="color: #000066;">,</span><span style="color: #0000ff;">8</span><span style="color: #000066;">)</span><span style="color: #000066;">)</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
      <span style="color: #000066;">Writeln</span><span style="color: #000066;">(</span><span style="color: #ff0000;">'Volume label:        '</span> <span style="color: #000066;">+</span> <span style="color: #000066;">Trim</span><span style="color: #000066;">(</span><span style="color: #000066;">Copy</span><span style="color: #000066;">(</span><span style="color: #000066; font-weight: bold;">PAnsiChar</span><span style="color: #000066;">(</span><span style="color: #000066;">@</span>Buffer<span style="color: #000066;">[</span><span style="color: #0000cc;">$0047</span><span style="color: #000066;">]</span><span style="color: #000066;">)</span><span style="color: #000066;">,</span><span style="color: #0000ff;">1</span><span style="color: #000066;">,</span><span style="color: #0000ff;">11</span><span style="color: #000066;">)</span><span style="color: #000066;">)</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
      <span style="color: #000066;">Writeln</span><span style="color: #000066;">(</span><span style="color: #ff0000;">'Volume serial:       '</span> <span style="color: #000066;">+</span> <span style="color: #000066;">IntToHex</span><span style="color: #000066;">(</span><span style="color: #000066; font-weight: bold;">PDWORD</span><span style="color: #000066;">(</span><span style="color: #000066;">@</span>Buffer<span style="color: #000066;">[</span><span style="color: #0000cc;">$0043</span><span style="color: #000066;">]</span><span style="color: #000066;">)</span><span style="color: #000066;">^</span><span style="color: #000066;">,</span><span style="color: #0000ff;">8</span><span style="color: #000066;">)</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
      BytsPerSec<span style="color: #000066;">:</span><span style="color: #000066;">=</span> <span style="color: #000066; font-weight: bold;">PWORD</span><span style="color: #000066;">(</span><span style="color: #000066;">@</span>Buffer<span style="color: #000066;">[</span><span style="color: #0000cc;">$000B</span><span style="color: #000066;">]</span><span style="color: #000066;">)</span><span style="color: #000066;">^</span><span style="color: #000066;">;</span>
      <span style="color: #000066;">Writeln</span><span style="color: #000066;">(</span><span style="color: #ff0000;">'Bytes per sector:    '</span> <span style="color: #000066;">+</span> <span style="color: #000066;">IntToStr</span><span style="color: #000066;">(</span>BytsPerSec<span style="color: #000066;">)</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
      SecPerClus<span style="color: #000066;">:</span><span style="color: #000066;">=</span> <span style="color: #000066; font-weight: bold;">PByte</span><span style="color: #000066;">(</span><span style="color: #000066;">@</span>Buffer<span style="color: #000066;">[</span><span style="color: #0000cc;">$000D</span><span style="color: #000066;">]</span><span style="color: #000066;">)</span><span style="color: #000066;">^</span><span style="color: #000066;">;</span>
      <span style="color: #000066;">Writeln</span><span style="color: #000066;">(</span><span style="color: #ff0000;">'Sectors per cluster: '</span> <span style="color: #000066;">+</span> <span style="color: #000066;">IntToStr</span><span style="color: #000066;">(</span>SecPerClus<span style="color: #000066;">)</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
      BytsPerClus<span style="color: #000066;">:</span><span style="color: #000066;">=</span> BytsPerSec <span style="color: #000066;">*</span> SecPerClus<span style="color: #000066;">;</span>
      <span style="color: #000066;">Writeln</span><span style="color: #000066;">(</span><span style="color: #ff0000;">'Bytes per cluster:   '</span> <span style="color: #000066;">+</span> <span style="color: #000066;">IntToStr</span><span style="color: #000066;">(</span>BytsPerClus<span style="color: #000066;">)</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
      RsvdSecCnt<span style="color: #000066;">:</span><span style="color: #000066;">=</span> <span style="color: #000066; font-weight: bold;">PWORD</span><span style="color: #000066;">(</span><span style="color: #000066;">@</span>Buffer<span style="color: #000066;">[</span><span style="color: #0000cc;">$000E</span><span style="color: #000066;">]</span><span style="color: #000066;">)</span><span style="color: #000066;">^</span><span style="color: #000066;">;</span>
      <span style="color: #000066;">Writeln</span><span style="color: #000066;">(</span><span style="color: #ff0000;">'Reserved sectors:    '</span> <span style="color: #000066;">+</span> <span style="color: #000066;">IntToStr</span><span style="color: #000066;">(</span>RsvdSecCnt<span style="color: #000066;">)</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
      NumFATs<span style="color: #000066;">:</span><span style="color: #000066;">=</span> <span style="color: #000066; font-weight: bold;">PByte</span><span style="color: #000066;">(</span><span style="color: #000066;">@</span>Buffer<span style="color: #000066;">[</span><span style="color: #0000cc;">$0010</span><span style="color: #000066;">]</span><span style="color: #000066;">)</span><span style="color: #000066;">^</span><span style="color: #000066;">;</span>
      <span style="color: #000066;">Writeln</span><span style="color: #000066;">(</span><span style="color: #ff0000;">'Number of FATs:      '</span> <span style="color: #000066;">+</span> <span style="color: #000066;">IntToStr</span><span style="color: #000066;">(</span>NumFATs<span style="color: #000066;">)</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
      FATSz32<span style="color: #000066;">:</span><span style="color: #000066;">=</span> <span style="color: #000066; font-weight: bold;">PWORD</span><span style="color: #000066;">(</span><span style="color: #000066;">@</span>Buffer<span style="color: #000066;">[</span><span style="color: #0000cc;">$0024</span><span style="color: #000066;">]</span><span style="color: #000066;">)</span><span style="color: #000066;">^</span><span style="color: #000066;">;</span>
      <span style="color: #000066;">Writeln</span><span style="color: #000066;">(</span><span style="color: #ff0000;">'Sectors per FAT:     '</span> <span style="color: #000066;">+</span> <span style="color: #000066;">IntToStr</span><span style="color: #000066;">(</span>FATSz32<span style="color: #000066;">)</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
      ClusCount<span style="color: #000066;">:</span><span style="color: #000066;">=</span> <span style="color: #000066;">(</span><span style="color: #000066;">(</span>FATSz32 <span style="color: #000066;">*</span> BytsPerSec<span style="color: #000066;">)</span> <span style="color: #000000; font-weight: bold;">div</span> <span style="color: #000066;">SizeOf</span><span style="color: #000066;">(</span><span style="color: #000066; font-weight: bold;">DWord</span><span style="color: #000066;">)</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
      <span style="color: #000066;">Writeln</span><span style="color: #000066;">(</span><span style="color: #ff0000;">'Cluster count:       '</span> <span style="color: #000066;">+</span> <span style="color: #000066;">IntToStr</span><span style="color: #000066;">(</span>ClusCount<span style="color: #000066;">)</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
      ClusBegin<span style="color: #000066;">:</span><span style="color: #000066;">=</span> RsvdSecCnt <span style="color: #000066;">+</span> <span style="color: #000066;">(</span>NumFATs <span style="color: #000066;">*</span> FATSz32<span style="color: #000066;">)</span><span style="color: #000066;">;</span>
      RootClus<span style="color: #000066;">:</span><span style="color: #000066;">=</span> <span style="color: #000066; font-weight: bold;">PDWORD</span><span style="color: #000066;">(</span><span style="color: #000066;">@</span>Buffer<span style="color: #000066;">[</span><span style="color: #0000cc;">$002C</span><span style="color: #000066;">]</span><span style="color: #000066;">)</span><span style="color: #000066;">^</span><span style="color: #000066;">;</span>
      <span style="color: #000066;">Writeln</span><span style="color: #000066;">(</span><span style="color: #ff0000;">'Root cluster:        '</span> <span style="color: #000066;">+</span> <span style="color: #000066;">IntToStr</span><span style="color: #000066;">(</span>RootClus<span style="color: #000066;">)</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
      Writeln<span style="color: #000066;">;</span>
    <span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">;</span>
  <span style="color: #000000; font-weight: bold;">finally</span>
    <span style="color: #808080; font-style: italic;">// Liberamos la memoria</span>
    <span style="color: #000066;">FreeMem</span><span style="color: #000066;">(</span>Buffer<span style="color: #000066;">)</span><span style="color: #000066;">;</span>
  <span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">;</span>
<span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">;</span>
 
<span style="color: #808080; font-style: italic;">// Lee la FAT</span>
<span style="color: #000000; font-weight: bold;">procedure</span> ReadFAT<span style="color: #000066;">(</span>Partition<span style="color: #000066;">:</span> TPartition<span style="color: #000066;">)</span><span style="color: #000066;">;</span>
<span style="color: #000000; font-weight: bold;">var</span>
  i<span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">DWord</span><span style="color: #000066;">;</span>
  FreeClus<span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">int64</span><span style="color: #000066;">;</span>
  ResClus<span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">int64</span><span style="color: #000066;">;</span>
  BadClus<span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">int64</span><span style="color: #000066;">;</span>
<span style="color: #000000; font-weight: bold;">begin</span>
  FreeClus<span style="color: #000066;">:</span><span style="color: #000066;">=</span> <span style="color: #0000ff;">0</span><span style="color: #000066;">;</span>
  ResClus<span style="color: #000066;">:</span><span style="color: #000066;">=</span> <span style="color: #0000ff;">0</span><span style="color: #000066;">;</span>
  BadClus<span style="color: #000066;">:</span><span style="color: #000066;">=</span> <span style="color: #0000ff;">0</span><span style="color: #000066;">;</span>
  <span style="color: #000000; font-weight: bold;">with</span> Partition <span style="color: #000000; font-weight: bold;">do</span>
  <span style="color: #000000; font-weight: bold;">begin</span>
    <span style="color: #808080; font-style: italic;">// No colocamos al principio de la FAT</span>
    Stream<span style="color: #000066;">.</span><span style="color: #006600;">Position</span><span style="color: #000066;">:</span><span style="color: #000066;">=</span> <span style="color: #000066;">(</span>PartBegin <span style="color: #000066;">+</span> RsvdSecCnt<span style="color: #000066;">)</span> <span style="color: #000066;">*</span> BytsPerSec<span style="color: #000066;">;</span>
    <span style="color: #808080; font-style: italic;">// La cargamos en memoria</span>
    Stream<span style="color: #000066;">.</span><span style="color: #006600;">ReadBuffer</span><span style="color: #000066;">(</span>FAT<span style="color: #000066;">^</span><span style="color: #000066;">,</span> FATSz32 <span style="color: #000066;">*</span> BytsPerSec<span style="color: #000066;">)</span><span style="color: #000066;">;</span>
    <span style="color: #000066;">Writeln</span><span style="color: #000066;">(</span><span style="color: #ff0000;">'=== Clusters ==='</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
    <span style="color: #808080; font-style: italic;">// La recorremos registro a registro</span>
    <span style="color: #000000; font-weight: bold;">for</span> i<span style="color: #000066;">:</span><span style="color: #000066;">=</span> <span style="color: #0000ff;">0</span> <span style="color: #000000; font-weight: bold;">to</span> ClusCount <span style="color: #000066;">-</span> <span style="color: #0000ff;">1</span> <span style="color: #000000; font-weight: bold;">do</span>
    <span style="color: #000000; font-weight: bold;">begin</span>
      <span style="color: #808080; font-style: italic;">// y contamos el estado de cada cluster</span>
      <span style="color: #000000; font-weight: bold;">case</span> FAT<span style="color: #000066;">[</span>i<span style="color: #000066;">]</span> <span style="color: #000000; font-weight: bold;">of</span>
        <span style="color: #0000ff;">0</span><span style="color: #000066;">:</span> <span style="color: #000066;">inc</span><span style="color: #000066;">(</span>FreeClus<span style="color: #000066;">)</span><span style="color: #000066;">;</span>
        <span style="color: #0000cc;">$FFFFFF7</span><span style="color: #000066;">:</span> <span style="color: #000066;">inc</span><span style="color: #000066;">(</span>BadClus<span style="color: #000066;">)</span><span style="color: #000066;">;</span>
      <span style="color: #000000; font-weight: bold;">else</span>
        <span style="color: #000066;">inc</span><span style="color: #000066;">(</span>ResClus<span style="color: #000066;">)</span><span style="color: #000066;">;</span>
      <span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">;</span>
    <span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">;</span>
    <span style="color: #808080; font-style: italic;">// Mostramos los contadores</span>
    <span style="color: #000066;">Writeln</span><span style="color: #000066;">(</span><span style="color: #ff0000;">'Free: '</span> <span style="color: #000066;">+</span> <span style="color: #000066;">IntToStr</span><span style="color: #000066;">(</span>FreeClus<span style="color: #000066;">)</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
    <span style="color: #000066;">Writeln</span><span style="color: #000066;">(</span><span style="color: #ff0000;">'Used: '</span> <span style="color: #000066;">+</span> <span style="color: #000066;">IntToStr</span><span style="color: #000066;">(</span>ResClus<span style="color: #000066;">)</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
    <span style="color: #000066;">Writeln</span><span style="color: #000066;">(</span><span style="color: #ff0000;">'Bad:  '</span> <span style="color: #000066;">+</span> <span style="color: #000066;">IntToStr</span><span style="color: #000066;">(</span>BadClus<span style="color: #000066;">)</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
    Writeln<span style="color: #000066;">;</span>
  <span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">;</span>
<span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">;</span>
 
<span style="color: #808080; font-style: italic;">// Escribe la FAT en el disco</span>
<span style="color: #000000; font-weight: bold;">procedure</span> WriteFAT<span style="color: #000066;">(</span>Partition<span style="color: #000066;">:</span> TPartition<span style="color: #000066;">)</span><span style="color: #000066;">;</span>
<span style="color: #000000; font-weight: bold;">var</span>
  i<span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">Byte</span><span style="color: #000066;">;</span>
<span style="color: #000000; font-weight: bold;">begin</span>
  <span style="color: #000000; font-weight: bold;">with</span> Partition <span style="color: #000000; font-weight: bold;">do</span>
  <span style="color: #000000; font-weight: bold;">begin</span>
    Stream<span style="color: #000066;">.</span><span style="color: #006600;">Position</span><span style="color: #000066;">:</span><span style="color: #000066;">=</span> <span style="color: #000066;">(</span>PartBegin <span style="color: #000066;">+</span> RsvdSecCnt<span style="color: #000066;">)</span> <span style="color: #000066;">*</span> BytsPerSec<span style="color: #000066;">;</span>
    <span style="color: #808080; font-style: italic;">// La escribimos tantas veces como indique el parametro NumFATs</span>
    <span style="color: #000000; font-weight: bold;">for</span> i<span style="color: #000066;">:</span><span style="color: #000066;">=</span> <span style="color: #0000ff;">1</span> <span style="color: #000000; font-weight: bold;">to</span> NumFATs <span style="color: #000000; font-weight: bold;">do</span>
      Stream<span style="color: #000066;">.</span><span style="color: #006600;">WriteBuffer</span><span style="color: #000066;">(</span>FAT<span style="color: #000066;">^</span><span style="color: #000066;">,</span> FATSz32 <span style="color: #000066;">*</span> BytsPerSec<span style="color: #000066;">)</span><span style="color: #000066;">;</span>
  <span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">;</span>
<span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">;</span>
 
<span style="color: #808080; font-style: italic;">// Lee un cluster</span>
<span style="color: #000000; font-weight: bold;">procedure</span> ReadClus<span style="color: #000066;">(</span>Partition<span style="color: #000066;">:</span> TPartition<span style="color: #000066;">;</span> Cluster<span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">DWord</span><span style="color: #000066;">;</span> Buffer<span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">PByte</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
<span style="color: #000000; font-weight: bold;">begin</span>
  <span style="color: #000000; font-weight: bold;">with</span> Partition <span style="color: #000000; font-weight: bold;">do</span>
  <span style="color: #000000; font-weight: bold;">begin</span>
    Stream<span style="color: #000066;">.</span><span style="color: #006600;">Position</span><span style="color: #000066;">:</span><span style="color: #000066;">=</span> <span style="color: #000066;">(</span>PartBegin <span style="color: #000066;">+</span> ClusBegin <span style="color: #000066;">+</span> <span style="color: #000066;">(</span>Cluster <span style="color: #000066;">-</span> <span style="color: #0000ff;">2</span><span style="color: #000066;">)</span> <span style="color: #000066;">*</span> SecPerClus<span style="color: #000066;">)</span>
      <span style="color: #000066;">*</span> BytsPerSec<span style="color: #000066;">;</span>
    Stream<span style="color: #000066;">.</span><span style="color: #006600;">ReadBuffer</span><span style="color: #000066;">(</span>Buffer<span style="color: #000066;">^</span><span style="color: #000066;">,</span> BytsPerClus<span style="color: #000066;">)</span><span style="color: #000066;">;</span>
  <span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">;</span>
<span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">;</span>
 
<span style="color: #808080; font-style: italic;">// Escribe un cluster</span>
<span style="color: #000000; font-weight: bold;">procedure</span> WriteClus<span style="color: #000066;">(</span>Partition<span style="color: #000066;">:</span> TPartition<span style="color: #000066;">;</span> Cluster<span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">DWord</span><span style="color: #000066;">;</span> Buffer<span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">PByte</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
<span style="color: #000000; font-weight: bold;">begin</span>
  <span style="color: #000000; font-weight: bold;">with</span> Partition <span style="color: #000000; font-weight: bold;">do</span>
  <span style="color: #000000; font-weight: bold;">begin</span>
    Stream<span style="color: #000066;">.</span><span style="color: #006600;">Position</span><span style="color: #000066;">:</span><span style="color: #000066;">=</span> <span style="color: #000066;">(</span>PartBegin <span style="color: #000066;">+</span> ClusBegin <span style="color: #000066;">+</span> <span style="color: #000066;">(</span>Cluster <span style="color: #000066;">-</span> <span style="color: #0000ff;">2</span><span style="color: #000066;">)</span> <span style="color: #000066;">*</span> SecPerClus<span style="color: #000066;">)</span>
      <span style="color: #000066;">*</span> BytsPerSec<span style="color: #000066;">;</span>
    Stream<span style="color: #000066;">.</span><span style="color: #006600;">WriteBuffer</span><span style="color: #000066;">(</span>Buffer<span style="color: #000066;">^</span><span style="color: #000066;">,</span> BytsPerClus<span style="color: #000066;">)</span><span style="color: #000066;">;</span>
  <span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">;</span>
<span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">;</span>
 
<span style="color: #808080; font-style: italic;">// Lee los datos de un fichero a partir de su primer cluster</span>
<span style="color: #000000; font-weight: bold;">procedure</span> ReadFileData<span style="color: #000066;">(</span>Partition<span style="color: #000066;">:</span> TPartition<span style="color: #000066;">;</span> Cluster<span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">DWord</span><span style="color: #000066;">;</span> Stream<span style="color: #000066;">:</span> TStream<span style="color: #000066;">)</span><span style="color: #000066;">;</span>
<span style="color: #000000; font-weight: bold;">var</span>
  Buffer<span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">PByte</span><span style="color: #000066;">;</span>
<span style="color: #000000; font-weight: bold;">begin</span>
  <span style="color: #808080; font-style: italic;">// Reservamos memoria para guardar los datos de un cluster</span>
  <span style="color: #000066;">GetMem</span><span style="color: #000066;">(</span>Buffer<span style="color: #000066;">,</span>Partition<span style="color: #000066;">.</span><span style="color: #006600;">SecPerClus</span> <span style="color: #000066;">*</span> Partition<span style="color: #000066;">.</span><span style="color: #006600;">BytsPerSec</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
  <span style="color: #000000; font-weight: bold;">try</span>
    <span style="color: #808080; font-style: italic;">// Mientras no se llegue al final del fichero</span>
    <span style="color: #000000; font-weight: bold;">while</span> Cluster &lt; Partition<span style="color: #000066;">.</span><span style="color: #006600;">ClusCount</span> <span style="color: #000000; font-weight: bold;">do</span>
    <span style="color: #000000; font-weight: bold;">begin</span>
      <span style="color: #808080; font-style: italic;">// Leemos el cluster</span>
      ReadClus<span style="color: #000066;">(</span>Partition<span style="color: #000066;">,</span> Cluster<span style="color: #000066;">,</span> Buffer<span style="color: #000066;">)</span><span style="color: #000066;">;</span>
      <span style="color: #808080; font-style: italic;">// Lo grabamos en el stream</span>
      Stream<span style="color: #000066;">.</span><span style="color: #006600;">WriteBuffer</span><span style="color: #000066;">(</span>Buffer<span style="color: #000066;">^</span><span style="color: #000066;">,</span> Partition<span style="color: #000066;">.</span><span style="color: #006600;">SecPerClus</span> <span style="color: #000066;">*</span> Partition<span style="color: #000066;">.</span><span style="color: #006600;">BytsPerSec</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
      <span style="color: #808080; font-style: italic;">// Buscamos en la FAT el siguiente cluster</span>
      Cluster<span style="color: #000066;">:</span><span style="color: #000066;">=</span> Partition<span style="color: #000066;">.</span><span style="color: #006600;">FAT</span><span style="color: #000066;">[</span>Cluster<span style="color: #000066;">]</span><span style="color: #000066;">;</span>
    <span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">;</span>
  <span style="color: #000000; font-weight: bold;">finally</span>
    <span style="color: #000066;">FreeMem</span><span style="color: #000066;">(</span>Buffer<span style="color: #000066;">)</span><span style="color: #000066;">;</span>
  <span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">;</span>
<span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">;</span>
 
<span style="color: #808080; font-style: italic;">// Muestra la estructura de un directorio</span>
<span style="color: #000000; font-weight: bold;">procedure</span> Tree<span style="color: #000066;">(</span>Partition<span style="color: #000066;">:</span> TPartition<span style="color: #000066;">;</span> Cluster<span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">DWord</span><span style="color: #000066;">;</span> Path<span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">String</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
<span style="color: #000000; font-weight: bold;">var</span>
  Tmp<span style="color: #000066;">:</span> TMemoryStream<span style="color: #000066;">;</span>
  Entry<span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">PAnsiChar</span><span style="color: #000066;">;</span>
  Name<span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">String</span><span style="color: #000066;">;</span>
  Attr<span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">Byte</span><span style="color: #000066;">;</span>
  Size<span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">DWord</span><span style="color: #000066;">;</span>
  FTime<span style="color: #000066;">:</span> TFILETIME<span style="color: #000066;">;</span>
  STime<span style="color: #000066;">:</span> TSYSTEMTIME<span style="color: #000066;">;</span>
  FTimeStr<span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">String</span><span style="color: #000066;">;</span>
<span style="color: #000000; font-weight: bold;">begin</span>
  <span style="color: #808080; font-style: italic;">// Creamos un stream temporal</span>
  Tmp<span style="color: #000066;">:</span><span style="color: #000066;">=</span> TMemoryStream<span style="color: #000066;">.</span><span style="color: #006600;">Create</span><span style="color: #000066;">;</span>
  <span style="color: #808080; font-style: italic;">// Reservamos memoria para guardar cada entrada del directorio</span>
  <span style="color: #000066;">GetMem</span><span style="color: #000066;">(</span>Entry<span style="color: #000066;">,</span> <span style="color: #0000ff;">32</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
  <span style="color: #000000; font-weight: bold;">try</span>
    <span style="color: #808080; font-style: italic;">// Leemos todas las entradas del directorio</span>
    ReadFileData<span style="color: #000066;">(</span>Partition<span style="color: #000066;">,</span>Cluster<span style="color: #000066;">,</span>Tmp<span style="color: #000066;">)</span><span style="color: #000066;">;</span>
    Tmp<span style="color: #000066;">.</span><span style="color: #006600;">Position</span><span style="color: #000066;">:</span><span style="color: #000066;">=</span> <span style="color: #0000ff;">0</span><span style="color: #000066;">;</span>
    <span style="color: #808080; font-style: italic;">// Procesamos cada una de las entradas del directorio</span>
    <span style="color: #000000; font-weight: bold;">while</span> Tmp<span style="color: #000066;">.</span><span style="color: #000000; font-weight: bold;">Read</span><span style="color: #000066;">(</span>Entry<span style="color: #000066;">^</span><span style="color: #000066;">,</span> <span style="color: #0000ff;">32</span><span style="color: #000066;">)</span> <span style="color: #000066;">=</span> <span style="color: #0000ff;">32</span> <span style="color: #000000; font-weight: bold;">do</span>
    <span style="color: #000000; font-weight: bold;">begin</span>
      <span style="color: #808080; font-style: italic;">// Si el primer byte es cero, significa que es la ultima</span>
      <span style="color: #000000; font-weight: bold;">if</span> Entry<span style="color: #000066;">[</span><span style="color: #0000ff;">0</span><span style="color: #000066;">]</span> <span style="color: #000066;">=</span> <span style="color: #ff0000;">#0</span> <span style="color: #000000; font-weight: bold;">then</span>
        break<span style="color: #000066;">;</span>
      <span style="color: #808080; font-style: italic;">// Si el primer bytes es alguno de estos, ignoramos la entrada</span>
      <span style="color: #000000; font-weight: bold;">if</span> Entry<span style="color: #000066;">[</span><span style="color: #0000ff;">0</span><span style="color: #000066;">]</span> <span style="color: #000000; font-weight: bold;">in</span> <span style="color: #000066;">[</span><span style="color: #ff0000;">#$00</span><span style="color: #000066;">,</span><span style="color: #ff0000;">#$05</span><span style="color: #000066;">,</span><span style="color: #ff0000;">#$2E</span><span style="color: #000066;">,</span><span style="color: #ff0000;">#$E5</span><span style="color: #000066;">]</span> <span style="color: #000000; font-weight: bold;">then</span>
        continue<span style="color: #000066;">;</span>
      Attr<span style="color: #000066;">:</span><span style="color: #000066;">=</span> <span style="color: #000066; font-weight: bold;">Byte</span><span style="color: #000066;">(</span>Entry<span style="color: #000066;">[</span><span style="color: #0000cc;">$0B</span><span style="color: #000066;">]</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
      <span style="color: #808080; font-style: italic;">// Ignoramos los nombres largos</span>
      <span style="color: #000000; font-weight: bold;">if</span> <span style="color: #000066;">(</span>Attr <span style="color: #000000; font-weight: bold;">and</span> <span style="color: #0000cc;">$0F</span><span style="color: #000066;">)</span> <span style="color: #000066;">=</span> <span style="color: #0000cc;">$0F</span> <span style="color: #000000; font-weight: bold;">then</span>
        continue<span style="color: #000066;">;</span>
      <span style="color: #808080; font-style: italic;">// Obtenemos la extension</span>
      Name<span style="color: #000066;">:</span><span style="color: #000066;">=</span> <span style="color: #000066;">Trim</span><span style="color: #000066;">(</span><span style="color: #000066;">Copy</span><span style="color: #000066;">(</span>Entry<span style="color: #000066;">,</span><span style="color: #0000ff;">9</span><span style="color: #000066;">,</span><span style="color: #0000ff;">3</span><span style="color: #000066;">)</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
      <span style="color: #000000; font-weight: bold;">if</span> Name &lt;&gt; EmptyStr <span style="color: #000000; font-weight: bold;">then</span>
        Name<span style="color: #000066;">:</span><span style="color: #000066;">=</span> <span style="color: #ff0000;">'.'</span> <span style="color: #000066;">+</span> Name<span style="color: #000066;">;</span>
      <span style="color: #808080; font-style: italic;">// y se la sumamos al nombre</span>
      Name<span style="color: #000066;">:</span><span style="color: #000066;">=</span> <span style="color: #000066;">Trim</span><span style="color: #000066;">(</span><span style="color: #000066;">Copy</span><span style="color: #000066;">(</span>Entry<span style="color: #000066;">,</span><span style="color: #0000ff;">1</span><span style="color: #000066;">,</span><span style="color: #0000ff;">8</span><span style="color: #000066;">)</span><span style="color: #000066;">)</span> <span style="color: #000066;">+</span> Name<span style="color: #000066;">;</span>
      <span style="color: #808080; font-style: italic;">// Obtenemos el tamaño</span>
      Size<span style="color: #000066;">:</span><span style="color: #000066;">=</span> <span style="color: #000066; font-weight: bold;">PDWord</span><span style="color: #000066;">(</span><span style="color: #000066;">@</span>Entry<span style="color: #000066;">[</span><span style="color: #0000cc;">$1C</span><span style="color: #000066;">]</span><span style="color: #000066;">)</span><span style="color: #000066;">^</span><span style="color: #000066;">;</span>
      <span style="color: #808080; font-style: italic;">// La fecha de modificación</span>
      DosDateTimeToFileTime<span style="color: #000066;">(</span><span style="color: #000066; font-weight: bold;">PDWord</span><span style="color: #000066;">(</span><span style="color: #000066;">@</span>Entry<span style="color: #000066;">[</span><span style="color: #0000cc;">$18</span><span style="color: #000066;">]</span><span style="color: #000066;">)</span><span style="color: #000066;">^</span><span style="color: #000066;">,</span><span style="color: #000066; font-weight: bold;">PDWord</span><span style="color: #000066;">(</span><span style="color: #000066;">@</span>Entry<span style="color: #000066;">[</span><span style="color: #0000cc;">$16</span><span style="color: #000066;">]</span><span style="color: #000066;">)</span><span style="color: #000066;">^</span><span style="color: #000066;">,</span>FTime<span style="color: #000066;">)</span><span style="color: #000066;">;</span>
      FileTimeToSystemTime<span style="color: #000066;">(</span>Ftime<span style="color: #000066;">,</span> STime<span style="color: #000066;">)</span><span style="color: #000066;">;</span>
      FTimeStr<span style="color: #000066;">:</span><span style="color: #000066;">=</span> <span style="color: #000066;">FormatDateTime</span><span style="color: #000066;">(</span><span style="color: #ff0000;">'dd/mm/yyyy  hh:nn'</span><span style="color: #000066;">,</span> <span style="color: #000066;">SystemTimeToDateTime</span><span style="color: #000066;">(</span>STime<span style="color: #000066;">)</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
      <span style="color: #808080; font-style: italic;">// Si es un directorio</span>
      <span style="color: #000000; font-weight: bold;">if</span> Attr <span style="color: #000000; font-weight: bold;">and</span> faDirectory <span style="color: #000066;">=</span> faDirectory <span style="color: #000000; font-weight: bold;">then</span>
      <span style="color: #000000; font-weight: bold;">begin</span>
        <span style="color: #000066;">Writeln</span><span style="color: #000066;">(</span><span style="color: #000066;">Format</span><span style="color: #000066;">(</span><span style="color: #ff0000;">'%s  %10.10s  %s%s'</span><span style="color: #000066;">,</span><span style="color: #000066;">[</span>FTimeStr<span style="color: #000066;">,</span><span style="color: #ff0000;">'&lt;DIR&gt;'</span><span style="color: #000066;">,</span>Path<span style="color: #000066;">,</span>Name<span style="color: #000066;">]</span><span style="color: #000066;">)</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
        <span style="color: #808080; font-style: italic;">// volvemos a llamar esta funcion de forma recursiva</span>
        Tree<span style="color: #000066;">(</span>Partition<span style="color: #000066;">,</span> <span style="color: #000066;">(</span><span style="color: #000066; font-weight: bold;">PWord</span><span style="color: #000066;">(</span><span style="color: #000066;">@</span>Entry<span style="color: #000066;">[</span><span style="color: #0000cc;">$14</span><span style="color: #000066;">]</span><span style="color: #000066;">)</span><span style="color: #000066;">^</span> <span style="color: #000066;">*</span> <span style="color: #0000cc;">$10000</span><span style="color: #000066;">)</span> <span style="color: #000066;">+</span> <span style="color: #000066; font-weight: bold;">PWord</span><span style="color: #000066;">(</span><span style="color: #000066;">@</span>Entry<span style="color: #000066;">[</span><span style="color: #0000cc;">$1A</span><span style="color: #000066;">]</span><span style="color: #000066;">)</span><span style="color: #000066;">^</span><span style="color: #000066;">,</span>
          Path <span style="color: #000066;">+</span> Name <span style="color: #000066;">+</span> <span style="color: #ff0000;">'\'</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
      <span style="color: #000000; font-weight: bold;">end</span> <span style="color: #000000; font-weight: bold;">else</span>
        <span style="color: #000066;">Writeln</span><span style="color: #000066;">(</span><span style="color: #000066;">Format</span><span style="color: #000066;">(</span><span style="color: #ff0000;">'%s  %10.10s  %s%s'</span><span style="color: #000066;">,</span><span style="color: #000066;">[</span>FTimeStr<span style="color: #000066;">,</span>FormatFileSize<span style="color: #000066;">(</span>Size<span style="color: #000066;">)</span><span style="color: #000066;">,</span>Path<span style="color: #000066;">,</span>Name<span style="color: #000066;">]</span><span style="color: #000066;">)</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
    <span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">;</span>
  <span style="color: #000000; font-weight: bold;">finally</span>
    <span style="color: #808080; font-style: italic;">// Liberamos la memoria y el stream</span>
    <span style="color: #000066;">FreeMem</span><span style="color: #000066;">(</span>Entry<span style="color: #000066;">)</span><span style="color: #000066;">;</span>
    Tmp<span style="color: #000066;">.</span><span style="color: #006600;">Free</span><span style="color: #000066;">;</span>
  <span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">;</span>
<span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">;</span>
 
<span style="color: #808080; font-style: italic;">// Esta es la funcion principal</span>
<span style="color: #000000; font-weight: bold;">procedure</span> main<span style="color: #000066;">;</span>
<span style="color: #000000; font-weight: bold;">var</span>
  C<span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">Char</span><span style="color: #000066;">;</span>
  i<span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">Integer</span><span style="color: #000066;">;</span>
  H<span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">Integer</span><span style="color: #000066;">;</span>
  Str<span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">String</span><span style="color: #000066;">;</span>
  LeerMBR<span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">Boolean</span><span style="color: #000066;">;</span>
  Stream<span style="color: #000066;">:</span> TFileStream<span style="color: #000066;">;</span>
  Partition<span style="color: #000066;">:</span> TPartition<span style="color: #000066;">;</span>
<span style="color: #000000; font-weight: bold;">begin</span>
  <span style="color: #000000; font-weight: bold;">try</span>
    <span style="color: #808080; font-style: italic;">// Si el archivo como parametro</span>
    <span style="color: #000000; font-weight: bold;">if</span> <span style="color: #000066;">(</span>ParamCount &gt; <span style="color: #0000ff;">0</span><span style="color: #000066;">)</span> <span style="color: #000000; font-weight: bold;">and</span> <span style="color: #000066;">(</span><span style="color: #000066;">Copy</span><span style="color: #000066;">(</span><span style="color: #000066;">ParamStr</span><span style="color: #000066;">(</span><span style="color: #0000ff;">1</span><span style="color: #000066;">)</span><span style="color: #000066;">,</span><span style="color: #0000ff;">1</span><span style="color: #000066;">,</span><span style="color: #0000ff;">1</span><span style="color: #000066;">)</span> &lt;&gt; <span style="color: #ff0000;">'/'</span><span style="color: #000066;">)</span> <span style="color: #000000; font-weight: bold;">then</span>
    <span style="color: #000000; font-weight: bold;">begin</span>
      LeerMBR<span style="color: #000066;">:</span><span style="color: #000066;">=</span> <span style="color: #000066;">FindCmdLineSwitch</span><span style="color: #000066;">(</span><span style="color: #ff0000;">'MBR'</span><span style="color: #000066;">,</span><span style="color: #000000; font-weight: bold;">TRUE</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
      Stream<span style="color: #000066;">:</span><span style="color: #000066;">=</span> TFileStream<span style="color: #000066;">.</span><span style="color: #006600;">Create</span><span style="color: #000066;">(</span><span style="color: #000066;">ParamStr</span><span style="color: #000066;">(</span><span style="color: #0000ff;">1</span><span style="color: #000066;">)</span><span style="color: #000066;">,</span>fmOpenRead <span style="color: #000000; font-weight: bold;">or</span> fmShareDenyWrite<span style="color: #000066;">)</span><span style="color: #000066;">;</span>
    <span style="color: #000000; font-weight: bold;">end</span> <span style="color: #000000; font-weight: bold;">else</span>
    <span style="color: #000000; font-weight: bold;">begin</span>
      <span style="color: #000000; font-weight: bold;">with</span> TStringList<span style="color: #000066;">.</span><span style="color: #006600;">Create</span> <span style="color: #000000; font-weight: bold;">do</span>
      <span style="color: #000000; font-weight: bold;">try</span>
        Add<span style="color: #000066;">(</span>EmptyStr<span style="color: #000066;">)</span><span style="color: #000066;">;</span>
        <span style="color: #000066;">Writeln</span><span style="color: #000066;">(</span><span style="color: #ff0000;">'['</span> <span style="color: #000066;">+</span> <span style="color: #000066;">IntToStr</span><span style="color: #000066;">(</span>Count<span style="color: #000066;">-</span><span style="color: #0000ff;">1</span><span style="color: #000066;">)</span> <span style="color: #000066;">+</span> <span style="color: #ff0000;">'] Salir'</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
        <span style="color: #808080; font-style: italic;">// Buscamos todas las unidades</span>
        <span style="color: #000000; font-weight: bold;">for</span> C<span style="color: #000066;">:</span><span style="color: #000066;">=</span> <span style="color: #ff0000;">'A'</span> <span style="color: #000000; font-weight: bold;">to</span> <span style="color: #ff0000;">'Z'</span> <span style="color: #000000; font-weight: bold;">do</span>
        <span style="color: #000000; font-weight: bold;">begin</span>
          Str<span style="color: #000066;">:</span><span style="color: #000066;">=</span> <span style="color: #ff0000;">'\\.\'</span> <span style="color: #000066;">+</span> C <span style="color: #000066;">+</span> <span style="color: #ff0000;">':'</span><span style="color: #000066;">;</span>
          H<span style="color: #000066;">:</span><span style="color: #000066;">=</span> <span style="color: #000066;">FileOpen</span><span style="color: #000066;">(</span><span style="color: #000066; font-weight: bold;">PAnsiChar</span><span style="color: #000066;">(</span>Str<span style="color: #000066;">)</span><span style="color: #000066;">,</span>fmOpenRead <span style="color: #000000; font-weight: bold;">or</span> fmShareDenyNone<span style="color: #000066;">)</span><span style="color: #000066;">;</span>
          <span style="color: #808080; font-style: italic;">// Si se puede abrir lo añadimos a la lista</span>
          <span style="color: #000000; font-weight: bold;">if</span> H &gt; <span style="color: #0000ff;">0</span> <span style="color: #000000; font-weight: bold;">then</span>
          <span style="color: #000000; font-weight: bold;">begin</span>
            CloseHandle<span style="color: #000066;">(</span>H<span style="color: #000066;">)</span><span style="color: #000066;">;</span>
            AddObject<span style="color: #000066;">(</span>Str<span style="color: #000066;">,</span><span style="color: #000066; font-weight: bold;">TObject</span><span style="color: #000066;">(</span><span style="color: #0000ff;">0</span><span style="color: #000066;">)</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
            <span style="color: #000066;">Writeln</span><span style="color: #000066;">(</span><span style="color: #ff0000;">'['</span> <span style="color: #000066;">+</span> <span style="color: #000066;">IntToStr</span><span style="color: #000066;">(</span>Count<span style="color: #000066;">-</span><span style="color: #0000ff;">1</span><span style="color: #000066;">)</span> <span style="color: #000066;">+</span> <span style="color: #ff0000;">'] '</span> <span style="color: #000066;">+</span> Str<span style="color: #000066;">)</span><span style="color: #000066;">;</span>
          <span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">;</span>
        <span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">;</span>
        <span style="color: #808080; font-style: italic;">// Buscamos todos los discos (al menos los 16 primeros)</span>
        <span style="color: #000000; font-weight: bold;">for</span> i<span style="color: #000066;">:</span><span style="color: #000066;">=</span> <span style="color: #0000ff;">0</span> <span style="color: #000000; font-weight: bold;">to</span> <span style="color: #0000ff;">16</span> <span style="color: #000000; font-weight: bold;">do</span>
        <span style="color: #000000; font-weight: bold;">begin</span>
          Str<span style="color: #000066;">:</span><span style="color: #000066;">=</span> <span style="color: #ff0000;">'\\.\PhysicalDrive'</span> <span style="color: #000066;">+</span> <span style="color: #000066;">IntTostr</span><span style="color: #000066;">(</span>i<span style="color: #000066;">)</span><span style="color: #000066;">;</span>
          H<span style="color: #000066;">:</span><span style="color: #000066;">=</span> <span style="color: #000066;">FileOpen</span><span style="color: #000066;">(</span><span style="color: #000066; font-weight: bold;">PAnsiChar</span><span style="color: #000066;">(</span>Str<span style="color: #000066;">)</span><span style="color: #000066;">,</span>fmOpenRead <span style="color: #000000; font-weight: bold;">or</span> fmShareDenyNone<span style="color: #000066;">)</span><span style="color: #000066;">;</span>
          <span style="color: #808080; font-style: italic;">// Si se puede abrir lo añadimos a la lista</span>
          <span style="color: #000000; font-weight: bold;">if</span> H &gt; <span style="color: #0000ff;">0</span> <span style="color: #000000; font-weight: bold;">then</span>
          <span style="color: #000000; font-weight: bold;">begin</span>
            CloseHandle<span style="color: #000066;">(</span>H<span style="color: #000066;">)</span><span style="color: #000066;">;</span>
            AddObject<span style="color: #000066;">(</span>Str<span style="color: #000066;">,</span><span style="color: #000066; font-weight: bold;">TObject</span><span style="color: #000066;">(</span><span style="color: #0000ff;">1</span><span style="color: #000066;">)</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
            <span style="color: #000066;">Writeln</span><span style="color: #000066;">(</span><span style="color: #ff0000;">'['</span> <span style="color: #000066;">+</span> <span style="color: #000066;">IntToStr</span><span style="color: #000066;">(</span>Count<span style="color: #000066;">-</span><span style="color: #0000ff;">1</span><span style="color: #000066;">)</span> <span style="color: #000066;">+</span> <span style="color: #ff0000;">'] '</span> <span style="color: #000066;">+</span> Str<span style="color: #000066;">)</span><span style="color: #000066;">;</span>
          <span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">;</span>
        <span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">;</span>
        i<span style="color: #000066;">:</span><span style="color: #000066;">=</span> <span style="color: #000066;">-</span><span style="color: #0000ff;">1</span><span style="color: #000066;">;</span>
        <span style="color: #000000; font-weight: bold;">while</span> i &lt; <span style="color: #0000ff;">0</span>  <span style="color: #000000; font-weight: bold;">do</span>
        <span style="color: #000000; font-weight: bold;">begin</span>
          <span style="color: #000000; font-weight: bold;">Write</span><span style="color: #000066;">(</span><span style="color: #ff0000;">'Escoge: '</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
          <span style="color: #000066;">Readln</span><span style="color: #000066;">(</span>Str<span style="color: #000066;">)</span><span style="color: #000066;">;</span>
          i<span style="color: #000066;">:</span><span style="color: #000066;">=</span> <span style="color: #000066;">StrToIntDef</span><span style="color: #000066;">(</span>Str<span style="color: #000066;">,</span><span style="color: #000066;">-</span><span style="color: #0000ff;">1</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
        <span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">;</span>
        Writeln<span style="color: #000066;">;</span>
        <span style="color: #000000; font-weight: bold;">if</span> i &gt; <span style="color: #0000ff;">0</span> <span style="color: #000000; font-weight: bold;">then</span>
        <span style="color: #000000; font-weight: bold;">begin</span>
          Stream<span style="color: #000066;">:</span><span style="color: #000066;">=</span> TFileStream<span style="color: #000066;">.</span><span style="color: #006600;">Create</span><span style="color: #000066;">(</span>Strings<span style="color: #000066;">[</span>i<span style="color: #000066;">]</span><span style="color: #000066;">,</span>fmOpenRead <span style="color: #000000; font-weight: bold;">or</span> fmShareDenyWrite<span style="color: #000066;">)</span><span style="color: #000066;">;</span>
          LeerMBR<span style="color: #000066;">:</span><span style="color: #000066;">=</span> <span style="color: #000066; font-weight: bold;">Integer</span><span style="color: #000066;">(</span>Objects<span style="color: #000066;">[</span>i<span style="color: #000066;">]</span><span style="color: #000066;">)</span> <span style="color: #000066;">=</span> <span style="color: #0000ff;">1</span><span style="color: #000066;">;</span>
        <span style="color: #000000; font-weight: bold;">end</span> <span style="color: #000000; font-weight: bold;">else</span>
          Exit<span style="color: #000066;">;</span>
      <span style="color: #000000; font-weight: bold;">finally</span>
        Free<span style="color: #000066;">;</span>
      <span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">;</span>
    <span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">;</span>
    <span style="color: #000000; font-weight: bold;">if</span> Stream <span style="color: #000066;">=</span> <span style="color: #000000; font-weight: bold;">nil</span> <span style="color: #000000; font-weight: bold;">then</span>
      Halt<span style="color: #000066;">;</span>
    <span style="color: #000000; font-weight: bold;">try</span>
      <span style="color: #808080; font-style: italic;">// Borramos todas las variables</span>
      <span style="color: #000066;">Fillchar</span><span style="color: #000066;">(</span>Partition<span style="color: #000066;">,</span><span style="color: #000066;">Sizeof</span><span style="color: #000066;">(</span>Partition<span style="color: #000066;">)</span><span style="color: #000066;">,</span><span style="color: #ff0000;">#0</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
      Partition<span style="color: #000066;">.</span><span style="color: #006600;">Stream</span><span style="color: #000066;">:</span><span style="color: #000066;">=</span> Stream<span style="color: #000066;">;</span>
      <span style="color: #808080; font-style: italic;">// Si nos pasan el parametro /MBR</span>
      <span style="color: #000000; font-weight: bold;">if</span> LeerMBR <span style="color: #000000; font-weight: bold;">then</span>
      <span style="color: #000000; font-weight: bold;">begin</span>
        <span style="color: #808080; font-style: italic;">// Leemos el MBR y buscamos la primera particion</span>
        ReadMasterBootRecord<span style="color: #000066;">(</span>Partition<span style="color: #000066;">)</span><span style="color: #000066;">;</span>
        Stream<span style="color: #000066;">.</span><span style="color: #006600;">Position</span><span style="color: #000066;">:</span><span style="color: #000066;">=</span> <span style="color: #0000ff;">512</span> <span style="color: #000066;">*</span> Partition<span style="color: #000066;">.</span><span style="color: #006600;">PartBegin</span><span style="color: #000066;">;</span>
      <span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">;</span>
      <span style="color: #808080; font-style: italic;">// Leemos el sector de arranque de la particion</span>
      ReadBootSector<span style="color: #000066;">(</span>Partition<span style="color: #000066;">)</span><span style="color: #000066;">;</span>
      <span style="color: #808080; font-style: italic;">// Reservamos espacio en memoria para la FAT</span>
      <span style="color: #000000; font-weight: bold;">with</span> Partition <span style="color: #000000; font-weight: bold;">do</span>
        <span style="color: #000066;">GetMem</span><span style="color: #000066;">(</span>FAT<span style="color: #000066;">,</span>FATSz32 <span style="color: #000066;">*</span> BytsPerSec<span style="color: #000066;">)</span><span style="color: #000066;">;</span>
      <span style="color: #000000; font-weight: bold;">try</span>
        <span style="color: #808080; font-style: italic;">// Leemos la FAT y la guardamos en memoria</span>
        ReadFAT<span style="color: #000066;">(</span>Partition<span style="color: #000066;">)</span><span style="color: #000066;">;</span>
        <span style="color: #808080; font-style: italic;">// Volcamos la informacion en pantalla</span>
        Tree<span style="color: #000066;">(</span>Partition<span style="color: #000066;">,</span> Partition<span style="color: #000066;">.</span><span style="color: #006600;">RootClus</span><span style="color: #000066;">,</span> <span style="color: #ff0000;">'\'</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
      <span style="color: #000000; font-weight: bold;">finally</span>
        <span style="color: #808080; font-style: italic;">// Liberamos la memoria reservada para la FAT</span>
        <span style="color: #000066;">FreeMem</span><span style="color: #000066;">(</span>Partition<span style="color: #000066;">.</span><span style="color: #006600;">FAT</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
      <span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">;</span>
    <span style="color: #000000; font-weight: bold;">finally</span>
      <span style="color: #808080; font-style: italic;">// Liberamos el stream</span>
      Stream<span style="color: #000066;">.</span><span style="color: #006600;">Free</span><span style="color: #000066;">;</span>
    <span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">;</span>
  <span style="color: #000000; font-weight: bold;">except</span>
    <span style="color: #808080; font-style: italic;">// Si ocurre un error</span>
    <span style="color: #000000; font-weight: bold;">On</span> E<span style="color: #000066;">:</span> Exception <span style="color: #000000; font-weight: bold;">do</span>
    <span style="color: #000000; font-weight: bold;">begin</span>
      <span style="color: #808080; font-style: italic;">// Lo mostramos</span>
      <span style="color: #000066;">Writeln</span><span style="color: #000066;">(</span><span style="color: #ff0000;">'Exception: '</span> <span style="color: #000066;">+</span> E<span style="color: #000066;">.</span><span style="color: #000000; font-weight: bold;">Message</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
      <span style="color: #000066;">Writeln</span><span style="color: #000066;">(</span><span style="color: #ff0000;">'LastError: '</span> <span style="color: #000066;">+</span> <span style="color: #000066;">SysErrorMessage</span><span style="color: #000066;">(</span>GetLastError<span style="color: #000066;">)</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
      <span style="color: #000066;">Writeln</span><span style="color: #000066;">(</span><span style="color: #ff0000;">'ParamStr(1): '</span> <span style="color: #000066;">+</span> <span style="color: #000066;">ParamStr</span><span style="color: #000066;">(</span><span style="color: #0000ff;">1</span><span style="color: #000066;">)</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
    <span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">;</span>
  <span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">;</span>
  Writeln<span style="color: #000066;">;</span>
  <span style="color: #000066;">Writeln</span><span style="color: #000066;">(</span><span style="color: #ff0000;">'Pulsa [ENTER] para cerrar el programa ...'</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
  Readln<span style="color: #000066;">;</span>
<span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">;</span>
 
<span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">.</span></pre></div>
<p>El funcionamiento es muy simple, solo hay que tener la precaución de ejecutarlo como administrador</p>
<p><img src="/sites/delphi.jmrds.com/imagenes/Stories/runas.png" /></p>
<p>Si no se pasa ningún fichero como parámetro se dan a escoger entre los discos del sistema:</p>
<div class="geshifilter">
<pre class="text geshifilter-text" style="font-family:monospace;">C:\fatexp&gt;fatexp
[0] Salir
[1] \\.\C:
[2] \\.\D:
[3] \\.\E:
[4] \\.\F:
[5] \\.\PhysicalDrive0
[6] \\.\PhysicalDrive1
[7] \\.\PhysicalDrive2
Escoge:</pre></div>
<p>Solo tenemos que escoger el disco y nos mostrara algo como esto:</p>
<div class="geshifilter">
<pre class="text geshifilter-text" style="font-family:monospace;">[0] Salir
[1] \\.\C:
[2] \\.\D:
[3] \\.\E:
[4] \\.\F:
[5] \\.\G:
[6] \\.\PhysicalDrive0
[7] \\.\PhysicalDrive1
[8] \\.\PhysicalDrive2
[9] \\.\PhysicalDrive3
Escoge: 
=== Master Boot Record ===
00000000:  33 C0 8E D0 BC 00 7C 8E  C0 8E D8 BE 00 7C BF 00  |3...............|
00000010:  06 B9 00 02 FC F3 A4 50  68 1C 06 CB FB B9 04 00  |.......Ph.......|
00000020:  BD BE 07 80 7E 00 00 7C  0B 0F 85 0E 01 83 C5 10  |................|
00000030:  E2 F1 CD 18 88 56 00 55  C6 46 11 05 C6 46 10 00  |.....V.U.F...F..|
00000040:  B4 41 BB AA 55 CD 13 5D  72 0F 81 FB 55 AA 75 09  |.A..U...r...U.u.|
00000050:  F7 C1 01 00 74 03 FE 46  10 66 60 80 7E 10 00 74  |....t..F.f.....t|
00000060:  26 66 68 00 00 00 00 66  FF 76 08 68 00 00 68 00  |.fh....f.v.h..h.|
00000070:  7C 68 01 00 68 10 00 B4  42 8A 56 00 8B F4 CD 13  |.h..h...B.V.....|
00000080:  9F 83 C4 10 9E EB 14 B8  01 02 BB 00 7C 8A 56 00  |..............V.|
00000090:  8A 76 01 8A 4E 02 8A 6E  03 CD 13 66 61 73 1C FE  |.v..N..n...fas..|
000000A0:  4E 11 75 0C 80 7E 00 80  0F 84 8A 00 B2 80 EB 84  |N.u.............|
000000B0:  55 32 E4 8A 56 00 CD 13  5D EB 9E 81 3E FE 7D 55  |U2..V..........U|
000000C0:  AA 75 6E FF 76 00 E8 8D  00 75 17 FA B0 D1 E6 64  |.un.v....u.....d|
000000D0:  E8 83 00 B0 DF E6 60 E8  7C 00 B0 FF E6 64 E8 75  |.............d.u|
000000E0:  00 FB B8 00 BB CD 1A 66  23 C0 75 3B 66 81 FB 54  |.......f..u.f..T|
000000F0:  43 50 41 75 32 81 F9 02  01 72 2C 66 68 07 BB 00  |CPAu2....r.fh...|
00000100:  00 66 68 00 02 00 00 66  68 08 00 00 00 66 53 66  |.fh....fh....fSf|
00000110:  53 66 55 66 68 00 00 00  00 66 68 00 7C 00 00 66  |SfUfh....fh....f|
00000120:  61 68 00 00 07 CD 1A 5A  32 F6 EA 00 7C 00 00 CD  |ah.....Z2.......|
00000130:  18 A0 B7 07 EB 08 A0 B6  07 EB 03 A0 B5 07 32 E4  |..............2.|
00000140:  05 00 07 8B F0 AC 3C 00  74 09 BB 07 00 B4 0E CD  |........t.......|
00000150:  10 EB F2 F4 EB FD 2B C9  E4 64 EB 00 24 02 E0 F8  |.........d......|
00000160:  24 02 C3 49 6E 76 61 6C  69 64 20 70 61 72 74 69  |...Invalid.parti|
00000170:  74 69 6F 6E 20 74 61 62  6C 65 00 45 72 72 6F 72  |tion.table.Error|
00000180:  20 6C 6F 61 64 69 6E 67  20 6F 70 65 72 61 74 69  |.loading.operati|
00000190:  6E 67 20 73 79 73 74 65  6D 00 4D 69 73 73 69 6E  |ng.system.Missin|
000001A0:  67 20 6F 70 65 72 61 74  69 6E 67 20 73 79 73 74  |g.operating.syst|
000001B0:  65 6D 00 00 00 63 7B 9A  00 00 00 00 00 00 80 02  |em...c..........|
000001C0:  03 00 0B FE 7F EB 80 00  00 00 80 BF 78 00 00 00  |............x...|
000001D0:  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
000001E0:  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
000001F0:  00 00 00 00 00 00 00 00  00 00 00 00 00 00 55 AA  |..............U.|
 
=== Table ===
00000000:  80 02 03 00 0B FE 7F EB  80 00 00 00 80 BF 78 00  |..............x.|
00000010:  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
00000020:  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
00000030:  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
 
=== Partitions ===
[0] 00000080/0078BF80 A
[1] 00000000/00000000
[2] 00000000/00000000
[3] 00000000/00000000
 
Go to partition 0 ...
 
=== Boot Sector ===
00000000:  EB 58 90 4D 53 44 4F 53  35 2E 30 00 02 08 C0 03  |.X.MSDOS5.0.....|
00000010:  02 00 00 00 00 F8 00 00  3F 00 FF 00 80 00 00 00  |................|
00000020:  80 BF 78 00 20 1E 00 00  00 00 00 00 02 00 00 00  |..x.............|
00000030:  01 00 06 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
00000040:  80 00 29 47 5D 32 AA 4E  4F 20 4E 41 4D 45 20 20  |...G.2.NO.NAME..|
00000050:  20 20 46 41 54 33 32 20  20 20 33 C9 8E D1 BC F4  |..FAT32...3.....|
00000060:  7B 8E C1 8E D9 BD 00 7C  88 4E 02 8A 56 40 B4 41  |.........N..V..A|
00000070:  BB AA 55 CD 13 72 10 81  FB 55 AA 75 0A F6 C1 01  |..U..r...U.u....|
00000080:  74 05 FE 46 02 EB 2D 8A  56 40 B4 08 CD 13 73 05  |t..F....V.....s.|
00000090:  B9 FF FF 8A F1 66 0F B6  C6 40 66 0F B6 D1 80 E2  |.....f....f.....|
000000A0:  3F F7 E2 86 CD C0 ED 06  41 66 0F B7 C9 66 F7 E1  |........Af...f..|
000000B0:  66 89 46 F8 83 7E 16 00  75 38 83 7E 2A 00 77 32  |f.F.....u8....w2|
000000C0:  66 8B 46 1C 66 83 C0 0C  BB 00 80 B9 01 00 E8 2B  |f.F.f...........|
000000D0:  00 E9 2C 03 A0 FA 7D B4  7D 8B F0 AC 84 C0 74 17  |..............t.|
000000E0:  3C FF 74 09 B4 0E BB 07  00 CD 10 EB EE A0 FB 7D  |..t.............|
000000F0:  EB E5 A0 F9 7D EB E0 98  CD 16 CD 19 66 60 80 7E  |............f...|
00000100:  02 00 0F 84 20 00 66 6A  00 66 50 06 53 66 68 10  |......fj.fP.Sfh.|
00000110:  00 01 00 B4 42 8A 56 40  8B F4 CD 13 66 58 66 58  |....B.V.....fXfX|
00000120:  66 58 66 58 EB 33 66 3B  46 F8 72 03 F9 EB 2A 66  |fXfX.3f.F.r....f|
00000130:  33 D2 66 0F B7 4E 18 66  F7 F1 FE C2 8A CA 66 8B  |3.f..N.f......f.|
00000140:  D0 66 C1 EA 10 F7 76 1A  86 D6 8A 56 40 8A E8 C0  |.f....v....V....|
00000150:  E4 06 0A CC B8 01 02 CD  13 66 61 0F 82 75 FF 81  |.........fa..u..|
00000160:  C3 00 02 66 40 49 75 94  C3 42 4F 4F 54 4D 47 52  |...f.Iu..BOOTMGR|
00000170:  20 20 20 20 00 00 00 00  00 00 00 00 00 00 00 00  |................|
00000180:  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
00000190:  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
000001A0:  00 00 00 00 00 00 00 00  00 00 00 00 0D 0A 52 65  |..............Re|
000001B0:  6D 6F 76 65 20 64 69 73  6B 73 20 6F 72 20 6F 74  |move.disks.or.ot|
000001C0:  68 65 72 20 6D 65 64 69  61 2E FF 0D 0A 44 69 73  |her.media....Dis|
000001D0:  6B 20 65 72 72 6F 72 FF  0D 0A 50 72 65 73 73 20  |k.error...Press.|
000001E0:  61 6E 79 20 6B 65 79 20  74 6F 20 72 65 73 74 61  |any.key.to.resta|
000001F0:  72 74 0D 0A 00 00 00 00  00 AC CB D8 00 00 55 AA  |rt............U.|
 
Partiton type:       0x0B (FAT32)
Signature:           55AA
System ID:           FAT32
OEM ID:              MSDOS5.0
Volume label:        NO NAME
Volume serial:       AA325D47
Bytes per sector:    512
Sectors per cluster: 8
Bytes per cluster:   4096
Reserved sectors:    960
Number of FATs:      2
Sectors per FAT:     7712
Cluster count:       987136
Root cluster:        2
 
=== Clusters ===
Free: 983750
Used: 3386
Bad:  0
 
27/04/2012  22:42       &lt;DIR&gt;  \UNO
27/04/2012  22:42        0     \UNO\TRES.TXT
27/04/2012  22:42        0     \DOS.TXT
22/01/2012  17:47       &lt;DIR&gt;  \WILLIA~1
14/06/2011  18:39   625,31 KB  \WILLIA~1\LAMµQU~1.AZW
14/06/2011  18:39   466,13 KB  \WILLIA~1\MONALI~1.MOB
14/06/2011  18:39   341,71 KB  \WILLIA~1\NEUROM~1.AZW
22/01/2012  17:47       &lt;DIR&gt;  \WILLIA~2
14/06/2011  18:39   305,49 KB  \WILLIA~2\ELSE¥O~1.MOB
... etc ...</pre></div>
<p>Por ultimo solo recordar que el programa se puede usar con imágenes de disco creadas con Dump, por ejemplo:</p>
<div class="geshifilter">
<pre class="text geshifilter-text" style="font-family:monospace;">fatexp imagen.bin</pre></div>
<p>El código y el programa ya compilado se pueden bajar de <a href="/sites/delphi.jmrds.com/adjuntos/fatexp.zip">aquí</a> </p>
<p><b>Enlaces de interés:</b><br />
Dump - <a href="http://delphi.jmrds.com/node/45">http://delphi.jmrds.com/node/45</a><br /><a href="http://www.pjrc.com/tech/8051/ide/fat32.html">http://www.pjrc.com/tech/8051/ide/fat32.html</a><br /><a href="http://en.wikipedia.org/wiki/File_Allocation_Table">http://en.wikipedia.org/wiki/File_Allocation_Table</a><br /><a href="http://en.wikipedia.org/wiki/Master_boot_record">http://en.wikipedia.org/wiki/Master_boot_record</a><br /><a href="http://technet.microsoft.com/en-us/library/cc977221.aspx">http://technet.microsoft.com/en-us/library/cc977221.aspx</a></p>
</div></div></div>    <footer>
        <ul class="links list-inline"><li class="comment_forbidden first last"></li>
</ul>  </footer>
    </article>

</section>
  </div>
    </section>

    
  </div>
</div>

  <script src="/sites/delphi.jmrds.com/themes/bootstrap/js/bootstrap.js?"></script>
</body>
</html>
