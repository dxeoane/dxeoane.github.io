<!DOCTYPE html>
<html lang="es" dir="ltr" prefix="content: http://purl.org/rss/1.0/modules/content/ dc: http://purl.org/dc/terms/ foaf: http://xmlns.com/foaf/0.1/ og: http://ogp.me/ns# rdfs: http://www.w3.org/2000/01/rdf-schema# sioc: http://rdfs.org/sioc/ns# sioct: http://rdfs.org/sioc/types# skos: http://www.w3.org/2004/02/skos/core# xsd: http://www.w3.org/2001/XMLSchema#">
<head>
  <link rel="profile" href="http://www.w3.org/1999/xhtml/vocab" />
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<link rel="shortcut icon" href="/sites/delphi.jmrds.com/themes/bootstrap/favicon.ico" type="image/vnd.microsoft.icon" />
<link rel="shortlink" href="/node/42" />
<link rel="canonical" href="/node/42" />
<meta name="Generator" content="Drupal 7 (http://drupal.org)" />
  <title>Recuerar imagenes jpeg 3 | La web de Seoane</title>
  <style>
@import url("/modules/system/system.base.css?");
</style>
<style>
@import url("/modules/field/theme/field.css?");
@import url("/modules/node/node.css?");
</style>
<style>
@import url("/sites/delphi.jmrds.com/modules/geshifilter/geshifilter.css?");
</style>
<link type="text/css" rel="stylesheet" href="/sites/delphi.jmrds.com/themes/bootstrap/bootstrap.css" media="all" />
<style>
@import url("/sites/delphi.jmrds.com/themes/bootstrap/css/3.3.5/overrides.min.css?");
</style>
  <!-- HTML5 element support for IE6-8 -->
  <!--[if lt IE 9]>
    <script src="https://cdn.jsdelivr.net/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
  <![endif]-->
  <script src="/sites/delphi.jmrds.com/modules/jquery_update/replace/jquery/1.10/jquery.min.js?v=1.10.2"></script>
<script src="/misc/jquery.once.js?v=1.2"></script>
<script src="/misc/drupal.js?"></script>
<script src="/sites/delphi.jmrds.com/themes/bootstrap/bootstrap.js"></script>
<script src="/sites/delphi.jmrds.com/files/languages/es_sB9mP1iixuFRbyZKZVySK7xrSW_2-LRj1vNEXyqwOu8.js?"></script>
<script>jQuery.extend(Drupal.settings, {"basePath":"\/","pathPrefix":"","ajaxPageState":{"theme":"bootstrap","theme_token":"FhN-XzCKn58PZ49z4zEnOLV1fbOC8gOCh8qhsZTx1rM","js":{"sites\/delphi.jmrds.com\/themes\/bootstrap\/js\/bootstrap.js":1,"sites\/delphi.jmrds.com\/modules\/jquery_update\/replace\/jquery\/1.10\/jquery.min.js":1,"misc\/jquery.once.js":1,"misc\/drupal.js":1,"\/\/cdn.jsdelivr.net\/bootstrap\/3.3.5\/js\/bootstrap.js":1,"public:\/\/languages\/es_sB9mP1iixuFRbyZKZVySK7xrSW_2-LRj1vNEXyqwOu8.js":1},"css":{"modules\/system\/system.base.css":1,"modules\/field\/theme\/field.css":1,"modules\/node\/node.css":1,"sites\/delphi.jmrds.com\/modules\/geshifilter\/geshifilter.css":1,"\/\/cdn.jsdelivr.net\/bootstrap\/3.3.5\/css\/bootstrap.css":1,"sites\/delphi.jmrds.com\/themes\/bootstrap\/css\/3.3.5\/overrides.min.css":1}},"bootstrap":{"anchorsFix":"0","anchorsSmoothScrolling":"0","formHasError":1,"popoverEnabled":"1","popoverOptions":{"animation":1,"html":0,"placement":"right","selector":"","trigger":"click","triggerAutoclose":1,"title":"","content":"","delay":0,"container":"body"},"tooltipEnabled":"1","tooltipOptions":{"animation":1,"html":0,"placement":"auto left","selector":"","trigger":"hover focus","delay":0,"container":"body"}}});</script>
</head>
<body class="html not-front not-logged-in no-sidebars page-node page-node- page-node-42 node-type-article">
  <div id="skip-link">
    <a href="#main-content" class="element-invisible element-focusable">Pasar al contenido principal</a>
  </div>
    <header id="navbar" role="banner" class="navbar container navbar-default">
  <div class="container">
    <div class="navbar-header">
              <a class="logo navbar-btn pull-left" href="/" title="Inicio">
          <img src="/sites/delphi.jmrds.com/themes/bootstrap/logo.png" alt="Inicio" />
        </a>
      
              <a class="name navbar-brand" href="/" title="Inicio">La web de Seoane</a>
      
              <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#navbar-collapse">
          <span class="sr-only">Toggle navigation</span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
          </div>

          <div class="navbar-collapse collapse" id="navbar-collapse">
        <nav role="navigation">
                      <ul class="menu nav navbar-nav"><li class="first leaf"><a href="/" title="">Inicio</a></li>
<li class="last leaf"><a href="/node/26" title="">Contacto</a></li>
</ul>                                      </nav>
      </div>
      </div>
</header>

<div class="main-container container">

  <header role="banner" id="page-header">
    
      </header> <!-- /#page-header -->

  <div class="row">

    
    <section class="col-sm-12">
                  <a id="main-content"></a>
                    <h1 class="page-header">Recuerar imagenes jpeg 3</h1>
                                                          <div class="region region-content">
    <section id="block-system-main" class="block block-system clearfix">

      
  <article id="node-42" class="node node-article node-promoted clearfix" about="/node/42" typeof="sioc:Item foaf:Document">
    <header>
            <span property="dc:title" content="Recuerar imagenes jpeg 3" class="rdf-meta element-hidden"></span><span property="sioc:num_replies" content="6" datatype="xsd:integer" class="rdf-meta element-hidden"></span>        <span class="submitted">
            <span property="dc:date dc:created" content="2007-10-07T01:44:20+02:00" datatype="xsd:dateTime" rel="sioc:has_creator">Enviado por <span class="username" xml:lang="" about="/user/1" typeof="sioc:UserAccount" property="foaf:name" datatype="">admin</span> el Dom, 10/07/2007 - 01:44</span>    </span>
      </header>
    <div class="field field-name-body field-type-text-with-summary field-label-hidden"><div class="field-items"><div class="field-item even" property="content:encoded"><p>Hace algún tiempo hablé de como recuperar imágenes jpg de un disco o archivo (<a href="/node/27">aquí</a> y <a href="/node/30">aquí</a>), ahora, además de depurar un poco el código de ambos programas, voy a aprovechar para unirlos en uno solo. El código resultante se puede compilar tanto en delphi como en freepascal, por lo que puede ser usado perfectamente en windows o en linux.</p>
<!--break--><p>
El funcionamiento del programa sigue siendo el mismo que el de los dos anteriores, buscamos la marca que indica el comienzo de un archivo jpeg, es decir, los bytes FFD8FF. Una vez encontrada, intentamos obtener de los bytes que siguen a esos tres una imagen jpeg, para luego continuar la búsqueda en el bloque siguiente.</p>
<p>El código es el siguiente (es una aplicación de consola):</p>
<div class="geshifilter">
<pre class="delphi geshifilter-delphi" style="font-family:monospace;"><span style="color: #000000; font-weight: bold;">program</span> recover<span style="color: #000066;">;</span>
 
<span style="color: #008000; font-style: italic;">{$APPTYPE CONSOLE}</span>
 
<span style="color: #000000; font-weight: bold;">uses</span>
  SysUtils<span style="color: #000066;">,</span> Classes<span style="color: #000066;">;</span>
 
<span style="color: #000000; font-weight: bold;">type</span>
  EGetOptError <span style="color: #000066;">=</span> <span style="color: #000000; font-weight: bold;">class</span><span style="color: #000066;">(</span>Exception<span style="color: #000066;">)</span><span style="color: #000066;">;</span>
 
<span style="color: #000000; font-weight: bold;">var</span>
  Options<span style="color: #000066;">:</span> <span style="color: #000000; font-weight: bold;">record</span>
    BlockSize<span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">Integer</span><span style="color: #000066;">;</span>
    InputFile<span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">String</span><span style="color: #000066;">;</span>
    FormatStr<span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">String</span><span style="color: #000066;">;</span>
    Index<span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">Integer</span><span style="color: #000066;">;</span>
  <span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">;</span>
 
<span style="color: #000000; font-weight: bold;">procedure</span> CopyJpegFrom<span style="color: #000066;">(</span>Src<span style="color: #000066;">,</span> Dst<span style="color: #000066;">:</span> TStream<span style="color: #000066;">)</span><span style="color: #000066;">;</span>
<span style="color: #000000; font-weight: bold;">var</span>
  Buffer<span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">PByteArray</span><span style="color: #000066;">;</span>
  Size<span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">Integer</span><span style="color: #000066;">;</span>
<span style="color: #000000; font-weight: bold;">begin</span>
  <span style="color: #000066;">GetMem</span><span style="color: #000066;">(</span>Buffer<span style="color: #000066;">,</span><span style="color: #0000cc;">$10000</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
  <span style="color: #000000; font-weight: bold;">try</span>
    <span style="color: #000000; font-weight: bold;">while</span> <span style="color: #000000; font-weight: bold;">TRUE</span> <span style="color: #000000; font-weight: bold;">do</span>
    <span style="color: #000000; font-weight: bold;">begin</span>
      <span style="color: #000066;">FillChar</span><span style="color: #000066;">(</span>Buffer<span style="color: #000066;">^</span><span style="color: #000066;">,</span><span style="color: #0000ff;">4</span><span style="color: #000066;">,</span><span style="color: #ff0000;">#0</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
      Src<span style="color: #000066;">.</span><span style="color: #000000; font-weight: bold;">Read</span><span style="color: #000066;">(</span>Buffer<span style="color: #000066;">^</span><span style="color: #000066;">,</span><span style="color: #0000ff;">4</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
      Size<span style="color: #000066;">:</span><span style="color: #000066;">=</span> <span style="color: #000066;">(</span><span style="color: #000066;">(</span>Buffer<span style="color: #000066;">[</span><span style="color: #0000ff;">2</span><span style="color: #000066;">]</span> <span style="color: #000000; font-weight: bold;">shl</span> <span style="color: #0000ff;">8</span><span style="color: #000066;">)</span> <span style="color: #000066;">+</span> Buffer<span style="color: #000066;">[</span><span style="color: #0000ff;">3</span><span style="color: #000066;">]</span><span style="color: #000066;">)</span> <span style="color: #000066;">-</span> <span style="color: #0000ff;">2</span><span style="color: #000066;">;</span>
      <span style="color: #000000; font-weight: bold;">case</span> Buffer<span style="color: #000066;">[</span><span style="color: #0000ff;">1</span><span style="color: #000066;">]</span> <span style="color: #000000; font-weight: bold;">of</span>
        <span style="color: #0000cc;">$01</span><span style="color: #000066;">,</span><span style="color: #0000cc;">$D0</span><span style="color: #000066;">..</span><span style="color: #0000cc;">$D8</span><span style="color: #000066;">:</span> <span style="color: #000000; font-weight: bold;">begin</span>
                        Dst<span style="color: #000066;">.</span><span style="color: #006600;">WriteBuffer</span><span style="color: #000066;">(</span>Buffer<span style="color: #000066;">^</span><span style="color: #000066;">,</span><span style="color: #0000ff;">2</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
                        Src<span style="color: #000066;">.</span><span style="color: #000066;">Seek</span><span style="color: #000066;">(</span><span style="color: #000066;">-</span><span style="color: #0000ff;">2</span><span style="color: #000066;">,</span>soFromCurrent<span style="color: #000066;">)</span><span style="color: #000066;">;</span>
                      <span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">;</span>
        <span style="color: #0000cc;">$D9</span><span style="color: #000066;">:</span> <span style="color: #000000; font-weight: bold;">begin</span>
               Dst<span style="color: #000066;">.</span><span style="color: #006600;">WriteBuffer</span><span style="color: #000066;">(</span>Buffer<span style="color: #000066;">^</span><span style="color: #000066;">,</span><span style="color: #0000ff;">2</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
               <span style="color: #808080; font-style: italic;">// Salimos del procedure</span>
               Exit<span style="color: #000066;">;</span>
             <span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">;</span>
        <span style="color: #0000cc;">$DA</span><span style="color: #000066;">:</span> <span style="color: #000000; font-weight: bold;">begin</span>
               Dst<span style="color: #000066;">.</span><span style="color: #006600;">WriteBuffer</span><span style="color: #000066;">(</span>Buffer<span style="color: #000066;">^</span><span style="color: #000066;">,</span><span style="color: #0000ff;">2</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
               Src<span style="color: #000066;">.</span><span style="color: #000066;">Seek</span><span style="color: #000066;">(</span><span style="color: #000066;">-</span><span style="color: #0000ff;">2</span><span style="color: #000066;">,</span>soFromCurrent<span style="color: #000066;">)</span><span style="color: #000066;">;</span>
               <span style="color: #000000; font-weight: bold;">while</span> <span style="color: #000000; font-weight: bold;">TRUE</span> <span style="color: #000000; font-weight: bold;">do</span>
               <span style="color: #000000; font-weight: bold;">begin</span>
                 Src<span style="color: #000066;">.</span><span style="color: #006600;">ReadBuffer</span><span style="color: #000066;">(</span>Buffer<span style="color: #000066;">^</span><span style="color: #000066;">,</span><span style="color: #0000ff;">1</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
                 <span style="color: #000000; font-weight: bold;">if</span> Buffer<span style="color: #000066;">[</span><span style="color: #0000ff;">0</span><span style="color: #000066;">]</span> <span style="color: #000066;">=</span> <span style="color: #0000cc;">$FF</span> <span style="color: #000000; font-weight: bold;">then</span>
                 <span style="color: #000000; font-weight: bold;">begin</span>
                   Src<span style="color: #000066;">.</span><span style="color: #006600;">ReadBuffer</span><span style="color: #000066;">(</span>Buffer<span style="color: #000066;">^</span><span style="color: #000066;">,</span><span style="color: #0000ff;">1</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
                  <span style="color: #000000; font-weight: bold;">if</span> <span style="color: #000066;">(</span>Buffer<span style="color: #000066;">[</span><span style="color: #0000ff;">0</span><span style="color: #000066;">]</span> &lt;&gt; <span style="color: #0000ff;">0</span><span style="color: #000066;">)</span> <span style="color: #000000; font-weight: bold;">and</span> <span style="color: #000000; font-weight: bold;">not</span> <span style="color: #000066;">(</span>Buffer<span style="color: #000066;">[</span><span style="color: #0000ff;">0</span><span style="color: #000066;">]</span> <span style="color: #000000; font-weight: bold;">in</span> <span style="color: #000066;">[</span><span style="color: #0000cc;">$D0</span><span style="color: #000066;">..</span><span style="color: #0000cc;">$D7</span><span style="color: #000066;">]</span><span style="color: #000066;">)</span> <span style="color: #000000; font-weight: bold;">then</span>
                   <span style="color: #000000; font-weight: bold;">begin</span>
                     Src<span style="color: #000066;">.</span><span style="color: #000066;">Seek</span><span style="color: #000066;">(</span><span style="color: #000066;">-</span><span style="color: #0000ff;">2</span><span style="color: #000066;">,</span>soFromCurrent<span style="color: #000066;">)</span><span style="color: #000066;">;</span>
                     break<span style="color: #000066;">;</span>
                   <span style="color: #000000; font-weight: bold;">end</span> <span style="color: #000000; font-weight: bold;">else</span>
                   <span style="color: #000000; font-weight: bold;">begin</span>
                     Buffer<span style="color: #000066;">[</span><span style="color: #0000ff;">1</span><span style="color: #000066;">]</span><span style="color: #000066;">:</span><span style="color: #000066;">=</span> Buffer<span style="color: #000066;">[</span><span style="color: #0000ff;">0</span><span style="color: #000066;">]</span><span style="color: #000066;">;</span>
                     Buffer<span style="color: #000066;">[</span><span style="color: #0000ff;">0</span><span style="color: #000066;">]</span><span style="color: #000066;">:</span><span style="color: #000066;">=</span> <span style="color: #0000cc;">$FF</span><span style="color: #000066;">;</span>
                     Dst<span style="color: #000066;">.</span><span style="color: #006600;">WriteBuffer</span><span style="color: #000066;">(</span>Buffer<span style="color: #000066;">^</span><span style="color: #000066;">,</span><span style="color: #0000ff;">2</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
                   <span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">;</span>
                 <span style="color: #000000; font-weight: bold;">end</span> <span style="color: #000000; font-weight: bold;">else</span>
                   Dst<span style="color: #000066;">.</span><span style="color: #006600;">WriteBuffer</span><span style="color: #000066;">(</span>Buffer<span style="color: #000066;">^</span><span style="color: #000066;">,</span><span style="color: #0000ff;">1</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
               <span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">;</span>
             <span style="color: #000000; font-weight: bold;">end</span>
        <span style="color: #000000; font-weight: bold;">else</span>
        <span style="color: #000000; font-weight: bold;">begin</span>
          Dst<span style="color: #000066;">.</span><span style="color: #006600;">WriteBuffer</span><span style="color: #000066;">(</span>Buffer<span style="color: #000066;">^</span><span style="color: #000066;">,</span><span style="color: #0000ff;">4</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
          Src<span style="color: #000066;">.</span><span style="color: #006600;">ReadBuffer</span><span style="color: #000066;">(</span>Buffer<span style="color: #000066;">^</span><span style="color: #000066;">,</span>Size<span style="color: #000066;">)</span><span style="color: #000066;">;</span>
          Dst<span style="color: #000066;">.</span><span style="color: #006600;">WriteBuffer</span><span style="color: #000066;">(</span>Buffer<span style="color: #000066;">^</span><span style="color: #000066;">,</span>Size<span style="color: #000066;">)</span><span style="color: #000066;">;</span>
        <span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">;</span>
      <span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">;</span>
    <span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">;</span>
  <span style="color: #000000; font-weight: bold;">finally</span>
    <span style="color: #000066;">FreeMem</span><span style="color: #000066;">(</span>Buffer<span style="color: #000066;">)</span><span style="color: #000066;">;</span>
  <span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">;</span>
<span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">;</span>
 
<span style="color: #000000; font-weight: bold;">procedure</span> SaveJpegToFile<span style="color: #000066;">(</span>Src<span style="color: #000066;">:</span> TStream<span style="color: #000066;">;</span> Filename<span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">String</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
<span style="color: #000000; font-weight: bold;">var</span>
  Stream<span style="color: #000066;">:</span> TMemoryStream<span style="color: #000066;">;</span>
<span style="color: #000000; font-weight: bold;">begin</span>
  Stream<span style="color: #000066;">:</span><span style="color: #000066;">=</span> TMemoryStream<span style="color: #000066;">.</span><span style="color: #006600;">Create</span><span style="color: #000066;">;</span>
  <span style="color: #000000; font-weight: bold;">try</span>
    CopyJpegFrom<span style="color: #000066;">(</span>Src<span style="color: #000066;">,</span> Stream<span style="color: #000066;">)</span><span style="color: #000066;">;</span>
    Stream<span style="color: #000066;">.</span><span style="color: #006600;">SaveToFile</span><span style="color: #000066;">(</span>Filename<span style="color: #000066;">)</span><span style="color: #000066;">;</span>
  <span style="color: #000000; font-weight: bold;">finally</span>
    Stream<span style="color: #000066;">.</span><span style="color: #006600;">Free</span><span style="color: #000066;">;</span>
  <span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">;</span>
<span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">;</span>
 
<span style="color: #000000; font-weight: bold;">procedure</span> ScanFile<span style="color: #000066;">(</span>Stream<span style="color: #000066;">:</span> TStream<span style="color: #000066;">;</span> FormatStr<span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">String</span><span style="color: #000066;">;</span> Index<span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">Integer</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span> <span style="color: #000000; font-weight: bold;">overload</span><span style="color: #000066;">;</span>
<span style="color: #000000; font-weight: bold;">var</span>
  B<span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">Byte</span><span style="color: #000066;">;</span>
  Leidos<span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">Integer</span><span style="color: #000066;">;</span>
  Posicion<span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">int64</span><span style="color: #000066;">;</span>
  Str<span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">String</span><span style="color: #000066;">;</span>
<span style="color: #000000; font-weight: bold;">begin</span>
  <span style="color: #808080; font-style: italic;">// Vamos leyendo byte a byte el archivo</span>
  Leidos<span style="color: #000066;">:</span><span style="color: #000066;">=</span> Stream<span style="color: #000066;">.</span><span style="color: #000000; font-weight: bold;">Read</span><span style="color: #000066;">(</span>B<span style="color: #000066;">,</span><span style="color: #0000ff;">1</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
  <span style="color: #000000; font-weight: bold;">while</span> Leidos <span style="color: #000066;">=</span> <span style="color: #0000ff;">1</span> <span style="color: #000000; font-weight: bold;">do</span>
    <span style="color: #000000; font-weight: bold;">if</span> B <span style="color: #000066;">=</span> <span style="color: #0000cc;">$FF</span> <span style="color: #000000; font-weight: bold;">then</span>
    <span style="color: #000000; font-weight: bold;">begin</span>
      Leidos<span style="color: #000066;">:</span><span style="color: #000066;">=</span> Stream<span style="color: #000066;">.</span><span style="color: #000000; font-weight: bold;">Read</span><span style="color: #000066;">(</span>B<span style="color: #000066;">,</span><span style="color: #0000ff;">1</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
      <span style="color: #000000; font-weight: bold;">if</span> Leidos <span style="color: #000066;">=</span> <span style="color: #0000ff;">1</span> <span style="color: #000000; font-weight: bold;">then</span>
        <span style="color: #000000; font-weight: bold;">if</span> B <span style="color: #000066;">=</span> <span style="color: #0000cc;">$D8</span> <span style="color: #000000; font-weight: bold;">then</span>
        <span style="color: #000000; font-weight: bold;">begin</span>
          Leidos<span style="color: #000066;">:</span><span style="color: #000066;">=</span> Stream<span style="color: #000066;">.</span><span style="color: #000000; font-weight: bold;">Read</span><span style="color: #000066;">(</span>B<span style="color: #000066;">,</span><span style="color: #0000ff;">1</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
          <span style="color: #000000; font-weight: bold;">if</span> Leidos <span style="color: #000066;">=</span> <span style="color: #0000ff;">1</span> <span style="color: #000000; font-weight: bold;">then</span>
            <span style="color: #000000; font-weight: bold;">if</span> B <span style="color: #000066;">=</span> <span style="color: #0000cc;">$FF</span> <span style="color: #000000; font-weight: bold;">then</span>
            <span style="color: #000000; font-weight: bold;">begin</span>
              <span style="color: #808080; font-style: italic;">// Hasta encontrar la combinacion $FFD8FF</span>
              <span style="color: #000066;">Writeln</span><span style="color: #000066;">(</span><span style="color: #ff0000;">'Encontrada una posible imagen'</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
              <span style="color: #808080; font-style: italic;">// Guardamos la posicion</span>
              Posicion<span style="color: #000066;">:</span><span style="color: #000066;">=</span> Stream<span style="color: #000066;">.</span><span style="color: #006600;">Position</span><span style="color: #000066;">;</span>
              Stream<span style="color: #000066;">.</span><span style="color: #000066;">Seek</span><span style="color: #000066;">(</span><span style="color: #000066;">-</span><span style="color: #0000ff;">3</span><span style="color: #000066;">,</span>soFromCurrent<span style="color: #000066;">)</span><span style="color: #000066;">;</span>
              Str<span style="color: #000066;">:</span><span style="color: #000066;">=</span> <span style="color: #000066;">Format</span><span style="color: #000066;">(</span>FormatStr<span style="color: #000066;">,</span><span style="color: #000066;">[</span>index<span style="color: #000066;">]</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
              <span style="color: #000000; font-weight: bold;">try</span>
                SaveJpegToFile<span style="color: #000066;">(</span>Stream<span style="color: #000066;">,</span>Str<span style="color: #000066;">)</span><span style="color: #000066;">;</span>
                <span style="color: #000066;">inc</span><span style="color: #000066;">(</span>index<span style="color: #000066;">)</span><span style="color: #000066;">;</span>
                <span style="color: #000066;">Writeln</span><span style="color: #000066;">(</span><span style="color: #ff0000;">'Recuperada: '</span> <span style="color: #000066;">+</span> Str<span style="color: #000066;">)</span><span style="color: #000066;">;</span>
              <span style="color: #000000; font-weight: bold;">except</span>
                <span style="color: #808080; font-style: italic;">// Si se produce un error lo mostramos, pero no salimos del bucle</span>
                <span style="color: #000000; font-weight: bold;">On</span> E<span style="color: #000066;">:</span> Exception <span style="color: #000000; font-weight: bold;">do</span>
                   <span style="color: #000066;">Writeln</span><span style="color: #000066;">(</span><span style="color: #ff0000;">'Error: '</span> <span style="color: #000066;">+</span> E<span style="color: #000066;">.</span><span style="color: #000000; font-weight: bold;">Message</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
              <span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">;</span>
              <span style="color: #808080; font-style: italic;">// Volvemos a la posicion en la que estabamos</span>
              Stream<span style="color: #000066;">.</span><span style="color: #006600;">Position</span><span style="color: #000066;">:</span><span style="color: #000066;">=</span> Posicion<span style="color: #000066;">;</span>
            <span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">;</span>
        <span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">;</span>
    <span style="color: #000000; font-weight: bold;">end</span> <span style="color: #000000; font-weight: bold;">else</span>
      Leidos<span style="color: #000066;">:</span><span style="color: #000066;">=</span> Stream<span style="color: #000066;">.</span><span style="color: #000000; font-weight: bold;">Read</span><span style="color: #000066;">(</span>B<span style="color: #000066;">,</span><span style="color: #0000ff;">1</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
<span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">;</span>
 
<span style="color: #000000; font-weight: bold;">const</span>
  MAXSIZE <span style="color: #000066;">=</span> <span style="color: #0000ff;">8</span><span style="color: #000066;">*</span><span style="color: #0000ff;">1024</span><span style="color: #000066;">*</span><span style="color: #0000ff;">1024</span><span style="color: #000066;">;</span>
 
<span style="color: #000000; font-weight: bold;">procedure</span> ScanFile<span style="color: #000066;">(</span>Stream<span style="color: #000066;">:</span> TStream<span style="color: #000066;">;</span> FormatStr<span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">String</span><span style="color: #000066;">;</span> Index<span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">Integer</span><span style="color: #000066;">;</span>
  BlockSize<span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">Integer</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span> <span style="color: #000000; font-weight: bold;">overload</span><span style="color: #000066;">;</span>
<span style="color: #000000; font-weight: bold;">var</span>
  Block<span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">PChar</span><span style="color: #000066;">;</span>
  Leidos<span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">Integer</span><span style="color: #000066;">;</span>
  Posicion<span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">int64</span><span style="color: #000066;">;</span>
  Str<span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">String</span><span style="color: #000066;">;</span>
  TmpStream<span style="color: #000066;">:</span> TMemorystream<span style="color: #000066;">;</span>
<span style="color: #000000; font-weight: bold;">begin</span>
  <span style="color: #000066;">GetMem</span><span style="color: #000066;">(</span>Block<span style="color: #000066;">,</span>BlockSize<span style="color: #000066;">)</span><span style="color: #000066;">;</span>
  <span style="color: #000000; font-weight: bold;">try</span>
    <span style="color: #808080; font-style: italic;">// Vamos leyendo bloque a bloque el archivo</span>
    Leidos<span style="color: #000066;">:</span><span style="color: #000066;">=</span> Stream<span style="color: #000066;">.</span><span style="color: #000000; font-weight: bold;">Read</span><span style="color: #000066;">(</span>Block<span style="color: #000066;">^</span><span style="color: #000066;">,</span>BlockSize<span style="color: #000066;">)</span><span style="color: #000066;">;</span>
    <span style="color: #000000; font-weight: bold;">while</span> Leidos <span style="color: #000066;">=</span> BlockSize <span style="color: #000000; font-weight: bold;">do</span>
    <span style="color: #000000; font-weight: bold;">begin</span>
      <span style="color: #808080; font-style: italic;">// Hasta encontrar la combinacion $FFD8FF</span>
      <span style="color: #000000; font-weight: bold;">if</span> <span style="color: #000066;">CompareMem</span><span style="color: #000066;">(</span>Block<span style="color: #000066;">,</span><span style="color: #000066; font-weight: bold;">PChar</span><span style="color: #000066;">(</span><span style="color: #ff0000;">#$FF</span><span style="color: #ff0000;">#$D8</span><span style="color: #ff0000;">#$FF</span><span style="color: #000066;">)</span><span style="color: #000066;">,</span><span style="color: #0000ff;">3</span><span style="color: #000066;">)</span> <span style="color: #000000; font-weight: bold;">then</span>
      <span style="color: #000000; font-weight: bold;">begin</span>
        Posicion<span style="color: #000066;">:</span><span style="color: #000066;">=</span> Stream<span style="color: #000066;">.</span><span style="color: #006600;">Position</span><span style="color: #000066;">;</span>
        TmpStream<span style="color: #000066;">:</span><span style="color: #000066;">=</span> TMemoryStream<span style="color: #000066;">.</span><span style="color: #006600;">Create</span><span style="color: #000066;">;</span>
        <span style="color: #000000; font-weight: bold;">try</span>
          TmpStream<span style="color: #000066;">.</span><span style="color: #000000; font-weight: bold;">Write</span><span style="color: #000066;">(</span>Block<span style="color: #000066;">^</span><span style="color: #000066;">,</span>Leidos<span style="color: #000066;">)</span><span style="color: #000066;">;</span>
          TmpStream<span style="color: #000066;">.</span><span style="color: #006600;">CopyFrom</span><span style="color: #000066;">(</span>Stream<span style="color: #000066;">,</span>MAXSIZE <span style="color: #000066;">-</span> <span style="color: #000066;">(</span>MAXSIZE <span style="color: #000000; font-weight: bold;">mod</span> BlockSize<span style="color: #000066;">)</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
          TmpStream<span style="color: #000066;">.</span><span style="color: #006600;">Position</span><span style="color: #000066;">:</span><span style="color: #000066;">=</span> <span style="color: #0000ff;">0</span><span style="color: #000066;">;</span>
          <span style="color: #000066;">Writeln</span><span style="color: #000066;">(</span><span style="color: #ff0000;">'Encontrada una posible imagen.'</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
          Str<span style="color: #000066;">:</span><span style="color: #000066;">=</span> <span style="color: #000066;">Format</span><span style="color: #000066;">(</span>FormatStr<span style="color: #000066;">,</span><span style="color: #000066;">[</span>index<span style="color: #000066;">]</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
          <span style="color: #808080; font-style: italic;">// Intentamos recuperar la imagen</span>
          <span style="color: #000000; font-weight: bold;">try</span>
            SaveJpegToFile<span style="color: #000066;">(</span>TmpStream<span style="color: #000066;">,</span>Str<span style="color: #000066;">)</span><span style="color: #000066;">;</span>
            <span style="color: #000066;">inc</span><span style="color: #000066;">(</span>index<span style="color: #000066;">)</span><span style="color: #000066;">;</span>
            <span style="color: #000066;">Writeln</span><span style="color: #000066;">(</span><span style="color: #ff0000;">'Recuperada: '</span> <span style="color: #000066;">+</span> Str<span style="color: #000066;">)</span><span style="color: #000066;">;</span>
          <span style="color: #000000; font-weight: bold;">except</span>
            <span style="color: #808080; font-style: italic;">// Si se produce un error lo mostramos, pero no salimos del bucle</span>
            <span style="color: #000000; font-weight: bold;">On</span> E<span style="color: #000066;">:</span> Exception <span style="color: #000000; font-weight: bold;">do</span>
               <span style="color: #000066;">Writeln</span><span style="color: #000066;">(</span><span style="color: #ff0000;">'Error: '</span> <span style="color: #000066;">+</span> E<span style="color: #000066;">.</span><span style="color: #000000; font-weight: bold;">Message</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
          <span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">;</span>
        <span style="color: #000000; font-weight: bold;">finally</span>
          TmpStream<span style="color: #000066;">.</span><span style="color: #006600;">Free</span><span style="color: #000066;">;</span>
        <span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">;</span>
        <span style="color: #808080; font-style: italic;">// Nos movemos hasta el siguiente cluster</span>
        Stream<span style="color: #000066;">.</span><span style="color: #006600;">Position</span><span style="color: #000066;">:</span><span style="color: #000066;">=</span> Posicion<span style="color: #000066;">;</span>
      <span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">;</span>
      Leidos<span style="color: #000066;">:</span><span style="color: #000066;">=</span> Stream<span style="color: #000066;">.</span><span style="color: #000000; font-weight: bold;">Read</span><span style="color: #000066;">(</span>Block<span style="color: #000066;">^</span><span style="color: #000066;">,</span>BlockSize<span style="color: #000066;">)</span><span style="color: #000066;">;</span>
    <span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">;</span>
  <span style="color: #000000; font-weight: bold;">finally</span>
    <span style="color: #000066;">FreeMem</span><span style="color: #000066;">(</span>Block<span style="color: #000066;">)</span><span style="color: #000066;">;</span>
  <span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">;</span>
<span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">;</span>
 
<span style="color: #000000; font-weight: bold;">procedure</span> WriteHelp<span style="color: #000066;">;</span>
<span style="color: #000000; font-weight: bold;">begin</span>
  Writeln<span style="color: #000066;">;</span>
  <span style="color: #000066;">Writeln</span><span style="color: #000066;">(</span><span style="color: #ff0000;">'Uso: recover [opciones]'</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
  <span style="color: #000066;">Writeln</span><span style="color: #000066;">(</span><span style="color: #ff0000;">'  --bs'</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
  <span style="color: #000066;">Writeln</span><span style="color: #000066;">(</span><span style="color: #ff0000;">'    Medida del bloque en el archivo de entrada'</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
  <span style="color: #000066;">Writeln</span><span style="color: #000066;">(</span><span style="color: #ff0000;">'  --fs'</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
  <span style="color: #000066;">Writeln</span><span style="color: #000066;">(</span><span style="color: #ff0000;">'    Cadena para dar formato a las imagenes recuperadas.'</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
  <span style="color: #000066;">Writeln</span><span style="color: #000066;">(</span><span style="color: #ff0000;">'  --help -h'</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
  <span style="color: #000066;">Writeln</span><span style="color: #000066;">(</span><span style="color: #ff0000;">'    Muestra este mensaje de ayuda'</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
  <span style="color: #000066;">Writeln</span><span style="color: #000066;">(</span><span style="color: #ff0000;">'  --id'</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
  <span style="color: #000066;">Writeln</span><span style="color: #000066;">(</span><span style="color: #ff0000;">'    Valor inicial del indice'</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
  <span style="color: #000066;">Writeln</span><span style="color: #000066;">(</span><span style="color: #ff0000;">'  --if'</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
  <span style="color: #000066;">Writeln</span><span style="color: #000066;">(</span><span style="color: #ff0000;">'    Nombre del archivo o disco a explorar'</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span> 
  Writeln<span style="color: #000066;">;</span>
  <span style="color: #000066;">Writeln</span><span style="color: #000066;">(</span><span style="color: #ff0000;">'Ejemplos:'</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
  <span style="color: #000066;">Writeln</span><span style="color: #000066;">(</span><span style="color: #ff0000;">'  recover --if=\\.\F: --bs=4096 --fs=%d.jpg --id=5'</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
  <span style="color: #000066;">Writeln</span><span style="color: #000066;">(</span><span style="color: #ff0000;">'    Busca y repuepar imagenes del disco F, y las guarda'</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
  <span style="color: #000066;">Writeln</span><span style="color: #000066;">(</span><span style="color: #ff0000;">'    como 5.jpg, 6.jpg, ...'</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
  <span style="color: #000066;">Writeln</span><span style="color: #000066;">(</span><span style="color: #ff0000;">'  recover --if=thumb.db --fs=%d.jpg'</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
  <span style="color: #000066;">Writeln</span><span style="color: #000066;">(</span><span style="color: #ff0000;">'    Busca y repuepar imagenes en el archivo "thumb.db", y'</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
  <span style="color: #000066;">Writeln</span><span style="color: #000066;">(</span><span style="color: #ff0000;">'    las guarda como 0.jpg, 1.jpg, ...'</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
  Writeln<span style="color: #000066;">;</span>      
<span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">;</span>
 
<span style="color: #000000; font-weight: bold;">function</span> Starts<span style="color: #000066;">(</span>Sub<span style="color: #000066;">,</span> Str<span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">String</span><span style="color: #000066;">)</span><span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">Boolean</span><span style="color: #000066;">;</span>
<span style="color: #000000; font-weight: bold;">begin</span>
  Result<span style="color: #000066;">:</span><span style="color: #000066;">=</span> <span style="color: #000066;">SameText</span><span style="color: #000066;">(</span>Sub<span style="color: #000066;">,</span><span style="color: #000066;">Copy</span><span style="color: #000066;">(</span>Str<span style="color: #000066;">,</span><span style="color: #0000ff;">1</span><span style="color: #000066;">,</span><span style="color: #000066;">Length</span><span style="color: #000066;">(</span>sub<span style="color: #000066;">)</span><span style="color: #000066;">)</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
<span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">;</span>
 
<span style="color: #000000; font-weight: bold;">procedure</span> Getopt<span style="color: #000066;">;</span>
<span style="color: #000000; font-weight: bold;">var</span>
  i<span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">Integer</span><span style="color: #000066;">;</span>
  Str<span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">String</span><span style="color: #000066;">;</span>
<span style="color: #000000; font-weight: bold;">begin</span>
  <span style="color: #000066;">FillChar</span><span style="color: #000066;">(</span>Options<span style="color: #000066;">,</span><span style="color: #000066;">Sizeof</span><span style="color: #000066;">(</span>Options<span style="color: #000066;">)</span><span style="color: #000066;">,</span><span style="color: #ff0000;">#0</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
  <span style="color: #000000; font-weight: bold;">if</span> ParamCount &gt; <span style="color: #0000ff;">0</span> <span style="color: #000000; font-weight: bold;">then</span>
    <span style="color: #000000; font-weight: bold;">for</span> i<span style="color: #000066;">:</span><span style="color: #000066;">=</span> <span style="color: #0000ff;">1</span> <span style="color: #000000; font-weight: bold;">to</span> ParamCount <span style="color: #000000; font-weight: bold;">do</span>
    <span style="color: #000000; font-weight: bold;">begin</span>
      Str<span style="color: #000066;">:</span><span style="color: #000066;">=</span> <span style="color: #000066;">ParamStr</span><span style="color: #000066;">(</span>i<span style="color: #000066;">)</span><span style="color: #000066;">;</span>
      <span style="color: #000000; font-weight: bold;">if</span> <span style="color: #000066;">(</span><span style="color: #000066;">Copy</span><span style="color: #000066;">(</span>Str<span style="color: #000066;">,</span><span style="color: #0000ff;">1</span><span style="color: #000066;">,</span><span style="color: #0000ff;">2</span><span style="color: #000066;">)</span> <span style="color: #000066;">=</span> <span style="color: #ff0000;">'--'</span><span style="color: #000066;">)</span> <span style="color: #000000; font-weight: bold;">and</span> <span style="color: #000066;">(</span><span style="color: #000066;">Length</span><span style="color: #000066;">(</span>Str<span style="color: #000066;">)</span> &gt; <span style="color: #0000ff;">2</span><span style="color: #000066;">)</span> <span style="color: #000000; font-weight: bold;">then</span>
      <span style="color: #000000; font-weight: bold;">begin</span>
        <span style="color: #000000; font-weight: bold;">if</span> Starts<span style="color: #000066;">(</span><span style="color: #ff0000;">'--if='</span><span style="color: #000066;">,</span>Str<span style="color: #000066;">)</span> <span style="color: #000000; font-weight: bold;">then</span>
        <span style="color: #000000; font-weight: bold;">begin</span>
          <span style="color: #000000; font-weight: bold;">if</span> Options<span style="color: #000066;">.</span><span style="color: #006600;">InputFile</span> <span style="color: #000066;">=</span> EmptyStr <span style="color: #000000; font-weight: bold;">then</span>
            Options<span style="color: #000066;">.</span><span style="color: #006600;">InputFile</span><span style="color: #000066;">:</span><span style="color: #000066;">=</span> <span style="color: #000066;">Copy</span><span style="color: #000066;">(</span>Str<span style="color: #000066;">,</span><span style="color: #000066;">Length</span><span style="color: #000066;">(</span><span style="color: #ff0000;">'--if='</span><span style="color: #000066;">)</span> <span style="color: #000066;">+</span> <span style="color: #0000ff;">1</span><span style="color: #000066;">,</span>MAXINT<span style="color: #000066;">)</span>
          <span style="color: #000000; font-weight: bold;">else</span>
            <span style="color: #000000; font-weight: bold;">raise</span> EGetOptError<span style="color: #000066;">.</span><span style="color: #006600;">Create</span><span style="color: #000066;">(</span>Str<span style="color: #000066;">)</span><span style="color: #000066;">;</span>
        <span style="color: #000000; font-weight: bold;">end</span> <span style="color: #000000; font-weight: bold;">else</span> <span style="color: #000000; font-weight: bold;">if</span> Starts<span style="color: #000066;">(</span><span style="color: #ff0000;">'--id='</span><span style="color: #000066;">,</span>Str<span style="color: #000066;">)</span> <span style="color: #000000; font-weight: bold;">then</span>
        <span style="color: #000000; font-weight: bold;">begin</span>
          <span style="color: #000000; font-weight: bold;">if</span> Options<span style="color: #000066;">.</span><span style="color: #006600;">Index</span> <span style="color: #000066;">=</span> <span style="color: #0000ff;">0</span> <span style="color: #000000; font-weight: bold;">then</span>
            Options<span style="color: #000066;">.</span><span style="color: #006600;">Index</span><span style="color: #000066;">:</span><span style="color: #000066;">=</span> <span style="color: #000066;">StrToInt</span><span style="color: #000066;">(</span><span style="color: #000066;">Copy</span><span style="color: #000066;">(</span>Str<span style="color: #000066;">,</span><span style="color: #000066;">Length</span><span style="color: #000066;">(</span><span style="color: #ff0000;">'--id='</span><span style="color: #000066;">)</span> <span style="color: #000066;">+</span> <span style="color: #0000ff;">1</span><span style="color: #000066;">,</span>MAXINT<span style="color: #000066;">)</span><span style="color: #000066;">)</span>
          <span style="color: #000000; font-weight: bold;">else</span>
            <span style="color: #000000; font-weight: bold;">raise</span> EGetOptError<span style="color: #000066;">.</span><span style="color: #006600;">Create</span><span style="color: #000066;">(</span>Str<span style="color: #000066;">)</span><span style="color: #000066;">;</span>
        <span style="color: #000000; font-weight: bold;">end</span> <span style="color: #000000; font-weight: bold;">else</span> <span style="color: #000000; font-weight: bold;">if</span> Starts<span style="color: #000066;">(</span><span style="color: #ff0000;">'--fs='</span><span style="color: #000066;">,</span>Str<span style="color: #000066;">)</span> <span style="color: #000000; font-weight: bold;">then</span>
        <span style="color: #000000; font-weight: bold;">begin</span>
          <span style="color: #000000; font-weight: bold;">if</span> Options<span style="color: #000066;">.</span><span style="color: #006600;">FormatStr</span> <span style="color: #000066;">=</span> EmptyStr <span style="color: #000000; font-weight: bold;">then</span>
            Options<span style="color: #000066;">.</span><span style="color: #006600;">FormatStr</span><span style="color: #000066;">:</span><span style="color: #000066;">=</span> <span style="color: #000066;">Copy</span><span style="color: #000066;">(</span>Str<span style="color: #000066;">,</span><span style="color: #000066;">Length</span><span style="color: #000066;">(</span><span style="color: #ff0000;">'--fs='</span><span style="color: #000066;">)</span> <span style="color: #000066;">+</span> <span style="color: #0000ff;">1</span><span style="color: #000066;">,</span>MAXINT<span style="color: #000066;">)</span>
          <span style="color: #000000; font-weight: bold;">else</span>
            <span style="color: #000000; font-weight: bold;">raise</span> EGetOptError<span style="color: #000066;">.</span><span style="color: #006600;">Create</span><span style="color: #000066;">(</span>Str<span style="color: #000066;">)</span><span style="color: #000066;">;</span>
        <span style="color: #000000; font-weight: bold;">end</span> <span style="color: #000000; font-weight: bold;">else</span> <span style="color: #000000; font-weight: bold;">if</span> Starts<span style="color: #000066;">(</span><span style="color: #ff0000;">'--bs='</span><span style="color: #000066;">,</span>Str<span style="color: #000066;">)</span> <span style="color: #000000; font-weight: bold;">then</span>
        <span style="color: #000000; font-weight: bold;">begin</span>
          <span style="color: #000000; font-weight: bold;">if</span> Options<span style="color: #000066;">.</span><span style="color: #006600;">BlockSize</span> <span style="color: #000066;">=</span> <span style="color: #0000ff;">0</span> <span style="color: #000000; font-weight: bold;">then</span>
            Options<span style="color: #000066;">.</span><span style="color: #006600;">BlockSize</span><span style="color: #000066;">:</span><span style="color: #000066;">=</span> <span style="color: #000066;">StrToInt</span><span style="color: #000066;">(</span><span style="color: #000066;">Copy</span><span style="color: #000066;">(</span>Str<span style="color: #000066;">,</span><span style="color: #000066;">Length</span><span style="color: #000066;">(</span><span style="color: #ff0000;">'--bs='</span><span style="color: #000066;">)</span> <span style="color: #000066;">+</span> <span style="color: #0000ff;">1</span><span style="color: #000066;">,</span>MAXINT<span style="color: #000066;">)</span><span style="color: #000066;">)</span>
          <span style="color: #000000; font-weight: bold;">else</span>
            <span style="color: #000000; font-weight: bold;">raise</span> EGetOptError<span style="color: #000066;">.</span><span style="color: #006600;">Create</span><span style="color: #000066;">(</span>Str<span style="color: #000066;">)</span><span style="color: #000066;">;</span>
        <span style="color: #000000; font-weight: bold;">end</span> <span style="color: #000000; font-weight: bold;">else</span> <span style="color: #000000; font-weight: bold;">if</span> <span style="color: #000066;">SameText</span><span style="color: #000066;">(</span><span style="color: #ff0000;">'--help'</span><span style="color: #000066;">,</span>Str<span style="color: #000066;">)</span> <span style="color: #000000; font-weight: bold;">then</span>
        <span style="color: #000000; font-weight: bold;">begin</span>
          WriteHelp<span style="color: #000066;">;</span>
          Halt<span style="color: #000066;">;</span>
        <span style="color: #000000; font-weight: bold;">end</span> <span style="color: #000000; font-weight: bold;">else</span>
          <span style="color: #000000; font-weight: bold;">raise</span> EGetOptError<span style="color: #000066;">.</span><span style="color: #006600;">Create</span><span style="color: #000066;">(</span>Str<span style="color: #000066;">)</span><span style="color: #000066;">;</span>
      <span style="color: #000000; font-weight: bold;">end</span> <span style="color: #000000; font-weight: bold;">else</span> <span style="color: #000000; font-weight: bold;">if</span> <span style="color: #000066;">(</span><span style="color: #000066;">Copy</span><span style="color: #000066;">(</span>Str<span style="color: #000066;">,</span><span style="color: #0000ff;">1</span><span style="color: #000066;">,</span><span style="color: #0000ff;">1</span><span style="color: #000066;">)</span> <span style="color: #000066;">=</span> <span style="color: #ff0000;">'-'</span><span style="color: #000066;">)</span> <span style="color: #000000; font-weight: bold;">and</span> <span style="color: #000066;">(</span><span style="color: #000066;">Length</span><span style="color: #000066;">(</span>Str<span style="color: #000066;">)</span> &gt; <span style="color: #0000ff;">1</span><span style="color: #000066;">)</span> <span style="color: #000000; font-weight: bold;">then</span>
      <span style="color: #000000; font-weight: bold;">begin</span>
        <span style="color: #000000; font-weight: bold;">if</span> <span style="color: #000066;">SameText</span><span style="color: #000066;">(</span><span style="color: #ff0000;">'-h'</span><span style="color: #000066;">,</span>Str<span style="color: #000066;">)</span> <span style="color: #000000; font-weight: bold;">then</span>
        <span style="color: #000000; font-weight: bold;">begin</span>
          WriteHelp<span style="color: #000066;">;</span>
          Halt<span style="color: #000066;">;</span>
        <span style="color: #000000; font-weight: bold;">end</span> <span style="color: #000000; font-weight: bold;">else</span>
          <span style="color: #000000; font-weight: bold;">raise</span> EGetOptError<span style="color: #000066;">.</span><span style="color: #006600;">Create</span><span style="color: #000066;">(</span>Str<span style="color: #000066;">)</span><span style="color: #000066;">;</span>
      <span style="color: #000000; font-weight: bold;">end</span> <span style="color: #000000; font-weight: bold;">else</span>
      <span style="color: #000000; font-weight: bold;">begin</span>
        <span style="color: #000000; font-weight: bold;">raise</span> EGetOptError<span style="color: #000066;">.</span><span style="color: #006600;">Create</span><span style="color: #000066;">(</span>Str<span style="color: #000066;">)</span><span style="color: #000066;">;</span>
      <span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">;</span>
    <span style="color: #000000; font-weight: bold;">end</span> <span style="color: #000000; font-weight: bold;">else</span>
    <span style="color: #000000; font-weight: bold;">begin</span>
      WriteHelp<span style="color: #000066;">;</span>
      Halt<span style="color: #000066;">;</span>
    <span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">;</span>
<span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">;</span>
 
<span style="color: #000000; font-weight: bold;">procedure</span> WriteHeader<span style="color: #000066;">;</span>
<span style="color: #000000; font-weight: bold;">begin</span>
  Writeln<span style="color: #000066;">;</span>
  <span style="color: #000066;">Writeln</span><span style="color: #000066;">(</span><span style="color: #ff0000;">'Recover 0.2 - Copyright (c) 2007 Domingo Seoane'</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
  <span style="color: #000066;">Writeln</span><span style="color: #000066;">(</span><span style="color: #ff0000;">'&lt;a href="http://delphi.jmrds.com'</span>"&gt;http<span style="color: #000066;">:</span><span style="color: #808080; font-style: italic;">//delphi.jmrds.com'&lt;/a&gt;);</span>
  Writeln<span style="color: #000066;">;</span>
<span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">;</span>   
 
<span style="color: #000000; font-weight: bold;">var</span>
  Stream<span style="color: #000066;">:</span> TFileStream<span style="color: #000066;">;</span>
<span style="color: #000000; font-weight: bold;">begin</span>
  WriteHeader<span style="color: #000066;">;</span>
  <span style="color: #000000; font-weight: bold;">try</span>
    GetOpt<span style="color: #000066;">;</span>
    TFileStream<span style="color: #000066;">.</span><span style="color: #006600;">Create</span><span style="color: #000066;">(</span><span style="color: #000066;">Format</span><span style="color: #000066;">(</span>Options<span style="color: #000066;">.</span><span style="color: #006600;">FormatStr</span><span style="color: #000066;">,</span><span style="color: #000066;">[</span><span style="color: #0000ff;">0</span><span style="color: #000066;">]</span><span style="color: #000066;">)</span><span style="color: #000066;">,</span>fmCreate<span style="color: #000066;">)</span><span style="color: #000066;">.</span><span style="color: #006600;">Free</span><span style="color: #000066;">;</span>
    <span style="color: #000066;">DeleteFile</span><span style="color: #000066;">(</span><span style="color: #000066;">Format</span><span style="color: #000066;">(</span>Options<span style="color: #000066;">.</span><span style="color: #006600;">FormatStr</span><span style="color: #000066;">,</span><span style="color: #000066;">[</span><span style="color: #0000ff;">0</span><span style="color: #000066;">]</span><span style="color: #000066;">)</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
    Stream<span style="color: #000066;">:</span><span style="color: #000066;">=</span> TFileStream<span style="color: #000066;">.</span><span style="color: #006600;">Create</span><span style="color: #000066;">(</span>Options<span style="color: #000066;">.</span><span style="color: #006600;">InputFile</span><span style="color: #000066;">,</span>fmOpenRead <span style="color: #000000; font-weight: bold;">or</span>
      fmShareDenyNone<span style="color: #000066;">)</span><span style="color: #000066;">;</span>
    <span style="color: #000000; font-weight: bold;">try</span>
      <span style="color: #000066;">Writeln</span><span style="color: #000066;">(</span><span style="color: #ff0000;">'Explorando el archivo: '</span> <span style="color: #000066;">+</span> Options<span style="color: #000066;">.</span><span style="color: #006600;">InputFile</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
      <span style="color: #000000; font-weight: bold;">if</span> Options<span style="color: #000066;">.</span><span style="color: #006600;">BlockSize</span> &gt; <span style="color: #0000ff;">0</span> <span style="color: #000000; font-weight: bold;">then</span>
        ScanFile<span style="color: #000066;">(</span>Stream<span style="color: #000066;">,</span>Options<span style="color: #000066;">.</span><span style="color: #006600;">FormatStr</span><span style="color: #000066;">,</span>Options<span style="color: #000066;">.</span><span style="color: #006600;">Index</span><span style="color: #000066;">,</span>Options<span style="color: #000066;">.</span><span style="color: #006600;">BlockSize</span><span style="color: #000066;">)</span>
      <span style="color: #000000; font-weight: bold;">else</span>
        ScanFile<span style="color: #000066;">(</span>Stream<span style="color: #000066;">,</span>Options<span style="color: #000066;">.</span><span style="color: #006600;">FormatStr</span><span style="color: #000066;">,</span>Options<span style="color: #000066;">.</span><span style="color: #006600;">Index</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
    <span style="color: #000000; font-weight: bold;">finally</span>
      Stream<span style="color: #000066;">.</span><span style="color: #006600;">Free</span><span style="color: #000066;">;</span>
    <span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">;</span>
  <span style="color: #000000; font-weight: bold;">except</span>
    <span style="color: #808080; font-style: italic;">// Si se produce un error, lo mostramos</span>
    <span style="color: #000000; font-weight: bold;">On</span> E<span style="color: #000066;">:</span> Exception <span style="color: #000000; font-weight: bold;">do</span>
      <span style="color: #000066;">Writeln</span><span style="color: #000066;">(</span><span style="color: #ff0000;">'Error: '</span> <span style="color: #000066;">+</span> E<span style="color: #000066;">.</span><span style="color: #000000; font-weight: bold;">Message</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
  <span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">;</span>
<span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">.</span></pre></div>
<p>El código completo y el programa ya compilado para windows, los puedes bajar de <a href="/sites/delphi.jmrds.com/adjuntos/recover3_delphi.zip">aquí</a></p>
<p>Para compilar el código en linux con freepascal utiliza un comando como este:<br /><b>fpc -XX -Sd recover.dpr</b></p>
<p>El programa recibe cuatro parámetros de los que solo dos son obligatorios, --if y --fs. El archivo de entrada (--if) es el archivo o disco donde se buscaran las imágenes, puede ser una archivo normal, por ejemplo "thumb.db", o un disco, por ejemplo "\\.\F:" en windows o "/dev/sda" en linux. El parámetro --fs sirve para generar el nombre con el que se guardaran las imágenes recuperadas, debe contener la cadena %d que sera sustituida por un numero creciente. Los otros dos parámetros (--bs y --id) son opcionales, y sirven para indicar el tamaño del bloque (necesario para los discos duros) y el numero por el que se empiezan a numerar las imágenes recuperadas. </p>
<p>Algunos ejemplo de uso:<br />
recover --if=\\.\F: --bs=4096 --fs=%d.jpg<br />
recover --if=/dev/sda --bs=4096 --fs=%d.jpg<br />
recover --if=thumb.db --fs=%d.jpg --id=100</p>
</div></div></div>    <footer>
        <ul class="links list-inline"><li class="comment_forbidden first last"></li>
</ul>  </footer>
    <div id="comments" class="comment-wrapper">
          <h2 class="title">Comentarios</h2>
      
  <a id="comment-22"></a>
<div class="comment comment-by-anonymous clearfix" about="/comment/22#comment-22" typeof="sioc:Post sioct:Comment">
  
  
    <h3 property="dc:title" datatype=""><a href="/comment/22#comment-22" class="permalink" rel="bookmark">I think that this program</a></h3>
  
  <div class="submitted">
    <a href="/comment/22#comment-22" class="permalink" rel="bookmark">Enlace permanente</a>    <span property="dc:date dc:created" content="2007-11-25T03:08:47+01:00" datatype="xsd:dateTime" rel="sioc:has_creator">Enviado por <span class="username" xml:lang="" typeof="sioc:UserAccount" property="foaf:name" datatype="">Anonimo (no verificado)</span> el Dom, 11/25/2007 - 03:08</span>  </div>

  <div class="content">
    <span rel="sioc:reply_of" resource="/node/42" class="rdf-meta element-hidden"></span><div class="field field-name-comment-body field-type-text-long field-label-hidden"><div class="field-items"><div class="field-item even" property="content:encoded"><p>I think that this program also recover actual (non deleted) images.  In fact it recover all possible jpg images from disk. On a disk i have about 3000 jpg images and it recover all of them + many miniatures. Am i right? </p>
<p>Thanks. nh. </p>
</div></div></div>      </div>

  <ul class="links list-inline"><li class="comment_forbidden first last"></li>
</ul></div>

<div class="indented"><a id="comment-23"></a>
<div class="comment comment-by-node-author clearfix" about="/comment/23#comment-23" typeof="sioc:Post sioct:Comment">
  
  
    <h3 property="dc:title" datatype=""><a href="/comment/23#comment-23" class="permalink" rel="bookmark">Tienes razón, el programa</a></h3>
  
  <div class="submitted">
    <a href="/comment/23#comment-23" class="permalink" rel="bookmark">Enlace permanente</a>    <span property="dc:date dc:created" content="2007-11-25T12:23:21+01:00" datatype="xsd:dateTime" rel="sioc:has_creator">Enviado por <span class="username" xml:lang="" about="/user/1" typeof="sioc:UserAccount" property="foaf:name" datatype="">admin</span> el Dom, 11/25/2007 - 12:23</span>  </div>

  <div class="content">
    <span rel="sioc:reply_of" resource="/node/42" class="rdf-meta element-hidden"></span><span rel="sioc:reply_of" resource="/comment/22#comment-22" class="rdf-meta element-hidden"></span><div class="field field-name-comment-body field-type-text-long field-label-hidden"><div class="field-items"><div class="field-item even" property="content:encoded"><p>Tienes razón, el programa recupera todas las imágenes jpg que encuentra en el disco, sin importar si las imágenes han sido borradas o no.  Esto es un problema cuando tienes muchas imágenes en un disco, una posible mejora sería descartar las que ya existen, o incluso hacer algún tipo de vista previa para poder seleccionar las que se quieren recuperar, pero eso lo dejo para un futuro.</p>
</div></div></div>      </div>

  <ul class="links list-inline"><li class="comment_forbidden first last"></li>
</ul></div>
</div><a id="comment-24"></a>
<div class="comment comment-by-anonymous clearfix" about="/comment/24#comment-24" typeof="sioc:Post sioct:Comment">
  
  
    <h3 property="dc:title" datatype=""><a href="/comment/24#comment-24" class="permalink" rel="bookmark">gracias  - a screening or</a></h3>
  
  <div class="submitted">
    <a href="/comment/24#comment-24" class="permalink" rel="bookmark">Enlace permanente</a>    <span property="dc:date dc:created" content="2007-11-25T15:36:44+01:00" datatype="xsd:dateTime" rel="sioc:has_creator">Enviado por <span class="username" xml:lang="" typeof="sioc:UserAccount" property="foaf:name" datatype="">Anonimo again  (no verificado)</span> el Dom, 11/25/2007 - 15:36</span>  </div>

  <div class="content">
    <span rel="sioc:reply_of" resource="/node/42" class="rdf-meta element-hidden"></span><div class="field field-name-comment-body field-type-text-long field-label-hidden"><div class="field-items"><div class="field-item even" property="content:encoded"><p>gracias  - a screening or filter would be not easy to do since we have no name on the files. Regular restoration programs recover deleted file by name i guess. Here it is different. Thank again - from montreal canada </p>
</div></div></div>      </div>

  <ul class="links list-inline"><li class="comment_forbidden first last"></li>
</ul></div>
<a id="comment-133"></a>
<div class="comment comment-by-anonymous clearfix" about="/comment/133#comment-133" typeof="sioc:Post sioct:Comment">
  
  
    <h3 property="dc:title" datatype=""><a href="/comment/133#comment-133" class="permalink" rel="bookmark">Cordial saludo Domingo.
Ojalá</a></h3>
  
  <div class="submitted">
    <a href="/comment/133#comment-133" class="permalink" rel="bookmark">Enlace permanente</a>    <span property="dc:date dc:created" content="2009-07-03T12:38:08+02:00" datatype="xsd:dateTime" rel="sioc:has_creator">Enviado por <span class="username" xml:lang="" typeof="sioc:UserAccount" property="foaf:name" datatype="">eherrera (no verificado)</span> el Vie, 07/03/2009 - 12:38</span>  </div>

  <div class="content">
    <span rel="sioc:reply_of" resource="/node/42" class="rdf-meta element-hidden"></span><div class="field field-name-comment-body field-type-text-long field-label-hidden"><div class="field-items"><div class="field-item even" property="content:encoded"><p>Cordial saludo Domingo.</p>
<p>Ojalá aún sigas atendiendo tu sitio.</p>
<p>Estas a punto de resolverme una necesidad grande que tengo, o tenía.</p>
<p>Estaba ampliando un partición de mi disco y hubo un corte de energía, cuando volví a tratar de ver su contenido (al rededor de 10000 fotos y videos), no pude verlas. Intenté recuperarlas con varios programas que hay en el mercado (Easyrecory, GetdataBack) y ecuperó una buena parte, pero tengo pendiente recuperara al rededor de 3000.</p>
<p>Tu programa me viene como anillo al dedo. Sin embargo tengo algunas inquietudes al respecto:</p>
<p>1. Dado que se trata de hacer un barrido de un dd de 250G, consideras viable utilizarlo ?. No importa que se demore días en lograrlo.<br />
2. Revisé los fuentes y se ocurre que utilizarlo para otro tipo de archivos sólo requiere conocer la "firma" del tipo de archivo que se desea recuperar y hacer los ajustes a tu fuente. Es correcto ?</p>
<p>Es inmensa la gratitud que te manifiesto, sólo por darme la esperanza de poder recuperar los archivo.</p>
</div></div></div>      </div>

  <ul class="links list-inline"><li class="comment_forbidden first last"></li>
</ul></div>
<a id="comment-911"></a>
<div class="comment comment-by-anonymous clearfix" about="/comment/911#comment-911" typeof="sioc:Post sioct:Comment">
  
  
    <h3 property="dc:title" datatype=""><a href="/comment/911#comment-911" class="permalink" rel="bookmark">Te felicito por el programa,</a></h3>
  
  <div class="submitted">
    <a href="/comment/911#comment-911" class="permalink" rel="bookmark">Enlace permanente</a>    <span property="dc:date dc:created" content="2012-04-19T00:40:00+02:00" datatype="xsd:dateTime" rel="sioc:has_creator">Enviado por <span class="username" xml:lang="" typeof="sioc:UserAccount" property="foaf:name" datatype="">Anonimo (no verificado)</span> el Jue, 04/19/2012 - 00:40</span>  </div>

  <div class="content">
    <span rel="sioc:reply_of" resource="/node/42" class="rdf-meta element-hidden"></span><div class="field field-name-comment-body field-type-text-long field-label-hidden"><div class="field-items"><div class="field-item even" property="content:encoded"><p>Te felicito por el programa, lo que no entiendo si detecta los distintos formatos de disco (Fat32,nfts,...). Aunque veo que aguanta los formatos de linux.</p>
<p>Supongo que según el formato se tendría que reajustar los parámetros.</p>
<p>Que al final se pueda usar a base de comandos linux, lo hace una herramienta muy eficaz. Por ejemplo en php podemos recurrir a este programa en la consola.</p>
</div></div></div>      </div>

  <ul class="links list-inline"><li class="comment_forbidden first last"></li>
</ul></div>

<div class="indented"><a id="comment-912"></a>
<div class="comment comment-by-node-author clearfix" about="/comment/912#comment-912" typeof="sioc:Post sioct:Comment">
  
  
    <h3 property="dc:title" datatype=""><a href="/comment/912#comment-912" class="permalink" rel="bookmark">Lee cualquier formato de</a></h3>
  
  <div class="submitted">
    <a href="/comment/912#comment-912" class="permalink" rel="bookmark">Enlace permanente</a>    <span property="dc:date dc:created" content="2012-04-19T00:48:29+02:00" datatype="xsd:dateTime" rel="sioc:has_creator">Enviado por <span class="username" xml:lang="" about="/user/1" typeof="sioc:UserAccount" property="foaf:name" datatype="">admin</span> el Jue, 04/19/2012 - 00:48</span>  </div>

  <div class="content">
    <span rel="sioc:reply_of" resource="/node/42" class="rdf-meta element-hidden"></span><span rel="sioc:reply_of" resource="/comment/911#comment-911" class="rdf-meta element-hidden"></span><div class="field field-name-comment-body field-type-text-long field-label-hidden"><div class="field-items"><div class="field-item even" property="content:encoded"><p>Lee cualquier formato de disco ya que lee "físicamente" el disco, independientemente del sistema de ficheros que se este utilizando.</p>
</div></div></div>      </div>

  <ul class="links list-inline"><li class="comment_forbidden first last"></li>
</ul></div>
</div>
  </div>
</article>

</section>
  </div>
    </section>

    
  </div>
</div>

  <script src="/sites/delphi.jmrds.com/themes/bootstrap/js/bootstrap.js?"></script>
</body>
</html>
