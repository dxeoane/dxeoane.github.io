<!DOCTYPE html>
<html lang="es" dir="ltr" prefix="content: http://purl.org/rss/1.0/modules/content/ dc: http://purl.org/dc/terms/ foaf: http://xmlns.com/foaf/0.1/ og: http://ogp.me/ns# rdfs: http://www.w3.org/2000/01/rdf-schema# sioc: http://rdfs.org/sioc/ns# sioct: http://rdfs.org/sioc/types# skos: http://www.w3.org/2004/02/skos/core# xsd: http://www.w3.org/2001/XMLSchema#">
<head>
  <link rel="profile" href="http://www.w3.org/1999/xhtml/vocab" />
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<link rel="shortcut icon" href="/sites/delphi.jmrds.com/themes/bootstrap/favicon.ico" type="image/vnd.microsoft.icon" />
<link rel="shortlink" href="/node/37" />
<link rel="canonical" href="/node/37" />
<meta name="Generator" content="Drupal 7 (http://drupal.org)" />
  <title>Crear archivo log | La web de Seoane</title>
  <style>
@import url("/modules/system/system.base.css?");
</style>
<style>
@import url("/modules/field/theme/field.css?");
@import url("/modules/node/node.css?");
</style>
<style>
@import url("/sites/delphi.jmrds.com/modules/geshifilter/geshifilter.css?");
</style>
<link type="text/css" rel="stylesheet" href="//cdn.jsdelivr.net/bootstrap/3.3.5/css/bootstrap.css" media="all" />
<style>
@import url("/sites/delphi.jmrds.com/themes/bootstrap/css/3.3.5/overrides.min.css?");
</style>
  <!-- HTML5 element support for IE6-8 -->
  <!--[if lt IE 9]>
    <script src="https://cdn.jsdelivr.net/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
  <![endif]-->
  <script src="/sites/delphi.jmrds.com/modules/jquery_update/replace/jquery/1.10/jquery.min.js?v=1.10.2"></script>
<script src="/misc/jquery.once.js?v=1.2"></script>
<script src="/misc/drupal.js?"></script>
<script src="//cdn.jsdelivr.net/bootstrap/3.3.5/js/bootstrap.js"></script>
<script src="/sites/delphi.jmrds.com/files/languages/es_sB9mP1iixuFRbyZKZVySK7xrSW_2-LRj1vNEXyqwOu8.js?"></script>
<script>jQuery.extend(Drupal.settings, {"basePath":"\/","pathPrefix":"","ajaxPageState":{"theme":"bootstrap","theme_token":"-iTThpnp2Nzq0Xr79Yj9dgHq4Nk41p7XDrfxiSCJZ1s","js":{"sites\/delphi.jmrds.com\/themes\/bootstrap\/js\/bootstrap.js":1,"sites\/delphi.jmrds.com\/modules\/jquery_update\/replace\/jquery\/1.10\/jquery.min.js":1,"misc\/jquery.once.js":1,"misc\/drupal.js":1,"\/\/cdn.jsdelivr.net\/bootstrap\/3.3.5\/js\/bootstrap.js":1,"public:\/\/languages\/es_sB9mP1iixuFRbyZKZVySK7xrSW_2-LRj1vNEXyqwOu8.js":1},"css":{"modules\/system\/system.base.css":1,"modules\/field\/theme\/field.css":1,"modules\/node\/node.css":1,"sites\/delphi.jmrds.com\/modules\/geshifilter\/geshifilter.css":1,"\/\/cdn.jsdelivr.net\/bootstrap\/3.3.5\/css\/bootstrap.css":1,"sites\/delphi.jmrds.com\/themes\/bootstrap\/css\/3.3.5\/overrides.min.css":1}},"bootstrap":{"anchorsFix":"0","anchorsSmoothScrolling":"0","formHasError":1,"popoverEnabled":"1","popoverOptions":{"animation":1,"html":0,"placement":"right","selector":"","trigger":"click","triggerAutoclose":1,"title":"","content":"","delay":0,"container":"body"},"tooltipEnabled":"1","tooltipOptions":{"animation":1,"html":0,"placement":"auto left","selector":"","trigger":"hover focus","delay":0,"container":"body"}}});</script>
</head>
<body class="html not-front not-logged-in no-sidebars page-node page-node- page-node-37 node-type-article">
  <div id="skip-link">
    <a href="#main-content" class="element-invisible element-focusable">Pasar al contenido principal</a>
  </div>
    <header id="navbar" role="banner" class="navbar container navbar-default">
  <div class="container">
    <div class="navbar-header">
              <a class="logo navbar-btn pull-left" href="/" title="Inicio">
          <img src="/sites/delphi.jmrds.com/themes/bootstrap/logo.png" alt="Inicio" />
        </a>
      
              <a class="name navbar-brand" href="/" title="Inicio">La web de Seoane</a>
      
              <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#navbar-collapse">
          <span class="sr-only">Toggle navigation</span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
          </div>

          <div class="navbar-collapse collapse" id="navbar-collapse">
        <nav role="navigation">
                      <ul class="menu nav navbar-nav"><li class="first leaf"><a href="/" title="">Inicio</a></li>
<li class="leaf"><a href="/search/node" title="">Buscar</a></li>
<li class="leaf"><a href="/rss.xml" title="">RSS</a></li>
<li class="leaf"><a href="/node/26" title="">Contacto</a></li>
<li class="last leaf"><a href="/user/login" title="">Login</a></li>
</ul>                                      </nav>
      </div>
      </div>
</header>

<div class="main-container container">

  <header role="banner" id="page-header">
    
      </header> <!-- /#page-header -->

  <div class="row">

    
    <section class="col-sm-12">
                  <a id="main-content"></a>
                    <h1 class="page-header">Crear archivo log</h1>
                                                          <div class="region region-content">
    <section id="block-system-main" class="block block-system clearfix">

      
  <article id="node-37" class="node node-article node-promoted clearfix" about="/node/37" typeof="sioc:Item foaf:Document">
    <header>
            <span property="dc:title" content="Crear archivo log" class="rdf-meta element-hidden"></span><span property="sioc:num_replies" content="3" datatype="xsd:integer" class="rdf-meta element-hidden"></span>        <span class="submitted">
            <span property="dc:date dc:created" content="2007-08-24T01:06:57+02:00" datatype="xsd:dateTime" rel="sioc:has_creator">Enviado por <span class="username" xml:lang="" about="/user/1" typeof="sioc:UserAccount" property="foaf:name" datatype="">admin</span> el Vie, 08/24/2007 - 01:06</span>    </span>
      </header>
    <div class="field field-name-body field-type-text-with-summary field-label-hidden"><div class="field-items"><div class="field-item even" property="content:encoded"><p>Cuando una aplicacion falla y hay que averiguar donde esta el error, resulta util tener tener un registro donde hayan quedado guardados, tanto las acciones realizadas como una descripcion de los posibles errores. El siguiente codigo puede ser una solucion rapida y sencilla si necesitamos crear un log, solo tenemos que llamar a la funcion con el mensaje a registrar y la propia funcion se encarga de guardar tambien la fecha, se preocupa de no entrar en conflicto con otros threads y cuando el tamaño del archivo se vuelve excesivo lo renombra y crea uno nuevo. Es decir, nosotros solo tenemos que añadir esta funcion a nuestro codigo y despreocuparnos de lo demas.</p>
<!--break--><div class="geshifilter">
<pre class="delphi geshifilter-delphi" style="font-family:monospace;"><span style="color: #000000; font-weight: bold;">procedure</span> log<span style="color: #000066;">(</span>Mensaje<span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">String</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
<span style="color: #000000; font-weight: bold;">var</span>
  F<span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">TextFile</span><span style="color: #000066;">;</span>
  Filename<span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">String</span><span style="color: #000066;">;</span>
  Mutex<span style="color: #000066;">:</span> <span style="color: #000066; font-weight: bold;">THandle</span><span style="color: #000066;">;</span>
  SearchRec<span style="color: #000066;">:</span> TSearchRec<span style="color: #000066;">;</span>
<span style="color: #000000; font-weight: bold;">begin</span>
  <span style="color: #808080; font-style: italic;">// Insertamos la fecha y la hora</span>
  Mensaje<span style="color: #000066;">:</span><span style="color: #000066;">=</span> <span style="color: #000066;">FormatDateTime</span><span style="color: #000066;">(</span><span style="color: #ff0000;">'[ddd dd mmm, hh:nn] '</span><span style="color: #000066;">,</span> Now<span style="color: #000066;">)</span> <span style="color: #000066;">+</span> Mensaje<span style="color: #000066;">;</span>
  <span style="color: #808080; font-style: italic;">// El nombre del archivo es igual al del ejecutable, pero con la extension .log</span>
  Filename<span style="color: #000066;">:</span><span style="color: #000066;">=</span> <span style="color: #000066;">ChangeFileExt</span><span style="color: #000066;">(</span><span style="color: #000066;">ParamStr</span><span style="color: #000066;">(</span><span style="color: #0000ff;">0</span><span style="color: #000066;">)</span><span style="color: #000066;">,</span><span style="color: #ff0000;">'.log'</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
  <span style="color: #808080; font-style: italic;">// Creamos un mutex, usando como identificador unico la ruta completa del ejecutable</span>
  Mutex<span style="color: #000066;">:</span><span style="color: #000066;">=</span> CreateMutex<span style="color: #000066;">(</span><span style="color: #000000; font-weight: bold;">nil</span><span style="color: #000066;">,</span><span style="color: #000000; font-weight: bold;">FALSE</span><span style="color: #000066;">,</span>
    <span style="color: #000066; font-weight: bold;">PChar</span><span style="color: #000066;">(</span><span style="color: #000066;">StringReplace</span><span style="color: #000066;">(</span><span style="color: #000066;">ParamStr</span><span style="color: #000066;">(</span><span style="color: #0000ff;">0</span><span style="color: #000066;">)</span><span style="color: #000066;">,</span><span style="color: #ff0000;">'\'</span><span style="color: #000066;">,</span><span style="color: #ff0000;">'/'</span><span style="color: #000066;">,</span><span style="color: #000066;">[</span>rfReplaceAll<span style="color: #000066;">]</span><span style="color: #000066;">)</span><span style="color: #000066;">)</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
  <span style="color: #000000; font-weight: bold;">if</span> Mutex &lt;&gt; <span style="color: #0000ff;">0</span> <span style="color: #000000; font-weight: bold;">then</span>
  <span style="color: #000000; font-weight: bold;">begin</span>
    <span style="color: #808080; font-style: italic;">// Esperamos nuestro turno para escribir</span>
    WaitForSingleObject<span style="color: #000066;">(</span>Mutex<span style="color: #000066;">,</span> INFINITE<span style="color: #000066;">)</span><span style="color: #000066;">;</span>
    <span style="color: #000000; font-weight: bold;">try</span>
      <span style="color: #808080; font-style: italic;">// Comprobamos el tamaño del archivo</span>
      <span style="color: #000000; font-weight: bold;">if</span> <span style="color: #000066;">FindFirst</span><span style="color: #000066;">(</span>Filename<span style="color: #000066;">,</span>faAnyFile<span style="color: #000066;">,</span>SearchRec<span style="color: #000066;">)</span> <span style="color: #000066;">=</span> <span style="color: #0000ff;">0</span> <span style="color: #000000; font-weight: bold;">then</span>
      <span style="color: #000000; font-weight: bold;">begin</span>
        <span style="color: #808080; font-style: italic;">// Si es mayor de un mega lo copiamos a (nombre).log.1</span>
        <span style="color: #000000; font-weight: bold;">if</span> SearchRec<span style="color: #000066;">.</span><span style="color: #006600;">Size</span> &gt; <span style="color: #000066;">(</span><span style="color: #0000ff;">1024</span><span style="color: #000066;">*</span><span style="color: #0000ff;">1024</span><span style="color: #000066;">)</span> <span style="color: #000000; font-weight: bold;">then</span>
          MoveFileEx<span style="color: #000066;">(</span><span style="color: #000066; font-weight: bold;">PChar</span><span style="color: #000066;">(</span>Filename<span style="color: #000066;">)</span><span style="color: #000066;">,</span><span style="color: #000066; font-weight: bold;">PChar</span><span style="color: #000066;">(</span>Filename <span style="color: #000066;">+</span> <span style="color: #ff0000;">'.1'</span><span style="color: #000066;">)</span><span style="color: #000066;">,</span>
            MOVEFILE_REPLACE_EXISTING<span style="color: #000066;">)</span><span style="color: #000066;">;</span>
        <span style="color: #000066;">FindClose</span><span style="color: #000066;">(</span>SearchRec<span style="color: #000066;">)</span><span style="color: #000066;">;</span>
      <span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">;</span>
      <span style="color: #000000; font-weight: bold;">try</span>
        <span style="color: #000066;">AssignFile</span><span style="color: #000066;">(</span>F<span style="color: #000066;">,</span> Filename<span style="color: #000066;">)</span><span style="color: #000066;">;</span>
        <span style="color: #008000; font-style: italic;">{$I-}</span>
          <span style="color: #000066;">Append</span><span style="color: #000066;">(</span>F<span style="color: #000066;">)</span><span style="color: #000066;">;</span>
        <span style="color: #000000; font-weight: bold;">if</span> IOResult &lt;&gt; <span style="color: #0000ff;">0</span> <span style="color: #000000; font-weight: bold;">then</span>
          <span style="color: #000066;">Rewrite</span><span style="color: #000066;">(</span>F<span style="color: #000066;">)</span><span style="color: #000066;">;</span>
        <span style="color: #008000; font-style: italic;">{$I+}</span>
        <span style="color: #000000; font-weight: bold;">if</span> IOResult <span style="color: #000066;">=</span> <span style="color: #0000ff;">0</span> <span style="color: #000000; font-weight: bold;">then</span>
        <span style="color: #000000; font-weight: bold;">begin</span>
          <span style="color: #808080; font-style: italic;">// Escribimos el mensaje</span>
          <span style="color: #000066;">Writeln</span><span style="color: #000066;">(</span>F<span style="color: #000066;">,</span>Mensaje<span style="color: #000066;">)</span><span style="color: #000066;">;</span>
          <span style="color: #000066;">CloseFile</span><span style="color: #000066;">(</span>F<span style="color: #000066;">)</span><span style="color: #000066;">;</span>
        <span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">;</span>
      <span style="color: #000000; font-weight: bold;">except</span>
        <span style="color: #808080; font-style: italic;">// </span>
      <span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">;</span>
    <span style="color: #000000; font-weight: bold;">finally</span>
      ReleaseMutex<span style="color: #000066;">(</span>Mutex<span style="color: #000066;">)</span><span style="color: #000066;">;</span>
      CloseHandle<span style="color: #000066;">(</span>Mutex<span style="color: #000066;">)</span><span style="color: #000066;">;</span>
    <span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">;</span>
  <span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">;</span>
<span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">;</span></pre></div>
<p>Una ejemplo sencillo de como usar esta función:</p>
<div class="geshifilter">
<pre class="delphi geshifilter-delphi" style="font-family:monospace;">log<span style="color: #000066;">(</span><span style="color: #ff0000;">'La aplicacion se inicio correctamente'</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span></pre></div>
<p>Aunque donde puede resultar muy util es, por ejemplo, dentro de un servicio para guardar la descripcion de las excepciones:</p>
<div class="geshifilter">
<pre class="delphi geshifilter-delphi" style="font-family:monospace;"><span style="color: #000000; font-weight: bold;">procedure</span> TService1<span style="color: #000066;">.</span><span style="color: #006600;">ServiceExecute</span><span style="color: #000066;">(</span>Sender<span style="color: #000066;">:</span> TService<span style="color: #000066;">)</span><span style="color: #000066;">;</span>
<span style="color: #000000; font-weight: bold;">begin</span>
  <span style="color: #000000; font-weight: bold;">try</span>    
    log<span style="color: #000066;">(</span><span style="color: #ff0000;">'Servicio iniciado'</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
    <span style="color: #808080; font-style: italic;">// Aqui una tarea que puede provocar excepciones</span>
    log<span style="color: #000066;">(</span><span style="color: #ff0000;">'Servicio finalizado'</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>  
  <span style="color: #000000; font-weight: bold;">except</span>
    <span style="color: #808080; font-style: italic;">// Si se produce una excepcion guardamos su descripcion</span>
    <span style="color: #000000; font-weight: bold;">on</span> E<span style="color: #000066;">:</span> Exception <span style="color: #000000; font-weight: bold;">do</span>
      log<span style="color: #000066;">(</span><span style="color: #ff0000;">'Exception: '</span> <span style="color: #000066;">+</span> E<span style="color: #000066;">.</span><span style="color: #000000; font-weight: bold;">Message</span><span style="color: #000066;">)</span><span style="color: #000066;">;</span>
  <span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">;</span>
<span style="color: #000000; font-weight: bold;">end</span><span style="color: #000066;">;</span></pre></div>
</div></div></div>    <footer>
        <ul class="links list-inline"><li class="comment_forbidden first last"></li>
</ul>  </footer>
    <div id="comments" class="comment-wrapper">
          <h2 class="title">Comentarios</h2>
      
  <a id="comment-6"></a>
<div class="comment comment-by-anonymous clearfix" about="/comment/6#comment-6" typeof="sioc:Post sioct:Comment">
  
  
    <h3 property="dc:title" datatype=""><a href="/comment/6#comment-6" class="permalink" rel="bookmark">Estupendo código.... e</a></h3>
  
  <div class="submitted">
    <a href="/comment/6#comment-6" class="permalink" rel="bookmark">Enlace permanente</a>    <span property="dc:date dc:created" content="2007-08-24T09:11:27+02:00" datatype="xsd:dateTime" rel="sioc:has_creator">Enviado por <span class="username" xml:lang="" typeof="sioc:UserAccount" property="foaf:name" datatype="">Javi (no verificado)</span> el Vie, 08/24/2007 - 09:11</span>  </div>

  <div class="content">
    <span rel="sioc:reply_of" resource="/node/37" class="rdf-meta element-hidden"></span><div class="field field-name-comment-body field-type-text-long field-label-hidden"><div class="field-items"><div class="field-item even" property="content:encoded"><p>Estupendo código.... e ideal para controlar servicio...tk!</p>
</div></div></div>      </div>

  <ul class="links list-inline"><li class="comment_forbidden first last"></li>
</ul></div>
<a id="comment-11"></a>
<div class="comment comment-by-anonymous clearfix" about="/comment/11#comment-11" typeof="sioc:Post sioct:Comment">
  
  
    <h3 property="dc:title" datatype=""><a href="/comment/11#comment-11" class="permalink" rel="bookmark">Está muy bien Domingo. :)</a></h3>
  
  <div class="submitted">
    <a href="/comment/11#comment-11" class="permalink" rel="bookmark">Enlace permanente</a>    <span property="dc:date dc:created" content="2007-09-01T05:24:41+02:00" datatype="xsd:dateTime" rel="sioc:has_creator">Enviado por <span class="username" xml:lang="" typeof="sioc:UserAccount" property="foaf:name" datatype="">dec (no verificado)</span> el Sáb, 09/01/2007 - 05:24</span>  </div>

  <div class="content">
    <span rel="sioc:reply_of" resource="/node/37" class="rdf-meta element-hidden"></span><div class="field field-name-comment-body field-type-text-long field-label-hidden"><div class="field-items"><div class="field-item even" property="content:encoded"><p>Está muy bien Domingo. :)</p>
</div></div></div>      </div>

  <ul class="links list-inline"><li class="comment_forbidden first last"></li>
</ul></div>
<a id="comment-58"></a>
<div class="comment comment-by-anonymous clearfix" about="/comment/58#comment-58" typeof="sioc:Post sioct:Comment">
  
  
    <h3 property="dc:title" datatype=""><a href="/comment/58#comment-58" class="permalink" rel="bookmark">Excelente!!!
Gracias por</a></h3>
  
  <div class="submitted">
    <a href="/comment/58#comment-58" class="permalink" rel="bookmark">Enlace permanente</a>    <span property="dc:date dc:created" content="2008-06-02T10:16:48+02:00" datatype="xsd:dateTime" rel="sioc:has_creator">Enviado por <span class="username" xml:lang="" typeof="sioc:UserAccount" property="foaf:name" datatype="">Anonimo (no verificado)</span> el Lun, 06/02/2008 - 10:16</span>  </div>

  <div class="content">
    <span rel="sioc:reply_of" resource="/node/37" class="rdf-meta element-hidden"></span><div class="field field-name-comment-body field-type-text-long field-label-hidden"><div class="field-items"><div class="field-item even" property="content:encoded"><p>Excelente!!!</p>
<p>Gracias por compartirlo</p>
</div></div></div>      </div>

  <ul class="links list-inline"><li class="comment_forbidden first last"></li>
</ul></div>

  </div>
</article>

</section>
  </div>
    </section>

    
  </div>
</div>

  <footer class="footer container">
      <div class="region region-footer">
    <section id="block-menu-menu-enlaces" class="block block-menu clearfix">

        <h2 class="block-title">Enlaces interesantes</h2>
    
  <ul class="menu nav"><li class="first leaf"><a href="http://www.cadetill.com" title="">Cadetill</a></li>
<li class="leaf"><a href="http://www.delphiaccess.com/forum" title="">DelphiAccess</a></li>
<li class="leaf"><a href="http://www.delphispano.com/" title="">Delphispano</a></li>
<li class="leaf"><a href="http://egostar.delphiaccess.com/" title="">Egostar</a></li>
<li class="leaf"><a href="http://jachguate.wordpress.com/" title="">Jachguate</a></li>
<li class="leaf"><a href="http://neftali.clubdelphi.com/" title="">Neftali</a></li>
<li class="leaf"><a href="http://elpoli.delphiaccess.com/" title="">Poliburro</a></li>
<li class="leaf"><a href="http://theroadtodelphi.wordpress.com/" title="">Rodrigo Ruz</a></li>
<li class="last leaf"><a href="http://salvador.oversistemas.com/" title="">Salvador Gomez</a></li>
</ul>
</section>
<section id="block-block-1" class="block block-block clearfix">

      
  <p>copyright (c) 2007 - 2016 Domingo Seoane</p>

</section>
  </div>
  </footer>
  <script src="/sites/delphi.jmrds.com/themes/bootstrap/js/bootstrap.js?"></script>
</body>
</html>
